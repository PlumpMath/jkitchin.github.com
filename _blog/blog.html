<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>org-element-explorer</title>
<!-- 2015-11-07 Sat 19:03 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/javascript" src="http://orgmode.org/mathjax/MathJax.js"></script>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
        //  config: ["MMLorHTML.js"], jax: ["input/TeX"],
            jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">org-element-explorer</h1>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Adding emacs command key-bindings and help functionality to org-mode</h2>
<div class="outline-text-2" id="text-1">
<p>
The documentation of functions in emacs allows you to put some light markup that will render as the key sequence required to run the command. I would like to have something like that in org-mode. You can look up the key-binding to a command like this:
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(substitute-command-keys <span style="color: #008000;">"\\[</span><span style="color: #D0372D;">org-toggle-latex-overlays</span><span style="color: #008000;">]"</span>)
</pre>
</div>

<pre class="example">
C-c C-x C-l
</pre>

<p>
We are going to explore a way to recognize the syntax shown above, change its appearance to alert us that we are looking at an emacs command, add a tooltip, and make it clickable to open the documentation. Font lock is the tool we will use for this. Basically, we need a regular expression to match the syntax, and a function to find the next instance, and put some properties on the matched text.
</p>

<p>
Here we use the `rx' library to build up a regular expression for this. It is a bit easier to document than a raw regexp. Since we are matching \ in the pattern, there are some obligatory escaping \ characters in there too. Here is how to set it up, and use it on a string.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">rx</span>)
(<span style="color: #0000FF;">let</span> ((rex (<span style="color: #0000FF;">rx</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">opening \\[</span>
            <span style="color: #008000;">"\\\\["</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">one or more characters that are not ]</span>
            (group (one-or-more (not (any <span style="color: #008000;">"]"</span>))))
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">The closing ]</span>
            <span style="color: #008000;">"]"</span>)))
      (string-match rex <span style="color: #008000;">"\\\\[</span><span style="color: #D0372D;">org-toggle-latex-overlays</span><span style="color: #008000;">]"</span>)
      (list (match-string 0 <span style="color: #008000;">"\\\\[org-toggle-latex-overlays\\]"</span>)
            (match-string 1 <span style="color: #008000;">"\\\\[org-toggle-latex-overlays\\]"</span>)))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">\\[org-toggle-latex-overlays\</td>
<td class="left">org-toggle-latex-overlays</td>
</tr>
</tbody>
</table>

<p>
So, we can find these, and all we need is to integrate this into font-lock. We define a function that will move the point to the end of the next match, and put an overlay and face on the match. We will go ahead and make the text clickable so we can access documentation easily. The overlay will show the key-binding to run the command.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">ov</span>)
(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">rx</span>)

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">elisp-symbol-keybinding-re</span>
  (<span style="color: #0000FF;">rx</span>
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">opening \\[</span>
   <span style="color: #008000;">"\\\\["</span>
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">one or more characters that are not ]</span>
   (group (one-or-more (not (any <span style="color: #008000;">"]"</span>))))
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">The closing ]</span>
   <span style="color: #008000;">"]"</span>)
<span style="color: #036A07;">"Regexp for an elisp command keybinding syntax. \\[</span><span style="color: #D0372D;">some-command</span><span style="color: #036A07;">]</span>
<span style="color: #036A07;">Regexp group 1 matches `</span><span style="color: #D0372D;">some-command</span><span style="color: #036A07;">'."</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">match-next-keybinding</span> (<span style="color: #6434A3;">&amp;optional</span> limit)
  <span style="color: #036A07;">"Move point to the end of the next expression matching</span>
<span style="color: #036A07;">`</span><span style="color: #D0372D;">elisp-symbol-keybinding-re</span><span style="color: #036A07;">', and put an overlay on the match</span>
<span style="color: #036A07;">that shows the key sequence. Non-bound commands are not</span>
<span style="color: #036A07;">fontified."</span>
  (<span style="color: #0000FF;">when</span> (<span style="color: #0000FF;">and</span> (re-search-forward elisp-symbol-keybinding-re limit t)
             (fboundp (intern (match-string 1))))
    (<span style="color: #0000FF;">let*</span> ((beg (match-beginning 0))
           (end (match-end 0))
           (s (match-string 0))
           (command (match-string 1))
           (func `(<span style="color: #0000FF;">lambda</span> ()
                   (<span style="color: #0000FF;">interactive</span>)
                   (describe-function (intern ,command))))
           (map (make-sparse-keymap)))

      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this is what gets run when you click on it.</span>
      (define-key map [mouse-1] func)

      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Here we define the overlay</span>
      (add-text-properties
       beg end
       `(local-map ,map
         mouse-face highlight
         help-echo ,(format
                     <span style="color: #008000;">"%s"</span>
                     (substitute-command-keys s))
         keybinding t)))))
</pre>
</div>

<p>
Now we need a way to turn them on and off. We do that here with a minor mode.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">define-minor-mode</span> <span style="color: #006699;">emacs-keybinding-overlay-mode</span>
  <span style="color: #036A07;">"Create overlays on emacs keybinding syntax. The overlays show</span>
<span style="color: #036A07;">the keybinding for a command, and make the command clickable to</span>
<span style="color: #036A07;">get to the documentation."</span>
  <span style="color: #006FE0;">:lighter</span> <span style="color: #008000;">" KB"</span>
  (<span style="color: #0000FF;">if</span> emacs-keybinding-overlay-mode
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">turn them on</span>
      (font-lock-add-keywords
       nil
       '((match-next-keybinding 1 font-lock-constant-face)))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">turn them off</span>
    (font-lock-remove-keywords
     nil
     '((match-next-keybinding 1 font-lock-constant-face)))))
</pre>
</div>

<p>
You can use \\[org-toggle-latex-overlays] to toggle latex overlays.
</p>

<p>
You can use \\[org-ref-helm-insert-cite-link] to insert citations. \\[helm]
</p>

<p>
That more or less does it! I don't know if this is the canonical way to do this, but it works nicely here. You can also use overlays, but I found them a little confusing because they are not editable, and you have to toggle the minor mode to see them. Here we have unobtrusive tooltips. One downside is these won't export in any fashion in org-mode since it is not part of the syntax.
</p>
</div>


<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> font lock solution</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">elisp-symbol-keybinding-re</span> <span style="color: #008000;">"\\\\\\\\\\[</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;">]]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">]"</span>
  <span style="color: #036A07;">"Regexp for an elisp command keybinding syntax."</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">match-next-keybinding</span> (<span style="color: #6434A3;">&amp;optional</span> limit)
  (<span style="color: #0000FF;">when</span> (re-search-forward elisp-symbol-keybinding-re limit t)
    (put-text-property (match-beginning 0) (match-end 0)
                       'face 'font-lock-constant-face)
    (put-text-property (match-beginning 0) (match-end 0)
                       'lisp-symbol t)
    (put-text-property
     (match-beginning 0) (match-end 0)
     'help-echo (<span style="color: #0000FF;">lambda</span> (window object position)
                  <span style="color: #036A07;">"Tooltip of the keybinding"</span>
                  (<span style="color: #0000FF;">save-excursion</span>
                    (goto-char position)
                    (<span style="color: #0000FF;">let</span> ((s (get-surrounding-text-with-property 'lisp-symbol)))
                      (string-match elisp-symbol-keybinding-re s)
                      (substitute-command-keys (match-string 0 s))))))))

(font-lock-add-keywords nil
 '((match-next-keybinding 0 'font-lock-constant-face)))

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">elisp-symbol-syntax-re</span> <span style="color: #008000;">"`</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;">']*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">'"</span>
  <span style="color: #036A07;">"Regexp for an `</span><span style="color: #D0372D;">elisp</span><span style="color: #036A07;">' command syntax."</span>)

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">make clickable syntax</span>
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">match-next-symbol</span> (<span style="color: #6434A3;">&amp;optional</span> limit)
  (<span style="color: #0000FF;">when</span> (re-search-forward elisp-symbol-syntax-re limit t)
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">set face</span>
    (put-text-property (match-beginning 1) (match-end 1)
                       'face 'font-lock-constant-face)
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">add property</span>
    (put-text-property (match-beginning 0) (match-end 0)
                       'lisp-symbol (match-string 1))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">clickable text</span>
    (<span style="color: #0000FF;">let</span> ((map (make-sparse-keymap)))
      (define-key map [mouse-1]
        (<span style="color: #0000FF;">lambda</span> ()
          (<span style="color: #0000FF;">interactive</span>)
          (<span style="color: #0000FF;">let</span> ((s (get-surrounding-text-with-property 'lisp-symbol)))
            (string-match elisp-symbol-syntax-re s)
            (describe-function (intern (match-string 1 s))))))
      (put-text-property (match-beginning 0) (match-end 0)
                         'mouse-face 'highlight)
      (put-text-property (match-beginning 0) (match-end 0)
                         'local-map map))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">tooltip</span>
    (put-text-property
     (match-beginning 0) (match-end 0)
     'help-echo (<span style="color: #0000FF;">lambda</span> (window object position)
                  <span style="color: #036A07;">"Tooltip of the keybinding"</span>
                  (<span style="color: #0000FF;">save-excursion</span>
                    (goto-char position)
                    (<span style="color: #0000FF;">let</span> ((s (get-surrounding-text-with-property 'lisp-symbol)))
                      (string-match elisp-symbol-syntax-re s)
                      (<span style="color: #0000FF;">save-window-excursion</span>
                        (describe-function (intern (match-string 1 s))))))))))

(font-lock-add-keywords nil
 '((match-next-symbol 0 'font-lock-constant-face)))
</pre>
</div>



<p>
`put-text-property'
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> button-lock</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">elisp-symbol-keybinding-re</span> <span style="color: #008000;">"\\\\\\\\\\[</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;">]]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">]"</span>
  <span style="color: #036A07;">"Regexp for an elisp command keybinding syntax."</span>)

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">elisp-symbol-syntax-re</span> <span style="color: #008000;">"`</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;">']*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">'"</span>
  <span style="color: #036A07;">"Regexp for an elisp command syntax."</span>)

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">make clickable syntax</span>
(button-lock-set-button
 elisp-symbol-keybinding-re
 (<span style="color: #0000FF;">lambda</span> ()
   (<span style="color: #0000FF;">interactive</span>)
   (<span style="color: #0000FF;">let</span> ((s (get-surrounding-text-with-property 'lisp-symbol)))
     (string-match elisp-symbol-keybinding-re s)
     (message (substitute-command-keys (match-string 0 s)))))
 <span style="color: #006FE0;">:face</span> font-lock-constant-face
 <span style="color: #006FE0;">:help-echo</span> (<span style="color: #0000FF;">lambda</span> (window object position)
                (<span style="color: #0000FF;">save-excursion</span>
                  (goto-char position)
                  (<span style="color: #0000FF;">let</span> ((s (get-surrounding-text-with-property 'lisp-symbol)))
                    (string-match elisp-symbol-keybinding-re s)
                    (substitute-command-keys (match-string 0 s)))))
 <span style="color: #006FE0;">:keyboard-binding</span> (kbd <span style="color: #008000;">"RET"</span>)
 <span style="color: #006FE0;">:additional-property</span> 'lisp-symbol)


(button-lock-set-button
 elisp-symbol-syntax-re
 (<span style="color: #0000FF;">lambda</span> ()
   (<span style="color: #0000FF;">interactive</span>)
   (<span style="color: #0000FF;">let</span> ((s (get-surrounding-text-with-property 'lisp-symbol)))
     (string-match elisp-symbol-syntax-re s)
     (describe-function (intern (match-string 1 s)))))
 <span style="color: #006FE0;">:face</span> '((<span style="color: #006FE0;">:background</span> <span style="color: #008000;">"Lightsteelblue1"</span>))
 <span style="color: #006FE0;">:help-echo</span> <span style="color: #008000;">"click for help"</span>
 <span style="color: #006FE0;">:keyboard-binding</span> (kbd <span style="color: #008000;">"RET"</span>)
 <span style="color: #006FE0;">:additional-property</span> 'lisp-symbol)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">`\([^']*\)'</td>
<td class="left">(0 (quote (face ((:background Lightsteelblue1)) keymap (keymap (13 lambda nil (interactive) (let ((s (get-surrounding-text-with-property (quote lisp-symbol)))) (string-match elisp-symbol-syntax-re s) (describe-function (intern (match-string 1 s))))) (mouse-1 lambda nil (interactive) (let ((s (get-surrounding-text-with-property (quote lisp-symbol)))) (string-match elisp-symbol-syntax-re s) (describe-function (intern (match-string 1 s)))))) button-lock t lisp-symbol t mouse-face button-lock-mouse-face help-echo click for help rear-nonsticky t)) append)</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2015-11-07 Sat 19:03</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.0.50.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
