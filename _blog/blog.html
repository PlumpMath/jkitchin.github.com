<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>blog</title>
<!-- 2016-03-26 Sat 14:49 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="John Kitchin" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">blog</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. A molecule link for org-mode</a>
<ul>
<li><a href="#sec-1-1">1.1. Appendix of molecules</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> A molecule link for org-mode</h2>
<div class="outline-text-2" id="text-1">
<p>
Here I am exploring some ideas on compact and functional representations of molecules in org-mode. We will use some functionality from OpenBabel (<a href="https://openbabel.org/docs/dev/index.html">https://openbabel.org/docs/dev/index.html</a>) for conversion of formats.
</p>

<p>
One approach we could use is the <a href="https://en.wikipedia.org/wiki/Simplified_molecular-input_line-entry_system">SMILES</a> representation. OpenBabel provides tools to convert SMILES to a visualization like this. Let's check out an old favorite: caffeine.
</p>


<div class="org-src-container">

<pre class="src src-sh">obabel -:<span style="color: #008000;">"Cn1cnc2n(C)c(=O)n(C)c(=O)c12"</span> -osvg
</pre>
</div>


<div class="figure">
<p><img src="out.svg" alt="out.svg" />
</p>
</div>

<p>
We can imagine the SMILES string is a program, and use an org-mode src block to contain it.  We do have to define how to "execute" the block, and for that we will just have obabel generate the svg representation of the molecule. Here is our execute function. It simply generates the svg to stdout. We can use a :file header to capture it in a file.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-execute:smiles</span> (body params)
  (shell-command-to-string
   (format <span style="color: #008000;">"obabel -:\"%s\" -osvg 2&gt; /dev/null"</span> body)))
</pre>
</div>

<pre class="example">
org-babel-execute:smiles
</pre>

<p>
You can find a smiles block for  in <a href="#sec-1-1">Appendix of molecules</a> that was adapted from <a href="https://en.wikipedia.org/wiki/Simplified_molecular-input_line-entry_system#Examples_2">https://en.wikipedia.org/wiki/Simplified_molecular-input_line-entry_system#Examples_2</a>.
</p>

<p>
Now, we need a link to refer to our molecule. We want the follow action to jump to our src block which should have a name. We will have it export as the name of the block linked to the molecule definition. This should work fine for definitions in the document. It is not robust to link to molecules in other org-files in the export. That would require those files to be exported too.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">molecule-jump</span> (name)
  (org-mark-ring-push)
  (org-open-link-from-string (format <span style="color: #008000;">"[[%s]]"</span> path)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">molecule-export</span> (path desc backend)
  (<span style="color: #0000FF;">let</span> ((name (<span style="color: #0000FF;">save-window-excursion</span>
                (molecule-jump path)
                (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context)))))
    (<span style="color: #0000FF;">cond</span>
     ((eq 'html backend)
      (format <span style="color: #008000;">"&lt;a href=\"#%s\"&gt;%s&lt;/a&gt;"</span> name name)))))

(org-add-link-type
 <span style="color: #008000;">"molecule"</span>
 'molecule-jump
 'molecule-export)
</pre>
</div>

<p>
Now we can make a <a href="#LSD">LSD</a> that allows us to navigate to the definition. We can also refer to a molecule in another file like <a href="#LSD">LSD</a>. The links are clickable, and should jump to the molecule definition.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><a id="ID-1CD759B4-E276-4990-982C-E98CCE5B0517" name="ID-1CD759B4-E276-4990-982C-E98CCE5B0517"></a><span class="section-number-3">1.1</span> Appendix of molecules</h3>
<div class="outline-text-3" id="text-1-1">

<div class="org-src-container">

<pre class="src src-smiles" id="LSD">CCN(CC)C(=O)[C@H]1CN(C)[C@@H]2Cc3c[nH]c4cccc(C2=C1)c34
</pre>
</div>


<div class="figure">
<p><img src="lsd.svg" alt="lsd.svg" />
</p>
</div>

<p>
It would be nice to have a language mode to do special edits of SMILES src blocks. This mode does very little but provide a function that converts SMILES to CML using obabel and open it in a buffer. We redirect stderr to /dev/null to avoid seeing the messages from obabel.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">easymenu</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">smiles-cml</span> ()
  <span style="color: #036A07;">"Convert the smiles string in the buffer to CML."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let</span> ((smiles (buffer-string)))
    (switch-to-buffer (get-buffer-create <span style="color: #008000;">"SMILES-CML"</span>))
    (erase-buffer)
    (insert
     (shell-command-to-string
      (format <span style="color: #008000;">"obabel -:\"%s\" -ocml 2&gt; /dev/null"</span>
              smiles)))
    (goto-char (point-min))
    (xml-mode)))

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">smiles-mode-map</span>
  nil
  <span style="color: #036A07;">"Keymap for smiles-mode."</span>)

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">adapted from http://ergoemacs.org/emacs/elisp_menu_for_major_mode.html</span>
(<span style="color: #0000FF;">define-derived-mode</span> <span style="color: #006699;">smiles-mode</span> fundamental-mode <span style="color: #008000;">"smiles-mode"</span>
  <span style="color: #036A07;">"Major mode for SMILES code."</span>
  (<span style="color: #0000FF;">setq</span> buffer-invisibility-spec '(t)
        mode-name <span style="color: #008000;">" &#9786;"</span>)

  (<span style="color: #0000FF;">when</span> (not smiles-mode-map)
    (<span style="color: #0000FF;">setq</span> smiles-mode-map (make-sparse-keymap)))
  (define-key smiles-mode-map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'smiles-cml)

  (define-key smiles-mode-map [menu-bar] (make-sparse-keymap))

  (<span style="color: #0000FF;">let</span> ((menuMap (make-sparse-keymap <span style="color: #008000;">"SMILES"</span>)))
    (define-key smiles-mode-map [menu-bar smiles] (cons <span style="color: #008000;">"SMILES"</span> menuMap))

    (define-key menuMap [cml]
      '(<span style="color: #008000;">"CML"</span> . smiles-cml))))
</pre>
</div>

<pre class="example">
smiles-mode
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: John Kitchin</p>
<p class="date">Created: 2016-03-26 Sat 14:49</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.50.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
