<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.47 in css mode. -->
<html>
  <head>
    <title>emacs-highlighting.org</title>
    <style type="text/css">
    <!--
      body {
        color: #333333;
        background-color: #FFFFFF;
      }
      .ATTRLIST {
        /* (:background "LightBlue") */
        background-color: #add8e6;
      }
      .ATTRLIST-1 {
        /* (:background "Darkolivegreen1") */
        background-color: #caff70;
      }
      .ATTRLIST-10 {
      }
      .ATTRLIST-11 {
      }
      .ATTRLIST-12 {
      }
      .ATTRLIST-2 {
        /* (:background "Pink") */
        background-color: #ffc0cb;
      }
      .ATTRLIST-3 {
        /* (:background "PaleVioletRed1") */
        background-color: #ff82ab;
      }
      .ATTRLIST-4 {
        /* (:background "Orange1") */
        background-color: #ffa500;
      }
      .ATTRLIST-5 {
      }
      .ATTRLIST-6 {
      }
      .ATTRLIST-7 {
      }
      .ATTRLIST-8 {
      }
      .ATTRLIST-9 {
      }
      .comment {
        /* font-lock-comment-face */
        color: #8D8D84;
        font-style: italic;
      }
      .constant {
        /* font-lock-constant-face */
        color: #D0372D;
      }
      .flyspell-incorrect {
        /* flyspell-incorrect */
        text-decoration: underline;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #555555;
        background-color: #E2E1D5;
        text-decoration: underline;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #555555;
        background-color: #E2E1D5;
        text-decoration: overline;
      }
      .org-code {
        /* org-code */
        color: #006400;
        background-color: #FDFFF7;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #3C3C3C;
        background-color: #F0F0F0;
        font-size: 130%;
        font-weight: bold;
        text-decoration: overline;
      }
      .org-link {
        /* org-link */
        color: #006DAF;
        text-decoration: underline;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #008ED1;
        background-color: #EAEAFF;
      }
      .org-property-value {
        /* org-property-value */
        color: #00A000;
      }
      .org-special-keyword {
        /* org-special-keyword */
        color: #00BB00;
        background-color: #EAFFEA;
        font-weight: bold;
      }
      .show-paren-match {
        /* show-paren-match */
        background-color: #99CCFF;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-level-1">* Persistent highlighting in Emacs</span>
<span class="org-special-keyword">  :PROPERTIES:</span>...

In this <span class="org-link"><a href="http://kitchingroup.cheme.cmu.edu/blog/2016/11/08/New-color-link-in-org-9-0-using-font-lock-to-color-the-text/">recent post</a></span> I showed a way to use org-mode links to color text. The main advantage of that approach is it is explicit markup in the file, so it is persistent and exportable to html. The downside of that approach is you cannot use it in code, since the markup will break the code.

An alternative approach is to use overlays to color the text. This allows you to color the text, add annotations as tooltips and to provide a variety of highlighting colors. Overlays are not explicit markup in the file, so it is necessary to think of a way to save them so they can be restored later. We do this by using hook functions to store the overlays in a file-local variable on saving, and a file-local variable to restore the overlays when the file is opened. I bind the primary function `<span class="constant">ov-highlighter/body</span>' to a key, in my case hyper-h, which launches a hydra to access the commands.

You can find the code here: <span class="org-link"><a href="https://github.com/jkitchin/scimax/blob/org-9/ov-highlighter.el">https://github.com/jkitchin/scimax/blob/org-9/ov-highlighter.el</a></span>. Probably around mid-December it will get merged into the master branch.

1. <span class="ATTRLIST">blue</span> <span class="ATTRLIST-1">green</span> <span class="ATTRLIST-2">pink</span> yellow custom
2. Put a <span class="ATTRLIST-4">comment here</span>.
3. Markup a <span class="flyspell-incorrect"><span class="ATTRLIST-3">tpyo</span></span>.
4. Get a list of the highlights in the buffer.

These highlights are pretty awesome. They work in code blocks, and comments. They also work in non-org files (only in Emacs of course).

<span class="org-block-begin-line">#+BEGIN_SRC python :results output org drawer
</span><span class="ATTRLIST-12">a</span><span class="ATTRLIST-11"> = 5
</span><span class="ATTRLIST-12">b</span><span class="ATTRLIST-11"> = 6

</span><span class="ATTRLIST-10"><span class="ATTRLIST-4">print</span></span><span class="ATTRLIST-11"><span class="ATTRLIST-4">(a+b)</span></span><span class="ATTRLIST-9">#</span><span class="ATTRLIST-8">print the sum of a and b
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS:</span>
<span class="org-special-keyword">:RESULTS:</span>
11
<span class="org-special-keyword">:END:</span>

Overall, this is pretty handy. You can highlight your own notes, provide feedback to others, etc. without changing the actual text in the document (well, except for the local variables at the end of the buffer, but these are usually in a "comment" that does not affect the document).


Here are few limitations though:
1. You can only edit/change the file in Emacs, and the hook functions have to enabled, or the overlay data will get corrupted. That means a merge conflict can ruin the overlays.
2. Anyone you share the file with needs to have the ov-highlighter library loaded too. Otherwise they will not see the highlights, and any edits will make the overlay data incorrect. 
3. The highlights do not export from org-mode (although they do work with `<span class="constant">htmlize-buffer</span>'!).

<span class="org-block-begin-line">#+BEGIN_SRC emacs-lisp
</span><span class="ATTRLIST-7">(</span><span class="ATTRLIST-6">let*</span><span class="ATTRLIST-7"> ((html-buffer (htmlize-buffer))
       (html (</span><span class="ATTRLIST-6">with-current-buffer</span><span class="ATTRLIST-7"> html-buffer
               (buffer-string))))
  </span><span class="ATTRLIST-7"><span class="show-paren-match">(</span></span><span class="ATTRLIST-6">with-temp-file</span><span class="ATTRLIST-7"> </span><span class="ATTRLIST-5">"test.html"</span><span class="ATTRLIST-7">
    (insert html)</span><span class="ATTRLIST-7"><span class="show-paren-match">)</span></span><span class="ATTRLIST-7">
  (kill-buffer html-buffer))

(browse-url </span><span class="ATTRLIST-5">"test.html"</span><span class="ATTRLIST-7">)
</span><span class="org-block-end-line">#+END_SRC
</span>
<span class="org-meta-line">#+RESULTS:</span>
<span class="org-code">: #&lt;process open test.html&gt;
</span>

<span class="comment"># Local Variables&#58;</span>
<span class="comment"># ov-highlight-data: "((1325%201329%20\"PaleVioletRed1\"%20\"typo\")%20(1299%201311%20\"Orange1\"%20\"Add%20note%20to%20future%20self.\")%20(1260%201264%20\"LightBlue\"%20nil)%20(1265%201270%20\"Darkolivegreen1\"%20nil)%20(1271%201275%20\"Pink\"%20nil))"</span>
<span class="comment"># eval: (ov-highlight-load)</span>
<span class="comment"># End:</span>
</pre>
  </body>
</html>
