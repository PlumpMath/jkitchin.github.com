<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
     xmlns:content="http://purl.org/rss/1.0/modules/content/"
     xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
     xmlns:atom="http://www.w3.org/2005/Atom"
     xmlns:dc="http://purl.org/dc/elements/1.1/"
     xmlns:wfw="http://wellformedweb.org/CommentAPI/"
     >
  <channel>
    <title>The Kitchin Research Group</title>
    <link>http://jkitchin.github.io/blog</link>
    <description>Chemical Engineering at Carnegie Mellon University</description>
    <pubDate>Fri, 20 Nov 2015 19:33:39 GMT</pubDate>
    <generator>Blogofile</generator>
    <sy:updatePeriod>hourly</sy:updatePeriod>
    <sy:updateFrequency>1</sy:updateFrequency>
    <item>
      <title>Asynchronously running python blocks in org-mode</title>
      <link>http://jkitchin.github.io/blog/2015/11/20/Asynchronously-running-python-blocks-in-org-mode</link>
      <pubDate>Fri, 20 Nov 2015 11:46:45 EST</pubDate>
      <category><![CDATA[python]]></category>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">U7qjSMgTDurNF_8TXKWrVuj-0X4=</guid>
      <description>Asynchronously running python blocks in org-mode</description>
      <content:encoded><![CDATA[


<p>
If you run long Python blocks from org-mode, you might want to keep working while it runs. Currently Emacs gets blocked and you have to wait patiently.  In this post we consider some ways to avoid this that run our code asynchronously, but still put results where they belong in the org-buffer.
</p>

<p>
This is a long post. You may want to see the video: <a href="https://www.youtube.com/watch?v=VDyoN8yipSE">https://www.youtube.com/watch?v=VDyoN8yipSE</a> , or skip to the <a href="#sec-3">end</a> where the best and final version is shown.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> The async module</h2>
<div class="outline-text-2" id="text-1">
<p>
Here we consider an approach that uses <a href="https://github.com/jwiegley/emacs-async">https://github.com/jwiegley/emacs-async</a> module. The idea is to tangle the Python block at point to a temp file, then asynchronously run it. We capture the output and put it back in the buffer. We use a uuid to find the place to put the results in org-mode format. Here is the code that implements this idea.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">async</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-async-execute</span> ()
  <span style="color: #036A07;">"Run a python block at point asynchrously."</span>
  (<span style="color: #0000FF;">interactive</span>)

  (<span style="color: #0000FF;">let</span> ((current-file (buffer-file-name))
        (uuid (org-id-uuid))
        (temporary-file-directory <span style="color: #008000;">"./"</span>)
        (tempfile (make-temp-file <span style="color: #008000;">"py-"</span>)))

    (org-babel-tangle '(4) tempfile)
    (org-babel-remove-result)
    (<span style="color: #0000FF;">save-excursion</span>
      (re-search-forward <span style="color: #008000;">"#\\+END_SRC"</span>)
      (insert (format
               <span style="color: #008000;">"\n\n#+RESULTS: %s\n: %s"</span>
               (<span style="color: #0000FF;">or</span> (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context))
                   <span style="color: #008000;">""</span>)
               uuid)))

    (<span style="color: #0000FF;">async-start</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">what to start</span>
     `(<span style="color: #0000FF;">lambda</span> ()
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now we run the command then cleanup</span>
        (<span style="color: #0000FF;">prog1</span>
            (shell-command-to-string (format <span style="color: #008000;">"python %s"</span> ,tempfile))
          (delete-file ,tempfile)))

     `(<span style="color: #0000FF;">lambda</span> (result)
        <span style="color: #036A07;">"Code that runs when the async function finishes."</span>
        (<span style="color: #0000FF;">save-window-excursion</span>
          (<span style="color: #0000FF;">save-excursion</span>
            (<span style="color: #0000FF;">save-restriction</span>
              (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect ,current-file)
                (goto-char (point-min))
                (re-search-forward ,uuid)
                (beginning-of-line)
                (kill-line)
                (insert (mapconcat
                         (<span style="color: #0000FF;">lambda</span> (x)
                           (format <span style="color: #008000;">": %s"</span> x))
                         (butlast (s-split <span style="color: #008000;">"\n"</span> result))
                         <span style="color: #008000;">"\n"</span>))))))))))
</pre>
</div>

<pre class="example">
org-babel-async-execute
</pre>

<p>
Here is a block to test it on. We can run the block, and keep on working while the code runs. The results seem to get inserted correctly at the right point even if I am in another window or frame! We don't get easy access to continuous output of the command. This wouldn't work if we close Emacs, but who does that?
</p>


<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'hello world'</span>
<span style="color: #0000FF;">import</span> time
time.sleep(5)

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">print</span> os.getcwd()
<span style="color: #0000FF;">print</span> time.asctime()
</pre>
</div>

<pre class="example">
hello world
/Users/jkitchin/blogofile-jkitchin.github.com/_blog
Fri Nov 20 10:17:53 2015
</pre>

<p>
There are some limitations to this approach. One of them is it assumes the src block is a stand-alone block that will run on its own. That is usually how I run mine, but I could see having other modules that should be tangled out of a file too. I think the script is being run in the current working directory, so it probably will find any local imports it needs.
</p>

<p>
You don't get any intermediate feedback on this process. It seems to be possible to do that with a different approach that puts some output in a new buffer, e.g. with start-process. But, you still need some clever code like the async model to know when to insert the results back into this buffer. We consider Emacs processes and sentinels next.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Emacs process approach with tangling</h2>
<div class="outline-text-2" id="text-2">
<p>
We can start a process in Emacs, and attach a sentinel function to it that runs after the process completes. Here is an example of that. We still tangle the src-block here.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-async-execute</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let*</span> ((current-file (buffer-file-name))
        (uuid (org-id-uuid))
        (temporary-file-directory <span style="color: #008000;">"./"</span>)
        (tempfile (make-temp-file <span style="color: #008000;">"py-"</span>))
        (pbuffer (format <span style="color: #008000;">"*%s*"</span> uuid))
        process)

    (org-babel-tangle '(4) tempfile)
    (org-babel-remove-result)

    (<span style="color: #0000FF;">save-excursion</span>
      (re-search-forward <span style="color: #008000;">"#\\+END_SRC"</span>)
      (insert (format
               <span style="color: #008000;">"\n\n#+RESULTS: %s\n: %s"</span>
               (<span style="color: #0000FF;">or</span> (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context))
                   <span style="color: #008000;">""</span>)
               uuid)))

    (<span style="color: #0000FF;">setq</span> process (start-process
                   uuid
                   pbuffer
                   <span style="color: #008000;">"python"</span>
                   tempfile))

    (set-process-sentinel
     process
     `(<span style="color: #0000FF;">lambda</span> (process event)
        (<span style="color: #0000FF;">when</span> (string= <span style="color: #008000;">"finished\n"</span> event)
          (delete-file ,tempfile)
          (<span style="color: #0000FF;">save-window-excursion</span>
            (<span style="color: #0000FF;">save-excursion</span>
              (<span style="color: #0000FF;">save-restriction</span>
                (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect ,current-file)
                  (goto-char (point-min))
                  (re-search-forward ,uuid)
                  (beginning-of-line)
                  (kill-line)
                  (insert (mapconcat
                           (<span style="color: #0000FF;">lambda</span> (x)
                             (format <span style="color: #008000;">": %s"</span> x))
                           (split-string
                            (<span style="color: #0000FF;">with-current-buffer</span> ,pbuffer (buffer-string))
                            <span style="color: #008000;">"\n"</span>)
                           <span style="color: #008000;">"\n"</span>)))))))
        (kill-buffer ,pbuffer)))))
</pre>
</div>

<pre class="example">
org-babel-async-execute
</pre>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'hello world'</span>
<span style="color: #0000FF;">import</span> time
time.sleep(10)

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">print</span> os.getcwd()
<span style="color: #0000FF;">print</span> time.asctime()
</pre>
</div>

<pre class="example">
hello world
/Users/jkitchin/blogofile-jkitchin.github.com/_blog
Fri Nov 20 10:20:01 2015
</pre>

<p>
That works well from what I can see. There are some limitations. I doubt this will work if you use variables in the src block header. Next we consider an approach that does not do the tangling, and that will show us code output as it goes.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><a id="ID-D8F2CBB5-31B2-4477-A363-E3C0063214DE" name="ID-D8F2CBB5-31B2-4477-A363-E3C0063214DE"></a><span class="section-number-2">3</span> Emacs process approach with no tangling</h2>
<div class="outline-text-2" id="text-3">
<p>
As an alternative to tangling to a file, here we just copy the code to a file and then run it.
</p>

<p>
UPDATE: I eliminated the send string approach because it caused some problems with blank lines in loops and such. This new approach eliminates that issue.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-async-execute</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let*</span> ((current-file (buffer-file-name))
         (uuid (org-id-uuid))
         (code (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context)))
         (temporary-file-directory <span style="color: #008000;">"."</span>)
         (tempfile (make-temp-file <span style="color: #008000;">"py-"</span>))
         (pbuffer (format <span style="color: #008000;">"*%s*"</span> uuid))
         process)

    (org-babel-remove-result)

    (<span style="color: #0000FF;">save-excursion</span>
      (re-search-forward <span style="color: #008000;">"#\\+END_SRC"</span>)
      (insert (format
               <span style="color: #008000;">"\n\n#+RESULTS: %s\n: %s"</span>
               (<span style="color: #0000FF;">or</span> (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context))
                   <span style="color: #008000;">""</span>)
               uuid)))
    (switch-to-buffer-other-window pbuffer)

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Create temp file</span>
    (<span style="color: #0000FF;">with-temp-file</span> tempfile
      (insert code))

    (<span style="color: #0000FF;">setq</span> process (start-process
                   uuid
                   pbuffer
                   <span style="color: #008000;">"python"</span>
                   tempfile))

    (set-process-sentinel
     process
     `(<span style="color: #0000FF;">lambda</span> (process event)
        (<span style="color: #0000FF;">save-window-excursion</span>
            (<span style="color: #0000FF;">save-excursion</span>
              (<span style="color: #0000FF;">save-restriction</span>
                (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect ,current-file)
                  (goto-char (point-min))
                  (re-search-forward ,uuid)
                  (beginning-of-line)
                  (kill-line)
                  (insert
                   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">This clunky code mostly cleans up the output so it looks</span>
                   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">more like org-mode output</span>
                   (mapconcat
                    (<span style="color: #0000FF;">lambda</span> (x)
                      (format <span style="color: #008000;">": %s"</span> x))
                    (split-string
                     (replace-regexp-in-string
                      <span style="color: #008000;">"</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">&gt;&gt;&gt; </span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">\\.\\.\\. </span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">: $</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">: &gt;&gt;&gt;$</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>
                      <span style="color: #008000;">""</span>
                      (mapconcat 'identity
                                 (butlast (split-string
                                           (<span style="color: #0000FF;">with-current-buffer</span>
                                               ,pbuffer
                                             (buffer-string))
                                           <span style="color: #008000;">"\n"</span>))
                                 <span style="color: #008000;">"\n"</span>))
                     <span style="color: #008000;">"\n"</span>)
                    <span style="color: #008000;">"\n"</span>))))))
        (<span style="color: #0000FF;">when</span> (get-buffer ,pbuffer)
          (kill-buffer ,pbuffer)
          (delete-window))
        (delete-file ,tempfile)
        (delete-process process)))))
</pre>
</div>

<pre class="example">
org-babel-async-execute
</pre>



<p>
Let us try it out again.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'hello world'</span>
<span style="color: #0000FF;">import</span> time
time.sleep(1)

<span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span>(5):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">print</span> i

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   time.sleep(0.5)



<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">print</span> os.getcwd()
<span style="color: #0000FF;">print</span> time.asctime()
</pre>
</div>

<pre class="example">
hello world
0
1
2
3
4
/Users/jkitchin/blogofile-jkitchin.github.com/_blog
Fri Nov 20 14:32:23 2015
</pre>


<p>
It works fine for this simple example. Again, this example doesn't do anything particularly sophisticated with src-block headers or imports, etc&#x2026; We also get to see the output as the code executes, which is a pleasant change from the usual way of running python blocks.
</p>

<p>
Maybe some org-moder's out there can try this and run it through some more rigorous paces?
</p>
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/20/Asynchronously-running-python-blocks-in-org-mode.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Functional and display math in technical documents</title>
      <link>http://jkitchin.github.io/blog/2015/11/19/Functional-and-display-math-in-technical-documents</link>
      <pubDate>Thu, 19 Nov 2015 06:07:15 EST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">MkWw-2cBqasTAJPpgjAhqbU49Zk=</guid>
      <description>Functional and display math in technical documents</description>
      <content:encoded><![CDATA[


<p>
I have been thinking about a way to have functional and readable mathematics in technical documents. It has always bothered me that I have to write a LaTeX version of an equation, and then a separate implementation of the equation in code somewhere. At least twice in my life these separate representations have not agreed!
</p>

<p>
One solution might be if my functional code could be converted to LaTeX easily. I explore one simple approach to this here. It is somewhat inspired by this work here <a href="http://oremacs.com/2015/01/23/eltex/">http://oremacs.com/2015/01/23/eltex/</a> on writing LaTeX in emacs-lisp, and from my work with org-mode in mixing narrative text, LaTeX and code.
</p>

<p>
The idea is to use emacs-lisp for the code, so it is functional, but provide an alternative output for the <i>same code</i> for a document conversion. In other words, we accept there is more than one version we need: a functional version for working, and a consumption version for presentation. We will generate the consumption version from the functional version.
</p>

<p>
I know emacs-lisp is not ideal for mathematics the way we are accustomed to seeing it, but it enables the idea I want to explore here so we will try it.
</p>

<p>
Here is the simplest example I could come up with for functional math. We can run it ourselves, and verify it is correct.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(+ 1 2 3)
</pre>
</div>

<pre class="example">
6
</pre>

<p>
Now, I can change the meaning of this code temporarily, so that it not only evaluates the form, but also represents the equation and result in LaTeX code. If this was incorporated into a preprocessor of the document, we could have a functional version representing our equations, in code form, and a presentation version generated from this version. The code that follows isn't how I would do this is in some production setting; it is only to show that you can <i>temporarily</i> change the meaning of "+". In a production setting, there would just be (+ 1 2 3) in the text, and a preprocessor would find all the sexps in the text, and replace them with the export format using code like this. At least, that is what I am imagining. It might be feasible to do this already with inline org-babel calls and an org-mode export filter, but I didn't try it here. So, here is the proof of concept code.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">cl-flet</span> ((+ (<span style="color: #0000FF;">lambda</span> (<span style="color: #6434A3;">&amp;rest</span> args)
               (format
                <span style="color: #008000;">"$%s = %s$"</span>
                (mapconcat #'number-to-string args <span style="color: #008000;">" + "</span>)
                (eval `(+ ,@args))))))
  (+ 1 2 3))
</pre>
</div>

<p>
\(1 + 2 + 3 = 6\)
</p>



<p>
Here is an example that generates a fraction from a division.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">cl-flet</span> ((/ (<span style="color: #0000FF;">lambda</span> (<span style="color: #6434A3;">&amp;rest</span> args)
               (format
                <span style="color: #008000;">"$\\frac{%s}{%s} = %s$"</span>
                (car args)
                (mapconcat 'number-to-string (cdr args) <span style="color: #008000;">" \\cdot "</span>)
                (eval `(/ ,@args))))))
  (/ 1.0 2.0 3.0))
</pre>
</div>

<p>
\(\frac{1.0}{2.0 \cdot 3.0} = 0.16666666666666666\)
</p>

<p>
As a proof of concept, this idea looks feasible, but this implementation has some limitations. Getting this to a complete workable approach would require a lot of work, basically creating transformation functions for many, many kinds of mathematical functions, and a lot of other kinds of logic. For example, (+ 1 2 (+ 3 4)) would not render correctly with the codes above. It isn't even clear what it should render to. I think you want 1 + 2 + (3 + 4) as the rendered output.
</p>

<p>
Anyway, it is an interesting idea, one that blurs the lines between code and mathematics. We are so used to the equation representation of mathematics, rather than the code representation that being able to go back and forth seems like a good idea, especially when one is derived from the other.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/19/Functional-and-display-math-in-technical-documents.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>New publication in Surface Science</title>
      <link>http://jkitchin.github.io/blog/2015/11/17/New-publication-in-Surface-Science</link>
      <pubDate>Tue, 17 Nov 2015 20:44:50 EST</pubDate>
      <category><![CDATA[p]]></category>
      <guid isPermaLink="false">SP4tErsvIPp1JOpY6mm0XXvJoJk=</guid>
      <description>New publication in Surface Science</description>
      <content:encoded><![CDATA[


<p>
Some time ago we published this paper on the coverage dependence of the adsorption energies of atomic adsorbates on different sites <a class='org-ref-reference' href="#xu-2014-probin-cover">xu-2014-probin-cover</a>. One of the concerns in that work was whether van der Waal forces were significant for some adsorbates. Well, now we have addressed that concern in a new paper in Surface Science! In this new work we use the BEEF functional to simultaneously access the impact of van der Waal forces on the adsorption energy trends, as well as do some error analysis on the significance of the coverage dependence. I won't ruin the surprise too much; the good news is that yes van der Waals do influence adsorption of atomic adsorbates on metal surfaces, but the trends are mostly the same! See the paper for more details. Congratulations Hari!
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #006699;">@article</span>{<span style="color: #D0372D;">thirumalai-2015-pt-pd</span>,
  <span style="color: #BA36A5;">author</span> =       "Hari Thirumalai and John R. Kitchin",
  <span style="color: #BA36A5;">title</span> =        {The Role of Vdw Interactions in Coverage Dependent Adsorption
                  Energies of Atomic Adsorbates on Pt(111) and Pd(111)},
  <span style="color: #BA36A5;">journal</span> =      "Surface Science ",
  <span style="color: #BA36A5;">pages</span> =        " - ",
  <span style="color: #BA36A5;">year</span> =         2015,
  <span style="color: #BA36A5;">doi</span> =          {<span style="color: #006DAF; text-decoration: underline;">10.1016/j.susc.2015.10.001</span>},
  <span style="color: #BA36A5;">url</span> =
                  "http://www.sciencedirect.com/science/article/pii/S0039602815003052",
  <span style="color: #BA36A5;">issn</span> =         "0039-6028",
}
</pre>
</div>

<p>
See it here: <a href="http://www.sciencedirect.com/science/article/pii/S0039602815003052">http://www.sciencedirect.com/science/article/pii/S0039602815003052</a> 
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/17/New-publication-in-Surface-Science.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>New Publication in International Journal of Greenhouse Gas Control</title>
      <link>http://jkitchin.github.io/blog/2015/11/17/New-Publication-in-International-Journal-of-Greenhouse-Gas-Control</link>
      <pubDate>Tue, 17 Nov 2015 20:24:28 EST</pubDate>
      <category><![CDATA[news]]></category>
      <category><![CDATA[publication]]></category>
      <guid isPermaLink="false">lW0TczS1xF_8PVScY4vn-3EYs30=</guid>
      <description>New Publication in International Journal of Greenhouse Gas Control</description>
      <content:encoded><![CDATA[


<p>
We have published a new paper on CO<sub>2</sub> capture in aqueous amino acid solvents! In this collaborative effort with the <a href="http://annalab.org">Anna Research group</a> and NETL, we show that potassium lysinate solvents show potential for CO<sub>2</sub> capture applications using a microfluidic characterization device and a continuously stirred tank reactor. We also examined the aqueous potassium salts of glycine, taurine and proline. Raman spectroscopy was used to characterize the speciation of CO<sub>2</sub> in the solvent. Congratulations Alex!
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #006699;">@article</span>{<span style="color: #D0372D;">hallenbeck-2015-compar-co2</span>,
  <span style="color: #BA36A5;">author</span> =       "Alexander P. Hallenbeck and Adefemi Egbebi and Kevin P. Resnik
                  and David Hopkinson and Shelley L. Anna and John R. Kitchin",
  <span style="color: #BA36A5;">title</span> =        {Comparative Microfluidic Screening of Amino Acid Salt
                  Solutions for Post-Combustion \ce{CO2} Capture},
  <span style="color: #BA36A5;">journal</span> =      "International Journal of Greenhouse Gas Control ",
  <span style="color: #BA36A5;">volume</span> =       43,
  <span style="color: #BA36A5;">pages</span> =        "189 - 197",
  <span style="color: #BA36A5;">year</span> =         2015,
  <span style="color: #BA36A5;">doi</span> =          {<span style="color: #006DAF; text-decoration: underline;">10.1016/j.ijggc.2015.10.026</span>},
  <span style="color: #BA36A5;">url</span> =
                  "http://www.sciencedirect.com/science/article/pii/S1750583615301134",
  <span style="color: #BA36A5;">issn</span> =         "1750-5836",
}
</pre>
</div>

<p>
See it here: <a href="http://www.sciencedirect.com/science/article/pii/S1750583615301134">http://www.sciencedirect.com/science/article/pii/S1750583615301134</a> 
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/17/New-Publication-in-International-Journal-of-Greenhouse-Gas-Control.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Clickable telephone numbers in mu4e messages</title>
      <link>http://jkitchin.github.io/blog/2015/11/04/Clickable-telephone-numbers-in-mu4e-messages</link>
      <pubDate>Wed, 04 Nov 2015 12:45:12 EST</pubDate>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">VK9llFbANs9fEub2uECz9FLc1EA=</guid>
      <description>Clickable telephone numbers in mu4e messages</description>
      <content:encoded><![CDATA[


<p>
We recently updated our university phone system to a VoIP system that uses Cisco Jabber. I am excited about that because finally I can make phone calls from Emacs with a little applescript automation! So, spoiler alert, this post mostly only applies to Macs, unless you know how to automate a Jabber client to make calls. How to make the telephone numbers clickable is general though, and could be used to do other things as well.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">cisco-call</span> (phone-number)
  (<span style="color: #0000FF;">interactive</span> <span style="color: #008000;">"sPhone number: "</span>)
  (do-applescript
   (format <span style="color: #008000;">"tell application \"Cisco Jabber\"</span>
<span style="color: #008000;">        activate</span>
<span style="color: #008000;">        tell application \"System Events\" to keystroke \"n\" using {shift down, command down}</span>
<span style="color: #008000;">        tell application \"System Events\" to keystroke \"%s\"</span>
<span style="color: #008000;">        tell application \"System Events\" to key code 36 #return</span>
<span style="color: #008000;">end tell"</span> phone-number)))
</pre>
</div>

<pre class="example">
cisco-call
</pre>

<p>
I would like to go a step further, and make clickable phone numbers in my Emacs buffers. Let's take a look at some options.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> org-mode phone link</h2>
<div class="outline-text-2" id="text-1">
<p>
This is a no-brainer approach. We can define an org-mode link that runs the cisco-call function.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-add-link-type
 <span style="color: #008000;">"phone"</span>
 (<span style="color: #0000FF;">lambda</span> (phone-number)
   (cisco-call phone-number)))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">lambda</td>
<td class="left">(phone-number)</td>
<td class="left">(cisco-call phone-number)</td>
</tr>
</tbody>
</table>

<p>
This makes simple link that just calls the number in the path of the link.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Clickable text with button-lock</h2>
<div class="outline-text-2" id="text-2">
<p>
I have used the button-lock package very often to make clickable text. Here we use it to highlight phone numbers matching a regular expression that seems to match most US numbers. This seems to work great in org-mode buffers.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">rx</span>)

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">highlight-phone-numbers</span> nil
 <span style="color: #036A07;">"Button for `</span><span style="color: #D0372D;">highlight-phone-numbers</span><span style="color: #036A07;">'"</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">highlight-phone-numbers</span> ()
  <span style="color: #036A07;">"Make phone numbers of the following types clickable:</span>
<span style="color: #036A07;">  (xxx) xxx-xxxx</span>
<span style="color: #036A07;">  xxx.xxx.xxx</span>
<span style="color: #036A07;">  xxxxxxxxxx</span>
<span style="color: #036A07;">  xxx-xxx-xxxx"</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let</span> ((inhibit-read-only t))
    (<span style="color: #0000FF;">setq</span> highlight-phone-numbers
          (button-lock-set-button
           (<span style="color: #0000FF;">rx</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">optional () around area code</span>
            (optional <span style="color: #008000;">"("</span>)
            (= 3 digit)
            (optional <span style="color: #008000;">")"</span>)
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">delimiters</span>
            (<span style="color: #0000FF;">or</span> (optional <span style="color: #008000;">"-"</span>)
                (optional <span style="color: #008000;">"."</span>)
                (optional <span style="color: #008000;">" "</span>))
            (= 3 digit)
            (<span style="color: #0000FF;">or</span> (optional <span style="color: #008000;">"-"</span>)
                (optional <span style="color: #008000;">"."</span>)
                (optional <span style="color: #008000;">" "</span>))
            (= 4 digit))
           (<span style="color: #0000FF;">lambda</span> ()
             (<span style="color: #0000FF;">interactive</span>)
             (cisco-call (get-surrounding-text-with-property 'phone-number)))
           <span style="color: #006FE0;">:face</span> '((<span style="color: #006FE0;">:background</span> <span style="color: #008000;">"Darkolivegreen2"</span>)
                   (<span style="color: #006FE0;">:underline</span> t))
           <span style="color: #006FE0;">:help-echo</span> <span style="color: #008000;">"click to call"</span>
           <span style="color: #006FE0;">:keyboard-binding</span> (kbd <span style="color: #008000;">"RET"</span>)
           <span style="color: #006FE0;">:additional-property</span> 'phone-number))))

(add-hook 'text-mode 'highlight-phone-numbers)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">highlight-phone-numbers</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Phone numbers in mu4e messages</h2>
<div class="outline-text-2" id="text-3">
<p>
For some reason, the button-lock package doesn't seem to work in mu4e message buffers, Maybe it is because . The highlight-regexp package does work though, so for these special buffers we use a new approach. We will just put text properties where we want them, and use those properties to make the text clickable.
</p>

<p>
The messages are in read-only buffers, but we can inhibit that so we can modify the properties. All we need to do is create a little key map as a copy of the existing map, define some keys on it, then search through the buffer adding properties to every phone number we find. I wrote a function that does that, and put that function in a hook to run each time I open a message. Whammo, now I have clickable phone numbers in email! It works pretty well for me.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defface</span> <span style="color: #BA36A5;">mu4e-phone-face</span>
  '((t (<span style="color: #006FE0;">:foreground</span> <span style="color: #008000;">"SteelBlue4"</span> <span style="color: #006FE0;">:background</span> <span style="color: #008000;">"Darkolivegreen2"</span> <span style="color: #006FE0;">:underline</span> t)))
  <span style="color: #036A07;">"Phone number directive face."</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">mu4e-highlight-phone-numbers</span> ()
  <span style="color: #036A07;">"Make phone numbers clickable in mu4e-view buffers."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let</span> ((phone-regex (<span style="color: #0000FF;">rx</span>
                      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">optional () around area code</span>
                      (optional <span style="color: #008000;">"("</span>)
                      (= 3 digit)
                      (optional <span style="color: #008000;">")"</span>)
                      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">delimiters</span>
                      (<span style="color: #0000FF;">or</span> (optional <span style="color: #008000;">"-"</span>)
                          (optional <span style="color: #008000;">"."</span>)
                          (optional <span style="color: #008000;">" "</span>))
                      (= 3 digit)
                      (<span style="color: #0000FF;">or</span> (optional <span style="color: #008000;">"-"</span>)
                          (optional <span style="color: #008000;">"."</span>)
                          (optional <span style="color: #008000;">" "</span>))
                      (= 4 digit))))
    (<span style="color: #0000FF;">save-excursion</span>
      (<span style="color: #0000FF;">let</span> ((inhibit-read-only t))
        (goto-char (point-min))
        (<span style="color: #0000FF;">while</span> (re-search-forward phone-regex nil t)
          (<span style="color: #0000FF;">let</span> ((map (copy-keymap mu4e-view-mode-map))
                (start (match-beginning 0))
                (end (match-end 0)))

            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">set file to be clickable to open the source</span>
            (define-key map [mouse-1]
              `(<span style="color: #0000FF;">lambda</span> ()
                 (<span style="color: #0000FF;">interactive</span>)
                 (cisco-call ,(match-string 0))))

            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">let letter c also make the call</span>
            (define-key map <span style="color: #008000;">"c"</span>
               `(<span style="color: #0000FF;">lambda</span> ()
                 (<span style="color: #0000FF;">interactive</span>)
                 (cisco-call ,(match-string 0))))

            (set-text-properties
             start end
             `(local-map, map
                          face mu4e-phone-face
                          mouse-face highlight
                          help-echo <span style="color: #008000;">"mouse-1: click to call"</span>))))))))

(add-hook 'mu4e-view-mode-hook 'mu4e-highlight-phone-numbers)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Summary</h2>
<div class="outline-text-2" id="text-4">
<p>
That works pretty well for me overall. The phone number regex is not perfect, e.g. it makes any 10 digit number clickable, and it doesn't recognize international numbers. I am not sure I can call those through the Jabber client anyway. This is purely convenience for me to easily make calls from emails, or other kinds of documents I might read in Emacs.
</p>

<p>
I don't use phone calls very often, but an interesting thing might be to open a phone log in org-mode, or open the contact that has that phone number to log that you called them, and provide some notes for them. Alternatively, open a new capture for a phone log that could be refiled later.
</p>
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/04/Clickable-telephone-numbers-in-mu4e-messages.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>YAT - yet another template strategy</title>
      <link>http://jkitchin.github.io/blog/2015/11/01/YAT-yet-another-template-strategy</link>
      <pubDate>Sun, 01 Nov 2015 14:12:34 EST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">HRokYj2LxynQjLOkdS0vG9PPbyI=</guid>
      <description>YAT - yet another template strategy</description>
      <content:encoded><![CDATA[



<p>
I have another need for a template that is dynamically evaluated. I previously wrote about this <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/01/26/Another-alternative-to-string-templates/">here</a> , and today I am going to do a variation of the theme. We will still use a syntax of $(expression), but a new approach to evaluating the expression. I saw this interesting function to evaluate and replace an s-expression in a buffer <a href="http://emacsredux.com/blog/2013/06/21/eval-and-replace/">Eval and Replace - Emacs Redux</a> . I am going use that to replace a template expression in a string, with a little variation to avoid replacing non-sexp variations, e.g. $(. Here we go.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">eval-and-replace</span> ()
  <span style="color: #036A07;">"Replace the preceding sexp with its value."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (backward-kill-sexp)
  (<span style="color: #0000FF;">condition-case</span> nil
      (princ (eval (read (current-kill 0)))
             (current-buffer))
    (<span style="color: #ff0000; font-weight: bold;">error</span> (message <span style="color: #008000;">"Invalid expression"</span>)
           (insert (concat <span style="color: #008000;">"$"</span> (current-kill 0))))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">j-format</span> (s)
  <span style="color: #036A07;">"Replace all instances of $(expression) in S with the evaluated</span>
<span style="color: #036A07;">expression."</span>
  (<span style="color: #0000FF;">with-temp-buffer</span>
    (insert s)
    (goto-char (point-min))
    (<span style="color: #0000FF;">while</span> (re-search-forward <span style="color: #008000;">"$("</span> nil t)
      (backward-char)
      (<span style="color: #0000FF;">when</span> (sexp-at-point)
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">get rid of the $</span>
        (delete-char -1)
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">go to the end of the sexp and then eval-and-replace it.</span>
        (end-of-sexp)
        (eval-and-replace)))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">return the formatted text.</span>
    (buffer-string)))


(<span style="color: #0000FF;">let</span> ((some-var <span style="color: #008000;">"You got me"</span>))
  (j-format <span style="color: #008000;">"Test of 4 + 5 = $(+ 4 5). $(  $(foobar). $(progn (setq x 5) \"\")</span>
<span style="color: #008000;">and then we have 2x=$(prin1 (* 2 x)).</span>

<span style="color: #008000;">some-var = $(print some-var)"</span>))
</pre>
</div>

<pre class="example">
Test of 4 + 5 = 9. $(  $(foobar).
and then we have 2x=10.

some-var = You got me
</pre>

<p>
That seems pretty ok. I obviously have not tested it extensively, but it looks pretty promising.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/01/YAT---yet-another-template-strategy.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Saving the current restriction and restoring it while following links</title>
      <link>http://jkitchin.github.io/blog/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links</link>
      <pubDate>Sat, 24 Oct 2015 13:41:45 EDT</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">YT9lKIGC8EOMKRbm2EP4wgSTpz0=</guid>
      <description>Saving the current restriction and restoring it while following links</description>
      <content:encoded><![CDATA[



<p>
On the org-mode mailing list there has been some discussion about following id links. The issue is that if your buffer is narrowed, clicking on the link does not change the restriction to actually take you to the entry. This is debatably desirable. If I click on a link, I want it to go where it points. But, I might also like to go back to my narrowed view. So here consider how to save the state of narrowing, and restore it. We modify the function that opens an id link to save the restriction, and widen the buffer if necessary.
</p>

<p>
Saving the restriction seems easy, we just save a marker to point, and the point-min and point-max. We save the marker for a convenient way to get the buffer, and perhaps the actual point. We advise the C-c &amp; function to restore the restriction after we leave it. This should fix the restriction in whatever buffer we undid it in.
</p>

<p>
Here is the code that seems to work for me. Thanks to Rasmus for the idea on saving the restriction data.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">*saved-restriction*</span> nil
 <span style="color: #036A07;">"A global var containing the current restriction.</span>
<span style="color: #036A07;">Returns (current-buffer point-min point-max"</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">save-current-restriction</span> ()
  <span style="color: #036A07;">"Save the current restriction at point."</span>
  (<span style="color: #0000FF;">setq</span> *saved-restriction*
        (<span style="color: #0000FF;">if</span> (buffer-narrowed-p)
            (list (current-buffer) (point-min) (point-max))
          nil)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">restore-saved-restriction</span> ()
  <span style="color: #036A07;">"Restore the last saved restriction."</span>
  (<span style="color: #0000FF;">when</span> *saved-restriction*
    (set-buffer (car *saved-restriction*))
    (narrow-to-region (nth 1 *saved-restriction*)
                      (nth 2 *saved-restriction*)))
  (<span style="color: #0000FF;">setq</span> *saved-restriction* nil))

<span style="color: #8D8D84;">;</span><span style="color: #8D8D84; font-style: italic;">' actually modify this function to save the restriction, and widen if needed.</span>
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-id-open</span> (id)
  <span style="color: #036A07;">"Go to the entry with id ID."</span>
  (org-mark-ring-push)
  (<span style="color: #0000FF;">let</span> ((m (org-id-find id 'marker))
        cmd)
    (<span style="color: #0000FF;">unless</span> m
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"Cannot find entry with ID \"%s\""</span> id))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Use a buffer-switching command in analogy to finding files</span>
    (<span style="color: #0000FF;">setq</span> cmd
          (<span style="color: #0000FF;">or</span>
           (cdr
            (assq
             (cdr (assq 'file org-link-frame-setup))
             '((find-file . switch-to-buffer)
               (find-file-other-window . switch-to-buffer-other-window)
               (find-file-other-frame . switch-to-buffer-other-frame))))
           'switch-to-buffer-other-window))
    (<span style="color: #0000FF;">if</span> (not (equal (current-buffer) (marker-buffer m)))
        (funcall cmd (marker-buffer m)))
    (save-current-restriction)
    (<span style="color: #0000FF;">when</span> (&gt; m (point-max))
      (widen))
    (goto-char m)
    (move-marker m nil)
    (org-show-context)))


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">And we advise the function going back to restore the restriction.</span>
(<span style="color: #0000FF;">defadvice</span> <span style="color: #006699;">org-mark-ring-goto</span> (after restore-my-restriction () activate)
  <span style="color: #036A07;">"Restore narrowing."</span>
  (restore-saved-restriction))
</pre>
</div>

<pre class="example">
org-mark-ring-goto
</pre>

<p>
This seems to preserve restrictions in the current buffer and in other buffers, as long as I use C-c &amp; to invoke org-mark-ring goto. I am not sure how easy it would be to make this work for all links. Each link has its own function for following so I am not sure we can easily get them all to do this unless there is some high level function to advise like org-mouse-down-mouse or something similar. It also has the limitation that the restoration only occurs using org-mark-ring-goto, unless you specifically run the  (restore-saved-restriction) function yourself. That could be made an interactive function for that purpose. Otherwise, this seems like a reasonable approach.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Line numbers in org-mode code blocks</title>
      <link>http://jkitchin.github.io/blog/2015/10/13/Line-numbers-in-org-mode-code-blocks</link>
      <pubDate>Tue, 13 Oct 2015 08:58:34 EDT</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[emacs]]></category>
      <guid isPermaLink="false">uiVEeY3zbYDjvvhyKVdNcK5To3s=</guid>
      <description>Line numbers in org-mode code blocks</description>
      <content:encoded><![CDATA[



<p>
Some of my students have wanted to show line numbers in code blocks. This is especially useful for when you run a Python block, and you get an error message with a line number in it. Right now, to figure out which line that is, you have to into the code block, type C-c ' to get into edit mode, and turn line numbers on. We look into how to achieve that here.
</p>

<p>
You may want to see the video here: <a href="https://www.youtube.com/watch?v=kinWijGzXms">https://www.youtube.com/watch?v=kinWijGzXms</a> .
</p>

<p>
First, we need to get the region that is the code block. We can find some info in the org-element, but, the :begin and :end include lines we don't want, like the header lines, and the results. But, we can get the beginning, and maybe from there search forward to the block. Run this code block to see where the point goes.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="boring-example"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">a boring comment</span>

(<span style="color: #0000FF;">progn</span>
  (+ 40 2))

(goto-char (org-element-property <span style="color: #006FE0;">:begin</span> (org-element-context)))
(re-search-forward (regexp-quote (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context))))
(goto-char (match-beginning 0))
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">number of lines in block. The last carriage return doesn't count.</span>
(1- (length (s-split <span style="color: #008000;">"\n"</span> (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context)))))
</pre>
</div>

<pre class="example">
9
</pre>

<p>
So, we can get the number of lines, and move the point to the first line. For numbers, we will use overlays. Here is a simple way to put a number at the beginning of a line.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> (ov)
  (beginning-of-line)
  (<span style="color: #0000FF;">setq</span> ov (make-overlay (point) (point)))
  (overlay-put ov 'before-string <span style="color: #008000;">"1"</span>))
</pre>
</div>

<pre class="example">
1
</pre>

<p>
The next thing to do is make a function that puts a number at the beginning of a line. We might as well store these overlays in a variable, so they are easy to remove later. This is just for exploration of how to do it. Later we combine all these pieces together.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">number-line-overlays</span> '()
  <span style="color: #036A07;">"List of overlays for line numbers."</span>)

(make-variable-buffer-local 'number-line-overlays)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">number-line</span> (N)
 <span style="color: #036A07;">"Put an overlay at the beginning of a line."</span>
  (beginning-of-line)
  (<span style="color: #0000FF;">let</span> (ov)
    (<span style="color: #0000FF;">setq</span> ov (make-overlay (point) (point)))
    (overlay-put ov 'before-string (format <span style="color: #008000;">"%3s"</span> (number-to-string N)))
    (add-to-list 'number-line-overlays ov)))

(number-line 4)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">#&lt;overlay from 1782 to 1782 in blog.org&gt;</td>
</tr>
</tbody>
</table>


<p>
That looks promising. Let's make a function to clear those overlays. It is so easy it may not even be worth writing.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">number-line-clear</span> ()
  (mapc 'delete-overlay number-line-overlays)
  (<span style="color: #0000FF;">setq</span> number-line-overlays '()))

(number-line-clear)
</pre>
</div>

<p>
Finally, we are ready to hack up the code block numbering code. The numbers will not automatically update, so we will write a function that numbers the block, but only temporarily. Any key press will get rid of the numbers so we can get back to work.  I am going to go ahead and make this a stand-alone function and block.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">number-line-overlays</span> '()
  <span style="color: #036A07;">"List of overlays for line numbers."</span>)

(make-variable-buffer-local 'number-line-overlays)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">number-line-src-block</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">save-excursion</span>
    (<span style="color: #0000FF;">let*</span> ((src-block (org-element-context))
           (nlines (- (length
                       (s-split
                        <span style="color: #008000;">"\n"</span>
                        (org-element-property <span style="color: #006FE0;">:value</span> src-block)))
                      1)))
      (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> src-block))
      (re-search-forward (regexp-quote (org-element-property <span style="color: #006FE0;">:value</span> src-block)))
      (goto-char (match-beginning 0))

      (<span style="color: #0000FF;">loop</span> for i from 1 to nlines
            do
            (beginning-of-line)
            (<span style="color: #0000FF;">let</span> (ov)
              (<span style="color: #0000FF;">setq</span> ov (make-overlay (point) (point)))
              (overlay-put ov 'before-string (format <span style="color: #008000;">"%3s"</span> (number-to-string i)))
              (add-to-list 'number-line-overlays ov))
            (next-line))))

  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now read a char to clear them</span>
  (read-key <span style="color: #008000;">"Press a key to clear numbers."</span>)
  (mapc 'delete-overlay number-line-overlays)
  (<span style="color: #0000FF;">setq</span> number-line-overlays '()))

(number-line-src-block)
</pre>
</div>

<p>
I am not sure how to get the numbers to automatically update smoothly like they do in linum-mode. That code uses a lot of hooks to make updates work, and embeds them in a minor mode to get rid of them. It also puts them in the fringe I think, but it is not clear how that is done.
</p>

<p>
We could modify what happens after the numbers are put on, e.g. pressing numbers might jump to a line, or some other kind of functionality. I don't have a critical need for this right now, so I didn't explore it more. Let me know if you have any good ideas for it!
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/13/Line-numbers-in-org-mode-code-blocks.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>The Kitchingroup welcomes Kenate Nemera</title>
      <link>http://jkitchin.github.io/blog/2015/10/11/The-Kitchingroup-welcomes-Kenate-Nemera</link>
      <pubDate>Sun, 11 Oct 2015 14:17:40 EDT</pubDate>
      <category><![CDATA[news]]></category>
      <guid isPermaLink="false">LVFmhnW53SbJnPsuhspqDWGl4t8=</guid>
      <description>The Kitchingroup welcomes Kenate Nemera</description>
      <content:encoded><![CDATA[


<p>
Kenate Nemera is joining us for 9 months on a Fulbright Fellowship! Kenate is an assistant professor at Addis Ababa University in Ethiopia. Kenate will help us with our recent work in modeling metal oxide polymorphs. Welcome Kenate!
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/11/The-Kitchingroup-welcomes-Kenate-Nemera.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
    <item>
      <title>Automatic latex image toggling when cursor is on a fragment</title>
      <link>http://jkitchin.github.io/blog/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment</link>
      <pubDate>Fri, 09 Oct 2015 11:54:50 EDT</pubDate>
      <category><![CDATA[orgmode]]></category>
      <guid isPermaLink="false">WfZuHsx_7kHcvF9V5tPn3RqURAg=</guid>
      <description>Automatic latex image toggling when cursor is on a fragment</description>
      <content:encoded><![CDATA[



<p>
There was a recent suggestion on the org-mode mailing list to make it possible to toggle individual equations in org-mode when the cursor is on them, and have them toggle back when the mouse is off. Presumably, this would let you edit the equation and see the result very easily.
</p>

<p>
The strategy to enable this is to use add a function to the post-command function hook. The function will store the last fragment/environment you were on, and compare it to where you are now.  If they are different the function will put the overlay back on the previous point, and do something appropriate at the current point, e.g. nothing if you are not on a fragment, or remove the overlay of the fragment you are on. The function will get run after every command, so we make sure we are in org-mode first!
</p>

<p>
Here are some example equations.
</p>

<p>
Here is a sentence with an equation \(f^{2x}=3\) and another form \(e^x = 20\) in it.
</p>

<p>
Here is a standalone equation environment.
</p>

\begin{equation}
a + b \sqrt{5o}
\end{equation}

<p>
And now, \[15 + 7 = 12\],
</p>

<p>
It is easiest to see this in a video here: <a href="https://www.youtube.com/watch?v=E0s3PDBqsEc">https://www.youtube.com/watch?v=E0s3PDBqsEc</a> 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">org-latex-fragment-last</span> nil
  <span style="color: #036A07;">"Holds last fragment/environment you were on."</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-latex-fragment-toggle</span> ()
  <span style="color: #036A07;">"Toggle a latex fragment image "</span>
  (<span style="color: #0000FF;">and</span> (eq 'org-mode major-mode)
       (<span style="color: #0000FF;">let*</span> ((el (org-element-context))
              (el-type (car el)))
         (<span style="color: #0000FF;">cond</span>
          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">were on a fragment and now on a new fragment</span>
          ((<span style="color: #0000FF;">and</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fragment we were on</span>
            org-latex-fragment-last
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">and are on a fragment now</span>
            (<span style="color: #0000FF;">or</span>
             (eq 'latex-fragment el-type)
             (eq 'latex-environment el-type))
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">but not on the last one this is a little tricky. as you edit the</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fragment, it is not equal to the last one. We use the begin</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">property which is less likely to change for the comparison.</span>
            (not (= (org-element-property <span style="color: #006FE0;">:begin</span> el)
                    (org-element-property <span style="color: #006FE0;">:begin</span> org-latex-fragment-last))))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">go back to last one and put image back</span>
           (<span style="color: #0000FF;">save-excursion</span>
             (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> org-latex-fragment-last))
             (org-preview-latex-fragment))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now remove current image</span>
           (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> el))
           (<span style="color: #0000FF;">let</span> ((ov (<span style="color: #0000FF;">loop</span> for ov in org-latex-fragment-image-overlays
                           if
                           (<span style="color: #0000FF;">and</span>
                            (&lt;= (overlay-start ov) (point))
                            (&gt;= (overlay-end ov) (point)))
                           return ov)))
             (<span style="color: #0000FF;">when</span> ov
               (delete-overlay ov)))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">and save new fragment</span>
           (<span style="color: #0000FF;">setq</span> org-latex-fragment-last el))

          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">were on a fragment and now are not on a fragment</span>
          ((<span style="color: #0000FF;">and</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">not on a fragment now</span>
            (not (<span style="color: #0000FF;">or</span>
                  (eq 'latex-fragment el-type)
                  (eq 'latex-environment el-type)))
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">but we were on one</span>
            org-latex-fragment-last)
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">put image back on</span>
           (<span style="color: #0000FF;">save-excursion</span>
             (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> org-latex-fragment-last))
             (org-preview-latex-fragment))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">unset last fragment</span>
           (<span style="color: #0000FF;">setq</span> org-latex-fragment-last nil))

          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">were not on a fragment, and now are</span>
          ((<span style="color: #0000FF;">and</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">we were not one one</span>
            (not org-latex-fragment-last)
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">but now we are</span>
            (<span style="color: #0000FF;">or</span>
             (eq 'latex-fragment el-type)
             (eq 'latex-environment el-type)))
           (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> el))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">remove image</span>
           (<span style="color: #0000FF;">let</span> ((ov (<span style="color: #0000FF;">loop</span> for ov in org-latex-fragment-image-overlays
                           if
                           (<span style="color: #0000FF;">and</span>
                            (&lt;= (overlay-start ov) (point))
                            (&gt;= (overlay-end ov) (point)))
                           return ov)))
             (<span style="color: #0000FF;">when</span> ov
               (delete-overlay ov)))
           (<span style="color: #0000FF;">setq</span> org-latex-fragment-last el))))))


(add-hook 'post-command-hook 'org-latex-fragment-toggle)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">org-latex-fragment-toggle</td>
<td class="left">matlab-start-block-highlight-timer</td>
<td class="left">eldoc-schedule-timer</td>
</tr>
</tbody>
</table>


<p>
I think there could be another way to do this with text properties, e.g. point-left and point-entered, but that would require those properties to be set on the fragments. I might try that approach another day.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content:encoded>
    </item>
  </channel>
</rss>
