<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
     xmlns:content="http://purl.org/rss/1.0/modules/content/"
     xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
     xmlns:atom="http://www.w3.org/2005/Atom"
     xmlns:dc="http://purl.org/dc/elements/1.1/"
     xmlns:wfw="http://wellformedweb.org/CommentAPI/"
     >
  <channel>
    <title>The Kitchin Research Group</title>
    <link>http://jkitchin.github.io/blog</link>
    <description>Chemical Engineering at Carnegie Mellon University</description>
    <pubDate>Sat, 08 Mar 2014 13:01:43 GMT</pubDate>
    <generator>Blogofile</generator>
    <sy:updatePeriod>hourly</sy:updatePeriod>
    <sy:updateFrequency>1</sy:updateFrequency>
    <item>
      <title>Using yasnippet to get completion in ref links</title>
      <link>http://jkitchin.github.io/blog/2014/03/08/Using-yasnippet-to-get-completion-in-ref-links</link>
      <pubDate>Sat, 08 Mar 2014 07:55:54 EST</pubDate>
      <category><![CDATA[org-mode]]></category>
      <guid isPermaLink="false">o-a0VyUQdRLKKR9sLjtLpupUsO8=</guid>
      <description>Using yasnippet to get completion in ref links</description>
      <content:encoded><![CDATA[



<p>
This post illustrates an alternative approach to completion in creating ref links compared to the approach shown <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/03/06/Using-completion-in-ref-links/">here</a> . In this approach we use a dynamic yasnippet to do the completion. We start with similar code that I used before to get a list of labels from the buffer. I used a slightly different regexp to recognize links in this version.
</p>

<p>
<pre>label:code-example</pre> 
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">get-labels</span> ()
  (interactive)
  (<span style="color: #8b0000;">save-excursion</span>
    (goto-char (point-min))
    (<span style="color: #8b0000;">let</span> ((matches '()))
      (<span style="color: #8b0000;">while</span> (re-search-forward <span style="color: #228b22;">"label:</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">(</span><span style="color: #228b22;">[a-zA-z0-9:-]*</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">)</span><span style="color: #228b22;">"</span> (point-max) t)
        (add-to-list 'matches (match-string-no-properties 1) t))
      matches)))
</pre>
</div>

<pre class="example">
get-labels
</pre>

<p>
Let us see that in action:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(get-labels)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">code-example</td>
<td class="left">\\</td>
<td class="left">code:ref-snippet</td>
<td class="left">load-snippets</td>
</tr>
</tbody>
</table>

<p>
I think the <code>\\</code> link is an artifact of the regexp in my get-labels code, and it would not appear in other examples. 
</p>

<p>
Now, we are going to create a yasnippet that uses the list returned from <code>get-labels</code> to provide your choices. See <a href="http://capitaomorte.github.io/yasnippet/snippet-development.html#sec-3-8">http://capitaomorte.github.io/yasnippet/snippet-development.html#sec-3-8</a> for some details. We will tangle this code block into a local snippets directory.
</p>

<p>
<pre>label:code:ref-snippet</pre> 
</p>
<div class="org-src-container">

<pre class="src src-snippet"><span style="color: #ff0000; font-weight: bold;"># -*- mode: snippet -*-</span>
<span style="color: #ff0000; font-weight: bold;"># --</span>
ref:<span style="color: #8b0000;">${</span><span style="color: #ff0000; font-weight: bold;">1</span><span style="color: #8b0000;">:</span>$<span style="color: #0000cd; font-weight: bold;">$(</span>yas-choose-value (get-labels))<span style="color: #8b0000;">}</span> <span style="color: #8b0000;">$</span><span style="color: #228b22;">0</span>
</pre>
</div>

<p>
Now we load the snippets directory.
</p>

<p>
<pre>label:load-snippets</pre> 
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(yas-load-directory <span style="color: #228b22;">"./snippets"</span>)
</pre>
</div>

<p>
Finally, we can type ref, press tab to complete it, and then select the label you want from a list. Here are some examples:
</p>

<p>
<pre>ref:code-example</pre> 
</p>

<p>
<pre>ref:code:ref-snippet</pre> 
</p>

<p>
That also works! I cannot decide if I like this better than the Emacs completion. yasnippet gives a popup menu, which is not as easy to navigate as the Emacs completion mechanism. It also requires a working yasnippet, which has not made it into my regular work flows too often. I think I like the Emacs completion better (which actually goes through Icicles since I have that installed). I like it better because I do not have to leave the keyboard or use the arrow buttons to choose a label. However, I do need to bind that function to some key to use it, or type in the command name. It turns out I do not use ref links too often, so it is not too burdensome.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/03/08/Using-yasnippet-to-get-completion-in-ref-links.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
    <item>
      <title>Storing label links in org-mode</title>
      <link>http://jkitchin.github.io/blog/2014/03/07/Storing-label-links-in-org-mode</link>
      <pubDate>Fri, 07 Mar 2014 16:13:39 EST</pubDate>
      <category><![CDATA[org-mode]]></category>
      <guid isPermaLink="false">NpP6aGRkBlN4BqSNugVcqHPVOog=</guid>
      <description>Storing label links in org-mode</description>
      <content:encoded><![CDATA[



<p>
I am continuing to evolve how I can use org-mode. I have created a label link, which if clicked on checks to see that the label is unique in the buffer. It would be nice to be able to be on a <pre>label:some-label</pre> link, and to store it so we could create a <pre>ref:some-label</pre> later. That ref link is also clickable, and it jumps to the label it refers to, and provides a C-c &amp; option to get back to the ref link. org-mode allows you to create <code>org-PREFIX-store-link</code> functions which store the link information. These functions must determine if they are responsible for storing the link and return nil if not. The first challenge is figuring out if the cursor is on a label link. Here is a function that does that.
</p>

<p>
This was a little challenging. The strategy to determine if the cursor is in a link is to search backward for a regular expression matching a label link. I found this was not sufficient, because it appeared to me that the matched string was only between the beginning of the label link and the point where the cursor was. So, after finding the beginning of the first label link before the cursor, then we search forward to find the whole link. Then we determine if the cursor is between the beginning and end of the match. If it is, then we are on a label link. Here is the code.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">in-label-link</span> ()
  <span style="color: #228b22;">"return label if in a label link, or return nil</span>

<span style="color: #228b22;">we store point, search forward to the first space, and backward to the previous space. then make sure label: is between them."</span>
  (interactive)
  (<span style="color: #8b0000;">let</span> ((current-point (point)))
    (<span style="color: #8b0000;">save-excursion</span>
      (re-search-backward <span style="color: #228b22;">"label:</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">(</span><span style="color: #228b22;">[a-zA-z0-9:-]*</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">)</span><span style="color: #228b22;">"</span> (point-min) t)
      (re-search-forward <span style="color: #228b22;">"label:</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">(</span><span style="color: #228b22;">[a-zA-Z0-9-:]*</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">)</span><span style="color: #228b22;">"</span> (point-max) t)   
      (<span style="color: #8b0000;">if</span> (and (&gt; current-point (match-beginning 0))
               (&lt; current-point (match-end 0)))
          t
        nil))))
</pre>
</div>

<p>
This code works for these kinds of links as far as I can tell. Interestingly, it only works when the cursor is to the right of label:. I am not sure if that is because of the regular expression or not.
</p>

<p>
<pre>label:plain-beginning</pre> 
</p>

<p>
<pre>label:telabel</pre> 
</p>

<p>
<pre>label:fig:test</pre> 
</p>

<p>
<pre>label:bracket-in-line</pre> 
</p>


<p>
Now, we create the code that stores the link. We only execute the code if we pass the function that checks if we are on a label link. If we are, then the label is stored in <code>(match-string 1)</code>, and we create the link and store it. Finally, we add the function to <code>org-store-link-functions</code> so that it will be used when C-c l is pressed.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">org-label-store-link</span> ()
  <span style="color: #228b22;">"store a link to a label. The output will be a ref to that label"</span>
  <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">First we have to make sure we are on a label link. </span>
  (<span style="color: #8b0000;">when</span> (in-label-link)
    (org-store-link-props
     <span style="color: #cd0000;">:type</span> <span style="color: #228b22;">"ref"</span>
     <span style="color: #cd0000;">:link</span> (concat <span style="color: #228b22;">"ref:"</span> (match-string 1)))))

(add-hook 'org-store-link-functions 'org-label-store-link)
</pre>
</div>

<p>
So, here is the evidence that it worked:
</p>

<p>
<pre>ref:plain-beginning</pre> 
</p>

<p>
<pre>ref:telabel</pre> 
</p>

<p>
<pre>ref:fig:test</pre> 
</p>

<p>
<pre>ref:bracket-in-line</pre> 
</p>

<p>
For each of these, I put the cursor on the labels, pressed C-c l, and then moved the cursor down here and pressed C-c C-l, and pressed enter and PRESTO! I had the reference that I wanted! That seems like a handy trick.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/03/07/Storing-label-links-in-org-mode.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
    <item>
      <title>Using completion in ref links</title>
      <link>http://jkitchin.github.io/blog/2014/03/06/Using-completion-in-ref-links</link>
      <pubDate>Thu, 06 Mar 2014 19:11:07 EST</pubDate>
      <category><![CDATA[org-mode]]></category>
      <guid isPermaLink="false">BYDh83A1U3X7fdTRJp_0i4quNyc=</guid>
      <description>Using completion in ref links</description>
      <content:encoded><![CDATA[



<p>
I came across this interesting post on using completion in links: <a href="http://draketo.de/light/english/free-software/custom-link-completion-org-mode-25-lines-emacs">http://draketo.de/light/english/free-software/custom-link-completion-org-mode-25-lines-emacs</a> . I like the idea, but the type-flow for is not how I usually insert links. For the method there to work, you have to enter a link with C-c C-l, partially enter the link type, press enter, and then partially enter the description, which can be completed with tab. That is a lot of typing to me, compared to what I usually do which is type the link in directly. That habit does not work too well in large documents, and always has the possibility of a typo in the link, which then does not work or export correctly.
</p>

<p>
Here I explore how to make a <pre>ref:label</pre> link using a function that provides all the options available as labels. The idea is to write a function that generates a list of labels in the buffer, which you can make a link to. Let us try an interactive function with a list of arguments. We are first going to generate a list of labels from the buffer. We use this code to get a list of labels in the buffer. You will get to choose which label you want a link to, and the function will insert it for you. Here it is:
</p>

<p>
<pre>label:code-example</pre> 
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">get-labels</span> ()
  (interactive)
  (<span style="color: #8b0000;">save-excursion</span>
    (goto-char (point-min))
    (<span style="color: #8b0000;">let</span> ((matches '()))
      (<span style="color: #8b0000;">while</span> (re-search-forward <span style="color: #228b22;">"label:</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">(</span><span style="color: #228b22;">.*</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">)</span><span style="color: #228b22;">"</span> (point-max) t)
        (add-to-list 'matches (match-string-no-properties 1) t))
      matches)))

(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">org-insert-ref-link</span> (<span style="color: #4682b4;">&amp;optional</span> arg)
  (interactive (list (completing-read <span style="color: #228b22;">"label: "</span> (get-labels))))
  (insert (format <span style="color: #228b22;">"ref:%s"</span> arg)))
</pre>
</div>

<pre class="example">
org-insert-ref-link
</pre>

<p>
So, here you run the command with M-x org-insert-ref-link, press tab, and select the label you want to use. A link like this gets inserted in your buffer <pre>ref:code-example</pre> . This is pretty nice. It should reduce the number of ref link mistakes, and make it easier to find the labels in the whole buffer.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/03/06/Using-completion-in-ref-links.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
    <item>
      <title>Creating a transportable zip-archive of an org-file</title>
      <link>http://jkitchin.github.io/blog/2014/03/05/Creating-a-transportable-zip-archive-of-an-org-file</link>
      <pubDate>Wed, 05 Mar 2014 10:49:14 EST</pubDate>
      <category><![CDATA[org-mode]]></category>
      <guid isPermaLink="false">JHmvc5iQPy-52jQTSAudfK1pe_E=</guid>
      <description>Creating a transportable zip-archive of an org-file</description>
      <content:encoded><![CDATA[



<p>
This post explores a method to save an org-buffer to a zip archive, with all the referencing files. The challenge is that you may want to share the org-file with someone, but the links break if you send them the file, and it is not that trivial to find all the links and change them, and to copy the files to a place where the new links work. 
</p>

<p>
The idea is to export the buffer to an org-file and process all the links to copy the files to a new directory, and change the links to point to these new files. For example, <a href="/media/2014-03-05-Creating-a-transportable-zip-archive-of-an-org-file/blog.pdf">blog.pdf</a> would be copied to the temporary directory, given a unique name, and then relinked. The text below includes some examples of the links that need to be modified.
</p>

<p>
A figure looks like:
</p>


<div class="figure">
<p><img src="/media/2014-03-05-Creating-a-transportable-zip-archive-of-an-org-file/cos-plot.png"> 
</p>
</div>

<p>
Alternatively, we might use a <img src="/media/2014-03-05-Creating-a-transportable-zip-archive-of-an-org-file/eos.png"> to a file. We do not want to change urls, such as this one: <a href="http://kitchingroup.cheme.cmu.edu/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog/">http://kitchingroup.cheme.cmu.edu/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog/</a> . As in that example, we will create a list of all the links in the buffer, but only modify the links that are files. We can parse the buffer and get the links like this.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((parsetree (org-element-parse-buffer))
      (counter 0))
  (org-element-map parsetree 'link
    (<span style="color: #8b0000;">lambda</span> (link) 
      (<span style="color: #8b0000;">let</span> ((type (nth 0 link))
            (plist (nth 1 link))
            (content (nth 2 link)))
        (princ (format <span style="color: #228b22;">"%s %s: %s %s\n"</span> 
                       counter 
                       (plist-get plist '<span style="color: #cd0000;">:type</span>) 
                       (plist-get plist <span style="color: #cd0000;">:path</span>) 
                       content))
        (setq counter (+ counter 1))))))
</pre>
</div>
<pre class="example">
0 file: ./blog.pdf nil
1 file: ./images/cos-plot.png nil
2 file: ./images/eos.png link
3 http: //kitchingroup.cheme.cmu.edu/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog/ nil
</pre>

<p>
So, our overall strategy will be to create a new directory to store the new versions of the files in. Then, we will copy the files that links point to into that directory, and give them new unique names. We will rename the links to point to these new names. We do this because you may, for some reason have links to files with the same name but in different directories. We want to make sure we do not clobber the files by overwriting them. We use a simple method here, based on unique, temporary filenames. There are other ways to do it to, this way worked first. Finally, we will zip that new directory, and delete the new directory.
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">directory to save all exports in, using the current date</span>
(setq org-archive (concat <span style="color: #228b22;">"org-archive-"</span> (format-time-string <span style="color: #228b22;">"%Y-%m-%d"</span> (current-time))))

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">delete directory and zip file if it exists</span>
(<span style="color: #8b0000;">when</span> (file-exists-p (concat org-archive <span style="color: #228b22;">".zip"</span>)) 
    (delete-file (concat org-archive <span style="color: #228b22;">".zip"</span>) t))

(<span style="color: #8b0000;">when</span> (file-exists-p org-archive) 
    (delete-directory org-archive t))

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">make directory</span>
(make-directory org-archive t)

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">get list of links, copy files and save names</span>
(setq link-list (<span style="color: #8b0000;">let</span> ((parsetree (org-element-parse-buffer))
                     (counter 0))
                 (org-element-map parsetree 'link
                   (<span style="color: #8b0000;">lambda</span> (link) 
                     (<span style="color: #8b0000;">let*</span> ((type (nth 0 link))
                            (plist (nth 1 link))
                            (content (nth 2 link))
                            (path (plist-get plist <span style="color: #cd0000;">:path</span>))
                            (type (plist-get plist '<span style="color: #cd0000;">:type</span>))
                            (fname (car (last (split-string path <span style="color: #228b22;">"/"</span>))))
                            (temporary-file-directory org-archive)
                            (new-file)
                            )     
                       (<span style="color: #8b0000;">cond</span>
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">regular file with content</span>
                        ((and (string= type <span style="color: #228b22;">"file"</span>)  content)
                         (setq new-file  (make-temp-file (file-name-sans-extension fname) nil 
                                                         (concat <span style="color: #228b22;">"."</span> (file-name-extension fname))))
                         (<span style="color: #8b0000;">with-temp-file</span> new-file
                           (insert-file-contents path))
                         (format <span style="color: #228b22;">"[[./%s][%s]] "</span> (file-name-nondirectory new-file) content))
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">regular file with no content</span>
                        ((and (string= type <span style="color: #228b22;">"file"</span>))
                         (setq new-file  (make-temp-file (file-name-sans-extension fname) nil 
                                                         (concat <span style="color: #228b22;">"."</span> (file-name-extension fname))))
                         (<span style="color: #8b0000;">with-temp-file</span> new-file
                           (insert-file-contents path))
                         (format <span style="color: #228b22;">"[[./%s]] "</span> (file-name-nondirectory new-file)))
                        (t nil)))))))

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">save current buffer name</span>
(setq current-name (buffer-name))

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">create filter for links and export org buffer</span>
(<span style="color: #8b0000;">let</span> ((counter 0))
  (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">ox-mrkup-filter-link</span> (text back-end info)
    (<span style="color: #8b0000;">let</span> ((link (nth counter link-list)))
      (<span style="color: #8b0000;">if</span> (not (string= link <span style="color: #228b22;">"nil"</span>)) (setq output   (format <span style="color: #228b22;">"%s"</span> link))
        (setq output (format <span style="color: #228b22;">"%s"</span> text)))
      (setq counter (+ counter 1))
      output))

  (<span style="color: #8b0000;">let</span> ((org-export-filter-link-functions '(ox-mrkup-filter-link)))
    (org-org-export-as-org)))

(switch-to-buffer <span style="color: #228b22;">"*Org ORG Export*"</span>)
(write-file (expand-file-name current-name org-archive))
(shell-command (concat <span style="color: #228b22;">"zip -R "</span> org-archive <span style="color: #228b22;">".zip  *"</span>))
(rename-file (concat org-archive <span style="color: #228b22;">".zip"</span>) (concat <span style="color: #228b22;">"../"</span>org-archive <span style="color: #228b22;">".zip"</span>))
(kill-buffer)

(switch-to-buffer current-name)
(delete-directory org-archive t)  <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">get rid of temp-dir</span>
</pre>
</div>



<p>
This example works fine! The result is here: <a href="/media/2014-03-05-Creating-a-transportable-zip-archive-of-an-org-file/org-archive-2014-03-05.zip">org-archive-2014-03-05.zip</a> This code would ideally be put into a function, and cleaned up a little so there are not global variables being set here and there. A subsequent function might make it easy to attach this file to an email. That code might look something like this:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(mail)
(mail-to)
(insert <span style="color: #228b22;">"jkitchin@andrew.cmu.edu"</span>)
(mml-attach-file <span style="color: #228b22;">"./org-archive-2014-03-05.zip"</span>)
</pre>
</div>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/03/05/Creating-a-transportable-zip-archive-of-an-org-file.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
    <item>
      <title>Getting a list of figures in an org-buffer</title>
      <link>http://jkitchin.github.io/blog/2014/03/02/Getting-a-list-of-figures-in-an-org-buffer</link>
      <pubDate>Sun, 02 Mar 2014 10:03:00 EST</pubDate>
      <category><![CDATA[org-mode]]></category>
      <guid isPermaLink="false">mG7o_GpUxz5PFXAl6lRCneMNgec=</guid>
      <description>Getting a list of figures in an org-buffer</description>
      <content:encoded><![CDATA[



<p>
Similar to the previous <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/03/01/Getting-a-list-of-tables-in-an-org-buffer/">example</a> of getting a list of tables, here we examine getting a list of figures. Here are two figure links, one with a label, and one with a caption.
</p>


<div id="fig:cos" class="figure">
<p><img src="/media/2014-03-02-Getting-a-list-of-figures-in-an-org-buffer/cos-plot.png"> 
</p>
</div>


<div class="figure">
<p><img src="/media/2014-03-02-Getting-a-list-of-figures-in-an-org-buffer/eos-uncertainty.png"> 
</p>
<p><span class="figure-number">Figure 1:</span> An equation of state. this is the caption of the figure.</p>
</div>


<div class="figure">
<p><img src="/media/2014-03-02-Getting-a-list-of-figures-in-an-org-buffer/implicit-uncertainty.png"> 
</p>
<p><span class="figure-number">Figure 2:</span> another figure</p>
</div>

<p>
We define a link that will parse the buffer, and create links in a new buffer to the figures. We define a figure as a  link with a :type of "file" that has a path that points to a file ending with png or pdf.  We will improve on the list of tables by making the buffer read-only, and making a local key binding to kill the buffer by pressing "q". Here is our attempted code. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">http://www.emacswiki.org/emacs/ElispCookbook#toc4</span>
(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">string/ends-with</span> (s ending)
  <span style="color: #228b22;">"return non-nil if string S ends with ENDING."</span>
  (<span style="color: #8b0000;">cond</span> ((&gt;= (length s) (length ending))
         (<span style="color: #8b0000;">let</span> ((elength (length ending)))
           (string= (substring s (- 0 elength)) ending)))
        (t nil)))

(org-add-link-type 
 <span style="color: #228b22;">"list-of-figures"</span>
 (<span style="color: #8b0000;">lambda</span> (link-string)
   (<span style="color: #8b0000;">let*</span> ((c-b (buffer-name))
          (counter 0)
          (list-of-figures 
           (org-element-map (org-element-parse-buffer) 'link
             (<span style="color: #8b0000;">lambda</span> (link) 
               <span style="color: #228b22;">"create a link for to the figure"</span>
               (<span style="color: #8b0000;">when</span> 
                   (and (string= (org-element-property <span style="color: #cd0000;">:type</span> link) <span style="color: #228b22;">"file"</span>)
                        (string-match-p  
                         <span style="color: #228b22;">"[</span><span style="color: #228b22;">^</span><span style="color: #228b22;">.]*\\.</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">(</span><span style="color: #228b22;">png</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">|</span><span style="color: #228b22;">jpg</span><span style="color: #228b22; font-weight: bold;">\\</span><span style="color: #228b22; font-weight: bold;">)</span><span style="color: #228b22;">$"</span>
                         (org-element-property <span style="color: #cd0000;">:path</span> link)))                   
                 (incf counter)
                 
                 (<span style="color: #8b0000;">let*</span> ((start (org-element-property <span style="color: #cd0000;">:begin</span> link))
                        (parent (car (cdr (org-element-property <span style="color: #cd0000;">:parent</span> link))))
                        (caption (caaar (plist-get parent <span style="color: #cd0000;">:caption</span>)))
                        (name (plist-get parent <span style="color: #cd0000;">:name</span>)))
                   (<span style="color: #8b0000;">if</span> caption 
                       (format 
                        <span style="color: #228b22;">"[[elisp:(progn (switch-to-buffer \"%s\")(goto-char %s))][figure %s: %s]] %s\n"</span> 
                        c-b start counter (or name <span style="color: #228b22;">""</span>) caption)
                     (format 
                      <span style="color: #228b22;">"[[elisp:(progn (switch-to-buffer \"%s\")(goto-char %s))][figure %s: %s]]\n"</span> 
                      c-b start counter (or name <span style="color: #228b22;">""</span>)))))))))
          (switch-to-buffer <span style="color: #228b22;">"*List of Figures*"</span>)
          (org-mode)
          (erase-buffer)
          (insert (mapconcat 'identity list-of-figures <span style="color: #228b22;">""</span>))
          (setq buffer-read-only t)
          (use-local-map (copy-keymap org-mode-map))
          (local-set-key <span style="color: #228b22;">"q"</span> #'(<span style="color: #8b0000;">lambda</span> () (interactive) (kill-buffer)))))
   (<span style="color: #8b0000;">lambda</span> (keyword desc format)
     (<span style="color: #8b0000;">cond</span>
      ((eq format 'latex)
       (format <span style="color: #228b22;">"\\listoffigures"</span>)))))
</pre>
</div>



<p>
This is a test to see if our function works for other image types.
<a href="/media/2014-03-02-Getting-a-list-of-figures-in-an-org-buffer/smiley.jpg">smiley.jpg</a> 
</p>

<p>
And a link to test it out: 
</p>

<p>

</p>

<p>
This works too. I am not sure I am getting the figure name and caption in a bulletproof way. They seem to be buried in the :parent of the element, which is a paragraph element. The caption seems to be buried in a few sets of parentheses, hence the use of <code>caaar</code> to get the caption out. I am not sure if the caption is always at that depth or not. As a proof of concept though, this is not too bad. 
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/03/02/Getting-a-list-of-figures-in-an-org-buffer.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
    <item>
      <title>Getting a list of tables in an org-buffer</title>
      <link>http://jkitchin.github.io/blog/2014/03/01/Getting-a-list-of-tables-in-an-org-buffer</link>
      <pubDate>Sat, 01 Mar 2014 18:12:15 EST</pubDate>
      <category><![CDATA[org-mode]]></category>
      <guid isPermaLink="false">P9YWx2BJKQvg3Ywadkpg2rtXkVI=</guid>
      <description>Getting a list of tables in an org-buffer</description>
      <content:encoded><![CDATA[



<p>
In a large document it might be nice to quickly get a list of tables. Preferrably by clicking on a link that generates the list, and exports appropriately, e.g. <code>listoftables</code> for LaTeX. A link like this:
</p>

<p>

</p>

<p>
Before getting to the code that does what we need, let us make some tables. We make three different kinds of tables for fun. A named table, an unnamed table, and a table with a caption. 
</p>

<table id="first-table" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">2</td>
</tr>

<tr>
<td class="right">a</td>
<td class="right">b</td>
</tr>
</tbody>
</table>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="right">t</td>
<td class="right">y</td>
</tr>

<tr>
<td class="right">5</td>
<td class="right">6</td>
</tr>
</tbody>
</table>


<table id="tbl-with-caption" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> column of numbers</caption>

<colgroup>
<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="right">34</td>
</tr>

<tr>
<td class="right">6</td>
</tr>

<tr>
<td class="right">6</td>
</tr>
</tbody>
</table>


<p>
We would like a function that creates a buffer with a list of the tables, and links to them. We include the table name, and caption if there is one. We will create an org-buffer, and use org-links to the tables. Here is a link definition that will do that.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-add-link-type 
 <span style="color: #228b22;">"list-of-tables"</span>
 (<span style="color: #8b0000;">lambda</span> (link-string)
   (<span style="color: #8b0000;">let*</span> ((c-b (buffer-name))
          (counter 0)
          (list-of-tables 
           (org-element-map (org-element-parse-buffer 'element) 'table
             (<span style="color: #8b0000;">lambda</span> (table) 
               <span style="color: #228b22;">"create a link for to the table"</span>
               (incf counter)
               (<span style="color: #8b0000;">let</span> ((start (org-element-property <span style="color: #cd0000;">:begin</span> table))
                     (name  (org-element-property <span style="color: #cd0000;">:name</span> table))
                     (caption (caaar (org-element-property <span style="color: #cd0000;">:caption</span> table))))
                 (<span style="color: #8b0000;">if</span> caption 
                     (format 
                      <span style="color: #228b22;">"[[elisp:(progn (switch-to-buffer \"%s\")(goto-char %s))][table %s: %s]] %s\n"</span> 
                      c-b start counter (or name <span style="color: #228b22;">""</span>) caption)
                   (format 
                    <span style="color: #228b22;">"[[elisp:(progn (switch-to-buffer \"%s\")(goto-char %s))][table %s: %s]]\n"</span> 
                    c-b start counter (or name <span style="color: #228b22;">""</span>))))))))
     (switch-to-buffer <span style="color: #228b22;">"*List of Tables*"</span>)
     (org-mode)
     (erase-buffer)
     (insert (mapconcat 'identity list-of-tables <span style="color: #228b22;">""</span>))))
 (<span style="color: #8b0000;">lambda</span> (keyword desc format)
   (<span style="color: #8b0000;">cond</span>
    ((eq format 'latex)
     (format <span style="color: #228b22;">"\\listoftables"</span>)))))
</pre>
</div>

<p>
A list of figures would only be a little trickier. You would map over the links, and find the file type links that have a select number of extensions, e.g. png, jpg, etc&#x2026;
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/03/01/Getting-a-list-of-tables-in-an-org-buffer.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
    <item>
      <title>Professor Kitchin awarded the Philip L. Dowd Fellowship Award</title>
      <link>http://jkitchin.github.io/blog/2014/02/28/Professor-Kitchin-awarded-the-Philip-L-Dowd-Fellowship-Award</link>
      <pubDate>Fri, 28 Feb 2014 13:44:31 EST</pubDate>
      <category><![CDATA[news]]></category>
      <guid isPermaLink="false">wnigWJ_7Sq_BbSzC1JEyv7e4lzs=</guid>
      <description>Professor Kitchin awarded the Philip L. Dowd Fellowship Award</description>
      <content:encoded><![CDATA[


<p>
The <a href="https://www.cit.cmu.edu/faculty_staff/faculty_awards/dowd.html">Dowd Fellowship</a> is awarded to a faculty member in engineering to recognize educational contributions and to encourage the undertaking of an educational project such as textbook writing, educational technology development, laboratory experience improvement, educational software, or course and curriculum development.
</p>

<p>
Professor Kitchin was recognized for his work in creating the <a href="http://kitchingroup.cheme.cmu.edu/dft-book">dft-book</a> , <a href="http://kitchingroup.cheme.cmu.edu">pycse</a> , and their integration into courses. These resources notably integrate technical narrative text, equation, images along with code and the output. He is continuing to develop these resources and similar materials for a new Master's course in chemical reaction engineering.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/02/28/Professor-Kitchin-awarded-the-Philip-L.-Dowd-Fellowship-Award.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
    <item>
      <title>Wilkinson's polynomial</title>
      <link>http://jkitchin.github.io/blog/2014/02/21/Wilkinson-s-polynomial</link>
      <pubDate>Fri, 21 Feb 2014 09:54:47 EST</pubDate>
      <category><![CDATA[polynomial]]></category>
      <guid isPermaLink="false">OXJ9tvV0MBPK_JMDffFb6cblHi8=</guid>
      <description>Wilkinson's polynomial</description>
      <content:encoded><![CDATA[



<p>
<a href="http://en.wikipedia.org/wiki/Wilkinson%27s_polynomial">Wilkinson's polynomial</a> is defined as
\(  w(x) = \prod_{i=1}^{20} (x - i) = (x-1)(x-2) \ldots (x-20) \). 
</p>

<p>
This innocent looking function has 20 roots, which are 1,2,3,&#x2026;,19,20. Here is a plot of the function.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt
<span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np

<span style="color: #4682b4;">@np.vectorize</span>
<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">wilkinson</span>(x):
    <span style="color: #8b008b;">p</span> = np.prod(np.array([x - i <span style="color: #8b0000;">for</span> i <span style="color: #8b0000;">in</span> <span style="color: #cd0000;">range</span>(1, 21)]))
    <span style="color: #8b0000;">return</span> p

<span style="color: #8b008b;">x</span> = np.linspace(0, 21, 1000)
plt.plot(x, wilkinson(x))
plt.ylim([-5e13, 5e13])
plt.savefig(<span style="color: #228b22;">'./images/wilkinson-1.png'</span>)
</pre>
</div>


<div class="figure">
<p><img src="/media/2014-02-21-Wilkinson's-polynomial/wilkinson-1.png"> 
</p>
</div>

<p>
Let us consider the expanded version of the polynomial. We will use sympy to expand the polynomial. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> sympy <span style="color: #8b0000;">import</span> Symbol, Poly
<span style="color: #8b0000;">from</span> sympy.polys.polytools <span style="color: #8b0000;">import</span>   poly_from_expr

<span style="color: #8b008b;">x</span> = Symbol(<span style="color: #228b22;">'x'</span>)
<span style="color: #8b008b;">W</span> = 1
<span style="color: #8b0000;">for</span> i <span style="color: #8b0000;">in</span> <span style="color: #cd0000;">range</span>(1, 21):
    <span style="color: #8b008b;">W</span> = W * (x-i)

<span style="color: #8b0000;">print</span> W.expand()

<span style="color: #8b008b;">P</span>,<span style="color: #8b008b;">d</span> = poly_from_expr(W.expand())
<span style="color: #8b0000;">print</span> P
</pre>
</div>
<pre class="example">
x**20 - 210*x**19 + 20615*x**18 - 1256850*x**17 + 53327946*x**16 - 1672280820*x**15 + 40171771630*x**14 - 756111184500*x**13 + 11310276995381*x**12 - 135585182899530*x**11 + 1307535010540395*x**10 - 10142299865511450*x**9 + 63030812099294896*x**8 - 311333643161390640*x**7 + 1206647803780373360*x**6 - 3599979517947607200*x**5 + 8037811822645051776*x**4 - 12870931245150988800*x**3 + 13803759753640704000*x**2 - 8752948036761600000*x + 2432902008176640000
Poly(x**20 - 210*x**19 + 20615*x**18 - 1256850*x**17 + 53327946*x**16 - 1672280820*x**15 + 40171771630*x**14 - 756111184500*x**13 + 11310276995381*x**12 - 135585182899530*x**11 + 1307535010540395*x**10 - 10142299865511450*x**9 + 63030812099294896*x**8 - 311333643161390640*x**7 + 1206647803780373360*x**6 - 3599979517947607200*x**5 + 8037811822645051776*x**4 - 12870931245150988800*x**3 + 13803759753640704000*x**2 - 8752948036761600000*x + 2432902008176640000, x, domain='ZZ')
</pre>

<p>
The coefficients are orders of magnitude apart in size. This should make you nervous, because the roots of this equation are between 1-20, but there are numbers here that are O(19). This is likely to make any rounding errors in the number representations very significant, and may lead to issues with accuracy of the solution. Let us explore that.
</p>

<p>
We will get the roots using numpy.roots.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">from</span> sympy <span style="color: #8b0000;">import</span> Symbol
<span style="color: #8b0000;">from</span> sympy.polys.polytools <span style="color: #8b0000;">import</span>   poly_from_expr

<span style="color: #8b008b;">x</span> = Symbol(<span style="color: #228b22;">'x'</span>)
<span style="color: #8b008b;">W</span> = 1
<span style="color: #8b0000;">for</span> i <span style="color: #8b0000;">in</span> <span style="color: #cd0000;">range</span>(1, 21):
    <span style="color: #8b008b;">W</span> = W * (x-i)

<span style="color: #8b008b;">P</span>,<span style="color: #8b008b;">d</span> = poly_from_expr(W.expand())
<span style="color: #8b008b;">p</span> = P.all_coeffs()
<span style="color: #8b008b;">x</span> = np.arange(1, 21)
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'\nThese are the known roots\n'</span>,x

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">evaluate the polynomial at the known roots</span>
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'\nThe polynomial evaluates to {0} at the known roots'</span>.<span style="color: #cd0000;">format</span>(np.polyval(p, x))

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">find the roots ourselves</span>
<span style="color: #8b008b;">roots</span> = np.roots(p)
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'\nHere are the roots from numpy:\n'</span>, roots

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">evaluate solution at roots</span>
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'\nHere is the polynomial evaluated at the calculated roots:\n'</span>, np.polyval(p, roots)
</pre>
</div>

<pre class="example">
These are the known roots
[ 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20]

The polynomial evaluates to [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] at the known roots

Here are the roots from numpy:
[ 20.00032488  18.99715999  18.01122169  16.97113219  16.04827464
  14.9353556   14.06527291  12.94905558  12.03344921  10.98404125
  10.00605969   8.99839449   8.00028434   6.99997348   5.99999976
   5.00000034   3.99999997   3.           2.           1.        ]

Here is the polynomial evaluated at the calculated roots:
[40711209714176.0 15404160985600.0 8634610242048.00 3479686769152.00
 1780604828160.00 694313602048.000 321293542400.000 150174387712.000
 56110411264.0000 21911624192.0000 8370015744.00000 3104464384.00000
 695443968.000000 125754368.000000 -947200.000000000 -9128960.00000000
 -4393984.00000000 -712192.000000000 -31744.0000000000 17408.0000000000]
</pre>

<p>
The roots are not exact. Even more to the point, the polynomial does not evaluate to zero at the calculated roots! Something is clearly wrong here. The polynomial function is fine, and it does evaluate to zero at the known roots which are integers. It is subtle, but up to that point, we are using only integers, which can be represented exactly. The roots function is evidently using some float math, and the floats are not the same as the integers.
</p>

<p>
If we simply change the roots to floats, and reevaluate our polynomial, we get dramatically different results.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">from</span> sympy <span style="color: #8b0000;">import</span> Symbol
<span style="color: #8b0000;">from</span> sympy.polys.polytools <span style="color: #8b0000;">import</span>   poly_from_expr

<span style="color: #8b008b;">x</span> = Symbol(<span style="color: #228b22;">'x'</span>)
<span style="color: #8b008b;">W</span> = 1
<span style="color: #8b0000;">for</span> i <span style="color: #8b0000;">in</span> <span style="color: #cd0000;">range</span>(1, 21):
    <span style="color: #8b008b;">W</span> = W * (x - i)

<span style="color: #8b008b;">P</span>,<span style="color: #8b008b;">d</span> = poly_from_expr(W.expand())
<span style="color: #8b008b;">p</span> = P.all_coeffs()
<span style="color: #8b008b;">x</span> = np.arange(1, 21, dtype=np.<span style="color: #cd0000;">float</span>)
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'\nThese are the known roots\n'</span>,x

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">evaluate the polynomial at the known roots</span>
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'\nThe polynomial evaluates to {0} at the known roots'</span>.<span style="color: #cd0000;">format</span>(np.polyval(p, x))
</pre>
</div>

<pre class="example">
These are the known roots
[  1.   2.   3.   4.   5.   6.   7.   8.   9.  10.  11.  12.  13.  14.  15.
  16.  17.  18.  19.  20.]

The polynomial evaluates to [0 -8192.00000000000 -73728.0000000000 262144.000000000 716800.000000000
 4055040.00000000 -200704.000000000 5767168.00000000 -13768704.0000000
 152166400.000000 89210880.0000000 -146866176.000000 -91027456.0000000
 -111190016.000000 405964800.000000 301989888.000000 -354531328.000000
 -10256523264.0000 1316743168.00000 5308416000.00000] at the known roots
</pre>

<p>
This also happens if we make the polynomial coefficients floats. That happens because in Python whenever one element is a float the results of math operations with that element are floats. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">from</span> sympy <span style="color: #8b0000;">import</span> Symbol
<span style="color: #8b0000;">from</span> sympy.polys.polytools <span style="color: #8b0000;">import</span>   poly_from_expr

<span style="color: #8b008b;">x</span> = Symbol(<span style="color: #228b22;">'x'</span>)
<span style="color: #8b008b;">W</span> = 1
<span style="color: #8b0000;">for</span> i <span style="color: #8b0000;">in</span> <span style="color: #cd0000;">range</span>(1, 21):
    <span style="color: #8b008b;">W</span> = W * (x - i)

<span style="color: #8b008b;">P</span>,<span style="color: #8b008b;">d</span> = poly_from_expr(W.expand())
<span style="color: #8b008b;">p</span> = [<span style="color: #cd0000;">float</span>(x) <span style="color: #8b0000;">for</span> x <span style="color: #8b0000;">in</span> P.all_coeffs()]
<span style="color: #8b008b;">x</span> = np.arange(1, 21)
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'\nThese are the known roots\n'</span>,x

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">evaluate the polynomial at the known roots</span>
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'\nThe polynomial evaluates to {0} at the known roots'</span>.<span style="color: #cd0000;">format</span>(np.polyval(p, x))
</pre>
</div>

<pre class="example">
These are the known roots
[ 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20]

The polynomial evaluates to [  0.00000000e+00  -8.19200000e+03  -1.84320000e+04  -6.22592000e+05
  -2.04800000e+06  -1.08380160e+07  -2.31813120e+07  -5.89824000e+07
  -1.31383296e+08  -9.93280000e+07  -5.61532928e+08  -8.75003904e+08
  -1.38583245e+09  -1.97532877e+09  -3.80851200e+09  -6.02931200e+09
  -9.61910374e+09  -2.36191334e+10  -1.62105057e+10  -2.71933440e+10] at the known roots
</pre>

<p>
Let us try to understand what is happening here. It turns out that the integer and float representations of the numbers are different! It is known that you cannot exactly represent numbers as floats. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">from</span> sympy <span style="color: #8b0000;">import</span> Symbol
<span style="color: #8b0000;">from</span> sympy.polys.polytools <span style="color: #8b0000;">import</span>   poly_from_expr

<span style="color: #8b008b;">x</span> = Symbol(<span style="color: #228b22;">'x'</span>)
<span style="color: #8b008b;">W</span> = 1
<span style="color: #8b0000;">for</span> i <span style="color: #8b0000;">in</span> <span style="color: #cd0000;">range</span>(1, 21):
    <span style="color: #8b008b;">W</span> = W * (x - i)

<span style="color: #8b008b;">P</span>,<span style="color: #8b008b;">d</span> = poly_from_expr(W.expand())
<span style="color: #8b008b;">p</span> = P.all_coeffs()

<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'{0:&lt;30s}{1:&lt;30s}{2}'</span>.<span style="color: #cd0000;">format</span>(<span style="color: #228b22;">'Integer'</span>,<span style="color: #228b22;">'Float'</span>,<span style="color: #228b22;">'\delta'</span>)
<span style="color: #8b0000;">for</span> pj <span style="color: #8b0000;">in</span> p:
    <span style="color: #8b0000;">print</span> <span style="color: #228b22;">'{0:&lt;30s}{1:&lt;30f}{2}'</span>.<span style="color: #cd0000;">format</span>(pj, <span style="color: #cd0000;">float</span>(pj), pj - <span style="color: #cd0000;">float</span>(pj))
</pre>
</div>

<pre class="example">
Integer                       Float                         \delta
1                             1.000000                      0
-210                          -210.000000                   0
20615                         20615.000000                  0
-1256850                      -1256850.000000               0
53327946                      53327946.000000               0
-1672280820                   -1672280820.000000            0
40171771630                   40171771630.000000            0
-756111184500                 -756111184500.000000          0
11310276995381                11310276995381.000000         0
-135585182899530              -135585182899530.000000       0
1307535010540395              1307535010540395.000000       0
-10142299865511450            -10142299865511450.000000     0
63030812099294896             63030812099294896.000000      0
-311333643161390640           -311333643161390656.000000    16.0000000000000
1206647803780373360           1206647803780373248.000000    112.000000000000
-3599979517947607200          -3599979517947607040.000000   -160.000000000000
8037811822645051776           8037811822645051392.000000    384.000000000000
-12870931245150988800         -12870931245150988288.000000  -512.000000000000
13803759753640704000          13803759753640704000.000000   0
-8752948036761600000          -8752948036761600000.000000   0
2432902008176640000           2432902008176640000.000000    0
</pre>

<p>
Now you can see the issue. Many of these numbers are identical in integer and float form, but five of them are not. The integer <i>cannot</i> be exactly represented as a float, and there is a difference in the representations. It is a small difference compared to the magnitude, but these kinds of differences get raised to high powers, and become larger. You may wonder why I used "0:&lt;30s&gt;" to print the integer? That is because <code>pj</code> in that loop is an object from sympy, which prints as a string. 
</p>

<p>
This is a famous, and well known problem that is especially bad for this case. This illustrates that you cannot simply rely on what a computer tells you the answer is, without doing some critical thinking about the problem and the solution. Especially in problems where there are coefficients that vary by many orders of magnitude you should be cautious.
</p>

<p>
There are a few interesting webpages on this topic, which inspired me to work this out in python. These webpages go into more detail on this problem, and provide additional insight into the sensitivity of the solutions to the polynomial coefficients.
</p>
<ol class="org-ol">
<li><a href="http://blogs.mathworks.com/cleve/2013/03/04/wilkinsons-polynomials/">http://blogs.mathworks.com/cleve/2013/03/04/wilkinsons-polynomials/</a> 
</li>
<li><a href="http://www.numericalexpert.com/blog/wilkinson_polynomial/">http://www.numericalexpert.com/blog/wilkinson_polynomial/</a> 
</li>
<li><a href="http://en.wikipedia.org/wiki/Wilkinson%27s_polynomial">http://en.wikipedia.org/wiki/Wilkinson%27s_polynomial</a> 
</li>
</ol>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/02/21/Wilkinson's-polynomial.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
    <item>
      <title>New publication in RSC Advances</title>
      <link>http://jkitchin.github.io/blog/2014/02/20/New-publication-in-RSC-Advances</link>
      <pubDate>Thu, 20 Feb 2014 15:08:12 EST</pubDate>
      <category><![CDATA[news]]></category>
      <category><![CDATA[publication]]></category>
      <guid isPermaLink="false">Q5ifrdwWBRYKi_3xDmv5lK37CnA=</guid>
      <description>New publication in RSC Advances</description>
      <content:encoded><![CDATA[


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Bibtex entry</a></li>
</ul>
</div>
</div>

<p>
A collaborative paper with our colleagues at NETL and U. Pitt. was just accepted in RSC Advances <pre>cite:thompson-2014-co2-react</pre> !
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Bibtex entry</h2>
<div class="outline-text-2" id="text-1">
<p>
#+BEGIN<sub>SRC</sub>: :tangle /tmp/extract-bib269688VI.bib
@Article{thompson-2014-co2-react,
  author =         {Thompson, Robert L. and Albenze, Erik and Shi, Wei
                  and Hopkinson, David and Damodaran, Krishnan and
                  Lee, Anita and Kitchin, John and Luebke, David
                  Richard and Nulwala, Hunaid},
  title =         {\ce{CO_2} Reactive Ionic Liquids: Effects of
                  functional groups on the anion and its influence on
                  the physical properties},
  journal =         {RSC Adv.},
  year =         2014,
  pages =         "-",
  publisher =         {The Royal Society of Chemistry},
  doi =                 {10.1039/C3RA47097K},
  url =                 {<a href="http://dx.doi.org/10.1039/C3RA47097K">http://dx.doi.org/10.1039/C3RA47097K</a> },
  abstract =         "Next generation of gas separation materials are
                  needed to alleviate issues faced in energy and
                  environmental area. Ionic liquids (ILs) are
                  promising class of material for CO2 separations. In
                  this work{,} CO2 reactive triazolides ILs were
                  synthesized and characterized with the aim of
                  developing deeper understanding on how structural
                  changes affect the overall properties for CO2
                  separation. Important insights were gained
                  illustrating the effects of substituents on the
                  anion. It was found that substituents play a crucial
                  role in dictating the overall physical properties of
                  reactive ionic liquids. Depending upon the
                  electronic and steric nature of the substituent{,}
                  CO2 capacities between 0.07-0.4 mol CO2/mol IL were
                  observed. Detailed spectroscopic{,} CO2
                  absorption{,} rheological{,} and simulation studies
                  were carried out to understand the nature and
                  influence of these substituents. The effect of water
                  content was also evaluated{,} and it was found that
                  water had an unexpected impact on the properties of
                  these materials{,} resulting in an increased
                  viscosity{,} but little change in the CO2
                  reactivity."
}
#+END<sub>SRC</sub></p>
</div>
</div>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/02/20/New-publication-in-RSC-Advances.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
    <item>
      <title>Extracting bibtex file from an org-buffer</title>
      <link>http://jkitchin.github.io/blog/2014/02/19/Extracting-bibtex-file-from-an-org-buffer</link>
      <pubDate>Wed, 19 Feb 2014 18:45:27 EST</pubDate>
      <category><![CDATA[org-mode]]></category>
      <category><![CDATA[bibtex]]></category>
      <guid isPermaLink="false">jz3xuLa5C0MBw0T0i0IyS7UbM7U=</guid>
      <description>Extracting bibtex file from an org-buffer</description>
      <content:encoded><![CDATA[


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Bibtex entries</a></li>
</ul>
</div>
</div>

<p>
We use citation links a lot in our org-files, like this: <pre>cite:thompson-2014-co2-react</pre> . Sometimes there are multiple citations like this <pre>cite:mehta-2014-ident-poten,hallenbeck-2013-effec-o2</pre> . It would be convenient at times to extract a bibtex file from these citations. That way we could easily share files. This is possible in RefTeX from a LaTeX file. Org makes it easy to export to LaTeX, so this seems like it should be easy. It would be easy, if I always put the bibliography link in the file. I usually do not, so let us check if that is the case, and if it is not add the bibliography to the end before we export. Then, with the LaTeX file in hand, we open it, and call the RefTeX functions to get the bibliography. Finally, we will create a link to the actual created file, and add it as a source block that can be tangled at the end of the file.
</p>

<p>
Here is a function that does the extraction and some house cleaning. We actually take the contents of the buffer and save it in a temporary file, so that we do not accidentally clobber a tex or bibtex file here.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">kg-extract-bibtex</span> ()
  <span style="color: #228b22;">"create bibtex file of entries cited in this buffer"</span>

  (<span style="color: #8b0000;">let*</span> ((tempname (make-temp-file <span style="color: #228b22;">"extract-bib"</span>))
         (contents (buffer-string))
         (cb (current-buffer))
         basename texfile bibfile results)
    
    (find-file tempname)
    (insert contents)
    (setq basename (file-name-sans-extension 
                    (file-name-nondirectory buffer-file-name))
          texfile (concat basename <span style="color: #228b22;">".tex"</span>)
          bibfile (concat basename <span style="color: #228b22;">".bib"</span>))

  (<span style="color: #8b0000;">save-excursion</span>
    (goto-char (point-min))
    (<span style="color: #8b0000;">unless</span> (re-search-forward <span style="color: #228b22;">"^bibliography:"</span> (point-max) 'end)
      (insert (format <span style="color: #228b22;">"\nbibliography:%s"</span> (mapconcat 'identity reftex-default-bibliography <span style="color: #228b22;">","</span>)))))

    (org-latex-export-to-latex)
    (find-file texfile)
    (reftex-parse-all)
    (reftex-create-bibtex-file bibfile)
    (setq results (buffer-string))
    (kill-buffer bibfile)
    (kill-buffer texfile)
    (delete-file texfile)
    (delete-file tempname)

    (switch-to-buffer cb)
    (<span style="color: #8b0000;">save-excursion</span>
      (goto-char (point-max))
      (insert (format <span style="color: #228b22;">"</span>

<span style="color: #228b22;">** Bibtex entries</span>

<span style="color: #228b22;">#+BEGIN_EXAMPLE: </span>
<span style="color: #228b22;">%s</span>
<span style="color: #228b22;">#+END_EXAMPLE"</span> results)))))

(kg-extract-bibtex)
</pre>
</div>

<p>
There it is! The src block does not render in HTML very well, since it appears to be simple text. It looks fine in the org file though.
</p>

<p>
It might be a good idea to replace the bibliography line with the new file, but I will leave that as an exercise for later.
</p>




<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Bibtex entries</h2>
<div class="outline-text-2" id="text-1">
<p>
#+BEGIN<sub>EXAMPLE</sub>: 
@article{hallenbeck-2013-effec-o2,
  author =         "Hallenbeck, Alexander P. and Kitchin, John R.",
  title =         "Effects of \ce{O_2} and \ce{SO_2} on the Capture
                  Capacity of a Primary-Amine Based Polymeric
                  \ce{CO_2} Sorbent",
  year =         2013,
  doi =                 "10.1021/ie400582a",
  eprint =         "<a href="http://pubs.acs.org/doi/pdf/10.1021/ie400582a">http://pubs.acs.org/doi/pdf/10.1021/ie400582a</a> ",
  journal =         "Industrial \&amp; Engineering Chemistry Research",
  pages =         "10788-10794",
  url =                 "<a href="http://pubs.acs.org/doi/abs/10.1021/ie400582a">http://pubs.acs.org/doi/abs/10.1021/ie400582a</a> ",
}
</p>

<p>
@article{mehta-2014-ident-poten,
  author =         {Mehta, Prateek and Salvador, Paul A. and Kitchin,
                  John R.},
  title =         {Identifying Potential BO2 Oxide Polymorphs for
                  Epitaxial Growth Candidates},
  journal =         {ACS Applied Materials \&amp; Interfaces},
  volume =         0,
  number =         0,
  pages =         {null},
  year =         2014,
  doi =                 {10.1021/am4059149},
  URL =                 {<a href="http://pubs.acs.org/doi/abs/10.1021/am4059149">http://pubs.acs.org/doi/abs/10.1021/am4059149</a> },
  eprint =         {<a href="http://pubs.acs.org/doi/pdf/10.1021/am4059149">http://pubs.acs.org/doi/pdf/10.1021/am4059149</a> }
}
</p>

<p>
@Article{thompson-2014-co2-react,
  author =         {Thompson, Robert L. and Albenze, Erik and Shi, Wei
                  and Hopkinson, David and Damodaran, Krishnan and
                  Lee, Anita and Kitchin, John and Luebke, David
                  Richard and Nulwala, Hunaid},
  title =         {\ce{CO_2} Reactive Ionic Liquids: Effects of
                  functional groups on the anion and its influence on
                  the physical properties},
  journal =         {RSC Adv.},
  year =         2014,
  pages =         "-",
  publisher =         {The Royal Society of Chemistry},
  doi =                 {10.1039/C3RA47097K},
  url =                 {<a href="http://dx.doi.org/10.1039/C3RA47097K">http://dx.doi.org/10.1039/C3RA47097K</a> },
  abstract =         "Next generation of gas separation materials are
                  needed to alleviate issues faced in energy and
                  environmental area. Ionic liquids (ILs) are
                  promising class of material for CO2 separations. In
                  this work{,} CO2 reactive triazolides ILs were
                  synthesized and characterized with the aim of
                  developing deeper understanding on how structural
                  changes affect the overall properties for CO2
                  separation. Important insights were gained
                  illustrating the effects of substituents on the
                  anion. It was found that substituents play a crucial
                  role in dictating the overall physical properties of
                  reactive ionic liquids. Depending upon the
                  electronic and steric nature of the substituent{,}
                  CO2 capacities between 0.07-0.4 mol CO2/mol IL were
                  observed. Detailed spectroscopic{,} CO2
                  absorption{,} rheological{,} and simulation studies
                  were carried out to understand the nature and
                  influence of these substituents. The effect of water
                  content was also evaluated{,} and it was found that
                  water had an unexpected impact on the properties of
                  these materials{,} resulting in an increased
                  viscosity{,} but little change in the CO2
                  reactivity."
}
#+END<sub>EXAMPLE</sub></p>
</div>
</div>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/02/19/Extracting-bibtex-file-from-an-org-buffer.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>]]></content:encoded>
    </item>
  </channel>
</rss>
