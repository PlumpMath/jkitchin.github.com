<?xml version="1.0" encoding="UTF-8"?>
<feed
  xmlns="http://www.w3.org/2005/Atom"
  xmlns:thr="http://purl.org/syndication/thread/1.0"
  xml:lang="en"
   >
  <title type="text">The Kitchin Research Group</title>
  <subtitle type="text">Chemical Engineering at Carnegie Mellon University</subtitle>

  <updated>2014-10-19T13:33:30Z</updated>
  <generator uri="http://blogofile.com/">Blogofile</generator>

  <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog" />
  <id>http://jkitchin.github.io/blog/feed/atom/</id>
  <link rel="self" type="application/atom+xml" href="http://jkitchin.github.io/blog/feed/atom/" />
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Using Pymacs to integrate Python into Emacs]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/10/19/Using-Pymacs-to-integrate-Python-into-Emacs" />
    <id>http://jkitchin.github.io/blog/2014/10/19/Using-Pymacs-to-integrate-Python-into-Emacs</id>
    <updated>2014-10-19T09:33:08Z</updated>
    <published>2014-10-19T09:33:08Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="python" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[Using Pymacs to integrate Python into Emacs]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/10/19/Using-Pymacs-to-integrate-Python-into-Emacs"><![CDATA[


<p>
<a href="https://github.com/pinard/Pymacs">Pymacs</a> is a project that aims to integrate Python into Emacs, and vice versa. In this post, I am going to examine the Python into Emacs integration. I cloned the git repository, ran make install, and setup my init.el file like this, as suggested in the manual.
</p>

<pre class="example">
(add-to-list 'load-path (expand-file-name "Pymacs" starter-kit-dir))
(require 'pymacs)
(autoload 'pymacs-apply "pymacs")
(autoload 'pymacs-call "pymacs")
(autoload 'pymacs-eval "pymacs" nil t)
(autoload 'pymacs-exec "pymacs" nil t)
(autoload 'pymacs-load "pymacs" nil t)
(autoload 'pymacs-autoload "pymacs")
</pre>

<p>
Pymacs provides some mapping of Python modules to emacs-lisp functions. You load modules in emacs-lisp, and then a dash-mangled version of the Python functions are available, <i>in emacs lisp</i>. Here is an example. We will load numpy, and find the maximum element of an array. For comparison, here is the Python script.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">print</span> np.max(np.array([[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>], [<span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">4</span>]]))
</pre>
</div>

<pre class="example">
4
</pre>

<p>
Now, the corresponding emacs version using Pymacs.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(pymacs-load <span style="color: #228b22;">"numpy"</span> <span style="color: #228b22;">"np-"</span>)
(np-max (np-array '((1 1) (2 4))))
</pre>
</div>

<pre class="example">
4
</pre>

<p>
Neat! The dot notation is basically replaced with dash notation, and we use a lisp list as the argument instead of an array. Otherwise, this looks almost identical. Now, let us consider something more complicated, and get the determinant of the array. We add a PREFIX to the load statement for numpy.linalg similar to what we would do in Python:
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">import</span> numpy.linalg <span style="color: #8b0000;">as</span> la
<span style="color: #8b0000;">print</span> la.det(np.array([[<span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>], [<span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">4</span>]]))
</pre>
</div>

<pre class="example">
2.0
</pre>

<p>
And in emacs-lisp:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(pymacs-load <span style="color: #228b22;">"numpy"</span> <span style="color: #228b22;">"np-"</span>)
(pymacs-load <span style="color: #228b22;">"numpy.linalg"</span> <span style="color: #228b22;">"la-"</span>)
(la-det (np-array '((1 1) (2 4))))
</pre>
</div>

<pre class="example">
2.0
</pre>

<p>
We can call functions from matplotlib to make a figure. For example:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(pymacs-load <span style="color: #228b22;">"matplotlib.pyplot"</span> <span style="color: #228b22;">"plt-"</span>)
(<span style="color: #8b0000;">let*</span> ((x  '(1 2 3 4))
       (y  (mapcar (<span style="color: #8b0000;">lambda</span> (z) (* z z)) x)))
  (plt-plot x y)
  (plt-xlabel <span style="color: #228b22;">"x values"</span>)
  (plt-ylabel <span style="color: #228b22;">"x$^2$"</span>)
  (plt-savefig <span style="color: #228b22;">"plt-pymacs.png"</span>))
</pre>
</div>


<div class="figure">
<p><img src="/media/2014-10-19-Using-Pymacs-to-integrate-Python-into-Emacs/plt-pymacs.png"> 
</p>
</div>

<p>
This was a little subtle. It was necessary to save the lists as variables, and use the variables in the plot command.
</p>

<p>
I am not sure what this offers over just having a Python block present in org-mode though. Maybe it is more useful in emacs-lisp libraries where you want to bring in some numerical analysis. Or if you have some custom library of Python you would like to use in elisp. Here is a highly contrived example. Suppose we have a Python module with this special function that converts an argument to "J":
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">def</span> <span style="color: #8b2323;">special_func</span>(x):
    <span style="color: #8b0000;">return</span> <span style="color: #228b22;">"J"</span>
</pre>
</div>

<p>
In Python, we might use it like this:
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> my_python <span style="color: #8b0000;">as</span> mp
<span style="color: #8b0000;">print</span> [mp.special_func(x) <span style="color: #8b0000;">for</span> x <span style="color: #8b0000;">in</span> [<span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">2</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">3</span>]]
</pre>
</div>

<pre class="example">
['J', 'J', 'J']
</pre>

<p>
We can import the module, and use the function in emacs-lisp too. The underscore in the function name is turned into a dash, which is a little confusing, but it works otherwise.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(pymacs-load <span style="color: #228b22;">"my_python"</span> <span style="color: #228b22;">"mp-"</span>)
(mapcar 'mp-special-func '(1 2 3))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">J</td>
<td class="left">J</td>
<td class="left">J</td>
</tr>
</tbody>
</table>


<p>
It does not seem possible to do everything though. For example, It is not clear how to pass functions through either side. For example, this does not work for fsolve, although it seems like it should. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(pymacs-load <span style="color: #228b22;">"scipy.optimize"</span> <span style="color: #228b22;">"so-"</span>)

(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">objective</span> (x)
  (- x 5))

(so-fsolve 'objective 3)
</pre>
</div>

<p>
I get an error like this:
</p>
<pre class="example">
Pymacs loading scipy.optimize...done
pymacs-report-error: Python: Emacs: "(wrong-type-argument number-or-marker-p (pymacs-python . 47))"
</pre>

<p>
The Python equivalent is here:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> scipy.optimize <span style="color: #8b0000;">import</span> fsolve
<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">objective</span>(x):
    <span style="color: #8b0000;">return</span> x - <span style="color: #000000; background-color: #cccccc; font-weight: bold;">5</span>

<span style="color: #8b0000;">print</span> fsolve(objective, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">3</span>)
</pre>
</div>

<pre class="example">
[ 5.]
</pre>

<p>
There is an open question on StackOverflow <a href="http://stackoverflow.com/questions/25471580/can-you-use-a-function-as-an-argument-to-a-python-function-in-pymacs">here</a> on this issue. Overall, I find the project very interesting. It would be awesome if you could extend emacs more easily in other languages, especially scripting languages such as Python that have numerical and plotting capabilities. Right now, this is possible in limited ways. For example, Xah Lee describes an <a href="http://ergoemacs.org/emacs/elisp_perl_wrapper.html">approach</a> where an arbitrary script can take data on stdin, process it, and output the results to stdout. Emacs can capture this and use it to modify the buffer. This uses the <code>shell-command</code> features in Emacs. These scripts could be written in Python, Perl, Ruby, etc&#x2026; This seems like a simpler and more flexible approach, except that it requires creating the shell commands and putting them on the executable path (as opposed to having Python modules on a PYTHONPATH). These lack the deep integration of documentation you get with emacs-lisp and Python functions.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/10/19/Using-Pymacs-to-integrate-Python-into-Emacs.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Generate emacs-lisp documentation]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/10/17/Generate-emacs-lisp-documentation" />
    <id>http://jkitchin.github.io/blog/2014/10/17/Generate-emacs-lisp-documentation</id>
    <updated>2014-10-17T14:39:49Z</updated>
    <published>2014-10-17T14:39:49Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="emacs_lisp" />
    <summary type="html"><![CDATA[Generate emacs-lisp documentation]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/10/17/Generate-emacs-lisp-documentation"><![CDATA[



<p>
Emacs has some pretty amazing features to get help on a function (describe-function), to navigate quickly to functions in an elisp file (speedbar and imenu). Other languages have tools for generating documentation for all the functions in a file, e.g. epydoc, javadoc, Doxygen,&#x2026; I have not found an equivalent to this in emacs-lisp. Here, we explore some options to get something similar to this. Our goal will be to take an emacs-lisp file, and generate an org-file of documentation, and then convert that to PDF for reading.
</p>

<p>
Say we have a function, jmax-bibtex-next-entry, and we want some information about it. Here are three functions that give us the argument list, documentation string, and function definition.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(help-function-arglist 'jmax-bibtex-next-entry)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">&amp;optional</td>
<td class="left">n</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(documentation 'jmax-bibtex-next-entry)
</pre>
</div>

<pre class="example">
Jump to the beginning of the next bibtex entry. N is a prefix
argument. If it is numeric, jump that many entries
forward. Negative numbers do nothing.
</pre>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(symbol-function 'jmax-bibtex-next-entry)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">lambda</td>
<td class="left">(&amp;optional n)</td>
<td class="left">Jump to the beginning of the next bibtex entry. N is a prefix\nargument. If it is numeric, jump that many entries\nforward. Negative numbers do nothing.</td>
<td class="left">(interactive P)</td>
<td class="left">(if (= (point) (save-excursion (bibtex-beginning-of-entry))) (progn (forward-char) (bibtex-next-entry)))</td>
<td class="left">(if (re-search-forward bibtex-entry-head nil t (and (numberp n) n)) (progn (bibtex-beginning-of-entry)))</td>
</tr>
</tbody>
</table>

<p>
That will not always be the code we wrote, but it is functionally similar.
</p>

<p>
So we could create an org-entry like this:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">fun2org</span> (function-symbol)
  (<span style="color: #8b0000;">let</span> ((args (help-function-arglist function-symbol))
        (doc  (documentation function-symbol))
        (code (symbol-function function-symbol)))
    (format <span style="color: #228b22;">"** %s %s</span>
<span style="color: #228b22;">%s</span>

<span style="color: #228b22;">#+BEGIN_SRC emacs-lisp</span>
<span style="color: #228b22;">%S</span>
<span style="color: #228b22;">#+END_SRC</span>
<span style="color: #228b22;">"</span> function-symbol args doc code)))

(fun2org 'jmax-bibtex-next-entry)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-org"><span style="color: #8b008b;">** jmax-bibtex-next-entry (&amp;optional n)</span>
Jump to the beginning of the next bibtex entry. N is a prefix
argument. If it is numeric, jump that many entries
forward. Negative numbers do nothing.

<span style="color: #ff0000; font-weight: bold;">#+BEGIN_SRC emacs-lisp</span>
<span style="background-color: #b0c4de;">(</span><span style="color: #8b0000; background-color: #b0c4de;">lambda</span><span style="background-color: #b0c4de;"> (</span><span style="color: #4682b4; background-color: #b0c4de;">&amp;optional</span><span style="background-color: #b0c4de;"> n) </span><span style="color: #228b22; background-color: #b0c4de;">"Jump to the beginning of the next bibtex entry. N is a prefix</span><span style="background-color: #b0c4de;">
</span><span style="color: #228b22; background-color: #b0c4de;">argument. If it is numeric, jump that many entries</span><span style="background-color: #b0c4de;">
</span><span style="color: #228b22; background-color: #b0c4de;">forward. Negative numbers do nothing."</span><span style="background-color: #b0c4de;"> (interactive </span><span style="color: #228b22; background-color: #b0c4de;">"P"</span><span style="background-color: #b0c4de;">) (</span><span style="color: #8b0000; background-color: #b0c4de;">if</span><span style="background-color: #b0c4de;"> (= (point) (</span><span style="color: #8b0000; background-color: #b0c4de;">save-excursion</span><span style="background-color: #b0c4de;"> (bibtex-beginning-of-entry))) (</span><span style="color: #8b0000; background-color: #b0c4de;">progn</span><span style="background-color: #b0c4de;"> (forward-char) (bibtex-next-entry))) (</span><span style="color: #8b0000; background-color: #b0c4de;">if</span><span style="background-color: #b0c4de;"> (re-search-forward bibtex-entry-head nil t (and (numberp n) n)) (</span><span style="color: #8b0000; background-color: #b0c4de;">progn</span><span style="background-color: #b0c4de;"> (bibtex-beginning-of-entry))))
</span><span style="color: #ff0000; font-weight: bold;">#+END_SRC</span>
</pre>
</div>

<p>
The code is not that beautifully indented, but it is optional. 
</p>

<p>
For variables, there are similar functions to get their documentation:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(documentation-property 'jmax-bibtex-journal-abbreviations 'variable-documentation)
</pre>
</div>

<pre class="example">
List of (string journal-full-name journal-abbreviation). Find abbreviations at http://cassi.cas.org/search.jsp.
</pre>

<p>
The problem still is, you have to know the variable and function names in advance. I want to take a file, and generate this for each function, and variable. 
</p>

<p>
I posted a question on <a href="http://stackoverflow.com/questions/26330363/how-do-i-get-a-list-of-functions-defined-in-an-emacs-lisp-file/26360946?iemail=1&noredirect=1#26360946">StackOverflow</a> on how to get the functions defined in a file. The most feasible suggestion was to use the variable load-history, which contains a history of the variables and functions loaded, and the files they are in.
</p>

<p>
Here is an example of getting the entries associated with jmax-bibtex.el
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(cdr (assoc <span style="color: #228b22;">"/Users/jkitchin/Dropbox/kitchingroup/jmax/jmax-bibtex.el"</span> load-history ))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(jmax-bibtex-journal-abbreviations
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-bibtex-generate-longtitles)
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-bibtex-generate-shorttitles)
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-stringify-journal-name)
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-set-journal-string)
 jmax-nonascii-latex-replacements
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-replace-nonascii)
 jmax-lower-case-words
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-title-case-article)
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-sentence-case-article)
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-bibtex-next-entry)
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-bibtex-previous-entry)
 (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">.</span> jmax-bibtex-mode-keys)
 (<span style="color: #8b0000;">provide</span> <span style="color: #cd0000;">.</span> jmax-bibtex))
</pre>
</div>

<p>
Each element in this case is either a variable, defun or provide. Here, we can use this to print some information about the variables defined in this file. I think it is sufficient to check if the element in the list is a symbol, because all the other elements are cons elements. I suppose there are other possibilities, including defcustom, defgroup, defalias, defsubst, and maybe others.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">dolist</span> (element (cdr
                  (assoc
                   <span style="color: #228b22;">"/Users/jkitchin/Dropbox/kitchingroup/jmax/jmax-bibtex.el"</span>
                   load-history )))
  (<span style="color: #8b0000;">when</span> (symbolp element)
    (princ 
    (format <span style="color: #228b22;">"%s</span>
<span style="color: #228b22;">Documentation: %s</span>

<span style="color: #228b22;">"</span> element (documentation-property element 'variable-documentation)))))
</pre>
</div>

<pre class="example">
jmax-bibtex-journal-abbreviations
Documentation: List of (string journal-full-name journal-abbreviation). Find abbreviations at http://cassi.cas.org/search.jsp.

jmax-nonascii-latex-replacements
Documentation: Cons list of non-ascii characters and their LaTeX representations

jmax-lower-case-words
Documentation: List of words to keep lowercase
</pre>

<p>
We can handle functions by checking if an element is a cons cell with a first element of defun.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">dolist</span> (element (cdr
                  (assoc
                   <span style="color: #228b22;">"/Users/jkitchin/Dropbox/kitchingroup/jmax/jmax-bibtex.el"</span>
                   load-history )))
  (<span style="color: #8b0000;">when</span> (and (consp element)
             (eq (car element) 'defun))
    (princ (format <span style="color: #228b22;">"%s is a function\n"</span> (cdr element))))))
</pre>
</div>

<pre class="example">
jmax-bibtex-generate-longtitles is a function
jmax-bibtex-generate-shorttitles is a function
jmax-stringify-journal-name is a function
jmax-set-journal-string is a function
jmax-replace-nonascii is a function
jmax-title-case-article is a function
jmax-sentence-case-article is a function
jmax-bibtex-next-entry is a function
jmax-bibtex-previous-entry is a function
jmax-bibtex-mode-keys is a function
</pre>


<p>
So, we have the important pieces to mash up what I am looking for. Let us refine the goal. I want to create a PDF documentation of what is in an elisp file with a section on variables, and a section on functions. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let*</span> ((elements (cdr
                  (assoc
                   <span style="color: #228b22;">"/Users/jkitchin/Dropbox/kitchingroup/jmax/jmax-bibtex.el"</span>
                   load-history)))
       (vars (-filter 'symbolp elements))
       (funcons (-filter (<span style="color: #8b0000;">lambda</span> (x)
                           (and (consp x)
                                (eq 'defun (car x))))
                         elements))
       (funcs (mapcar 'cdr funcons)))
  (switch-to-buffer <span style="color: #228b22;">"*org-doc*"</span>)
  (erase-buffer)
  (insert (format <span style="color: #228b22;">"#+TITLE: Documentation for %s</span>
<span style="color: #228b22;">#+OPTIONS: toc:nil</span>
<span style="color: #228b22;">\\maketitle</span>
<span style="color: #228b22;">\\tableofcontents</span>
<span style="color: #228b22;">"</span> <span style="color: #228b22;">"/Users/jkitchin/Dropbox/kitchingroup/jmax/jmax-bibtex.el"</span>))
  (insert <span style="color: #228b22;">"* Variables\n"</span>)
  (<span style="color: #8b0000;">dolist</span> (var (sort vars 'string-lessp))
    (insert (format <span style="color: #228b22;">"** %s</span>
<span style="color: #228b22;">Documentation: %s\n\n"</span> var  (documentation-property var 'variable-documentation))))

  (insert <span style="color: #228b22;">"* Functions\n\n"</span>)
  (<span style="color: #8b0000;">dolist</span> (funcs (sort funcs 'string-lessp))
    (insert (format <span style="color: #228b22;">"** %s %s</span>
<span style="color: #228b22;">Documentation: %s</span>

<span style="color: #228b22;">Code:</span>
<span style="color: #228b22;">#+BEGIN_SRC emacs-lisp</span>
<span style="color: #228b22;">%S</span>
<span style="color: #228b22;">#+END_SRC</span>
<span style="color: #228b22;">"</span>
                    funcs
                    (or (help-function-arglist funcs) <span style="color: #228b22;">""</span>)
                    (documentation funcs)
                    (symbol-function funcs))))

  (org-mode)
  (write-file <span style="color: #228b22;">"jmax-bibtex-doc.org"</span>)
  (org-export-to-file 'latex <span style="color: #228b22;">"jmax-bibtex-doc.tex"</span>)
  (org-latex-compile <span style="color: #228b22;">"jmax-bibtex-doc.tex"</span>)
  (kill-buffer <span style="color: #228b22;">"*org-doc*"</span>)
  (kill-buffer <span style="color: #228b22;">"jmax-bibtex-doc.org"</span>))
</pre>
</div>

<p>
Here is the resulting pdf: <a href="/media/2014-10-17-Generate-emacs-lisp-documentation/jmax-bibtex-doc.pdf">jmax-bibtex-doc.pdf</a> . It is not too bad. The code is not beautiful, and it would take some work to get that looking nice. It might be nice to find all instances of '` and replace them with links to variable names, but I leave that for another day. There is also no information about the header comments, but I leave this for another day to.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/10/17/Generate-emacs-lisp-documentation.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Sentence casing your bibtex entry journal titles]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/10/14/Sentence-casing-your-bibtex-entry-journal-titles" />
    <id>http://jkitchin.github.io/blog/2014/10/14/Sentence-casing-your-bibtex-entry-journal-titles</id>
    <updated>2014-10-14T08:48:19Z</updated>
    <published>2014-10-14T08:48:19Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="bib" />
    <summary type="html"><![CDATA[Sentence casing your bibtex entry journal titles]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/10/14/Sentence-casing-your-bibtex-entry-journal-titles"><![CDATA[



<p>
I previously talked about <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/10/12/Title-casing-bibtex-entry-journal-titles/">title-casing</a> the titles of journal articles in bibtex entries. Here we describe an alternative transformation: sentence-casing. In sentence case the first word is capitalized, and all others (except proper nouns). We also should capitalize the first word of any subtitles, which we take to be the first word after a :. That is usually correct. We should also ignore any LaTeX commands, or protected words in the title.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">jmax-sentence-case-article</span> (<span style="color: #4682b4;">&amp;optional</span> key start end)
  <span style="color: #228b22;">"Convert a bibtex entry article title to sentence-case. The</span>
<span style="color: #228b22;">arguments are optional, and are only there so you can use this</span>
<span style="color: #228b22;">function with `</span><span style="color: #cd0000;">bibtex-map-entries</span><span style="color: #228b22;">' to change all the title</span>
<span style="color: #228b22;">entries in articles."</span>
  (interactive)
  (bibtex-beginning-of-entry)

  (<span style="color: #8b0000;">let*</span> ((title (bibtex-autokey-get-field <span style="color: #228b22;">"title"</span>))
         (words (split-string title))
         (start 0))
    (<span style="color: #8b0000;">when</span>
        (string= <span style="color: #228b22;">"article"</span> (downcase (cdr (assoc <span style="color: #228b22;">"=type="</span> (bibtex-parse-entry)))))
      (setq words (mapcar
                   (<span style="color: #8b0000;">lambda</span> (word)
                     (<span style="color: #8b0000;">if</span>
                         ;; <span style="color: #ff0000; font-weight: bold;">match words containing {} or \ which are probably</span>
                         ;; <span style="color: #ff0000; font-weight: bold;">LaTeX or protected words</span>
                         (string-match <span style="color: #228b22;">"\\$</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">|</span><span style="color: #228b22;">{</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">|</span><span style="color: #228b22;">}</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">|</span><span style="color: #228b22;">\\\\"</span> word)
                         word
                       (s-downcase word)))
                   words))
      
      ;; <span style="color: #ff0000; font-weight: bold;">capitalize first word</span>
      (setf (car words) (s-capitalize (car words)))

      ;; <span style="color: #ff0000; font-weight: bold;">join the words</span>
      (setq title (mapconcat 'identity words <span style="color: #228b22;">" "</span>))

      ;; <span style="color: #ff0000; font-weight: bold;">capitalize a word after a :, eg. a subtitle, and protect it</span>
      (<span style="color: #8b0000;">while</span>
          (string-match <span style="color: #228b22;">"[a-z]:\\s-+</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">(</span><span style="color: #228b22;">[A-Z]</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">)</span><span style="color: #228b22;">"</span> title start)
        (<span style="color: #8b0000;">let</span> ((char (substring title (match-beginning 1) (match-end 1))))
          (setf (substring title (match-beginning 1) (match-end 1))
                (format <span style="color: #228b22;">"%s"</span> (upcase char)))
          (setq start (match-end 1))))
            
      ;; <span style="color: #ff0000; font-weight: bold;">this is defined in doi-utils</span>
      (bibtex-set-field
       <span style="color: #228b22;">"title"</span> title)

      ;; <span style="color: #ff0000; font-weight: bold;">clean and refill entry so it looks nice</span>
      (bibtex-clean-entry)
      (bibtex-fill-entry))))
</pre>
</div>

<pre class="example">
jmax-sentence-case-article
</pre>

<p>
Now, we can easily convert this entry in title-case:
</p>
<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #8b2323;">@article</span>{<span style="color: #cd0000;">arroyave-2005-ab-ni</span>,
  <span style="color: #8b008b;">author</span> =       {R. Arroyave and D. Shin and Z.-K. Liu},
  <span style="color: #8b008b;">title</span> =        {Ab Initio Thermodynamic Properties of Stoichiometric
                  Phases in the {Ni-Al} System},
  <span style="color: #8b008b;">journal</span> =      {Acta Materialia },
  <span style="color: #8b008b;">volume</span> =       53,
  <span style="color: #8b008b;">number</span> =       6,
  <span style="color: #8b008b;">pages</span> =        {1809 - 1819},
  <span style="color: #8b008b;">year</span> =         2005,
  <span style="color: #8b008b;">doi</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">10.1016/j.actamat.2004.12.030</span>},
  <span style="color: #8b008b;">url</span> =
                  {http://www.sciencedirect.com/science/article/pii/S1359645404007669},
  <span style="color: #8b008b;">issn</span> =         {1359-6454},
  <span style="color: #8b008b;">keywords</span> =     {Ab initio},
}
</pre>
</div>

<p>
To this in sentence case:
</p>
<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #8b2323;">@article</span>{<span style="color: #cd0000;">arroyave-2005-ab-ni</span>,
  <span style="color: #8b008b;">author</span> =       {R. Arroyave and D. Shin and Z.-K. Liu},
  <span style="color: #8b008b;">title</span> =        {Ab initio thermodynamic properties of stoichiometric
                  phases in the {Ni-Al} system},
  <span style="color: #8b008b;">journal</span> =      {Acta Materialia },
  <span style="color: #8b008b;">volume</span> =       53,
  <span style="color: #8b008b;">number</span> =       6,
  <span style="color: #8b008b;">pages</span> =        {1809 - 1819},
  <span style="color: #8b008b;">year</span> =         2005,
  <span style="color: #8b008b;">doi</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">10.1016/j.actamat.2004.12.030</span>},
  <span style="color: #8b008b;">url</span> =
                  {http://www.sciencedirect.com/science/article/pii/S1359645404007669},
  <span style="color: #8b008b;">issn</span> =         {1359-6454},
  <span style="color: #8b008b;">keywords</span> =     {Ab initio},
}
</pre>
</div>

<p>
The function is written so you can use it with bibtex-map-entries to change all the titles in one shot like this:
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #ff0000; font-weight: bold;">% (bibtex-map-entries 'jmax-sentence-case-article)</span>
</pre>
</div>

<p>
The function is <i>not</i> perfect. For example in this next entry, the chemical symbols Mn, Fe, Co, Ni, are incorrectly lower-cased.
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #8b2323;">@article</span>{<span style="color: #cd0000;">arroyo-2010-first-princ</span>,
  <span style="color: #8b008b;">author</span> =       {Arroyo y de Dompablo, M. E. and Lee, Yueh-Lin and
                  Morgan, D.},
  <span style="color: #8b008b;">title</span> =        {First principles investigation of oxygen vacancies
                  in columbite \ce{MNb_2O_6} ({M = Mn, Fe, Co, Ni,
                  Cu})},
  <span style="color: #8b008b;">journal</span> =      {Chemistry of Materials},
  <span style="color: #8b008b;">volume</span> =       22,
  <span style="color: #8b008b;">number</span> =       3,
  <span style="color: #8b008b;">pages</span> =        {906-913},
  <span style="color: #8b008b;">year</span> =         2010,
  <span style="color: #8b008b;">doi</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">10.1021/cm901723j</span>},
  <span style="color: #8b008b;">url</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">http://pubs.acs.org/doi/abs/10.1021/cm901723j</span>},
  <span style="color: #8b008b;">eprint</span> =       {http://pubs.acs.org/doi/pdf/10.1021/cm901723j},
}
</pre>
</div>

<p>
Here is the result of sentence casing:
</p>
<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #8b2323;">@article</span>{<span style="color: #cd0000;">arroyo-2010-first-princ</span>,
  <span style="color: #8b008b;">author</span> =       {Arroyo y de Dompablo, M. E. and Lee, Yueh-Lin and
                  Morgan, D.},
  <span style="color: #8b008b;">title</span> =        {First principles investigation of oxygen vacancies
                  in columbite \ce{MNb_2O_6} ({M = mn, fe, co, ni,
                  Cu})},
  <span style="color: #8b008b;">journal</span> =      {Chemistry of Materials},
  <span style="color: #8b008b;">volume</span> =       22,
  <span style="color: #8b008b;">number</span> =       3,
  <span style="color: #8b008b;">pages</span> =        {906-913},
  <span style="color: #8b008b;">year</span> =         2010,
  <span style="color: #8b008b;">doi</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">10.1021/cm901723j</span>},
  <span style="color: #8b008b;">url</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">http://pubs.acs.org/doi/abs/10.1021/cm901723j</span>},
  <span style="color: #8b008b;">eprint</span> =       {http://pubs.acs.org/doi/pdf/10.1021/cm901723j},
}
</pre>
</div>

<p>
The Cu is not lower-cased because it has a } attached to it after the title is split into words. The original entry is not properly formatted, in my opinion. I was lazy in wrapping the whole string in braces, {M = Mn, Fe, Co, Ni, Cu}, to protect the capitalization of the elements in bibtex. The correct way to do this is the more verbose: {M} = {M}n, {F}e, {C}o, {N}i, {C}u, where each letter is individually protected.
</p>

<p>
Still, the function can save a lot of keystrokes. You should still inspect the final results, to catch any unusual modifications. You do have your bibtex file under version control right?
</p>

<p>
This function can also be found at <a href="https://github.com/jkitchin/jmax/blob/master/jmax-bibtex.el">https://github.com/jkitchin/jmax/blob/master/jmax-bibtex.el</a> .
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/10/14/Sentence-casing-your-bibtex-entry-journal-titles.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Navigating your bibtex file]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/10/13/Navigating-your-bibtex-file" />
    <id>http://jkitchin.github.io/blog/2014/10/13/Navigating-your-bibtex-file</id>
    <updated>2014-10-13T10:22:27Z</updated>
    <published>2014-10-13T10:22:27Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="bibtex" />
    <summary type="html"><![CDATA[Navigating your bibtex file]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/10/13/Navigating-your-bibtex-file"><![CDATA[



<p>
You may be able to tell I am spending some time cleaning up bibtex files these days. One of the things I need to do is navigate around a bibtex file easily. There are some built-in navigation keys within an entry.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">navigation</th>
<th scope="col" class="left">key strokes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">next field</td>
<td class="left">C-j</td>
</tr>

<tr>
<td class="left">end of field</td>
<td class="left">TAB</td>
</tr>

<tr>
<td class="left">beginning of entry</td>
<td class="left">C-M-a</td>
</tr>

<tr>
<td class="left">end of entry</td>
<td class="left">C-M-e</td>
</tr>
</tbody>
</table>

<p>
I am not aware of an easy way to navigate to the next or previous entry though. I would like something simple to do that. There is a regexp defined in bibtex "bibtex-entry-head", to search for the next or previous entry.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">bibtex-entry-head
</pre>
</div>

<pre class="example">
^[      ]*\(@[  ]*\(?:\(?:Article\|Book\(?:let\)?\|In\(?:Book\|Collection\|Proceedings\)\|M\(?:a\(?:nual\|stersThesis\)\|isc\)\|P\(?:\(?:hdThesi\|roceeding\)s\)\|TechReport\|Unpublished\)\)\)[        ]*[({][         
]*\([][[:alnum:].:;?!`'/*@+|()&lt;&gt;&amp;_^$-]+\)
</pre>

<p>
Here are two functions that do it. This was a little more subtle than I anticipated.  The subtlety comes about if you are at the beginning of the entry, we need to move the cursor by a character, and then search forward because of the way re-search-forward works. I also wrote in an option for a prefix argument, so you can go forward or backward several entries.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">bibtex-next-entry</span> (<span style="color: #4682b4;">&amp;optional</span> n)
  <span style="color: #228b22;">"Jump to the beginning of the next bibtex entry. N is a prefix</span>
<span style="color: #228b22;">argument. If it is numeric, jump that many entries</span>
<span style="color: #228b22;">forward. Negative numbers do nothing."</span>
  (interactive <span style="color: #228b22;">"P"</span>)
  ;; <span style="color: #ff0000; font-weight: bold;">Note if we start at the beginning of an entry, nothing</span>
  ;; <span style="color: #ff0000; font-weight: bold;">happens. We need to move forward a char, and call again.</span>
  (<span style="color: #8b0000;">when</span> (= (point) (<span style="color: #8b0000;">save-excursion</span>
                     (bibtex-beginning-of-entry)))
    (forward-char)
    (bibtex-next-entry))

  ;; <span style="color: #ff0000; font-weight: bold;">search forward for an entry </span>
  (<span style="color: #8b0000;">when</span> 
      (re-search-forward bibtex-entry-head nil t (and (numberp n) n))
    ;; <span style="color: #ff0000; font-weight: bold;">go to beginning of the entry</span>
    (bibtex-beginning-of-entry)))


(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">bibtex-previous-entry</span> (<span style="color: #4682b4;">&amp;optional</span> n)
  <span style="color: #228b22;">"Jump to beginning of the previous bibtex entry. N is a prefix</span>
<span style="color: #228b22;">argument. If it is numeric, jump that many entries back."</span>
  (interactive <span style="color: #228b22;">"P"</span>)
  (bibtex-beginning-of-entry)
 (<span style="color: #8b0000;">when</span> 
     (re-search-backward bibtex-entry-head nil t (and (numberp n) n))
   (bibtex-beginning-of-entry)))
</pre>
</div>

<pre class="example">
bibtex-previous-entry
</pre>

<p>
That is pretty simple. Let us go ahead and bind these to M-n, and M-p, but only in bibtex-mode. Thanks to <a href="http://ergoemacs.org/emacs/emacs_set_keys_for_major_mode.html">Xah Lee</a> for this idea. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">jmax-bibtex-mode-keys</span> ()
  <span style="color: #228b22;">"Modify keymaps used by `</span><span style="color: #cd0000;">bibtex-mode</span><span style="color: #228b22;">'."</span>
  (local-set-key (kbd <span style="color: #228b22;">"M-n"</span>) 'bibtex-next-entry)
  (local-set-key (kbd <span style="color: #228b22;">"M-p"</span>) 'bibtex-previous-entry))

;; <span style="color: #ff0000; font-weight: bold;">add to bibtex-mode-hook</span>
(add-hook 'bibtex-mode-hook 'jmax-bibtex-mode-keys)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">jmax-bibtex-mode-keys</td>
</tr>
</tbody>
</table>

<p>
Now, C-n moves forward an entry, C-u 2 C-n moves you two entries, etc&#x2026; and C-p moves you back an entry, while C-u 2 C-p moves you back two entries. 
</p>

<p>
Finally, I sometimes want to jump to a field in an entry. Basically, I want a completion enabled function that lists the fields in the current entry, and then jumps to the selected field. Yes, you could simply do an incremental search forward or backward that is about as simple. But, then I would not get to remind myself how to do a completion command ;)
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">jmax-bibtex-get-fields</span> ()
  <span style="color: #228b22;">"Get a list of fields in a bibtex entry."</span>
  (bibtex-beginning-of-entry)
  (remove <span style="color: #228b22;">"=type="</span>
          (remove <span style="color: #228b22;">"=key="</span>
                  (mapcar 'car (bibtex-parse-entry)))))

(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">jmax-bibtex-jump-to-field</span> (field)
  <span style="color: #228b22;">"Jump to FIELD in the current bibtex entry"</span>
  (interactive
   (list
    (ido-completing-read <span style="color: #228b22;">"Field: "</span> (jmax-bibtex-get-fields))))
  (<span style="color: #8b0000;">save-restriction</span>
    (bibtex-narrow-to-entry)
    (bibtex-beginning-of-entry)
    (<span style="color: #8b0000;">when</span>
        ;; <span style="color: #ff0000; font-weight: bold;">fields start with spaces, a field name, possibly more</span>
        ;; <span style="color: #ff0000; font-weight: bold;">spaces, then =</span>
        (re-search-forward (format <span style="color: #228b22;">"^\\s-*%s\\s-*="</span> field) nil t))))
</pre>
</div>

<pre class="example">
jmax-bibtex-jump-to-field
</pre>

<p>
These functions live in <a href="https://github.com/jkitchin/jmax/blob/master/jmax-bibtex.el">https://github.com/jkitchin/jmax/blob/master/jmax-bibtex.el</a> , which is the version we use on a regular basis.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/10/13/Navigating-your-bibtex-file.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Title casing bibtex entry journal titles]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/10/12/Title-casing-bibtex-entry-journal-titles" />
    <id>http://jkitchin.github.io/blog/2014/10/12/Title-casing-bibtex-entry-journal-titles</id>
    <updated>2014-10-12T09:23:17Z</updated>
    <published>2014-10-12T09:23:17Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="bibtex" />
    <summary type="html"><![CDATA[Title casing bibtex entry journal titles]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/10/12/Title-casing-bibtex-entry-journal-titles"><![CDATA[



<p>
I mostly love bibtex. You keep bibliographic entries in a central file, and you can cite them in your writing. Bibtex takes care of <i>most</i> of the formatting for you, but not always all of it. Lately, we have been writing some manuscripts for submission to ACS journals. They want the titles of journal articles included in the bibliography, preferrably in title-case, or in sentence case, but all the same format either way. Unfortunately, the achemso.bst bibtex format does not make this happen. You have to title-case or sentence case the titles themselves in your bibtex file. Well, at least we can get Emacs to do the heavy lifting on that for us. 
</p>

<p>
First, the manual approach. Open your bibtex file, navigate to a title field, put your cursor on the first letter of the title, and press M-c until you get to the end of the title. That runs (capitalize-word). For a few titles, you might just do this. It does not take long.
</p>

<p>
For a lot of entries though, you might prefer some code to do it. Here we consider how to convert all article titles to Title case. The current code can be found at <a href="https://github.com/jkitchin/jmax/blob/master/jmax-bibtex.el">https://github.com/jkitchin/jmax/blob/master/jmax-bibtex.el</a> .
</p>

<p>
First, we need to decide on some rules. We will capitalize every word in a title except for words like a, an, the, &#x2026; unless they start the title. We do not want to change words with $, {} in them, or \, because these are either protected or LaTeX commands and we probably do not want to change them. The gist of our idea is to get the title, split it into words, capitalize each word that needs to be,  join the words together, and then set the entry title to the new capitalized title. 
</p>

<p>
We use functions from <a href="https://github.com/magnars/s.el">s.el</a> , and <a href="https://github.com/jkitchin/jmax/blob/master/org/doi-utils.org">doi-utils.org</a> here.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defvar</span> <span style="color: #8b008b;">jmax-lower-case-words</span>
  '(<span style="color: #228b22;">"a"</span> <span style="color: #228b22;">"an"</span> <span style="color: #228b22;">"on"</span> <span style="color: #228b22;">"and"</span> <span style="color: #228b22;">"for"</span>
    <span style="color: #228b22;">"the"</span> <span style="color: #228b22;">"of"</span> <span style="color: #228b22;">"in"</span>)
  <span style="color: #228b22;">"List of words to keep lowercase"</span>)

(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">jmax-title-case-article</span> (<span style="color: #4682b4;">&amp;optional</span> key start end)
  <span style="color: #228b22;">"Convert a bibtex entry article title to title-case. The</span>
<span style="color: #228b22;">arguments are optional, and are only there so you can use this</span>
<span style="color: #228b22;">function with `</span><span style="color: #cd0000;">bibtex-map-entries</span><span style="color: #228b22;">' to change all the title</span>
<span style="color: #228b22;">entries in articles."</span>
  (interactive)
  (bibtex-beginning-of-entry)

  (<span style="color: #8b0000;">let*</span> ((title (bibtex-autokey-get-field <span style="color: #228b22;">"title"</span>))
         (words (split-string title))
         (lower-case-words '(<span style="color: #228b22;">"a"</span> <span style="color: #228b22;">"an"</span> <span style="color: #228b22;">"on"</span> <span style="color: #228b22;">"and"</span> <span style="color: #228b22;">"for"</span>
                             <span style="color: #228b22;">"the"</span> <span style="color: #228b22;">"of"</span> <span style="color: #228b22;">"in"</span>)))
    (<span style="color: #8b0000;">when</span>
        (string= <span style="color: #228b22;">"article"</span> (downcase (cdr (assoc <span style="color: #228b22;">"=type="</span> (bibtex-parse-entry)))))
      (setq words (mapcar
                   (<span style="color: #8b0000;">lambda</span> (word)
                     (<span style="color: #8b0000;">if</span> (or
                          ;; <span style="color: #ff0000; font-weight: bold;">match words containing {} or \ which are probably</span>
                          ;; <span style="color: #ff0000; font-weight: bold;">LaTeX or protected words</span>
                          (string-match <span style="color: #228b22;">"\\$</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">|</span><span style="color: #228b22;">{</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">|</span><span style="color: #228b22;">}</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">|</span><span style="color: #228b22;">\\\\"</span> word)
                          ;; <span style="color: #ff0000; font-weight: bold;">these words should not be capitalized, unless they</span>
                          ;; <span style="color: #ff0000; font-weight: bold;">are the first word</span>
                          (-contains? lower-case-words (s-downcase word)))
                         word
                       (s-capitalize word)))
                   words))

      ;; <span style="color: #ff0000; font-weight: bold;">Check if first word should be capitalized</span>
      (<span style="color: #8b0000;">when</span> (-contains? jmax-lower-case-words (car words))
        (setf (car words) (s-capitalize (car words))))
            
      ;; <span style="color: #ff0000; font-weight: bold;">this is defined in doi-utils</span>
      (bibtex-set-field
       <span style="color: #228b22;">"title"</span>
       (mapconcat 'identity words <span style="color: #228b22;">" "</span>))
      (bibtex-fill-entry))))
</pre>
</div>

<pre class="example">
jmax-title-case-article
</pre>


<p>
Now, a single command converts this:
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #8b2323;">@article</span>{<span style="color: #cd0000;">campbell-2013-enthal-entrop</span>,
  <span style="color: #8b008b;">author</span> =       {Charles T. Campbell and Jason R. V. Sellers},
  <span style="color: #8b008b;">title</span> =        {Enthalpies and entropies of adsorption on
                  well-defined oxide surfaces: experimental
                  measurements},
  <span style="color: #8b008b;">journal</span> =      CR,
  <span style="color: #8b008b;">volume</span> =       113,
  <span style="color: #8b008b;">number</span> =       6,
  <span style="color: #8b008b;">pages</span> =        {4106-4135},
  <span style="color: #8b008b;">year</span> =         2013,
  <span style="color: #8b008b;">doi</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">10.1021/cr300329s</span>},
  <span style="color: #8b008b;">url</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">http://dx.doi.org/10.1021/cr300329s</span>},
  <span style="color: #8b008b;">month</span> =        6,
}
</pre>
</div>

<p>
to this:
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #8b2323;">@article</span>{<span style="color: #cd0000;">campbell-2013-enthal-entrop</span>,
  <span style="color: #8b008b;">author</span> =       {Charles T. Campbell and Jason R. V. Sellers},
  <span style="color: #8b008b;">title</span> =        {Enthalpies and Entropies of Adsorption on
                  Well-defined Oxide Surfaces: Experimental
                  Measurements},
  <span style="color: #8b008b;">journal</span> =      CR,
  <span style="color: #8b008b;">volume</span> =       113,
  <span style="color: #8b008b;">number</span> =       6,
  <span style="color: #8b008b;">pages</span> =        {4106-4135},
  <span style="color: #8b008b;">year</span> =         2013,
  <span style="color: #8b008b;">doi</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">10.1021/cr300329s</span>},
  <span style="color: #8b008b;">url</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">http://dx.doi.org/10.1021/cr300329s</span>},
  <span style="color: #8b008b;">month</span> =        6,
}
</pre>
</div>

<p>
We wrote the title case function so we can use it with bibtex-map-entries. That means we can fix every entry in a file by putting a comment at the top like this:
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #ff0000; font-weight: bold;">% (bibtex-map-entries 'jmax-title-case-article)  &lt;- put cursor here. C-x C-e</span>
</pre>
</div>

<p>
The function is not perfect, and does not include every word that should not be capitalized. You will still want to review your entries, but hopefully this saves some typing in the end.</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/10/12/Title-casing-bibtex-entry-journal-titles.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Abbreviated journal names in bibtex]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/10/11/Abbreviated-journal-names-in-bibtex" />
    <id>http://jkitchin.github.io/blog/2014/10/11/Abbreviated-journal-names-in-bibtex</id>
    <updated>2014-10-11T17:31:59Z</updated>
    <published>2014-10-11T17:31:59Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="bibtex" />
    <summary type="html"><![CDATA[Abbreviated journal names in bibtex]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/10/11/Abbreviated-journal-names-in-bibtex"><![CDATA[



<p>
Some journals require abbreviated journal names in the bibliography, and some require full names. Unfortunately, it is not possible to have both in your bibtex file. Or is it&#x2026;
</p>

<p>
It is possible to define a <a href="http://www.bibtex.org/Format/">@string</a> that is replaced in your bibtex file. If we have the definition of the @string in a separate file, we can specify its definition there, e.g. as an abbreviation, or as the full name. To make this useful, we need a simple way to add new journals, and to generate the definitions. 
</p>

<p>
First, you can find accepted journal name abbreviations here: <a href="http://cassi.cas.org/search.jsp">http://cassi.cas.org/search.jsp</a> . 
</p>

<p>
We are going to define a variable to hold the string definition, journal full name and an abbreviation. You can find our production version of what follows here: <a href="https://github.com/jkitchin/jmax/blob/master/jmax-bibtex.el">https://github.com/jkitchin/jmax/blob/master/jmax-bibtex.el</a> 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defvar</span> <span style="color: #8b008b;">jmax-bibtex-abbreviations</span>
  '((<span style="color: #228b22;">"ACAT"</span> <span style="color: #228b22;">"ACS Catalysis"</span> <span style="color: #228b22;">"ACS Catal."</span>)
    (<span style="color: #228b22;">"AM"</span> <span style="color: #228b22;">"Acta Materialia"</span> <span style="color: #228b22;">"Acta Mater."</span>)
    (<span style="color: #228b22;">"AMM"</span> <span style="color: #228b22;">"Acta Metallurgica et Materialia"</span> <span style="color: #228b22;">"Acta Metall. Mater."</span>)
    (<span style="color: #228b22;">"AMiner"</span> <span style="color: #228b22;">"American Mineralogist"</span> <span style="color: #228b22;">"Am. Mineral."</span>)
    (<span style="color: #228b22;">"AngC"</span> <span style="color: #228b22;">"Angewandte Chemie-International Edition"</span> <span style="color: #228b22;">"Angew. Chem. Int. Edit."</span>)
    (<span style="color: #228b22;">"APLM"</span> <span style="color: #228b22;">"APL Materials"</span> <span style="color: #228b22;">"APL Mat."</span>)
    (<span style="color: #228b22;">"ACBE"</span> <span style="color: #228b22;">"Applied Catalysis B: Environmental"</span> <span style="color: #228b22;">"Appl. Catal. B-Environ."</span>)
    (<span style="color: #228b22;">"APL"</span> <span style="color: #228b22;">"Applied Physics Letters"</span> <span style="color: #228b22;">"Appl. Phys. Lett."</span>)
    (<span style="color: #228b22;">"ASS"</span> <span style="color: #228b22;">"Applied Surface Science"</span> <span style="color: #228b22;">"Appl. Surf. Sci."</span>)
    (<span style="color: #228b22;">"CL"</span> <span style="color: #228b22;">"Catalysis Letters"</span> <span style="color: #228b22;">"Catal. Lett."</span>)
    (<span style="color: #228b22;">"CT"</span> <span style="color: #228b22;">"Catalysis Today"</span> <span style="color: #228b22;">"Catal. Today"</span>)
    (<span style="color: #228b22;">"CPL"</span> <span style="color: #228b22;">"Chemical Physics Letters"</span> <span style="color: #228b22;">"Chem. Phys. Lett"</span>)
    (<span style="color: #228b22;">"CR"</span> <span style="color: #228b22;">"Chemical Reviews"</span> <span style="color: #228b22;">"Chem. Rev."</span>)
    (<span style="color: #228b22;">"CSR"</span> <span style="color: #228b22;">"Chemical Society Reviews"</span> <span style="color: #228b22;">"Chem. Soc. Rev."</span>)
    (<span style="color: #228b22;">"CSR"</span> <span style="color: #228b22;">"Chemical Society Reviews"</span> <span style="color: #228b22;">"Chem. Soc. Rev."</span>)
    (<span style="color: #228b22;">"CM"</span> <span style="color: #228b22;">"Chemistry of Materials"</span> <span style="color: #228b22;">"Chem. Mater."</span>)
    (<span style="color: #228b22;">"CSA"</span> <span style="color: #228b22;">"Colloids and Surfaces, A: Physicochemical and Engineering Aspects"</span> <span style="color: #228b22;">"Colloids Surf., A"</span>)
    (<span style="color: #228b22;">"CPMS"</span> <span style="color: #228b22;">"Computational Materials Science"</span> <span style="color: #228b22;">"Comp. Mater. Sci."</span>)
    (<span style="color: #228b22;">"CPC"</span> <span style="color: #228b22;">"Computer Physics Communications"</span> <span style="color: #228b22;">"Comput. Phys. Commun."</span>)
    (<span style="color: #228b22;">"CGD"</span> <span style="color: #228b22;">"Crystal Growth \\&amp; Design"</span> <span style="color: #228b22;">"Cryst. Growth Des."</span>)
    (<span style="color: #228b22;">"CEC"</span> <span style="color: #228b22;">"CrystEngComm"</span> <span style="color: #228b22;">"CrystEngComm"</span>)
    (<span style="color: #228b22;">"ECST"</span> <span style="color: #228b22;">"ECS Transactions"</span> <span style="color: #228b22;">"ECS Trans."</span>)
    (<span style="color: #228b22;">"EES"</span> <span style="color: #228b22;">"Energy \\&amp; Environmental Science"</span> <span style="color: #228b22;">"Energy Environ. Sci."</span>)
    (<span style="color: #228b22;">"HPR"</span> <span style="color: #228b22;">"High Pressure Research"</span> <span style="color: #228b22;">"High Pressure Res."</span>)
    (<span style="color: #228b22;">"IC"</span> <span style="color: #228b22;">"Inorganic Chemistry"</span> <span style="color: #228b22;">"Inorg. Chem."</span>)
    (<span style="color: #228b22;">"IECR"</span> <span style="color: #228b22;">"Industrial \\&amp; Engineering Chemistry Research"</span> <span style="color: #228b22;">"Ind. Eng. Chem. Res."</span>)
    (<span style="color: #228b22;">"JJAP"</span> <span style="color: #228b22;">"Japanese Journal of Applied Physics"</span> <span style="color: #228b22;">"Jpn. J. Appl. Phys."</span>)
    (<span style="color: #228b22;">"JMatR"</span> <span style="color: #228b22;">"Journal of  Materials Research"</span> <span style="color: #228b22;">"J. Mater. Res."</span>)
    (<span style="color: #228b22;">"JALC"</span> <span style="color: #228b22;">"Journal of Alloys and Compounds"</span> <span style="color: #228b22;">"J. Alloy Compd."</span>)
    (<span style="color: #228b22;">"JAC"</span> <span style="color: #228b22;">"Journal of Applied Crystallography"</span> <span style="color: #228b22;">"J. Appl. Crystallogr."</span>)
    (<span style="color: #228b22;">"JAP"</span> <span style="color: #228b22;">"Journal of Applied Physics"</span> <span style="color: #228b22;">"J. Appl. Phys."</span>)
    (<span style="color: #228b22;">"JC"</span> <span style="color: #228b22;">"Journal of Catalysis"</span> <span style="color: #228b22;">"J. Catal."</span>)
    (<span style="color: #228b22;">"JCP"</span> <span style="color: #228b22;">"Journal of Chemical Physics"</span> <span style="color: #228b22;">"J. Chem. Phys."</span>)
    (<span style="color: #228b22;">"JCG"</span> <span style="color: #228b22;">"Journal of Crystal Growth"</span> <span style="color: #228b22;">"J. Crys. Growth"</span>)
    (<span style="color: #228b22;">"JMC"</span> <span style="color: #228b22;">"Journal of Materials Chemistry"</span> <span style="color: #228b22;">"J. Mater. Chem."</span>)
    (<span style="color: #228b22;">"JMC"</span> <span style="color: #228b22;">"Journal of Materials Chemistry"</span> <span style="color: #228b22;">"J. Mater. Chem."</span>)
    (<span style="color: #228b22;">"JMSL"</span> <span style="color: #228b22;">"Journal of Materials Science Letters"</span> <span style="color: #228b22;">"J. Mater. Sci. Lett."</span>)
    (<span style="color: #228b22;">"JMS"</span> <span style="color: #228b22;">"Journal of Membrane Science"</span> <span style="color: #228b22;">"J. Memb. Sci."</span>)
    (<span style="color: #228b22;">"JPE"</span> <span style="color: #228b22;">"Journal of Phase Equilibria"</span> <span style="color: #228b22;">"J. Phase Equilib."</span>)
    (<span style="color: #228b22;">"JPCS"</span> <span style="color: #228b22;">"Journal of Physics and Chemistry of Solids"</span> <span style="color: #228b22;">"J. Phys. Chem. Solids"</span>)
    (<span style="color: #228b22;">"JPCM"</span> <span style="color: #228b22;">"Journal of Physics: Condensed Matter"</span> <span style="color: #228b22;">"J. Phys.: Condens. Matter"</span>)
    (<span style="color: #228b22;">"JSSC"</span> <span style="color: #228b22;">"Journal of Solid State Chemistry"</span> <span style="color: #228b22;">"J. Solid State Chem."</span>)
    (<span style="color: #228b22;">"JACerS"</span> <span style="color: #228b22;">"Journal of the American Ceramic Society"</span> <span style="color: #228b22;">"J. Am. Ceram. Soc."</span>)
    (<span style="color: #228b22;">"JACS"</span> <span style="color: #228b22;">"Journal of the American Chemical Society"</span> <span style="color: #228b22;">"J. Am. Chem. Soc."</span>)
    (<span style="color: #228b22;">"JES"</span> <span style="color: #228b22;">"Journal of The Electrochemical Society"</span> <span style="color: #228b22;">"J. Electrochem. Soc."</span>)
    (<span style="color: #228b22;">"JES"</span> <span style="color: #228b22;">"Journal of The Electrochemical Society"</span> <span style="color: #228b22;">"J. Electrochem. Soc."</span>)
    (<span style="color: #228b22;">"JMS"</span> <span style="color: #228b22;">"Journal of Membrane Science"</span> <span style="color: #228b22;">"J. Memb. Sci."</span>)
    (<span style="color: #228b22;">"JVST"</span> <span style="color: #228b22;">"Journal of Vacuum Science \\&amp; Technology A"</span> <span style="color: #228b22;">"J. Vac. Sci. Technol. A"</span>)
    (<span style="color: #228b22;">"ML"</span> <span style="color: #228b22;">"Materials Letters"</span> <span style="color: #228b22;">"Mater. Lett."</span>)
    (<span style="color: #228b22;">"MSE-BS"</span> <span style="color: #228b22;">"Materials Science and Engineering B"</span> <span style="color: #228b22;">"Mat. Sci. Eng. B-Solid"</span>)
    (<span style="color: #228b22;">"MOLSIM"</span> <span style="color: #228b22;">"Molecular Simulation"</span> <span style="color: #228b22;">"Mol. Sim."</span>)
    (<span style="color: #228b22;">"Nature"</span> <span style="color: #228b22;">"Nature"</span> <span style="color: #228b22;">"Nature"</span>)
    (<span style="color: #228b22;">"NM"</span> <span style="color: #228b22;">"Nature Materials"</span> <span style="color: #228b22;">"Nat. Mater."</span>)
    (<span style="color: #228b22;">"PML"</span> <span style="color: #228b22;">"Philosophical Magazine Letters"</span> <span style="color: #228b22;">"Phil. Mag. Lett."</span>)
    (<span style="color: #228b22;">"PMA"</span> <span style="color: #228b22;">"Philosophical Magazine A"</span> <span style="color: #228b22;">"Phil. Mag. A"</span>)
    (<span style="color: #228b22;">"PA"</span> <span style="color: #228b22;">"Physica A: Statistical Mechanics and its Applications"</span> <span style="color: #228b22;">"Physica A"</span>)
    (<span style="color: #228b22;">"PB"</span> <span style="color: #228b22;">"Physica B-Condensed Matter"</span> <span style="color: #228b22;">"Physica B"</span>)
    (<span style="color: #228b22;">"PCCP"</span> <span style="color: #228b22;">"Physical Chemistry Chemical Physics"</span> <span style="color: #228b22;">"Phys. Chem. Chem. Phys."</span>)
    (<span style="color: #228b22;">"PSSB"</span> <span style="color: #228b22;">"physica status solidi (b)"</span> <span style="color: #228b22;">"Phys. Status Solidi B"</span>)
    (<span style="color: #228b22;">"PRA"</span> <span style="color: #228b22;">"Physical Review A"</span> <span style="color: #228b22;">"Phys. Rev. A"</span>)
    (<span style="color: #228b22;">"PRB"</span> <span style="color: #228b22;">"Physical Review B"</span> <span style="color: #228b22;">"Phys. Rev. B"</span>)
    (<span style="color: #228b22;">"PRL"</span> <span style="color: #228b22;">"Physical Review Letters"</span> <span style="color: #228b22;">"Phys. Rev. Lett."</span>)
    (<span style="color: #228b22;">"PCM"</span> <span style="color: #228b22;">"Physics and Chemistry of Minerals"</span> <span style="color: #228b22;">"Phys. Chem. Miner."</span>)
    (<span style="color: #228b22;">"PSurfSci"</span> <span style="color: #228b22;">"Progress in Surface Science"</span> <span style="color: #228b22;">"Prog. Surf. Sci."</span>)
    (<span style="color: #228b22;">"Science"</span> <span style="color: #228b22;">"Science"</span> <span style="color: #228b22;">"Science"</span>)
    (<span style="color: #228b22;">"SABC"</span> <span style="color: #228b22;">"Sensors and Actuators B: Chemical"</span> <span style="color: #228b22;">"Sensor. Actuat. B-Chem."</span>)
    (<span style="color: #228b22;">"SS"</span> <span style="color: #228b22;">"Surface Science"</span> <span style="color: #228b22;">"Surf. Sci."</span>)
    (<span style="color: #228b22;">"EPJB"</span> <span style="color: #228b22;">"The European Physical Journal B"</span> <span style="color: #228b22;">"Eur. Phys. J. B"</span>)
    (<span style="color: #228b22;">"JPC"</span> <span style="color: #228b22;">"The Journal of Physical Chemistry"</span> <span style="color: #228b22;">"J. Phys. Chem."</span>)
    (<span style="color: #228b22;">"JPCB"</span> <span style="color: #228b22;">"The Journal of Physical Chemistry  B"</span> <span style="color: #228b22;">"J. Phys. Chem. B"</span>)
    (<span style="color: #228b22;">"JPCC"</span> <span style="color: #228b22;">"The Journal of Physical Chemistry C"</span> <span style="color: #228b22;">"J. Phys. Chem. C"</span>)
    (<span style="color: #228b22;">"JCP"</span> <span style="color: #228b22;">"The Journal of Chemical Physics"</span> <span style="color: #228b22;">"J. Chem. Phys."</span>)
    (<span style="color: #228b22;">"TSF"</span> <span style="color: #228b22;">"Thin Solid Films"</span> <span style="color: #228b22;">"Thin Solid Films"</span>)
    (<span style="color: #228b22;">"TC"</span> <span style="color: #228b22;">"Topics in Catalysis"</span> <span style="color: #228b22;">"Top. Catal."</span>)
    (<span style="color: #228b22;">"WR"</span> <span style="color: #228b22;">"Water Research"</span> <span style="color: #228b22;">"Water Res."</span>))
  <span style="color: #228b22;">"List of (string journal-full-name journal-abbreviation)"</span>)
</pre>
</div>

<pre class="example">
bibtex-abbreviations
</pre>

<p>
This data structure will serve a few purposes.
</p>

<ol class="org-ol">
<li>We will generate the bib files that define the @string definitions
</li>
<li>We will use it to modify bibtex files to use those strings.
</li>
</ol>

<p>
First, here are some simple functions to generate the @string definitions.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">jmax-bibtex-generate-longtitles</span> ()
  (interactive)
  (<span style="color: #8b0000;">with-temp-file</span> <span style="color: #228b22;">"longtitles.bib"</span>
    (<span style="color: #8b0000;">dolist</span> (row bibtex-abbreviations)
      (insert (format <span style="color: #228b22;">"@string{%s=\"%s\"}\n"</span>
                      (nth 0 row)
                      (nth 1 row))))))

(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">jmax-bibtex-generate-shorttitles</span> ()
  (interactive)
  (<span style="color: #8b0000;">with-temp-file</span> <span style="color: #228b22;">"shorttitles.bib"</span>
    (<span style="color: #8b0000;">dolist</span> (row bibtex-abbreviations)
      (insert (format <span style="color: #228b22;">"@string{%s=\"%s\"}\n"</span>
                      (nth 0 row)
                      (nth 2 row))))))
</pre>
</div>

<pre class="example">
jmax-bibtex-generate-shorttitles
</pre>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(jmax-bibtex-generate-longtitles)
(jmax-bibtex-generate-shorttitles)
</pre>
</div>

<p>
Here are the results of running that code: <a href="/media/2014-10-11-Abbreviated-journal-names-in-bibtex/shorttitles.bib">shorttitles.bib</a> and <a href="/media/2014-10-11-Abbreviated-journal-names-in-bibtex/longtitles.bib">longtitles.bib</a> . This is the first step. We have the @strings defined. Now, we need to convert the names in a bibtex entry to use our string. We want to replace full names and abbreviated names with the @string.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">jmax-stringify-journal-name</span> (<span style="color: #4682b4;">&amp;optional</span> key start end)
  <span style="color: #228b22;">"replace journal name with a string. The strings are defined in `</span><span style="color: #cd0000;">bibtex-abbreviations</span><span style="color: #228b22;">'."</span>
  (interactive)
  (bibtex-beginning-of-entry)
  (<span style="color: #8b0000;">when</span>
      (string= <span style="color: #228b22;">"article"</span>
               (downcase
                (cdr (assoc <span style="color: #228b22;">"=type="</span> (bibtex-parse-entry)))))
    (<span style="color: #8b0000;">let*</span> ((full-names (mapcar
                        (<span style="color: #8b0000;">lambda</span> (row)
                          (cons  (nth 1 row) (nth 0 row)))
                        bibtex-abbreviations))
           (abbrev-names (mapcar
                          (<span style="color: #8b0000;">lambda</span> (row)
                            (cons  (nth 2 row) (nth 0 row)))
                          bibtex-abbreviations))
           (journal (s-trim (bibtex-autokey-get-field <span style="color: #228b22;">"journal"</span>)))
           (bstring (or
                     (cdr (assoc journal full-names))
                     (cdr (assoc journal abbrev-names)))))
      (<span style="color: #8b0000;">when</span> bstring
        (bibtex-set-field <span style="color: #228b22;">"journal"</span> bstring t)
        (bibtex-fill-entry)))))
</pre>
</div>

<pre class="example">
jmax-stringify-journal-name
</pre>

<p>
Now, with a single command, we can convert this:
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #8b2323;">@article</span>{<span style="color: #cd0000;">lizzit-2001-surfac-ru</span>,
  <span style="color: #8b008b;">author</span> =       {S. Lizzit and A. Baraldi and A. Groso and K. Reuter
                  and M. Ganduglia-Pirovano and C. Stampfl and
                  M. Scheffler and M. Stichler and C. Keller and
                  W. Wurth and D. Menzel},
  <span style="color: #8b008b;">title</span> =        {Surface Core-level Shifts of Clean and
                  Oxygen-covered {R}u(0001)},
  <span style="color: #8b008b;">journal</span> =      {Physical Review B,
  <span style="color: #8b008b;">volume</span> =       63,
  <span style="color: #8b008b;">number</span> =       20,
  <span style="color: #8b008b;">pages</span> =        {nil},
  <span style="color: #8b008b;">year</span> =         2001,
  <span style="color: #8b008b;">doi</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">10.1103/physrevb.63.205419</span>},
  <span style="color: #8b008b;">url</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">http://dx.doi.org/10.1103/PhysRevB.63.205419</span>},
  <span style="color: #8b008b;">month</span> =        5,
}
</pre>
</div>

<p>
into this:
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #8b2323;">@article</span>{<span style="color: #cd0000;">lizzit-2001-surfac-ru</span>,
  <span style="color: #8b008b;">author</span> =       {S. Lizzit and A. Baraldi and A. Groso and K. Reuter
                  and M. Ganduglia-Pirovano and C. Stampfl and
                  M. Scheffler and M. Stichler and C. Keller and
                  W. Wurth and D. Menzel},
  <span style="color: #8b008b;">title</span> =        {Surface Core-level Shifts of Clean and
                  Oxygen-covered {R}u(0001)},
  <span style="color: #8b008b;">journal</span> =      PRB,
  <span style="color: #8b008b;">volume</span> =       63,
  <span style="color: #8b008b;">number</span> =       20,
  <span style="color: #8b008b;">pages</span> =        {nil},
  <span style="color: #8b008b;">year</span> =         2001,
  <span style="color: #8b008b;">doi</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">10.1103/physrevb.63.205419</span>},
  <span style="color: #8b008b;">url</span> =          {<span style="color: #3a5fcd; text-decoration: underline;">http://dx.doi.org/10.1103/PhysRevB.63.205419</span>},
  <span style="color: #8b008b;">month</span> =        5,
}
</pre>
</div>

<p>
If you have a lot of entries you want to modify, you can use bibtex-map-entries like this. Basically, put the elisp form in a comment, and then execute the elisp form
</p>

<div class="org-src-container">

<pre class="src src-bibtex"><span style="color: #ff0000; font-weight: bold;">%% (bibtex-map-entries 'jmax-stringify-journal-name)  &lt;- put cursor here. C-x C-e</span>
</pre>
</div>

<p>
This saves some effort. Over time, I will keep adding entries to the abbreviation table. As long as a standard journal name or abbreviation is in your bibtex file, this approach should work pretty well. After you replace the journal names with @string entries, you have to generate the string file, either shorttitles.bib or longtitles.bib, and in your LaTeX file, change your bibliography line to:
</p>

<div class="org-src-container">

<pre class="src src-latex"><span style="color: #8b0000;">\bibliography</span>{<span style="color: #cd0000;">shorttitles,references</span>}
</pre>
</div>

<p>
The order is important. The @string definitions are in shorttitles.bib, and your bibtex entries in references.bib.</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/10/11/Abbreviated-journal-names-in-bibtex.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Editing org-mode python source blocks in an external editor (Canopy)]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/09/28/Editing-org-mode-python-source-blocks-in-an-external-editor-Canopy" />
    <id>http://jkitchin.github.io/blog/2014/09/28/Editing-org-mode-python-source-blocks-in-an-external-editor-Canopy</id>
    <updated>2014-09-28T14:41:49Z</updated>
    <published>2014-09-28T14:41:49Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="python" />
    <summary type="html"><![CDATA[Editing org-mode python source blocks in an external editor (Canopy)]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/09/28/Editing-org-mode-python-source-blocks-in-an-external-editor-Canopy"><![CDATA[


<p>
Continuing on the <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/09/27/Improved-debugging-of-Python-code-blocks-in-org-mode/">last post</a> about leveraging org-mode and python syntax checkers, here we consider using (heresy alert&#x2026;) an external editor for Python src blocks in org-mode. Why would we consider such insanity? Because, for beginners, environments such as Canopy are (IMHO) easier to use, and better than anything I have used in Emacs. And, I still want the framework of org-mode for content, just a better Python code writing environment.
</p>

<p>
This problem has some interesting challenges. I would like a command that opens a code block with its contents in the Canopy editor, or that creates a code block if needed. We need to figure out that context based on the cursor position. We will use the same temporary file strategy as used before, so Canopy has something to read and save to. We need to wait for Canopy to finish, which will be tricky because it returns as soon as you run it. Finally, I want the code block to run after it is put back in the org-file, so that the results are captured. 
</p>

<p>
This code block implements the idea, and the comments in the code explain what each section is doing.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">edit-in-canopy</span> ()
  (interactive)
  (<span style="color: #8b0000;">let*</span> ((eop (org-element-at-point))
         ;; <span style="color: #ff0000; font-weight: bold;">use current directory for temp file so relative paths work</span>
         (temporary-file-directory <span style="color: #228b22;">"."</span>)
         (tempfile))

    ;; <span style="color: #ff0000; font-weight: bold;">create a tempfile. </span>
    (setq tempfile (make-temp-file <span style="color: #228b22;">"canopy"</span> nil <span style="color: #228b22;">".py"</span>))

    ;; <span style="color: #ff0000; font-weight: bold;">figure out what to do</span>
    (<span style="color: #8b0000;">when</span>
        ;; <span style="color: #ff0000; font-weight: bold;">in an existing source block. we want to edit it.</span>
        (and (eq 'src-block (car eop))
             (string= <span style="color: #228b22;">"python"</span> (org-element-property <span style="color: #cd0000;">:language</span> eop)))
          
      ;; <span style="color: #ff0000; font-weight: bold;">put code into tempfile</span>
      (<span style="color: #8b0000;">with-temp-file</span> tempfile
        (insert (org-element-property <span style="color: #cd0000;">:value</span> eop))))

    ;; <span style="color: #ff0000; font-weight: bold;">open tempfile in canopy</span>
    (shell-command (concat <span style="color: #228b22;">"canopy "</span> tempfile))
    (sleep-for 2) ;; <span style="color: #ff0000; font-weight: bold;">startup time. canopy is slow to showup in</span>
                  ;; <span style="color: #ff0000; font-weight: bold;">ps. This gives it some time to do that. Canopy</span>
                  ;; <span style="color: #ff0000; font-weight: bold;">returns right away, so we sleep while there is</span>
                  ;; <span style="color: #ff0000; font-weight: bold;">evidence that it is open. We get that evidence</span>
                  ;; <span style="color: #ff0000; font-weight: bold;">from ps by searching for canopy.app.main, which</span>
                  ;; <span style="color: #ff0000; font-weight: bold;">seems to exist in the output while Canopy is</span>
                  ;; <span style="color: #ff0000; font-weight: bold;">open.</span>
    (<span style="color: #8b0000;">while</span>
        (string-match <span style="color: #228b22;">"canopy\.app\.main"</span>
                      (shell-command-to-string <span style="color: #228b22;">"ps aux"</span>))
      ;; <span style="color: #ff0000; font-weight: bold;">pause a while, then check again.</span>
      (sleep-for 1))

    ;; <span style="color: #ff0000; font-weight: bold;">Canopy has closed, so we get the new script contents</span>
    (<span style="color: #8b0000;">let</span> ((new-contents (<span style="color: #8b0000;">with-temp-buffer</span>
                          (insert-file-contents tempfile)
                          (buffer-string))))
      (<span style="color: #8b0000;">cond</span>
       ;; <span style="color: #ff0000; font-weight: bold;">replace existing code block contents</span>
       ((and (eq 'src-block (car eop))
             (string= <span style="color: #228b22;">"python"</span> (org-element-property <span style="color: #cd0000;">:language</span> eop)))
        (goto-char (org-element-property <span style="color: #cd0000;">:begin</span> eop))
        (search-forward (org-element-property <span style="color: #cd0000;">:value</span> eop))
        (replace-match (concat new-contents <span style="color: #228b22;">"\n"</span>)))
       ;; <span style="color: #ff0000; font-weight: bold;">create new code block</span>
       (t
        (insert
         (format <span style="color: #228b22;">"\n#+BEGIN_SRC python</span>
<span style="color: #228b22;">%s</span>
<span style="color: #228b22;">#+END_SRC</span>
<span style="color: #228b22;">"</span> new-contents))
        ;; <span style="color: #ff0000; font-weight: bold;">go into new block so we can run it.</span>
        (previous-line 2))))

    ;; <span style="color: #ff0000; font-weight: bold;">delete the tempfile so they do not accumulate</span>
    (delete-file tempfile)
    ;; <span style="color: #ff0000; font-weight: bold;">and run the new block to get the results</span>
    (org-babel-execute-src-block)))
</pre>
</div>

<pre class="example">
edit-in-canopy
</pre>

<p>
That seems to work. It is difficult to tell from this post the function works as advertised. You can see it in action here: <a href="http://www.youtube.com/watch?v=-noKrT1dfFE">http://www.youtube.com/watch?v=-noKrT1dfFE</a> .
</p>


<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> scipy.integrate <span style="color: #8b0000;">import</span> odeint


<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">dydx</span>(y, x):
    <span style="color: #000000; background-color: #cccccc; font-weight: bold;">k</span> = <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>
    <span style="color: #8b0000;">return</span> -k * y

<span style="color: #8b0000;">print</span> odeint(dydx, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>, [<span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>])

<span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">print</span> np.exp(-<span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>)
</pre>
</div>

<pre class="example">
[[ 1.        ]
 [ 0.36787947]]
0.367879441171
</pre>



<p>
We created this code block externally.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">print</span> <span style="color: #228b22;">'hello'</span>
</pre>
</div>

<pre class="example">
hello
</pre>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Summary thoughts</h2>
<div class="outline-text-2" id="text-1">
<p>
Opening Canopy is a little slow (and that is coming from someone who opens Emacs ;). But, once it is open it is pretty nice for writing code, with the interactive Ipython console, and integrated help. Yes, it is probably possible to get Emacs to do that too, and maybe it will do that one day. Canopy does it today.
</p>

<p>
Unfortunately, this code will not work on Windows, most likely, since it relies on the ps program. There does seem to be a tasklist function in Windows that is similar, but it seems that Canopy runs as pythonw in that function, which is not very specific.</p>
</div>
</div>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/09/28/Editing-org-mode-python-source-blocks-in-an-external-editor-(Canopy).org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Improved debugging of Python code blocks in org-mode]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/09/27/Improved-debugging-of-Python-code-blocks-in-org-mode" />
    <id>http://jkitchin.github.io/blog/2014/09/27/Improved-debugging-of-Python-code-blocks-in-org-mode</id>
    <updated>2014-09-27T15:27:40Z</updated>
    <published>2014-09-27T15:27:40Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="python" />
    <summary type="html"><![CDATA[Improved debugging of Python code blocks in org-mode]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/09/27/Improved-debugging-of-Python-code-blocks-in-org-mode"><![CDATA[


<p>
Writing and running code blocks in org-mode is awesome, when it works. I find as the code blocks get past a certain size though, it can be tedious to debug, especially for new users. Since I am teaching 59 students to use Python in org-mode, I see this issue a lot! They lack experience to avoid many simple errors, and to find and fix them. Even in my hands, I do not always want to be switching to Python mode to run and debug blocks. 
</p>

<p>
org-mode src-blocks offer a unique challenge for the usual tools like pylint and pychecker, because the code does not exist in a file. In this post, I will explore developing some functions that do syntax checking on a src block. We will use a simple method which will write the block to a temporary file, and to the checking on that block. Then, we will create temporary buffers with the output.
</p>

<p>
Here is the first idea. We create a temp file in the working directory, write the code to it, and run pychecker, pyflakes and pep8 on the file. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">org-pychecker</span> ()
  <span style="color: #228b22;">"Run pychecker on a source block"</span>
  (interactive)
  (<span style="color: #8b0000;">let</span> ((eop (org-element-at-point))
        (temporary-file-directory <span style="color: #228b22;">"."</span>)
        (tempfile))
    (<span style="color: #8b0000;">when</span> (and (eq 'src-block (car eop))
               (string= <span style="color: #228b22;">"python"</span> (org-element-property <span style="color: #cd0000;">:language</span> eop)))
      (setq tempfile (make-temp-file <span style="color: #228b22;">"pychecker"</span> nil <span style="color: #228b22;">".py"</span>))
      ;; <span style="color: #ff0000; font-weight: bold;">create code file</span>
      (<span style="color: #8b0000;">with-temp-file</span> tempfile
        (insert (org-element-property <span style="color: #cd0000;">:value</span> eop)))
      (switch-to-buffer <span style="color: #228b22;">"*pychecker*"</span>)
      (erase-buffer)
      (insert <span style="color: #228b22;">"pychecker\n=================\n"</span>)
      (insert
       (shell-command-to-string (format <span style="color: #228b22;">"pychecker %s"</span> (file-name-nondirectory tempfile))))
      (insert <span style="color: #228b22;">"\npyflakes\n=================\n"</span>)
      (insert
       (shell-command-to-string (format <span style="color: #228b22;">"pyflakes %s"</span> (file-name-nondirectory tempfile))))
      (insert <span style="color: #228b22;">"\npep8\n=================\n"</span>)
      (insert
       (shell-command-to-string (format <span style="color: #228b22;">"pep8 %s"</span> (file-name-nondirectory tempfile))))
      (delete-file tempfile))))
</pre>
</div>

<p>
Here is a sample code block with some errors in it.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #000000; background-color: #cccccc; font-weight: bold;">a</span> = <span style="color: #000000; background-color: #cccccc; font-weight: bold;">5</span>  <span style="color: #ff0000; font-weight: bold;"># a variable we do not use</span>


<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">f</span>(x, y):  <span style="color: #ff0000; font-weight: bold;"># unused argument</span>
    <span style="color: #8b0000;">return</span> x - b <span style="color: #ff0000; font-weight: bold;"># undefined variable</span>

<span style="color: #8b0000;">print</span> <span style="color: #000000; background-color: #cccccc; font-weight: bold;">6</span> * c
</pre>
</div>

<p>
On the code block above, that function leads to this output.
</p>

<pre class="example">
pychecker
=================
Processing module pychecker63858xo0 (pychecker63858xo0.py)...
  Caught exception importing module pychecker63858xo0:
    File "/Users/jkitchin/Library/Enthought/Canopy_64bit/User/lib/python2.7/site-packages/pychecker/pcmodules.py", line 540, in setupMainCode()
      module = imp.load_module(self.moduleName, handle, filename, smt)
    File "pychecker63858xo0.py", line 7, in &lt;module&gt;()
      print 6 * c
  NameError: name 'c' is not defined

Warnings...

pychecker63858xo0:1: NOT PROCESSED UNABLE TO IMPORT

pyflakes
=================
pychecker63858xo0.py:5: undefined name 'b'
pychecker63858xo0.py:7: undefined name 'c'

pep8
=================
pychecker63858xo0.py:5:17: E261 at least two spaces before inline comment
</pre>

<p>
That is pretty helpful, but it gives us line numbers we cannot directly access in our code block. We can open the code block in Python mode, and then navigate to them, but that is likely to make the buffer with this information disappear. It would be better if we could just click on a link and go to the right place. Let us explore what we need for that. 
</p>

<p>
We need to parse the output to get the line numbers, and then we can construct org-links to those places in the src block. pyflakes, pep8 and pylint look like the easiest to get. A way to get to the line would be a lisp function that moves to the beginning of the code block, and then moves forward n lines. We will use a regular expression on each line of the output of pyflakes and pep8 to get the line number. We will construct an org-link to go to the source block at the line. 
</p>

<p>
In this long code block, we create a function that will run pyflakes, pep8 and pylint, and create a new buffer with links to the issues it finds. Finally, we apply this as advice on executing org-babel-execute:python so it only runs when we execute a python block in org-mode. This is a long block, because I have made it pretty feature complete. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">org-py-check</span> ()
  <span style="color: #228b22;">"Run python check programs on a source block.</span>
<span style="color: #228b22;">Opens a buffer with links to what is found."</span>
  (interactive)
  (<span style="color: #8b0000;">let</span> ((eop (org-element-at-point))
        (temporary-file-directory <span style="color: #228b22;">"."</span>)
        (cb (current-buffer))
        (n) ; <span style="color: #ff0000; font-weight: bold;">for line number</span>
        (content) ; <span style="color: #ff0000; font-weight: bold;">error on line</span>
        (pb <span style="color: #228b22;">"*org pycheck*"</span>)
        (pyflakes-status nil)
        (link)
        (tempfile))

    (<span style="color: #8b0000;">unless</span> (executable-find <span style="color: #228b22;">"pyflakes"</span>)
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #228b22;">"pyflakes is not installed."</span>))
    
    (<span style="color: #8b0000;">unless</span> (executable-find <span style="color: #228b22;">"pep8"</span>)
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #228b22;">"pep8 not installed"</span>))

    (<span style="color: #8b0000;">unless</span> (executable-find <span style="color: #228b22;">"pylint"</span>)
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #228b22;">"pylint not installed"</span>))

    ;; <span style="color: #ff0000; font-weight: bold;">rm buffer if it exists</span>
    (<span style="color: #8b0000;">when</span> (get-buffer pb) (kill-buffer pb))
    
    ;; <span style="color: #ff0000; font-weight: bold;">only run if in a python code-block</span>
    (<span style="color: #8b0000;">when</span> (and (eq 'src-block (car eop))
               (string= <span style="color: #228b22;">"python"</span> (org-element-property <span style="color: #cd0000;">:language</span> eop)))

      ;; <span style="color: #ff0000; font-weight: bold;">tempfile for the code</span>
      (setq tempfile (make-temp-file <span style="color: #228b22;">"pychecker"</span> nil <span style="color: #228b22;">".py"</span>))
      ;; <span style="color: #ff0000; font-weight: bold;">create code file</span>
      (<span style="color: #8b0000;">with-temp-file</span> tempfile
        (insert (org-element-property <span style="color: #cd0000;">:value</span> eop)))
      
      (<span style="color: #8b0000;">let</span> ((status (shell-command
                     (format <span style="color: #228b22;">"pyflakes %s"</span> (file-name-nondirectory tempfile))))
            (output (delete <span style="color: #228b22;">""</span> (split-string
                                (<span style="color: #8b0000;">with-current-buffer</span> <span style="color: #228b22;">"*Shell Command Output*"</span>
                                  (buffer-string)) <span style="color: #228b22;">"\n"</span>))))
        (setq pyflakes-status status)
        (kill-buffer <span style="color: #228b22;">"*Shell Command Output*"</span>)
        (<span style="color: #8b0000;">when</span> output
          (set-buffer (get-buffer-create pb))
          (insert (format <span style="color: #228b22;">"\n* pyflakes output (status=%s)</span>
<span style="color: #228b22;">pyflakes checks your code for errors. You should probably fix all of these.</span>

<span style="color: #228b22;">"</span> status))
          (<span style="color: #8b0000;">dolist</span> (line output)
            ;; <span style="color: #ff0000; font-weight: bold;">get the line number</span>
            (<span style="color: #8b0000;">if</span> 
                (string-match (format <span style="color: #228b22;">"^%s:</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">(</span><span style="color: #228b22;">[0-9]*</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">)</span><span style="color: #228b22;">:</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">(</span><span style="color: #228b22;">.*</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">)</span><span style="color: #228b22;">"</span>
                                      (file-name-nondirectory tempfile))
                              line)
                (<span style="color: #8b0000;">progn</span>
                  (setq n (match-string 1 line))
                  (setq content (match-string 2 line))
                  (setq link (format <span style="color: #228b22;">"[[elisp:(progn (switch-to-buffer-other-window \"%s\")(goto-char %s)(forward-line %s))][%s]]\n"</span>
                                     cb
                                     (org-element-property <span style="color: #cd0000;">:begin</span> eop)
                                     n
                                     (format <span style="color: #228b22;">"Line %s: %s"</span> n content))))
              ;; <span style="color: #ff0000; font-weight: bold;">no match, just insert line</span>
              (setq link (concat line <span style="color: #228b22;">"\n"</span>)))
            (insert link))))

      (<span style="color: #8b0000;">let</span> ((status (shell-command
                     (format <span style="color: #228b22;">"pep8 %s"</span> (file-name-nondirectory tempfile))))
            (output (delete <span style="color: #228b22;">""</span> (split-string
                                (<span style="color: #8b0000;">with-current-buffer</span> <span style="color: #228b22;">"*Shell Command Output*"</span>
                                  (buffer-string)) <span style="color: #228b22;">"\n"</span>))))
        (kill-buffer <span style="color: #228b22;">"*Shell Command Output*"</span>)
        (<span style="color: #8b0000;">when</span> output
          (set-buffer (get-buffer-create pb))
          (insert (format <span style="color: #228b22;">"\n\n* pep8 output (status = %s)\n"</span> status))
          (insert <span style="color: #228b22;">"pep8 is the [[http://legacy.python.org/dev/peps/pep-0008][officially recommended style]] for writing Python code. Fixing these will usually make your code more readable and beautiful. Your code will probably run if you do not fix them, but, it will be ugly.</span>

<span style="color: #228b22;">"</span>)
          (<span style="color: #8b0000;">dolist</span> (line output)
            ;; <span style="color: #ff0000; font-weight: bold;">get the line number</span>
            (<span style="color: #8b0000;">if</span> 
                (string-match (format <span style="color: #228b22;">"^%s:</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">(</span><span style="color: #228b22;">[0-9]*</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">)</span><span style="color: #228b22;">:</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">(</span><span style="color: #228b22;">.*</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">)</span><span style="color: #228b22;">"</span>
                                      (file-name-nondirectory tempfile))
                              line)
                (<span style="color: #8b0000;">progn</span>
                  (setq n (match-string 1 line))
                  (setq content (match-string 2 line))
                  (setq link (format <span style="color: #228b22;">"[[elisp:(progn (switch-to-buffer-other-window \"%s\")(goto-char %s)(forward-line %s))][%s]]\n"</span>
                                     cb
                                     (org-element-property <span style="color: #cd0000;">:begin</span> eop)
                                     n
                                     (format <span style="color: #228b22;">"Line %s: %s"</span> n content))))
              ;; <span style="color: #ff0000; font-weight: bold;">no match, just insert line</span>
              (setq link (concat line <span style="color: #228b22;">"\n"</span>)))
            (insert link))))

      ;; <span style="color: #ff0000; font-weight: bold;">pylint</span>
      (<span style="color: #8b0000;">let</span> ((status (shell-command
                     (format <span style="color: #228b22;">"pylint -r no %s"</span> (file-name-nondirectory tempfile))))
            (output (delete <span style="color: #228b22;">""</span> (split-string
                                (<span style="color: #8b0000;">with-current-buffer</span> <span style="color: #228b22;">"*Shell Command Output*"</span>
                                  (buffer-string)) <span style="color: #228b22;">"\n"</span>))))
        (kill-buffer <span style="color: #228b22;">"*Shell Command Output*"</span>)
        (<span style="color: #8b0000;">when</span> output
          (set-buffer (get-buffer-create pb))
          (insert (format <span style="color: #228b22;">"\n\n* pylint (status = %s)\n"</span> status))
          (insert <span style="color: #228b22;">"pylint checks your code for errors, style and convention. It is complementary to pyflakes and pep8, and usually more detailed.</span>

<span style="color: #228b22;">"</span>)

          (<span style="color: #8b0000;">dolist</span> (line output)
            ;; <span style="color: #ff0000; font-weight: bold;">pylint gives a line and column number</span>
            (<span style="color: #8b0000;">if</span> 
                (string-match <span style="color: #228b22;">"[A-Z]:\\s-+</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">(</span><span style="color: #228b22;">[0-9]*</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">)</span><span style="color: #228b22;">,\\s-*</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">(</span><span style="color: #228b22;">[0-9]*</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">)</span><span style="color: #228b22;">:</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">(</span><span style="color: #228b22;">.*</span><span style="color: #228b22;">\\</span><span style="color: #228b22;">)</span><span style="color: #228b22;">"</span>                            
                              line)
                (<span style="color: #8b0000;">let</span> ((line-number (match-string 1 line))
                      (column-number (match-string 2 line))
                      (content (match-string 3 line)))
                     
                  (setq link (format <span style="color: #228b22;">"[[elisp:(progn (switch-to-buffer-other-window \"%s\")(goto-char %s)(forward-line %s)(forward-line 0)(forward-char %s))][%s]]\n"</span>
                                     cb
                                     (org-element-property <span style="color: #cd0000;">:begin</span> eop)
                                     line-number
                                     column-number
                                     line)))
              ;; <span style="color: #ff0000; font-weight: bold;">no match, just insert line</span>
              (setq link (concat line <span style="color: #228b22;">"\n"</span>)))
            (insert link))))
    
      (<span style="color: #8b0000;">when</span> (get-buffer pb)
        (switch-to-buffer-other-window pb)
        (goto-char (point-min))
        (insert <span style="color: #228b22;">"Press q to close the window\n"</span>)
        (org-mode)       
        (org-cycle '(64))
        ;; <span style="color: #ff0000; font-weight: bold;">make read-only and press q to quit</span>
        (setq buffer-read-only t)
        (use-local-map (copy-keymap org-mode-map))
        (local-set-key <span style="color: #228b22;">"q"</span> #'(<span style="color: #8b0000;">lambda</span> () (interactive) (kill-buffer))))

      (<span style="color: #8b0000;">unless</span> (= 0 pyflakes-status)
        (forward-line 4)
        (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #228b22;">"pyflakes exited non-zero. please fix errors"</span>))
      ;; <span style="color: #ff0000; font-weight: bold;">final cleanup and delete file</span>
      (delete-file tempfile)
      (switch-to-buffer-other-window cb))))


(<span style="color: #8b0000;">defadvice</span> <span style="color: #8b2323;">org-babel-execute:python</span> (before pychecker)
  (org-py-check))

(ad-activate 'org-babel-execute:python)
</pre>
</div>

<pre class="example">
org-babel-execute:python
</pre>

<p>
Now, when I try to run this code block, which has some errors in it:
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #000000; background-color: #cccccc; font-weight: bold;">a</span> = <span style="color: #000000; background-color: #cccccc; font-weight: bold;">5</span>  <span style="color: #ff0000; font-weight: bold;"># a variable we do not use</span>


<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">f</span>(x, y):  <span style="color: #ff0000; font-weight: bold;"># unused argument</span>
    <span style="color: #8b0000;">return</span> x - b <span style="color: #ff0000; font-weight: bold;"># undefined</span>

<span style="color: #8b0000;">print</span> <span style="color: #000000; background-color: #cccccc; font-weight: bold;">6</span> * c
</pre>
</div>

<p>
I get a new buffer with approximately these contents:
</p>

<div class="org-src-container">

<pre class="src src-org">Press q to close the window

<span style="color: #8b2323;">* pyflakes output (status=1)</span>
pyflakes checks your code for errors. You should probably fix all of these.

<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 5))">Line 5:  undefined name 'b'</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 7))">Line 7:  undefined name 'c'</a></span>


<span style="color: #8b2323;">* pep8 output (status = 1)</span>
pep8 is the <span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="http://legacy.python.org/dev/peps/pep-0008">officially recommended style</a></span> for writing Python code. Fixing these will usually make your code more readable and beautiful. Your code will probably run if you do not fix them, but, it will be ugly.

<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 5))">Line 5: 17: E261 at least two spaces before inline comment</a></span>


<span style="color: #8b2323;">* pylint (status = 22)pylint checks your code for errors, style and convention. It is complementary to pyflakes and pep8, and usually more detailed.</span>

No config file found, using default configuration
<span style="color: #4682b4;">************* Module pychecker68224dkX</span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 1)(forward-line 0)(forward-char 0))">C:  1, 0: Invalid module name "pychecker68224dkX" (invalid-name)</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 1)(forward-line 0)(forward-char 0))">C:  1, 0: Missing module docstring (missing-docstring)</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 1)(forward-line 0)(forward-char 0))">C:  1, 0: Invalid constant name "a" (invalid-name)</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 4)(forward-line 0)(forward-char 0))">C:  4, 0: Invalid function name "f" (invalid-name)</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 4)(forward-line 0)(forward-char 0))">C:  4, 0: Invalid argument name "x" (invalid-name)</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 4)(forward-line 0)(forward-char 0))">C:  4, 0: Invalid argument name "y" (invalid-name)</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 4)(forward-line 0)(forward-char 0))">C:  4, 0: Missing function docstring (missing-docstring)</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 5)(forward-line 0)(forward-char 15))">E:  5,15: Undefined variable 'b' (undefined-variable)</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 4)(forward-line 0)(forward-char 9))">W:  4, 9: Unused argument 'y' (unused-argument)</a></span>
<span style="color: #0000ff; font-weight: bold; text-decoration: underline;"><a href="elisp:(progn (switch-to-buffer-other-window &quot;blog.org&quot;)(goto-char 9180)(forward-line 7)(forward-line 0)(forward-char 10))">E:  7,10: Undefined variable 'c' (undefined-variable)</a></span>
</pre>
</div>

<p>
Each of those links takes me to either the line, or the position of the error (in the case of pylint)! I have not tested this on more than a handful of code blocks, but it has worked pretty nicely on them so far!
</p>

<p>
Of course, you must have pyflakes, pep8 and pylint installed. But those are all easily installed with pip as far as I can tell.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/09/27/Improved-debugging-of-Python-code-blocks-in-org-mode.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Generating an atomic stoichiometric matrix]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/09/23/Generating-an-atomic-stoichiometric-matrix" />
    <id>http://jkitchin.github.io/blog/2014/09/23/Generating-an-atomic-stoichiometric-matrix</id>
    <updated>2014-09-23T14:25:36Z</updated>
    <published>2014-09-23T14:25:36Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="python" />
    <category scheme="http://jkitchin.github.io/blog" term="thermodynamics" />
    <summary type="html"><![CDATA[Generating an atomic stoichiometric matrix]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/09/23/Generating-an-atomic-stoichiometric-matrix"><![CDATA[



<p>
In computing thermodynamic properties with species, it is sometimes required to get a matrix that specifies number of each type of atom in each species. For example, we can create this by hand as follows:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="right">H2O</td>
<td class="right">CO2</td>
<td class="right">H2</td>
<td class="right">CO</td>
</tr>

<tr>
<td class="left">H</td>
<td class="right">2</td>
<td class="right">0</td>
<td class="right">2</td>
<td class="right">0</td>
</tr>

<tr>
<td class="left">C</td>
<td class="right">0</td>
<td class="right">1</td>
<td class="right">0</td>
<td class="right">1</td>
</tr>

<tr>
<td class="left">O</td>
<td class="right">1</td>
<td class="right">2</td>
<td class="right">0</td>
<td class="right">1</td>
</tr>
</tbody>
</table>

<p>
Here we aim to generate this table from code. Why? 1. We can readily add species to it if we do it right. 2. We are less likely to make mistakes in generation of the table, and if we do, it will be faster to regenerate the table. 
</p>

<p>
We will start with a list of strings that represent the chemical formula of each species. We will need to parse the strings to find the elements, and number of them. We will use a fairly naive regular expression to parse a chemical formula. Basically, we match a capital letter + an optional lowercase letter, followed by an optional number. Here is a fictitous example to illustrate. Note, this will not work with formulas that have parentheses, or charges. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> re
<span style="color: #000000; background-color: #cccccc; font-weight: bold;">m</span> = re.findall(<span style="color: #228b22;">'([A-Z][a-z]?)(\d?)'</span> , <span style="color: #228b22;">'ArC2H6Cu56Pd47Co'</span>)
<span style="color: #8b0000;">print</span> m
</pre>
</div>

<pre class="example">
[('Ar', ''), ('C', '2'), ('H', '6'), ('Cu', '5'), ('Pd', '4'), ('Co', '')]
</pre>

<p>
Now, we need to loop over the species, and collect all the elements in them. We will just make a list of all of the elments, and then get the set.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> re

# <span style="color: #ff0000; font-weight: bold;">save for future use</span>
<span style="color: #000000; background-color: #cccccc; font-weight: bold;">cf</span> = re.compile(<span style="color: #228b22;">'([A-Z][a-z]?)(\d?)'</span>)

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">species</span> = [<span style="color: #228b22;">'H2O'</span>, <span style="color: #228b22;">'CO2'</span>, <span style="color: #228b22;">'H2'</span>, <span style="color: #228b22;">'CO2'</span>]

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">all_elements</span> = []

<span style="color: #8b0000;">for</span> s <span style="color: #8b0000;">in</span> species:
    <span style="color: #8b0000;">for</span> el, count <span style="color: #8b0000;">in</span> re.findall(cf, s):
        <span style="color: #000000; background-color: #cccccc; font-weight: bold;">all_elements</span> += [el]

<span style="color: #8b0000;">print</span><span style="color: #cd0000;"> set</span>(all_elements)
</pre>
</div>

<pre class="example">
set(['H', 'C', 'O'])
</pre>

<p>
Finally, we can create the table. We need to loop through each element, and then through each species
</p>


<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> re

# <span style="color: #ff0000; font-weight: bold;">save for future use</span>
<span style="color: #000000; background-color: #cccccc; font-weight: bold;">cf</span> = re.compile(<span style="color: #228b22;">'([A-Z][a-z]?)(\d?)'</span>)

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">species</span> = [<span style="color: #228b22;">'H2O'</span>, <span style="color: #228b22;">'CO2'</span>, <span style="color: #228b22;">'H2'</span>, <span style="color: #228b22;">'CO2'</span>]

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">all_elements</span> = []

<span style="color: #8b0000;">for</span> s <span style="color: #8b0000;">in</span> species:
    <span style="color: #8b0000;">for</span> el, count <span style="color: #8b0000;">in</span> re.findall(cf, s):
        <span style="color: #000000; background-color: #cccccc; font-weight: bold;">all_elements</span> += [el]

<span style="color: #000000; background-color: #cccccc; font-weight: bold;">atoms</span> =<span style="color: #cd0000;"> set</span>(all_elements)

# <span style="color: #ff0000; font-weight: bold;">we put a placeholder in the first row</span>
<span style="color: #000000; background-color: #cccccc; font-weight: bold;">counts</span> = [[<span style="color: #228b22;">""</span>] + species]
<span style="color: #8b0000;">for</span> e <span style="color: #8b0000;">in</span> atoms:
    # <span style="color: #ff0000; font-weight: bold;">store the element in the first column</span>
    <span style="color: #000000; background-color: #cccccc; font-weight: bold;">count</span> = [e]
    <span style="color: #8b0000;">for</span> s <span style="color: #8b0000;">in</span> species:    
        <span style="color: #000000; background-color: #cccccc; font-weight: bold;">d</span> =<span style="color: #cd0000;"> dict</span>(re.findall(cf, s))
        <span style="color: #000000; background-color: #cccccc; font-weight: bold;">n</span> = d.get(e, <span style="color: #000000; background-color: #cccccc; font-weight: bold;">0</span>)
        <span style="color: #8b0000;">if</span> <span style="color: #000000; background-color: #cccccc; font-weight: bold;">n</span> == <span style="color: #228b22;">''</span>: <span style="color: #000000; background-color: #cccccc; font-weight: bold;">n</span> = <span style="color: #000000; background-color: #cccccc; font-weight: bold;">1</span>
        <span style="color: #000000; background-color: #cccccc; font-weight: bold;">count</span> += <span style="color: #cd0000;">[int</span>(n)]
    <span style="color: #000000; background-color: #cccccc; font-weight: bold;">counts</span> += [count]

# <span style="color: #ff0000; font-weight: bold;">this directly returns the array to org-mode</span>
<span style="color: #8b0000;">return</span> counts
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="right">H2O</td>
<td class="right">CO2</td>
<td class="right">H2</td>
<td class="right">CO2</td>
</tr>

<tr>
<td class="left">H</td>
<td class="right">2</td>
<td class="right">0</td>
<td class="right">2</td>
<td class="right">0</td>
</tr>

<tr>
<td class="left">C</td>
<td class="right">0</td>
<td class="right">1</td>
<td class="right">0</td>
<td class="right">1</td>
</tr>

<tr>
<td class="left">O</td>
<td class="right">1</td>
<td class="right">2</td>
<td class="right">0</td>
<td class="right">2</td>
</tr>
</tbody>
</table>

<p>
For this simple example it seems like a lot of code. If there were 200 species though, it would be the same code! Only the list of species would be longer. It might be possible to avoid the two sets of looping, if you could represent the stoichiometric matrix as a sparse matrix, i.e. only store non-zero elements. The final comment I have is related to the parsing of the chemical formulas. Here we can only parse simple formulas. To do better than this would require a pretty sophisticated parser, probably built on the grammar of chemical formulas. The example <a href="http://www.onlamp.com/pub/a/python/2006/01/26/pyparsing.html?page=3">here</a> implements the code above using pyparsing, and could probably be extended to include more complex formulas such as (CH3)3CH.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/09/23/Generating-an-atomic-stoichiometric-matrix.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Showing what data went into a code block on export]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2014/09/22/Showing-what-data-went-into-a-code-block-on-export" />
    <id>http://jkitchin.github.io/blog/2014/09/22/Showing-what-data-went-into-a-code-block-on-export</id>
    <updated>2014-09-22T12:33:51Z</updated>
    <published>2014-09-22T12:25:29Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <summary type="html"><![CDATA[Showing what data went into a code block on export]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2014/09/22/Showing-what-data-went-into-a-code-block-on-export"><![CDATA[


<p>
Sometimes I define variables in the header of a code block and then use the code to analyze the data. In org-mode this is super, and you can read the file and easily see what is going on. 
</p>

<p>
When you export the file, however, the information is lost, and in the exported result you cannot see what data went into a code block, or figure out where it is from. 
</p>

<p>
Today we examine how to get that information into exported code. First, we setup a simple example that will do what need.
</p>

<table id="tbl-data" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">x</th>
<th scope="col" class="right">y</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">1</td>
</tr>

<tr>
<td class="right">2</td>
<td class="right">4</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">9</td>
</tr>
</tbody>
</table>

<p>
Now a code block that has a defined variable in the header that uses data from the table defined above.
</p>

<div class="org-src-container">

<pre class="src src-python" id="print-table"><span style="color: #8b0000;">return</span> data
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />
</colgroup>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">1</td>
</tr>

<tr>
<td class="right">2</td>
<td class="right">4</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">9</td>
</tr>
</tbody>
</table>

<p>
During export, org-mode does some interesting things to the document, including removing the headers from the code blocks, which makes it impossible to access them inside the export. The headers are apparently removed during org-babel-exp-process-buffer. It does not appear possible to advise this function because it processes the whole buffer at once, and we need to save data for each code block.  
</p>

<p>
So, we will have to preprocess the buffer to get the parameters on each block, and then put the parameters in the export afterwards. For this, we can use a filter. We will preprocess the buffer to get names of tables, and parameters of src-blocks. (I suppose we could put this preprocessing in the advice function, but I tend to avoid advice when possible).
</p>

<p>
Here is how we can get a list of the table-names indicating their name or that they are results (results are enclosed in ()).
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-element-map (org-element-parse-buffer) 'table
  (<span style="color: #8b0000;">lambda</span> (element)     
    (or (org-element-property <span style="color: #cd0000;">:name</span> element) (org-element-property <span style="color: #cd0000;">:results</span> element))))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">tbl-data</td>
<td class="left">(print-table)</td>
<td class="left">()</td>
<td class="left">()</td>
</tr>
</tbody>
</table>

<p>
Similarly, here is the list of parameters for each block.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-element-map (org-element-parse-buffer) 'src-block
  (<span style="color: #8b0000;">lambda</span> (element)     
    (org-element-property <span style="color: #cd0000;">:parameters</span> element)))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">:var data=tbl-data :results value</td>
</tr>
</tbody>
</table>

<p>
Now, we combine them with filters to modify the output. First, we preprocess to get each list, and then in the filter, we will pop off each value and insert the data. We will also get the language for each code block, and add that in the export. We use a filter because we are not modified the transcoded text, simply adding some new text in front of it.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">ox-mrkup-filter-table</span> (text back-end info)
  (<span style="color: #8b0000;">let</span> ((tblname (pop tblnames)))
    (message <span style="color: #228b22;">"tblname is \"%s\""</span> tblname)
    ; <span style="color: #ff0000; font-weight: bold;">pop does not remove nil from the list, so we do it here.</span>
    (<span style="color: #8b0000;">when</span> (null tblname) (setq tblnames (cdr tblnames)))
    (<span style="color: #8b0000;">cond</span>
     ((listp tblname)  ; <span style="color: #ff0000; font-weight: bold;">from results</span>
      (concat (format <span style="color: #228b22;">"&lt;br&gt;Results: %s"</span> (car tblname)) text))
     ((null tblname)   ; <span style="color: #ff0000; font-weight: bold;">no name</span>
      text)
     (t ; <span style="color: #ff0000; font-weight: bold;">everything else</span>
      (concat (format <span style="color: #228b22;">"&lt;br&gt;Table name: %s"</span> tblname) text)))))

(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">ox-mrkup-filter-src-block</span> (text back-end info)
  (<span style="color: #8b0000;">let</span> ((params (pop src-params))
        (lang (pop src-langs)))
    (<span style="color: #8b0000;">when</span> (null params) (setq src-params (cdr src-params)))
    (<span style="color: #8b0000;">if</span> params  
        (concat (format <span style="color: #228b22;">"&lt;pre&gt;Language = %s\nParameters = %s&lt;/pre&gt;"</span> lang params) text)
      text)))

;; <span style="color: #ff0000; font-weight: bold;">preprocess to get table names, src parameters and languages.</span>
(<span style="color: #8b0000;">let</span> ((tblnames (org-element-map (org-element-parse-buffer) 'table
                  (<span style="color: #8b0000;">lambda</span> (element)     
                    (or (org-element-property <span style="color: #cd0000;">:name</span> element)                    
                        (org-element-property <span style="color: #cd0000;">:results</span> element)))))

      (src-params (org-element-map (org-element-parse-buffer) 'src-block
                    (<span style="color: #8b0000;">lambda</span> (element)     
                      (org-element-property <span style="color: #cd0000;">:parameters</span> element))))

      (src-langs (org-element-map (org-element-parse-buffer) 'src-block
                    (<span style="color: #8b0000;">lambda</span> (element)     
                      (org-element-property <span style="color: #cd0000;">:language</span> element))))

      ;; <span style="color: #ff0000; font-weight: bold;">register the filters</span>
      (org-export-filter-table-functions '(ox-mrkup-filter-table))
      (org-export-filter-src-block-functions '(ox-mrkup-filter-src-block)))

  ;; <span style="color: #ff0000; font-weight: bold;">and export the result</span>
  (browse-url (org-export-to-file 'html <span style="color: #228b22;">"custom-src-table-export-3.html"</span>)))
</pre>
</div>

<pre class="example">
#&lt;process open custom-src-table-export-3.html&gt;
</pre>


<p>
Here is the resulting html file: <a href="/media/2014-09-22-Showing-what-data-went-into-a-code-block-on-export/custom-src-table-export-3.html">custom-src-table-export-3.html</a> which shows the new export behavior. It might not be too difficult to make links between the parameters and the tables, but it would require parsing the :parameters string. For now, this makes it easy enough to read in HTML where the data is coming from (assuming fluency in org-mode header arguments!).
</p>

<p>
Special thanks to Aaron Ecay, and Charles Berry on the org-mode mailing list for pointing me towards a solution. 
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/09/22/Showing-what-data-went-into-a-code-block-on-export.org">org-mode source</a><p><p>Org-mode version = 8.2.7c</p>]]></content>
  </entry>
</feed>
