<?xml version="1.0" encoding="UTF-8"?>
<feed
  xmlns="http://www.w3.org/2005/Atom"
  xmlns:thr="http://purl.org/syndication/thread/1.0"
  xml:lang="en"
   >
  <title type="text">The Kitchin Research Group</title>
  <subtitle type="text">Chemical Engineering at Carnegie Mellon University</subtitle>

  <updated>2016-03-26T19:28:33Z</updated>
  <generator uri="http://blogofile.com/">Blogofile</generator>

  <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog" />
  <id>http://jkitchin.github.io/blog/feed/atom/</id>
  <link rel="self" type="application/atom+xml" href="http://jkitchin.github.io/blog/feed/atom/" />
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[A molecule link for org-mode]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2016/03/26/A-molecule-link-for-org-mode" />
    <id>http://jkitchin.github.io/blog/2016/03/26/A-molecule-link-for-org-mode</id>
    <updated>2016-03-26T15:28:17Z</updated>
    <published>2016-03-26T15:28:17Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="chemistry" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[A molecule link for org-mode]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2016/03/26/A-molecule-link-for-org-mode"><![CDATA[


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Appendix of molecules</a></li>
<li><a href="#sec-2">2. smiles major mode</a></li>
</ul>
</div>
</div>
<p>
Here I am exploring some ideas on compact and functional representations of molecules in org-mode. We will use some functionality from OpenBabel (<a href="https://openbabel.org/docs/dev/index.html">https://openbabel.org/docs/dev/index.html</a> ) for conversion of formats.
</p>

<p>
One approach we could use is the <a href="https://en.wikipedia.org/wiki/Simplified_molecular-input_line-entry_system">SMILES</a> representation. OpenBabel provides tools to convert SMILES to a visualization like this. Let's check out an old favorite: caffeine.
</p>

<div class="org-src-container">

<pre class="src src-sh">obabel -:<span style="color: #008000;">"Cn1cnc2n(C)c(=O)n(C)c(=O)c12"</span> -osvg
</pre>
</div>


<div class="figure">
<p><a href="/media/2016-03-26-A-molecule-link-for-org-mode/out.svg">out.svg</a> 
</p>
</div>

<p>
We can imagine the SMILES string is a program, and use an org-mode src block to contain it.  It isn't quite a program, as it is more like data, but we can make the block executable if we define how to "execute" the block, and for that we will just have obabel generate the svg representation of the molecule. Here is our execute function. It simply generates the svg to stdout. We can use a :file header to capture it in a file.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-execute:smiles</span> (body params)
  (shell-command-to-string
   (format <span style="color: #008000;">"obabel -:\"%s\" -osvg 2&gt; /dev/null"</span> body)))
</pre>
</div>

<pre class="example">
org-babel-execute:smiles
</pre>

<p>
You can find a smiles block in <a href="#sec-1">Appendix of molecules</a> that was adapted from <a href="http://www.daylight.com/dayhtml_tutorials/languages/smiles/smiles_examples.html">here</a> .
</p>

<p>
Now, we need a link to refer to our molecule. We want the follow action to jump to our src block which should have a name. We will have it export as the name of the block linked to the molecule definition. This should work fine for definitions in the document. It is not robust to link to molecules in other org-files in the export. That would require those files to be exported too. For now we just define an HTML export.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">molecule-jump</span> (name)
  (org-mark-ring-push)
  (org-open-link-from-string (format <span style="color: #008000;">"[[%s]]"</span> path)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">molecule-export</span> (path desc backend)
  (<span style="color: #0000FF;">let</span> ((name (<span style="color: #0000FF;">save-window-excursion</span>
                (molecule-jump path)
                (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context)))))
    (<span style="color: #0000FF;">cond</span>
     ((eq 'html backend)
      (format <span style="color: #008000;">"&lt;a href=\"#%s\"&gt;%s&lt;/a&gt;"</span> name name)))))

(org-add-link-type
 <span style="color: #008000;">"molecule"</span>
 'molecule-jump
 'molecule-export)
</pre>
</div>

<p>
Now we link to <a href="#LSD">LSD</a> and <a href="#ethanol">ethanol</a> that allows us to navigate to the definition. We can also refer to a molecule in another file like <a href="#ethanol">ethanol</a>. The links are clickable, and should jump to the molecule definition. On export to HTML they will be links to the definition.
</p>

<p>
Our link provides some limited functionality. We can provide more by making the follow action open a menu for example. Instead, we created a major mode <a href="#sec-2">here</a>. It provides a function to convert smiles to CML. It is readily extensible to do other conversions.
</p>

<p>
One of the reasons we want to have molecules as "data" is so we can find them in our papers. Here is an example of that. We defined two molecules in the Appendix, and we find them here.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-element-map (org-element-parse-buffer)
    'src-block
  (<span style="color: #0000FF;">lambda</span> (src)
    (<span style="color: #0000FF;">when</span> (string= <span style="color: #008000;">"smiles"</span> (org-element-property <span style="color: #006FE0;">:language</span> src))
      (org-element-property <span style="color: #006FE0;">:name</span> src))))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">LSD</td>
<td class="left">ethanol</td>
</tr>
</tbody>
</table>

<p>
There is still a lot to do to make this really functional. For example, we might want to use the molecules to write reactions. We might also want more advanced conversion or lookup functions, and more export options. It might be desirable to have tooltips on the links to see the molecules too. No doubt one might want to fine-tune the way the blocks run, so that options could be passed as header args.
Maybe I will work on that another day.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a id="ID-1CD759B4-E276-4990-982C-E98CCE5B0517" name="ID-1CD759B4-E276-4990-982C-E98CCE5B0517"></a><span class="section-number-2">1</span> Appendix of molecules</h2>
<div class="outline-text-2" id="text-1">

<p>
Here is an example smiles block.
</p>
<div class="org-src-container">
<label class="org-src-name">A lysergic acid diethylamide molecule</label>
<pre class="src src-smiles" id="LSD">CCN(CC)C(=O)[C@H]1CN(C)[C@@H]2Cc3c[nH]c4cccc(C2=C1)c34
</pre>
</div>


<div class="figure">
<p><a href="/media/2016-03-26-A-molecule-link-for-org-mode/lsd.svg">lsd.svg</a> 
</p>
</div>

<div class="org-src-container">
<label class="org-src-name">An ethanol molecule.</label>
<pre class="src src-smiles" id="ethanol">CCO
</pre>
</div>


<div class="figure">
<p><a href="/media/2016-03-26-A-molecule-link-for-org-mode/ethanol.svg">ethanol.svg</a> 
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><a id="ID-7978044B-CB2F-4AB3-8142-34A28B3DB201" name="ID-7978044B-CB2F-4AB3-8142-34A28B3DB201"></a><span class="section-number-2">2</span> smiles major mode</h2>
<div class="outline-text-2" id="text-2">
<p>
It would be nice to have a language mode to do special edits of SMILES src blocks. This mode does very little but provide a function that converts SMILES to CML using obabel and open it in a buffer. We redirect stderr to /dev/null to avoid seeing the messages from obabel. We also provide another function that opens a browser to names of the molecule.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">easymenu</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">smiles-cml</span> ()
  <span style="color: #036A07;">"Convert the smiles string in the buffer to CML."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let</span> ((smiles (buffer-string)))
    (switch-to-buffer (get-buffer-create <span style="color: #008000;">"SMILES-CML"</span>))
    (erase-buffer)
    (insert
     (shell-command-to-string
      (format <span style="color: #008000;">"obabel -:\"%s\" -ocml 2&gt; /dev/null"</span>
              smiles)))
    (goto-char (point-min))
    (xml-mode)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">smiles-names</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (browse-url
   (format <span style="color: #008000;">"http://cactus.nci.nih.gov/chemical/structure/%s/names"</span>
           (buffer-string))))

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">smiles-mode-map</span>
  nil
  <span style="color: #036A07;">"Keymap for smiles-mode."</span>)

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">adapted from http://ergoemacs.org/emacs/elisp_menu_for_major_mode.html</span>
(<span style="color: #0000FF;">define-derived-mode</span> <span style="color: #006699;">smiles-mode</span> fundamental-mode <span style="color: #008000;">"smiles-mode"</span>
  <span style="color: #036A07;">"Major mode for SMILES code."</span>
  (<span style="color: #0000FF;">setq</span> buffer-invisibility-spec '(t)
        mode-name <span style="color: #008000;">" &#9786;"</span>)

  (<span style="color: #0000FF;">when</span> (not smiles-mode-map)
    (<span style="color: #0000FF;">setq</span> smiles-mode-map (make-sparse-keymap)))
  (define-key smiles-mode-map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'smiles-cml)
  (define-key smiles-mode-map (kbd <span style="color: #008000;">"C-c C-n"</span>) 'smiles-names)

  (define-key smiles-mode-map [menu-bar] (make-sparse-keymap))

  (<span style="color: #0000FF;">let</span> ((menuMap (make-sparse-keymap <span style="color: #008000;">"SMILES"</span>)))
    (define-key smiles-mode-map [menu-bar smiles] (cons <span style="color: #008000;">"SMILES"</span> menuMap))

    (define-key menuMap [cml]
      '(<span style="color: #008000;">"CML"</span> . smiles-cml))
    (define-key menuMap [names]
      '(<span style="color: #008000;">"Names"</span> . smiles-names))))
</pre>
</div>

<pre class="example">
smiles-mode
</pre>
</div>
</div>
<p>Copyright (C) 2016 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2016/03/26/A-molecule-link-for-org-mode.org">org-mode source</a></p>
<p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
</feed>
