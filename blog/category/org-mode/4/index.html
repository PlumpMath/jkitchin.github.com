

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Kitchin Research Group</title>
  <meta name="google-site-verification" content="CGcacJdHc2YoZyI0Vey9XRA5qwhhFDzThKJezbRFcJ4" />
  <meta name="description" content="Chemical Engineering at Carnegie Mellon University">
  <meta name="author" content="John Kitchin">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
<div id="header" class="header_gradient theme_font">
<table><tr><td>
    <h1><a href="/">The Kitchin Research Group</a></h1>
    <h2>Chemical Engineering at Carnegie Mellon University</h2>
</td>
<td colspan=100%><div style="float:right;width:100%;text-align:right;"> <span id='badgeCont737515' style='width:126px'><script src='http://labs.researcherid.com/mashlets?el=badgeCont737515&mashlet=badge&showTitle=false&className=a&rid=A-2363-2010'></script></span></div>
</td></tr>
</table>
</div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/blog"
             class="">Blog</a></li>

      <li><a href="/blog/archive"
             class="">Archives</a></li>

      <li><a href="http://www.researcherid.com/rid/A-2363-2010" target="_new">Publications</a></li>

      <li><a href="/research.html"
             class="">Research</a></li>

      <li><a href="/group.html"
             class="">Group</a></li>

      <li><a href="/categories.html"
             class="">Categories</a></li>

      <li><a href="/about.html"
             class="">About us</a></li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  





<article>
  <div class="blog_post">
    <header>
      <div id="Writing-exams-in-org-mode"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/10/23/Writing-exams-in-org-mode/" rel="bookmark" title="Permanent Link to Writing exams in org-mode">Writing exams in org-mode</a></h2>
      <p><small><span class="blog_post_date">Posted October 23, 2013 at 03:54 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/10/23/Writing-exams-in-org-mode#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated October 23, 2013 at 06:26 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. The exam section</a>
<ul>
<li><a href="#sec-1-1">1.1. Do you get it?</a></li>
<li><a href="#sec-1-2">1.2. Multipart question</a>
<ul>
<li><a href="#sec-1-2-1">1.2.1. Circle the best answer</a></li>
<li><a href="#sec-1-2-2">1.2.2. Describe a cat.</a></li>
</ul>
</li>
<li><a href="#sec-1-3">1.3. Essay question</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Back to the grade table construction</a></li>
<li><a href="#sec-3">3. building the pdf</a></li>
</ul>
</div>
</div>
<p>
There are a few aspects of writing exams that are tedious the way I normally do it. Typically I write exams in Word because I can easily see the layout, how much whitespace there is to write answers in, etc&#x2026; I like to put a gradesheet on the final page which lists each problem, the points it is worth, and a blank to put the grade for that problem into.  It is tedious to go back through 10 pages of questions to look up all the points, enter them in, add them up, etc&#x2026; And if I decide to renumber the questions or move them, it must be repeated.
</p>

<p>
Construction of the grade sheet ought to be automated. That is not going to happen in my hands in MS Word. I have seen this done in LaTeX in the Acrotex educational package, but I don't see myself hacking LaTeX any  time soon either. Enter org-mode. I could see writing the exam in org-mode, and writing some code to construct the grade table. 
</p>


<p>
The idea is that we would store the points in a PROPERTY of an org-heading. Then, to create the table, we just loop through the headlines, gather the levels and points, and then construct a table to put in the exported LaTeX. The next section contains some exam questions that will form the basis of this post.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> The exam section</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Do you get it?</h3>
<div class="outline-text-3" id="text-1-1">
<p>
What is the answer to the universe?
 \vspace{2cm} 
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Multipart question</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> Circle the best answer</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
What is 1 + 1?
a) 2
b) 3
c) 4
</p>
</div>
</div>

<div id="outline-container-sec-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><span class="section-number-4">1.2.2</span> Describe a cat.</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
\vspace{2cm} 
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Essay question</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Expound on the meaning of life.
 \vspace{3cm} 
</p>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Back to the grade table construction</h2>
<div class="outline-text-2" id="text-2">
<p>
We will parse the buffer to get the headlines, and then extract some properties from each headline. For each headline that has points we will print the title and points it is worth,  and finally the total number of points.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq total-points 0)    <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">counter for the total points</span>

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">now loop over headlines</span>
(org-element-map 
    (org-element-parse-buffer 'headline) 'headline 
  <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">function to print headline title and points</span>
  (<span style="color: #8b0000;">lambda</span> (headline) 
    (<span style="color: #8b0000;">let</span> ((points (org-element-property <span style="color: #cd0000;">:POINTS</span> headline))
          (title  (org-element-property <span style="color: #cd0000;">:title</span> headline)))
      (<span style="color: #8b0000;">if</span> points (<span style="color: #8b0000;">progn</span>
                   (setq total-points (+ total-points (string-to-number points)))
                   (princ (format <span style="color: #228b22;">"title=%s\nPOINTS=%s\n\n"</span> title points)))))))

(princ (format <span style="color: #228b22;">"Total points = %s"</span> total-points))
</pre>
</div>

<pre class="example">
title=Do you get it?
POINTS=5

title=Circle the best answer
POINTS=10

title=Describe a cat.
POINTS=4

title=Essay question
POINTS=25

Total points = 44
</pre>

<p>
That is the foundation for the grade table. What I would like is the grade table to be structured like this:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">problem</td>
<td class="left">Points</td>
<td class="left">grade</td>
</tr>

<tr>
<td class="left">ref to heading</td>
<td class="left">#points</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Where the <code>ref to heading</code> is the same number as the actual heading. During the export, labels are generated for each section, which we could refer to. To take advantage of this we need to figure out what the labels are, so we can refer to them. 
</p>

<p>
After quite a bit of hackery, I figured out how to access this information <sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>. It is not readily apparent this is how to do it, but it works!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let*</span> ((info (org-export-collect-tree-properties (org-element-parse-buffer 'headline) '()))
       (headline-numbering (plist-get info <span style="color: #cd0000;">:headline-numbering</span>)))
(org-element-map (plist-get info <span style="color: #cd0000;">:parse-tree</span>) 'headline
  (<span style="color: #8b0000;">lambda</span> (headline) 
    (format <span style="color: #228b22;">"\\ref{sec-%s}"</span> (mapconcat 
                      (<span style="color: #8b0000;">lambda</span> (x) (format <span style="color: #228b22;">"%s"</span> x)) (cdr (assoc headline headline-numbering)) <span style="color: #228b22;">"-"</span>)))))
</pre>
</div>

<pre class="example">
("\\ref{sec-1}" "\\ref{sec-2}" "\\ref{sec-2-1}" "\\ref{sec-2-2}" "\\ref{sec-2-2-1}" "\\ref{sec-2-2-2}" "\\ref{sec-2-3}" "\\ref{sec-3}" "\\ref{sec-}")
</pre>


<p>
So, let us try putting this all together <sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup>.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq total-points 0)    <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">counter for the total points</span>
(princ <span style="color: #228b22;">"#+caption: The grade table\n"</span>)
(princ <span style="color: #228b22;">"#+attr_latex: :align |c|c|c|\n"</span>)
(princ <span style="color: #228b22;">"|-\n"</span>)
(princ <span style="color: #228b22;">"|Problem|Possible Points|Points earned|\n|-\n"</span>)
(<span style="color: #8b0000;">let*</span> ((info (org-export-collect-tree-properties (org-element-parse-buffer 'headline) '()))
       (headline-numbering (plist-get info <span style="color: #cd0000;">:headline-numbering</span>)))
  (org-element-map (plist-get info <span style="color: #cd0000;">:parse-tree</span>) 'headline
    (<span style="color: #8b0000;">lambda</span> (headline) 
      (<span style="color: #8b0000;">let</span> ((ref (format <span style="color: #228b22;">"\\ref{sec-%s}"</span> (mapconcat 
                                          (<span style="color: #8b0000;">lambda</span> (x) (format <span style="color: #228b22;">"%s"</span> x)) (cdr (assoc headline headline-numbering)) <span style="color: #228b22;">"-"</span>)))
            (points (org-element-property <span style="color: #cd0000;">:POINTS</span> headline)))
        (<span style="color: #8b0000;">if</span> points (<span style="color: #8b0000;">progn</span>
                     (setq total-points (+ total-points (string-to-number points)))
                     (princ (format <span style="color: #228b22;">"|%s|%s|  |\n|-\n"</span> ref points))))))))

(princ (format <span style="color: #228b22;">"| |Total points| %s|\n"</span> total-points))
(princ <span style="color: #228b22;">"|-\n"</span>)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption align="above"><span class="table-number">Table 1:</span> The grade table</caption>

<colgroup>
<col  class="left" />

<col  class="right" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Problem</th>
<th scope="col" class="right">Possible Points</th>
<th scope="col" class="left">Points earned</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">\ref{sec-1-1-1}</td>
<td class="right">5</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">\ref{sec-1-1-2-1}</td>
<td class="right">10</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">\ref{sec-1-1-2-2}</td>
<td class="right">4</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">\ref{sec-1-1-3}</td>
<td class="right">25</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="right">Total points</td>
<td class="left">44</td>
</tr>
</tbody>
</table>

<p>
Note this table gets munged by Mathjax in HTML. I am not sure that is fixable. You can open the <a href="/media/2013-10-23-Writing-exams-in-org-mode/writing-exams-in-orgmode.pdf">pdf</a> and see the results.
</p>

<p>
This works ok. There is still some work to be done. For example the boxes in the grade table are not very large. The references are a little odd in this case, but that is an artifact of the fact that you cannot nest a section deeper than 3 levels in LaTeX without some work, and I nested my exam section in a second level heading so it would appear in the blog post. A real application of this would not have all these other sections, and would not export the build section. It is a tad tedious to hand build the table, but not too bad. 
</p>

<p>
It might be better to use CUSTOM_ID labels in the sections, rather than try to build up the references. You still need to think about what the labels would be, and we are used to seeing numbers!
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> building the pdf</h2>
<div class="outline-text-2" id="text-3">
<p>
I have gotten in the habit of building the latex file from commands, and manually running them with C-c C-c.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((org-latex-default-packages-alist
       '((<span style="color: #228b22;">""</span> <span style="color: #228b22;">"minted"</span> nil)
         (<span style="color: #228b22;">"linktocpage,</span>
<span style="color: #228b22;">  pdfstartview=FitH,</span>
<span style="color: #228b22;">  colorlinks,</span>
<span style="color: #228b22;">  linkcolor=blue,</span>
<span style="color: #228b22;">  anchorcolor=blue,</span>
<span style="color: #228b22;">  citecolor=blue,</span>
<span style="color: #228b22;">  filecolor=blue,</span>
<span style="color: #228b22;">  menucolor=blue,</span>
<span style="color: #228b22;">  urlcolor=blue"</span> <span style="color: #228b22;">"hyperref"</span> t)))
      (async nil)
      (subtreep nil)
      (visible-only nil)
      (body-only nil))

  (org-latex-export-to-latex async subtreep visible-only body-only '()))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">progn</span>
  (shell-command <span style="color: #228b22;">"pdflatex -shell-escape writing-exams-in-orgmode"</span>)
  (shell-command <span style="color: #228b22;">"pdflatex -shell-escape writing-exams-in-orgmode"</span>))
</pre>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p>
This code does not generate correct labels for headlines with TODO in them, or for footnotes.
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p>
Note this table gets munged by Mathjax in HTML.
</p></div>


</div>
</div><p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/10/23/Writing-exams-in-org-mode.org">org-mode source</a><p>

    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/10/23/Writing-exams-in-org-mode#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Enabling-right-clicks-in-org-mode-links"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/10/21/Enabling-right-clicks-in-org-mode-links/" rel="bookmark" title="Permanent Link to Enabling right-clicks in org-mode links">Enabling right-clicks in org-mode links</a></h2>
      <p><small><span class="blog_post_date">Posted October 21, 2013 at 07:58 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/10/21/Enabling-right-clicks-in-org-mode-links#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated October 21, 2013 at 08:45 PM</span>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
Out of the box you can click on org-mode links to make the do things. On my machine, all clicks are equal, left mouse, middle mouse, and right mouse all act as a "click". I was curious about whether I could get different behavior on a link with a left or right mouse click. It is easy enough to <a href="http://orgmode.org/manual/Adding-hyperlink-types.html">define a new link type</a> . You define a function that is run when you click on the link.
</p>

<p>
To figure out what to do here, I looked into the events handling in emacs. According to this <a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Click-Events.html">page</a> , there are click events. So, after we click on a link, there should be a click event which was the last input event. We can get that, figure out which button was pressed, and run code accordingly. We will make the code add some lines to the buffer after the link about what happened.
</p>

<p>
Here is my link definition. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq counter 1)
(org-add-link-type
 <span style="color: #228b22;">"test"</span>
 <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">this function is run when you click</span>
 (<span style="color: #8b0000;">lambda</span> (link-string) 
   (<span style="color: #8b0000;">let</span> ((button (car last-input-event)))
     (<span style="color: #8b0000;">cond</span> ((eq button 'mouse-1) 
            (end-of-line)
            (insert (format <span style="color: #228b22;">"\nclick %s. mouse-1 pressed %s\n"</span> counter last-input-event))
            (setq counter (+ counter 1)))
           ((eq button 'mouse-2) 
            (end-of-line) 
            (insert (format <span style="color: #228b22;">"\nclick %s. mouse-2 pressed %s\n"</span> counter last-input-event))
            (setq counter (+ counter 1)))
           ((eq button 'mouse-3) 
            (end-of-line)
            (insert (format <span style="color: #228b22;">"\nclick %s. mouse-3 pressed %s\n"</span> counter last-input-event))
            (setq counter (+ counter 1))))))
 <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">formatting</span>
(<span style="color: #8b0000;">lambda</span> (keyword desc format)
   (<span style="color: #8b0000;">cond</span>
    ((eq format 'html) (format <span style="color: #228b22;">"&lt;pre&gt;%s:%s&lt;/pre&gt;"</span> keyword desc)))))
</pre>
</div>


<p>
Here we make a link. When you click on it, it adds lines right after the link telling you what was clicked on. I left-clicked, middle-clicked and right-clicked. The right-clicked result is the first line.
</p>

<p>
<pre>test:which-button</pre> 
click 3. mouse-3 pressed (mouse-3 (#&lt;window 46 on blog.org&gt; 56959 (57 . 456) -320964819 nil 56959 (7 . 28) nil (1 . 8) (8 . 16)))
</p>

<p>
click 2. mouse-2 pressed (mouse-2 (#&lt;window 46 on blog.org&gt; 56959 (57 . 456) -320965724 nil 56959 (7 . 28) nil (1 . 8) (8 . 16)))
</p>

<p>
click 1. mouse-2 pressed (mouse-2 (#&lt;window 46 on blog.org&gt; 56959 (57 . 456) -320966660 nil 56959 (7 . 28) nil (1 . 8) (8 . 16)))
</p>


<p>
Curiously, this only shows that mouse-2 (for left or middle mouse) or mouse-3 (for right click) was pressed, never mouse-1. I am not sure what causes that. If I try to capture an event it does show mouse-1 is active.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(princ (read-event))
</pre>
</div>

<pre class="example">
(down-mouse-1 (#&lt;window 34 on blog.org&gt; 56437 (253 . 308) -322917920 nil 56437 (31 . 19) nil (93 . 4) (8 . 16)))
</pre>

<p>
Anyway, it looks conceivable that you could have different link actions occur for different mouse clicks. I could see using this in a citation link, where a left click might open the citation in my bibtex file, and right clicking would open a pdf of the citation if it existed. 
</p>

<p>
I have not figured out how flexible this might be, for example could you use modifier keys with mouse clicks? This code suggests that it is possible in emacs, but so far none of these make it into the last-input-event in the org-link clicks.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(princ (read-event))
</pre>
</div>

<pre class="example">
(S-down-mouse-1 (#&lt;window 34 on blog.org&gt; 56725 (1 . 299) -322897656 nil 56725 (0 . 18) nil (1 . 11) (8 . 16)))
</pre>

<p>
It might be difficult remembering all the modifiers and clicks, but it would be cool if it was possible!
</p>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/10/21/Enabling-right-clicks-in-org-mode-links.org">org-mode source</a><p>

    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/10/21/Enabling-right-clicks-in-org-mode-links#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Lisp-links-in-org-mode-to-dynamically-generated-content"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/10/14/Lisp-links-in-org-mode-to-dynamically-generated-content/" rel="bookmark" title="Permanent Link to Lisp links in org-mode to dynamically generated content">Lisp links in org-mode to dynamically generated content</a></h2>
      <p><small><span class="blog_post_date">Posted October 14, 2013 at 10:49 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/10/14/Lisp-links-in-org-mode-to-dynamically-generated-content#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated October 20, 2013 at 10:19 AM</span>
      </small></p>
    </header>
    <div class="post_prose">
      




<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Converting elisp links to their value on export</a>
<ul>
<li><a href="#sec-1-1">1.1. empty section</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Converting elisp links to their value on export</h2>
<div class="outline-text-2" id="text-1">
<p>
Someone asked on the mailing list if it would be possible to replace a lisp expression in org-mode with its value. I thought this should work with the filter system I have been exploring.  The idea is to preprocess the org buffer, get all the links, and handle the elisp links specially. Then, we use a filter to replace elisp links with the output we got from preprocessing. We need to have a few different links in this file to make it more obvious what we are doing. For example we do not want this <a href="#sec-1-1">link</a> to be changed. The link to <a href="http://orgmode.org">http://orgmode.org</a> should not be changed. But we want a link like <code>elisp:(+ 2 3)</code> to be replaced by <code>5</code>.
</p>

<p>
The following text:
</p>
<pre class="example">
This file was exported on [[elisp:(format-time-string "%Y-%m-%d at %H:%m %p")]].

The answer to 2 + 3 is [[elisp:(+ 2 3)]].
</pre>
<p>
Renders like this:
</p>

<p>
This file was exported on 2013-10-20 at 10:10 AM.
</p>

<p>
The answer to 2 + 3 is 5.
</p>

<p>
First, we get the links. If there is an elisp link we set the list value to the value of the link evaluated, otherwise we set it to nil. In the filter, we will replace the output of the link if the value in this list is not nil.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq link-list (<span style="color: #8b0000;">let</span> ((parsetree (org-element-parse-buffer))
                      (counter 0))
                  (org-element-map parsetree 'link
                    (<span style="color: #8b0000;">lambda</span> (link) 
                      (<span style="color: #8b0000;">let*</span> ((plist (nth 1 link))
                             (content (plist-get plist <span style="color: #cd0000;">:content</span>))
                             (path (plist-get plist <span style="color: #cd0000;">:path</span>))
                             (type (plist-get plist '<span style="color: #cd0000;">:type</span>))
                             (fname (car (last (split-string path <span style="color: #228b22;">"/"</span>))))
                             )
                       (<span style="color: #8b0000;">if</span> (string-match <span style="color: #228b22;">"elisp"</span> type) (format <span style="color: #228b22;">"%s"</span> (eval (read (plist-get plist <span style="color: #cd0000;">:path</span>)))) <span style="color: #228b22;">"nil"</span>))))))

(princ link-list)
</pre>
</div>

<pre class="example">
(nil nil 2013-10-20 at 10:10 AM 5 nil)
</pre>

<p>
Now, we have the output of what we want for each link. Now, we will setup the filter, and export this file to a blogpost.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((counter 0))

  (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">ox-mrkup-filter-link</span> (text back-end info)
    (<span style="color: #8b0000;">let</span> ((link-content (nth counter link-list)))
      (<span style="color: #8b0000;">if</span> (not (string= link-content <span style="color: #228b22;">"nil"</span>)) 
          (setq output (format <span style="color: #228b22;">"%s"</span> link-content)) <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">this was an elisp link</span>
        (setq output text))) <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">this was some other kind of link</span>
      (setq counter (+ counter 1))
      output)

  (<span style="color: #8b0000;">let</span> ((org-export-filter-link-functions '(ox-mrkup-filter-link))
        (async nil)
        (subtreep nil)
        (visible-only nil)
        (body-only t)
        (ext-plist '()))
    (org-html-export-as-html async subtreep visible-only body-only ext-plist))

    <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">now get the output into the org output</span>
    (switch-to-buffer <span style="color: #228b22;">"*Org HTML Export*"</span>)

    (setq HTML (buffer-string))
    (setq YAML <span style="color: #228b22;">"---</span>
<span style="color: #228b22;">title: Lisp links in org-mode to dynamically generated content</span>
<span style="color: #228b22;">date: 2013/10/14 22:49:00</span>
<span style="color: #228b22;">updated: 2013/10/20 10:19:00</span>
<span style="color: #228b22;">categories: org-mode</span>
<span style="color: #228b22;">---</span>



<span style="color: #228b22;">"</span>)
  (<span style="color: #8b0000;">with-temp-buffer</span>
(insert YAML)
(insert HTML)
(write-region (point-min) (point-max) <span style="color: #228b22;">"../_posts/2013-10-14-Lisp-links-in-org-mode-to-dynamically-generted-content.html"</span>)))
(princ <span style="color: #228b22;">"Done."</span>)
</pre>
</div>

<pre class="example">
Done.
</pre>


<p>
Finally, let us check <a href="../_posts/2013-10-14-Lisp-links-in-org-mode-to-dynamically-generted-content.html">../_posts/2013-10-14-Lisp-links-in-org-mode-to-dynamically-generted-content.html</a>.
</p>
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> empty section</h3>
</div>
</div>


    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/10/14/Lisp-links-in-org-mode-to-dynamically-generated-content#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Attaching-code-blocks-to-a-pdf-file-during-export"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/09/30/Attaching-code-blocks-to-a-pdf-file-during-export/" rel="bookmark" title="Permanent Link to Attaching code blocks to a pdf file during export">Attaching code blocks to a pdf file during export</a></h2>
      <p><small><span class="blog_post_date">Posted September 30, 2013 at 09:58 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/09/30/Attaching-code-blocks-to-a-pdf-file-during-export#disqus_thread">View Comments</a>
      </small></p>
    </header>
    <div class="post_prose">
      



<p>
This post is a further exploration of using the export filters to modify construction of content exported from org-mode. In this post we look at some code that will save all of the code-blocks in an org-buffer to systematically named files, and then attach the files to an exported pdf file. We will use the <a href="http://www.ctan.org/tex-archive/macros/latex/contrib/attachfile">attachfile</a>LaTeX package to attach the scripts. We will build off of <a href="http://jkitchin.github.io/blog/2013/09/28/Customizing-export-of-code-blocks-in-HTML/">this post</a>for the filters.
</p>

<p>
First, let us put in a gratuitous code block. In the rendered pdf, this script will be embedded in the pdf. I am not quite ready to build a filter that supports multiple backends, so in this post we just modify the latex export.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b008b;">name</span> = <span style="color: #228b22;">'John'</span>
<span style="color: #8b0000;">print</span> <span style="color: #228b22;">'Hello {0}'</span>.<span style="color: #cd0000;">format</span>(name)
</pre>
</div>

<pre class="example">
Hello John
</pre>

<p>
We are only going to attach the python code blocks in this example, and ignore all the other blocks. We will basically use the same kind strategy we have used before. We will initially parse the buffer to get a list of all the code blocks. Then we create a filter for the src-blocks that keeps a counter of src-blocks, and depending on the type of the nth src-block, we will save the file, and modify the text for that block. Here is our code for the list of code blocks.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq src-block-list 
      (org-element-map (org-element-parse-buffer) 'src-block 
        (<span style="color: #8b0000;">lambda</span> (src-block) src-block)))
</pre>
</div>

<p>
Now we create the filter. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">ox-mrkup-filter-src-block</span> (text back-end info)
  (<span style="color: #8b0000;">catch</span> '<span style="color: #cd0000;">return</span> text)
  (<span style="color: #8b0000;">let</span> ((src-block (nth counter src-block-list)))
    (<span style="color: #8b0000;">if</span> (string= (org-element-property <span style="color: #cd0000;">:language</span> src-block) <span style="color: #228b22;">"python"</span>)
        (<span style="color: #8b0000;">progn</span> 
          (setq scriptname (format <span style="color: #228b22;">"py-%d.py"</span> counter))
          <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">save code block</span>
          (<span style="color: #8b0000;">with-temp-buffer</span>
            (insert (org-element-property <span style="color: #cd0000;">:value</span> src-block))
            (write-region (point-min) (point-max) scriptname ))
         
          (setq output (format <span style="color: #228b22;">"%s\n\\attachfile{%s} Double click me to open"</span> text scriptname)))
      <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">else</span>
      (setq output text)))
  <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">increment counter no matter what so next block is processed</span>
  (setq counter (+ counter 1))
  <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">return output</span>
  output)
</pre>
</div>

<p>
Finally, we export the document to LaTeX, and run pdflatex on it to generate the pdf.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((counter 0)
      <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">these packages are loaded in the latex file</span>
      (org-latex-default-packages-alist 
       '((<span style="color: #228b22;">"utf8"</span> <span style="color: #228b22;">"inputenc"</span> nil)
         (<span style="color: #228b22;">"T1"</span> <span style="color: #228b22;">"fontenc"</span> nil)
         (<span style="color: #228b22;">""</span> <span style="color: #228b22;">"fixltx2e"</span> nil)
         (<span style="color: #228b22;">""</span> <span style="color: #228b22;">"lmodern"</span> nil)
         (<span style="color: #228b22;">""</span> <span style="color: #228b22;">"minted"</span> nil) <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">for code syntax highlighting</span>
         <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">customize how pdf links look</span>
         (<span style="color: #228b22;">"linktocpage,</span>
<span style="color: #228b22;">           pdfstartview=FitH,</span>
<span style="color: #228b22;">           colorlinks,</span>
<span style="color: #228b22;">           linkcolor=blue,</span>
<span style="color: #228b22;">           anchorcolor=blue,</span>
<span style="color: #228b22;">           citecolor=blue,</span>
<span style="color: #228b22;">           filecolor=blue,</span>
<span style="color: #228b22;">           menucolor=blue,</span>
<span style="color: #228b22;">           urlcolor=blue"</span> <span style="color: #228b22;">"hyperref"</span> nil)))
      (org-export-filter-src-block-functions '(ox-mrkup-filter-src-block))
      (async nil)
      (subtreep nil)
      (visible-only nil)
      (body-only nil)
      (ext-plist '()))
  (org-latex-export-to-pdf async subtreep visible-only body-only ext-plist))
</pre>
</div>

<p>
Check out the result: <a href="/media/2013-09-30-Attaching-code-blocks-to-a-pdf-file-during-export/attaching-code-blocks-to-a-pdf.pdf">attaching-code-blocks-to-a-pdf.pdf</a>. This text won't show up in the pdf. I had some difficulty including the link via org-links. The export engine wanted to embed it as a pdf in itself! That does not seem to work. 
</p>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/09/30/Attaching-code-blocks-to-a-pdf-file-during-export.org">org-mode source</a><p>

    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/09/30/Attaching-code-blocks-to-a-pdf-file-during-export#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  





<article>
  <div class="blog_post">
    <header>
      <div id="Changing-links-to-files-so-they-work-in-a-blog"></div>
      <h2 class="blog_post_title"><a href="/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog/" rel="bookmark" title="Permanent Link to Changing links to files so they work in a blog">Changing links to files so they work in a blog</a></h2>
      <p><small><span class="blog_post_date">Posted September 28, 2013 at 05:49 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/org-mode/'>org-mode</a></span> | tags: 
        | <a href="http://jkitchin.github.io/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog#disqus_thread">View Comments</a>
      <p><small><span class="blog_post_date">Updated September 29, 2013 at 08:14 AM</span>
      </small></p>
    </header>
    <div class="post_prose">
      




<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Getting links to files in a post to point to the actual file</a>
<ul>
<li><a href="#sec-1-1">1.1. link one</a></li>
<li><a href="#sec-1-2">1.2. link two</a></li>
<li><a href="#sec-1-3">1.3. link three</a></li>
<li><a href="#sec-1-4">1.4. Checkout all the links</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Getting links to files in a post to point to the actual file</h2>
<div class="outline-text-2" id="text-1">
<p>
Occasionally I use a data file in post. In the local org-file buffer I can make a link to the file, and it opens just fine. However, when I publish the post, there is not a mechanism to copy the file to the blog directory, and rewrite the link in exported html so it opens the file. 
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> link one</h3>
<div class="outline-text-3" id="text-1-1">
<p>
This is an explicit file link
<a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org">news.org</a>
</p>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> link two</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Here we just use a path inside [[]]
<a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org">news.org</a>
</p>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> link three</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Here we use a decorated link.
<a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org">Org-file containing news</a>
</p>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Checkout all the links</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Let us now check out the links. We will use org-element-map to parse the elements and print the link number, the link type, and the :path. For fun, let us put an emacs-lisp link in: <pre>elisp:(princ "test")</pre>and a link to an image:
</p>


<div class="figure">
<p><img src="/media/Changing-links-to-files-so-they work-in-a-blog/tooltip-emacs.png">
</p>
</div>

<p>
And finally, I want a link to a file in another directory: <a href="/media/Changing-links-to-files-so-they work-in-a-blog/fabfile.py">fabfile.py</a>
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((parsetree (org-element-parse-buffer))
      (counter 0))
  (org-element-map parsetree 'link
    (<span style="color: #8b0000;">lambda</span> (link) 
      (<span style="color: #8b0000;">let</span> ((type (nth 0 link))
            (plist (nth 1 link))
            (content (nth 2 link)))
        (princ (format <span style="color: #228b22;">"%s %s: %s %s\n"</span> counter (plist-get plist '<span style="color: #cd0000;">:type</span>) (plist-get plist <span style="color: #cd0000;">:path</span>) content))
        (setq counter (+ counter 1))))))
</pre>
</div>

<pre class="example">
0 file: news.org nil
1 file: ./news.org nil
2 file: ./news.org Org-file containing news
3 elisp: (princ "test") nil
4 file: ../img/tooltip-emacs.png nil
5 file: ../fabfile.py nil
6 http: //orgmode.org/worg/exporters/filter-markup.html nil
7 https: //github.com/jkitchin/jmax/blob/prelude/blogofile.el blogofile.el
</pre>

<p>
So we can see all the links this way, and we will have to differentiate what kind of links they are. What needs to happen when exporting is that the files we want to refer to in the post must be copied to the media folder of the blog, and a url to that file needs to be put in the exported html in the place of the link. We are going to try the following strategy:
</p>

<ol class="org-ol">
<li>Parse the org-file.
</li>
<li>For each file link we will copy the file to the blogofile media folder and make a list of URLS for each link
</li>
<li>Write a link filter that gets the nth value of our list of urls and replace the link text with a url to the file. If the link had any content, use that for the URL text.
</li>
</ol>


<p>
Ok. Now let us write a block of code that does all those things. I want to avoid overwriting files with the same name from other posts, so we will copy all these files to a directory based on the blog post title: "Changing-links-to-files-so-they work-in-a-blog". We construct URLS for each link type that we want and store them in a list in the variable <code>url-list</code>.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq url-list (<span style="color: #8b0000;">let</span> ((parsetree (org-element-parse-buffer))
                     (counter 0))
                 (org-element-map parsetree 'link
                   (<span style="color: #8b0000;">lambda</span> (link) 
                     (<span style="color: #8b0000;">let*</span> ((type (nth 0 link))
                            (plist (nth 1 link))
                            (content (nth 2 link))
                            (path (plist-get plist <span style="color: #cd0000;">:path</span>))
                            (type (plist-get plist '<span style="color: #cd0000;">:type</span>))
                            (fname (car (last (split-string path <span style="color: #228b22;">"/"</span>))))
                            )
                       <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">make directory if it does not exist</span>
                       (make-directory <span style="color: #228b22;">"../media/Changing-links-to-files-so-they work-in-a-blog"</span> t)
                       (<span style="color: #8b0000;">cond</span>
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">image</span>
                        ((and (string= type <span style="color: #228b22;">"file"</span>)
                              (string-match <span style="color: #228b22;">"png"</span> (file-name-extension fname))) 
                         (<span style="color: #8b0000;">progn</span> 
                           (copy-file path (concat <span style="color: #228b22;">"../media/Changing-links-to-files-so-they work-in-a-blog/"</span> fname) t)
                           (format <span style="color: #228b22;">"&lt;img src=\"/media/Changing-links-to-files-so-they work-in-a-blog/%s\"&gt;"</span> fname)))
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">regular file with content</span>
                        ((and (string= type <span style="color: #228b22;">"file"</span>)  content)
                         (<span style="color: #8b0000;">progn</span> (copy-file path (concat <span style="color: #228b22;">"../media/Changing-links-to-files-so-they work-in-a-blog/"</span> fname) t)
                                (format <span style="color: #228b22;">"&lt;a href=\"/media/Changing-links-to-files-so-they work-in-a-blog/%s\"&gt;%s&lt;/a&gt;"</span> fname content)))
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">regular file with no content</span>
                        ((and (string= type <span style="color: #228b22;">"file"</span>))
                         (<span style="color: #8b0000;">progn</span> (copy-file path (concat <span style="color: #228b22;">"../media/Changing-links-to-files-so-they work-in-a-blog/"</span> fname) t)
                                (format <span style="color: #228b22;">"&lt;a href=\"/media/Changing-links-to-files-so-they work-in-a-blog/%s\"&gt;%s&lt;/a&gt;"</span> fname fname)))
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">URLS</span>
                        ((string-match <span style="color: #228b22;">"http"</span> type) (format <span style="color: #228b22;">"&lt;a href=\"%s\"&gt;%s&lt;/a&gt;"</span> 
                          (plist-get plist <span style="color: #cd0000;">:raw-link</span>) (plist-get plist <span style="color: #cd0000;">:raw-link</span>)))
                        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">all other links will be formatted as &lt;pre&gt; blocks on the raw link</span>
                        (t (format <span style="color: #228b22;">"&lt;pre&gt;%s&lt;/pre&gt;"</span> (plist-get plist <span style="color: #cd0000;">:raw-link</span>)))))))))
(princ url-list)
<span style="color: #ff0000; font-weight: bold;">;</span><span style="color: #ff0000; font-weight: bold;">(princ (org-element-parse-buffer))</span>
</pre>
</div>

<pre class="example">
(&lt;a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org"&gt;news.org&lt;/a&gt; &lt;a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org"&gt;news.org&lt;/a&gt; &lt;a href="/media/Changing-links-to-files-so-they work-in-a-blog/news.org"&gt;Org-file containing news&lt;/a&gt; &lt;pre&gt;elisp:(princ "test")&lt;/pre&gt; &lt;img src="/media/Changing-links-to-files-so-they work-in-a-blog/tooltip-emacs.png"&gt; &lt;a href="/media/Changing-links-to-files-so-they work-in-a-blog/fabfile.py"&gt;fabfile.py&lt;/a&gt; &lt;a href="http://orgmode.org/worg/exporters/filter-markup.html"&gt;http://orgmode.org/worg/exporters/filter-markup.html&lt;/a&gt; &lt;a href="https://github.com/jkitchin/jmax/blob/prelude/blogofile.el"&gt;https://github.com/jkitchin/jmax/blob/prelude/blogofile.el&lt;/a&gt;)
</pre>

<p>
Now, we are ready to consider the filter. Again, building off of <a href="http://orgmode.org/worg/exporters/filter-markup.html">http://orgmode.org/worg/exporters/filter-markup.html</a>we are going to setup a counter, increment the counter in the filter, and get the nth url from the list we constructed above, and replace the text if the URL is not nil. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((counter 0))

  (<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">ox-mrkup-filter-link</span> (text back-end info)
    (<span style="color: #8b0000;">let</span> ((url (nth counter url-list)))
      (<span style="color: #8b0000;">if</span> (not (string= url <span style="color: #228b22;">"nil"</span>)) (setq output   (format <span style="color: #228b22;">"%s"</span> url))
        (setq output (format <span style="color: #228b22;">"%s"</span> text)))
      (setq counter (+ counter 1))
      output))

  (<span style="color: #8b0000;">let</span> ((org-export-filter-link-functions '(ox-mrkup-filter-link))
        (async nil)
        (subtreep nil)
        (visible-only nil)
        (body-only t)
        (ext-plist '()))
    (org-html-export-as-html async subtreep visible-only body-only ext-plist))

    <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">now get the output into the org output</span>
    (switch-to-buffer <span style="color: #228b22;">"*Org HTML Export*"</span>)

    (setq HTML (buffer-string))
    (setq YAML <span style="color: #228b22;">"---</span>
<span style="color: #228b22;">title: Changing links to files so they work in a blog</span>
<span style="color: #228b22;">date: 2013/09/28 17:49:00</span>
<span style="color: #228b22;">updated: 2013/09/29 08:14:00</span>
<span style="color: #228b22;">categories: org-mode</span>
<span style="color: #228b22;">---</span>



<span style="color: #228b22;">"</span>)
  (<span style="color: #8b0000;">with-temp-buffer</span>
(insert YAML)
(insert HTML)
(write-region (point-min) (point-max) <span style="color: #228b22;">"../_posts/2013-09-28-Changing-links-to-files-so-they-work-in-a-blog.html"</span>)))
(princ <span style="color: #228b22;">"Done."</span>)
</pre>
</div>

<pre class="example">
Done.
</pre>

<p>
You can see from this that we were able to process the org-buffer to get all the links, identify which of those links were external files that were not images (png files), and copy those files to our blog directory. Finally, we used a filter to modify the link text to point towards the blog url for publishing to HTML. I don't have this fully automated in <a href="https://github.com/jkitchin/jmax/blob/prelude/blogofile.el">https://github.com/jkitchin/jmax/blob/prelude/blogofile.el</a>, but now all the pieces are done to enable that one day!
</p>
</div>
</div>
</div>


    </div>
  </div>
</article>



  <div class="after_post"><a href="http://jkitchin.github.io/blog/2013/09/28/Changing-links-to-files-so-they-work-in-a-blog#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="/blog/category/org-mode/3">« Previous Page</a>
  --  
 <a href="/blog/category/org-mode/5">Next Page »</a>

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
<section>
Search
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kitchingroup.cheme.cmu.edu" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
</section>


  <section>
    <h1 class="post_header_gradient theme_font">Links</h1>
    <ul>
    <li><a href="http://enthought.com">Enthought Python</a></li>
    <li><a href="/pycse">Pycse</a></li>
    <li><a href="/dft-book">DFT-book</a></li>
    </ul>
  </section>

  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2014/02/19/Extracting-bibtex-file-from-an-org-buffer/">Extracting bibtex file from an org-buffer</a></li>
      <li><a href="/blog/2014/02/17/yasnippets-for-jasp-ase-and-python/">yasnippets for jasp, ase and python</a></li>
      <li><a href="/blog/2014/02/16/A-dynamic-snippet-for-a-task-due-7-days-from-now/">A dynamic snippet for a task due 7 days from now</a></li>
      <li><a href="/blog/2014/02/10/Merging-bibtex-files-and-avoiding-duplicates/">Merging bibtex files and avoiding duplicates</a></li>
      <li><a href="/blog/2014/02/09/Sorting-fields-in-bibtex-entries/">Sorting fields in bibtex entries</a></li>
    </ul>
  </section>

  <section>
 <h1 class="post_header_gradient theme_font"><a href="http://www.citeulike.org/user/jkitchin" class="external text" title="http://www.citeulike.org/user/jkitchin" rel="nofollow">CiteULike</a> Reading List</h1>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {

var d = new Date();
curr_year = d.getFullYear();

$.getJSON('http://www.citeulike.org/json/user/jkitchin/,,?callback=?&per_page=5',
function(data) {
  var items = [];
  year=curr_year
  $.each(data, function(i) {
    year=data[i].published[0];
    var cit='<li id="' + i + '">' + '<a class="pap" href="http://dx.doi.org/'+data[i].doi+'">'+ data[i].title + '</a><br>';
    cit+='</li>';
    items.push( cit )      
  });

  $('<ul/>', {
    'class': 'my-new-list',
    html: items.join('')
  }).appendTo('#papers2');
});
});
</script>

<div id="papers2"></div>

  </section>

<section>
<h1 class="post_header_gradient theme_font">Latest GitHub Repos</h1>
  <a href="https://github.com/jkitchin">@jkitchin</a> on GitHub.
<ul id="my-github-projects">
    <li class="loading">Status updating&#8230;</li>
  </ul>

</section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
        <a href="http://kitchinresearchgroup.disqus.com/latest.rss">Comments RSS Feed</a>.
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2014
        John Kitchin
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-35731398-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script>
  (function() {
      var links = document.getElementsByTagName('a');
      var query = '?';
      for(var i = 0; i < links.length; i++) {
          if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
          }
      }
      document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/kitchinresearchgroup/get_num_replies.js' + query + '"></' + 'script>');
  })();
  </script>

  </body>
</html>






<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="/js/git.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function() {
     $("#my-github-projects").loadRepositories("jkitchin");
    });
</script>



