<?xml version="1.0" encoding="UTF-8"?>
<feed
  xmlns="http://www.w3.org/2005/Atom"
  xmlns:thr="http://purl.org/syndication/thread/1.0"
  xml:lang="en"
   >
  <title type="text">The Kitchin Research Group</title>
  <subtitle type="text">Chemical Engineering at Carnegie Mellon University</subtitle>

  <updated>2015-11-21T00:32:24Z</updated>
  <generator uri="http://blogofile.com/">Blogofile</generator>

  <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog" />
  <id>http://jkitchin.github.io/blog/feed/atom/</id>
  <link rel="self" type="application/atom+xml" href="http://jkitchin.github.io/blog/feed/atom/" />
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Asynchronously running python blocks in org-mode]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/11/20/Asynchronously-running-python-blocks-in-org-mode" />
    <id>http://jkitchin.github.io/blog/2015/11/20/Asynchronously-running-python-blocks-in-org-mode</id>
    <updated>2015-11-20T19:30:57Z</updated>
    <published>2015-11-20T11:46:45Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="python" />
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[Asynchronously running python blocks in org-mode]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/11/20/Asynchronously-running-python-blocks-in-org-mode"><![CDATA[


<p>
If you run long Python blocks from org-mode, you might want to keep working while it runs. Currently Emacs gets blocked and you have to wait patiently.  In this post we consider some ways to avoid this that run our code asynchronously, but still put results where they belong in the org-buffer.
</p>

<p>
This is a long post. You may want to see the video: <a href="https://www.youtube.com/watch?v=VDyoN8yipSE">https://www.youtube.com/watch?v=VDyoN8yipSE</a> , or skip to the <a href="#sec-3">end</a> where the best and final version is shown.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> The async module</h2>
<div class="outline-text-2" id="text-1">
<p>
Here we consider an approach that uses <a href="https://github.com/jwiegley/emacs-async">https://github.com/jwiegley/emacs-async</a> module. The idea is to tangle the Python block at point to a temp file, then asynchronously run it. We capture the output and put it back in the buffer. We use a uuid to find the place to put the results in org-mode format. Here is the code that implements this idea.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">async</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-async-execute</span> ()
  <span style="color: #036A07;">"Run a python block at point asynchrously."</span>
  (<span style="color: #0000FF;">interactive</span>)

  (<span style="color: #0000FF;">let</span> ((current-file (buffer-file-name))
        (uuid (org-id-uuid))
        (temporary-file-directory <span style="color: #008000;">"./"</span>)
        (tempfile (make-temp-file <span style="color: #008000;">"py-"</span>)))

    (org-babel-tangle '(4) tempfile)
    (org-babel-remove-result)
    (<span style="color: #0000FF;">save-excursion</span>
      (re-search-forward <span style="color: #008000;">"#\\+END_SRC"</span>)
      (insert (format
               <span style="color: #008000;">"\n\n#+RESULTS: %s\n: %s"</span>
               (<span style="color: #0000FF;">or</span> (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context))
                   <span style="color: #008000;">""</span>)
               uuid)))

    (<span style="color: #0000FF;">async-start</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">what to start</span>
     `(<span style="color: #0000FF;">lambda</span> ()
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now we run the command then cleanup</span>
        (<span style="color: #0000FF;">prog1</span>
            (shell-command-to-string (format <span style="color: #008000;">"python %s"</span> ,tempfile))
          (delete-file ,tempfile)))

     `(<span style="color: #0000FF;">lambda</span> (result)
        <span style="color: #036A07;">"Code that runs when the async function finishes."</span>
        (<span style="color: #0000FF;">save-window-excursion</span>
          (<span style="color: #0000FF;">save-excursion</span>
            (<span style="color: #0000FF;">save-restriction</span>
              (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect ,current-file)
                (goto-char (point-min))
                (re-search-forward ,uuid)
                (beginning-of-line)
                (kill-line)
                (insert (mapconcat
                         (<span style="color: #0000FF;">lambda</span> (x)
                           (format <span style="color: #008000;">": %s"</span> x))
                         (butlast (s-split <span style="color: #008000;">"\n"</span> result))
                         <span style="color: #008000;">"\n"</span>))))))))))
</pre>
</div>

<pre class="example">
org-babel-async-execute
</pre>

<p>
Here is a block to test it on. We can run the block, and keep on working while the code runs. The results seem to get inserted correctly at the right point even if I am in another window or frame! We don't get easy access to continuous output of the command. This wouldn't work if we close Emacs, but who does that?
</p>


<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'hello world'</span>
<span style="color: #0000FF;">import</span> time
time.sleep(5)

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">print</span> os.getcwd()
<span style="color: #0000FF;">print</span> time.asctime()
</pre>
</div>

<pre class="example">
hello world
/Users/jkitchin/blogofile-jkitchin.github.com/_blog
Fri Nov 20 10:17:53 2015
</pre>

<p>
There are some limitations to this approach. One of them is it assumes the src block is a stand-alone block that will run on its own. That is usually how I run mine, but I could see having other modules that should be tangled out of a file too. I think the script is being run in the current working directory, so it probably will find any local imports it needs.
</p>

<p>
You don't get any intermediate feedback on this process. It seems to be possible to do that with a different approach that puts some output in a new buffer, e.g. with start-process. But, you still need some clever code like the async model to know when to insert the results back into this buffer. We consider Emacs processes and sentinels next.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Emacs process approach with tangling</h2>
<div class="outline-text-2" id="text-2">
<p>
We can start a process in Emacs, and attach a sentinel function to it that runs after the process completes. Here is an example of that. We still tangle the src-block here.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-async-execute</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let*</span> ((current-file (buffer-file-name))
        (uuid (org-id-uuid))
        (temporary-file-directory <span style="color: #008000;">"./"</span>)
        (tempfile (make-temp-file <span style="color: #008000;">"py-"</span>))
        (pbuffer (format <span style="color: #008000;">"*%s*"</span> uuid))
        process)

    (org-babel-tangle '(4) tempfile)
    (org-babel-remove-result)

    (<span style="color: #0000FF;">save-excursion</span>
      (re-search-forward <span style="color: #008000;">"#\\+END_SRC"</span>)
      (insert (format
               <span style="color: #008000;">"\n\n#+RESULTS: %s\n: %s"</span>
               (<span style="color: #0000FF;">or</span> (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context))
                   <span style="color: #008000;">""</span>)
               uuid)))

    (<span style="color: #0000FF;">setq</span> process (start-process
                   uuid
                   pbuffer
                   <span style="color: #008000;">"python"</span>
                   tempfile))

    (set-process-sentinel
     process
     `(<span style="color: #0000FF;">lambda</span> (process event)
        (<span style="color: #0000FF;">when</span> (string= <span style="color: #008000;">"finished\n"</span> event)
          (delete-file ,tempfile)
          (<span style="color: #0000FF;">save-window-excursion</span>
            (<span style="color: #0000FF;">save-excursion</span>
              (<span style="color: #0000FF;">save-restriction</span>
                (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect ,current-file)
                  (goto-char (point-min))
                  (re-search-forward ,uuid)
                  (beginning-of-line)
                  (kill-line)
                  (insert (mapconcat
                           (<span style="color: #0000FF;">lambda</span> (x)
                             (format <span style="color: #008000;">": %s"</span> x))
                           (split-string
                            (<span style="color: #0000FF;">with-current-buffer</span> ,pbuffer (buffer-string))
                            <span style="color: #008000;">"\n"</span>)
                           <span style="color: #008000;">"\n"</span>)))))))
        (kill-buffer ,pbuffer)))))
</pre>
</div>

<pre class="example">
org-babel-async-execute
</pre>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'hello world'</span>
<span style="color: #0000FF;">import</span> time
time.sleep(10)

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">print</span> os.getcwd()
<span style="color: #0000FF;">print</span> time.asctime()
</pre>
</div>

<pre class="example">
hello world
/Users/jkitchin/blogofile-jkitchin.github.com/_blog
Fri Nov 20 10:20:01 2015
</pre>

<p>
That works well from what I can see. There are some limitations. I doubt this will work if you use variables in the src block header. Next we consider an approach that does not do the tangling, and that will show us code output as it goes.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><a id="ID-D8F2CBB5-31B2-4477-A363-E3C0063214DE" name="ID-D8F2CBB5-31B2-4477-A363-E3C0063214DE"></a><span class="section-number-2">3</span> Emacs process approach with no tangling</h2>
<div class="outline-text-2" id="text-3">
<p>
As an alternative to tangling to a file, here we just copy the code to a file and then run it. This allows us to use :var in the header to pass data in at run time. At the moment, this code only supports printed output from code blocks, not the value for :results.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-async-execute:python</span> ()
  <span style="color: #036A07;">"Execute the python src-block at point asynchronously.</span>
<span style="color: #036A07;">:var headers are supported.</span>
<span style="color: #036A07;">:results output is all that is supported for output.</span>

<span style="color: #036A07;">A new window will pop up showing you the output as it appears,</span>
<span style="color: #036A07;">and the output in that window will be put in the RESULTS section</span>
<span style="color: #036A07;">of the code block."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let*</span> ((current-file (buffer-file-name))
         (uuid (org-id-uuid))
         (code (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context)))
         (temporary-file-directory <span style="color: #008000;">"."</span>)
         (tempfile (make-temp-file <span style="color: #008000;">"py-"</span>))
         (pbuffer (format <span style="color: #008000;">"*%s*"</span> uuid))
         (varcmds (org-babel-variable-assignments:python
                   (nth 2 (org-babel-get-src-block-info))))
         process)

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">get rid of old results, and put a place-holder for the new results to</span>
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">come.</span>
    (org-babel-remove-result)

    (<span style="color: #0000FF;">save-excursion</span>
      (re-search-forward <span style="color: #008000;">"#\\+END_SRC"</span>)
      (insert (format
               <span style="color: #008000;">"\n\n#+RESULTS: %s\n: %s"</span>
               (<span style="color: #0000FF;">or</span> (org-element-property <span style="color: #006FE0;">:name</span> (org-element-context))
                   <span style="color: #008000;">""</span>)
               uuid)))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">open the results buffer to see the results in.</span>
    (switch-to-buffer-other-window pbuffer)

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Create temp file containing the code.</span>
    (<span style="color: #0000FF;">with-temp-file</span> tempfile
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">if there are :var headers insert them.</span>
      (<span style="color: #0000FF;">dolist</span> (cmd varcmds)
        (insert cmd)
        (insert <span style="color: #008000;">"\n"</span>))
      (insert code))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">run the code</span>
    (<span style="color: #0000FF;">setq</span> process (start-process
                   uuid
                   pbuffer
                   <span style="color: #008000;">"python"</span>
                   tempfile))

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">when the process is done, run this code to put the results in the</span>
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">org-mode buffer.</span>
    (set-process-sentinel
     process
     `(<span style="color: #0000FF;">lambda</span> (process event)
        (<span style="color: #0000FF;">save-window-excursion</span>
          (<span style="color: #0000FF;">save-excursion</span>
            (<span style="color: #0000FF;">save-restriction</span>
              (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect ,current-file)
                (goto-char (point-min))
                (re-search-forward ,uuid)
                (beginning-of-line)
                (kill-line)
                (insert
                 (mapconcat
                  (<span style="color: #0000FF;">lambda</span> (x)
                    (format <span style="color: #008000;">": %s"</span> x))
                  (butlast (split-string
                            (<span style="color: #0000FF;">with-current-buffer</span>
                                ,pbuffer
                              (buffer-string))
                            <span style="color: #008000;">"\n"</span>))
                  <span style="color: #008000;">"\n"</span>))))))
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">delete the results buffer then delete the tempfile.</span>
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">finally, delete the process.</span>
        (<span style="color: #0000FF;">when</span> (get-buffer ,pbuffer)
          (kill-buffer ,pbuffer)
          (delete-window))
        (delete-file ,tempfile)
        (delete-process process)))))
</pre>
</div>

<pre class="example">
org-babel-async-execute:python
</pre>

<p>
Let us try it out again.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">print</span> <span style="color: #008000;">'hello world'</span>
<span style="color: #0000FF;">import</span> time
time.sleep(1)

<span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span>(5):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">print</span> i

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   time.sleep(0.5)


<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">print</span> os.getcwd()
<span style="color: #0000FF;">print</span> time.asctime()

<span style="color: #0000FF;">print</span> data

<span style="color: #0000FF;">raise</span> <span style="color: #6434A3;">IOError</span>(<span style="color: #008000;">'No file!'</span>)
</pre>
</div>

<pre class="example">
hello world
0
1
2
3
4
/Users/jkitchin/blogofile-jkitchin.github.com/_blog
Fri Nov 20 19:30:16 2015
[1, 3]
Traceback (most recent call last):
  File "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/py-84344aa1", line 18, in &lt;module&gt;
    raise IOError('No file!')
IOError: No file!
</pre>

<p>
It works fine for this simple example. We get to see the output as the code executes, which is a pleasant change from the usual way of running python blocks. There is some support for some header arguments, notably the :var header. I don't use :results value in Python, so for now only output is supported. We even support Exceptions in the output finally!
</p>

<p>
Maybe some org-moder's out there can try this and run it through some more rigorous paces?
</p>
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/20/Asynchronously-running-python-blocks-in-org-mode.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Functional and display math in technical documents]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/11/19/Functional-and-display-math-in-technical-documents" />
    <id>http://jkitchin.github.io/blog/2015/11/19/Functional-and-display-math-in-technical-documents</id>
    <updated>2015-11-19T14:43:12Z</updated>
    <published>2015-11-19T06:07:15Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[Functional and display math in technical documents]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/11/19/Functional-and-display-math-in-technical-documents"><![CDATA[


<p>
I have been thinking about a way to have functional and readable mathematics in technical documents. It has always bothered me that I have to write a LaTeX version of an equation, and then a separate implementation of the equation in code somewhere. At least twice in my life these separate representations have not agreed!
</p>

<p>
One solution might be if my functional code could be converted to LaTeX easily. I explore one simple approach to this here. It is somewhat inspired by this work here <a href="http://oremacs.com/2015/01/23/eltex/">http://oremacs.com/2015/01/23/eltex/</a> on writing LaTeX in emacs-lisp, and from my work with org-mode in mixing narrative text, LaTeX and code.
</p>

<p>
The idea is to use emacs-lisp for the code, so it is functional, but provide an alternative output for the <i>same code</i> for a document conversion. In other words, we accept there is more than one version we need: a functional version for working, and a consumption version for presentation. We will generate the consumption version from the functional version.
</p>

<p>
I know emacs-lisp is not ideal for mathematics the way we are accustomed to seeing it, but it enables the idea I want to explore here so we will try it.
</p>

<p>
Here is the simplest example I could come up with for functional math. We can run it ourselves, and verify it is correct.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(+ 1 2 3)
</pre>
</div>

<pre class="example">
6
</pre>

<p>
Now, I can change the meaning of this code temporarily, so that it not only evaluates the form, but also represents the equation and result in LaTeX code. If this was incorporated into a preprocessor of the document, we could have a functional version representing our equations, in code form, and a presentation version generated from this version. The code that follows isn't how I would do this is in some production setting; it is only to show that you can <i>temporarily</i> change the meaning of "+". In a production setting, there would just be (+ 1 2 3) in the text, and a preprocessor would find all the sexps in the text, and replace them with the export format using code like this. At least, that is what I am imagining. It might be feasible to do this already with inline org-babel calls and an org-mode export filter, but I didn't try it here. So, here is the proof of concept code.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">cl-flet</span> ((+ (<span style="color: #0000FF;">lambda</span> (<span style="color: #6434A3;">&amp;rest</span> args)
               (format
                <span style="color: #008000;">"$%s = %s$"</span>
                (mapconcat #'number-to-string args <span style="color: #008000;">" + "</span>)
                (eval `(+ ,@args))))))
  (+ 1 2 3))
</pre>
</div>

<p>
\(1 + 2 + 3 = 6\)
</p>



<p>
Here is an example that generates a fraction from a division.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">cl-flet</span> ((/ (<span style="color: #0000FF;">lambda</span> (<span style="color: #6434A3;">&amp;rest</span> args)
               (format
                <span style="color: #008000;">"$\\frac{%s}{%s} = %s$"</span>
                (car args)
                (mapconcat 'number-to-string (cdr args) <span style="color: #008000;">" \\cdot "</span>)
                (eval `(/ ,@args))))))
  (/ 1.0 2.0 3.0))
</pre>
</div>

<p>
\(\frac{1.0}{2.0 \cdot 3.0} = 0.16666666666666666\)
</p>

<p>
As a proof of concept, this idea looks feasible, but this implementation has some limitations. Getting this to a complete workable approach would require a lot of work, basically creating transformation functions for many, many kinds of mathematical functions, and a lot of other kinds of logic. For example, (+ 1 2 (+ 3 4)) would not render correctly with the codes above. It isn't even clear what it should render to. I think you want 1 + 2 + (3 + 4) as the rendered output.
</p>

<p>
Anyway, it is an interesting idea, one that blurs the lines between code and mathematics. We are so used to the equation representation of mathematics, rather than the code representation that being able to go back and forth seems like a good idea, especially when one is derived from the other.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/19/Functional-and-display-math-in-technical-documents.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[YAT - yet another template strategy]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/11/01/YAT-yet-another-template-strategy" />
    <id>http://jkitchin.github.io/blog/2015/11/01/YAT-yet-another-template-strategy</id>
    <updated>2015-11-01T14:12:34Z</updated>
    <published>2015-11-01T14:12:34Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[YAT - yet another template strategy]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/11/01/YAT-yet-another-template-strategy"><![CDATA[



<p>
I have another need for a template that is dynamically evaluated. I previously wrote about this <a href="http://kitchingroup.cheme.cmu.edu/blog/2014/01/26/Another-alternative-to-string-templates/">here</a> , and today I am going to do a variation of the theme. We will still use a syntax of $(expression), but a new approach to evaluating the expression. I saw this interesting function to evaluate and replace an s-expression in a buffer <a href="http://emacsredux.com/blog/2013/06/21/eval-and-replace/">Eval and Replace - Emacs Redux</a> . I am going use that to replace a template expression in a string, with a little variation to avoid replacing non-sexp variations, e.g. $(. Here we go.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">eval-and-replace</span> ()
  <span style="color: #036A07;">"Replace the preceding sexp with its value."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (backward-kill-sexp)
  (<span style="color: #0000FF;">condition-case</span> nil
      (princ (eval (read (current-kill 0)))
             (current-buffer))
    (<span style="color: #ff0000; font-weight: bold;">error</span> (message <span style="color: #008000;">"Invalid expression"</span>)
           (insert (concat <span style="color: #008000;">"$"</span> (current-kill 0))))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">j-format</span> (s)
  <span style="color: #036A07;">"Replace all instances of $(expression) in S with the evaluated</span>
<span style="color: #036A07;">expression."</span>
  (<span style="color: #0000FF;">with-temp-buffer</span>
    (insert s)
    (goto-char (point-min))
    (<span style="color: #0000FF;">while</span> (re-search-forward <span style="color: #008000;">"$("</span> nil t)
      (backward-char)
      (<span style="color: #0000FF;">when</span> (sexp-at-point)
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">get rid of the $</span>
        (delete-char -1)
        <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">go to the end of the sexp and then eval-and-replace it.</span>
        (end-of-sexp)
        (eval-and-replace)))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">return the formatted text.</span>
    (buffer-string)))


(<span style="color: #0000FF;">let</span> ((some-var <span style="color: #008000;">"You got me"</span>))
  (j-format <span style="color: #008000;">"Test of 4 + 5 = $(+ 4 5). $(  $(foobar). $(progn (setq x 5) \"\")</span>
<span style="color: #008000;">and then we have 2x=$(prin1 (* 2 x)).</span>

<span style="color: #008000;">some-var = $(print some-var)"</span>))
</pre>
</div>

<pre class="example">
Test of 4 + 5 = 9. $(  $(foobar).
and then we have 2x=10.

some-var = You got me
</pre>

<p>
That seems pretty ok. I obviously have not tested it extensively, but it looks pretty promising.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/11/01/YAT---yet-another-template-strategy.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Saving the current restriction and restoring it while following links]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links" />
    <id>http://jkitchin.github.io/blog/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links</id>
    <updated>2015-10-25T07:09:15Z</updated>
    <published>2015-10-24T13:41:45Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[Saving the current restriction and restoring it while following links]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links"><![CDATA[



<p>
On the org-mode mailing list there has been some discussion about following id links. The issue is that if your buffer is narrowed, clicking on the link does not change the restriction to actually take you to the entry. This is debatably desirable. If I click on a link, I want it to go where it points. But, I might also like to go back to my narrowed view. So here consider how to save the state of narrowing, and restore it. We modify the function that opens an id link to save the restriction, and widen the buffer if necessary.
</p>

<p>
Saving the restriction seems easy, we just save a marker to point, and the point-min and point-max. We save the marker for a convenient way to get the buffer, and perhaps the actual point. We advise the C-c &amp; function to restore the restriction after we leave it. This should fix the restriction in whatever buffer we undid it in.
</p>

<p>
Here is the code that seems to work for me. Thanks to Rasmus for the idea on saving the restriction data.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">*saved-restriction*</span> nil
 <span style="color: #036A07;">"A global var containing the current restriction.</span>
<span style="color: #036A07;">Returns (current-buffer point-min point-max"</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">save-current-restriction</span> ()
  <span style="color: #036A07;">"Save the current restriction at point."</span>
  (<span style="color: #0000FF;">setq</span> *saved-restriction*
        (<span style="color: #0000FF;">if</span> (buffer-narrowed-p)
            (list (current-buffer) (point-min) (point-max))
          nil)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">restore-saved-restriction</span> ()
  <span style="color: #036A07;">"Restore the last saved restriction."</span>
  (<span style="color: #0000FF;">when</span> *saved-restriction*
    (set-buffer (car *saved-restriction*))
    (narrow-to-region (nth 1 *saved-restriction*)
                      (nth 2 *saved-restriction*)))
  (<span style="color: #0000FF;">setq</span> *saved-restriction* nil))

<span style="color: #8D8D84;">;</span><span style="color: #8D8D84; font-style: italic;">' actually modify this function to save the restriction, and widen if needed.</span>
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-id-open</span> (id)
  <span style="color: #036A07;">"Go to the entry with id ID."</span>
  (org-mark-ring-push)
  (<span style="color: #0000FF;">let</span> ((m (org-id-find id 'marker))
        cmd)
    (<span style="color: #0000FF;">unless</span> m
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"Cannot find entry with ID \"%s\""</span> id))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Use a buffer-switching command in analogy to finding files</span>
    (<span style="color: #0000FF;">setq</span> cmd
          (<span style="color: #0000FF;">or</span>
           (cdr
            (assq
             (cdr (assq 'file org-link-frame-setup))
             '((find-file . switch-to-buffer)
               (find-file-other-window . switch-to-buffer-other-window)
               (find-file-other-frame . switch-to-buffer-other-frame))))
           'switch-to-buffer-other-window))
    (<span style="color: #0000FF;">if</span> (not (equal (current-buffer) (marker-buffer m)))
        (funcall cmd (marker-buffer m)))
    (save-current-restriction)
    (<span style="color: #0000FF;">when</span> (&gt; m (point-max))
      (widen))
    (goto-char m)
    (move-marker m nil)
    (org-show-context)))


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">And we advise the function going back to restore the restriction.</span>
(<span style="color: #0000FF;">defadvice</span> <span style="color: #006699;">org-mark-ring-goto</span> (after restore-my-restriction () activate)
  <span style="color: #036A07;">"Restore narrowing."</span>
  (restore-saved-restriction))
</pre>
</div>

<pre class="example">
org-mark-ring-goto
</pre>

<p>
This seems to preserve restrictions in the current buffer and in other buffers, as long as I use C-c &amp; to invoke org-mark-ring goto. I am not sure how easy it would be to make this work for all links. Each link has its own function for following so I am not sure we can easily get them all to do this unless there is some high level function to advise like org-mouse-down-mouse or something similar. It also has the limitation that the restoration only occurs using org-mark-ring-goto, unless you specifically run the  (restore-saved-restriction) function yourself. That could be made an interactive function for that purpose. Otherwise, this seems like a reasonable approach.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/24/Saving-the-current-restriction-and-restoring-it-while-following-links.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Line numbers in org-mode code blocks]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/10/13/Line-numbers-in-org-mode-code-blocks" />
    <id>http://jkitchin.github.io/blog/2015/10/13/Line-numbers-in-org-mode-code-blocks</id>
    <updated>2015-10-13T08:58:34Z</updated>
    <published>2015-10-13T08:58:34Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[Line numbers in org-mode code blocks]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/10/13/Line-numbers-in-org-mode-code-blocks"><![CDATA[



<p>
Some of my students have wanted to show line numbers in code blocks. This is especially useful for when you run a Python block, and you get an error message with a line number in it. Right now, to figure out which line that is, you have to into the code block, type C-c ' to get into edit mode, and turn line numbers on. We look into how to achieve that here.
</p>

<p>
You may want to see the video here: <a href="https://www.youtube.com/watch?v=kinWijGzXms">https://www.youtube.com/watch?v=kinWijGzXms</a> .
</p>

<p>
First, we need to get the region that is the code block. We can find some info in the org-element, but, the :begin and :end include lines we don't want, like the header lines, and the results. But, we can get the beginning, and maybe from there search forward to the block. Run this code block to see where the point goes.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="boring-example"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">a boring comment</span>

(<span style="color: #0000FF;">progn</span>
  (+ 40 2))

(goto-char (org-element-property <span style="color: #006FE0;">:begin</span> (org-element-context)))
(re-search-forward (regexp-quote (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context))))
(goto-char (match-beginning 0))
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">number of lines in block. The last carriage return doesn't count.</span>
(1- (length (s-split <span style="color: #008000;">"\n"</span> (org-element-property <span style="color: #006FE0;">:value</span> (org-element-context)))))
</pre>
</div>

<pre class="example">
9
</pre>

<p>
So, we can get the number of lines, and move the point to the first line. For numbers, we will use overlays. Here is a simple way to put a number at the beginning of a line.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">let</span> (ov)
  (beginning-of-line)
  (<span style="color: #0000FF;">setq</span> ov (make-overlay (point) (point)))
  (overlay-put ov 'before-string <span style="color: #008000;">"1"</span>))
</pre>
</div>

<pre class="example">
1
</pre>

<p>
The next thing to do is make a function that puts a number at the beginning of a line. We might as well store these overlays in a variable, so they are easy to remove later. This is just for exploration of how to do it. Later we combine all these pieces together.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">number-line-overlays</span> '()
  <span style="color: #036A07;">"List of overlays for line numbers."</span>)

(make-variable-buffer-local 'number-line-overlays)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">number-line</span> (N)
 <span style="color: #036A07;">"Put an overlay at the beginning of a line."</span>
  (beginning-of-line)
  (<span style="color: #0000FF;">let</span> (ov)
    (<span style="color: #0000FF;">setq</span> ov (make-overlay (point) (point)))
    (overlay-put ov 'before-string (format <span style="color: #008000;">"%3s"</span> (number-to-string N)))
    (add-to-list 'number-line-overlays ov)))

(number-line 4)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">#&lt;overlay from 1782 to 1782 in blog.org&gt;</td>
</tr>
</tbody>
</table>


<p>
That looks promising. Let's make a function to clear those overlays. It is so easy it may not even be worth writing.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">number-line-clear</span> ()
  (mapc 'delete-overlay number-line-overlays)
  (<span style="color: #0000FF;">setq</span> number-line-overlays '()))

(number-line-clear)
</pre>
</div>

<p>
Finally, we are ready to hack up the code block numbering code. The numbers will not automatically update, so we will write a function that numbers the block, but only temporarily. Any key press will get rid of the numbers so we can get back to work.  I am going to go ahead and make this a stand-alone function and block.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">number-line-overlays</span> '()
  <span style="color: #036A07;">"List of overlays for line numbers."</span>)

(make-variable-buffer-local 'number-line-overlays)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">number-line-src-block</span> ()
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">save-excursion</span>
    (<span style="color: #0000FF;">let*</span> ((src-block (org-element-context))
           (nlines (- (length
                       (s-split
                        <span style="color: #008000;">"\n"</span>
                        (org-element-property <span style="color: #006FE0;">:value</span> src-block)))
                      1)))
      (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> src-block))
      (re-search-forward (regexp-quote (org-element-property <span style="color: #006FE0;">:value</span> src-block)))
      (goto-char (match-beginning 0))

      (<span style="color: #0000FF;">loop</span> for i from 1 to nlines
            do
            (beginning-of-line)
            (<span style="color: #0000FF;">let</span> (ov)
              (<span style="color: #0000FF;">setq</span> ov (make-overlay (point) (point)))
              (overlay-put ov 'before-string (format <span style="color: #008000;">"%3s"</span> (number-to-string i)))
              (add-to-list 'number-line-overlays ov))
            (next-line))))

  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now read a char to clear them</span>
  (read-key <span style="color: #008000;">"Press a key to clear numbers."</span>)
  (mapc 'delete-overlay number-line-overlays)
  (<span style="color: #0000FF;">setq</span> number-line-overlays '()))

(number-line-src-block)
</pre>
</div>

<p>
I am not sure how to get the numbers to automatically update smoothly like they do in linum-mode. That code uses a lot of hooks to make updates work, and embeds them in a minor mode to get rid of them. It also puts them in the fringe I think, but it is not clear how that is done.
</p>

<p>
We could modify what happens after the numbers are put on, e.g. pressing numbers might jump to a line, or some other kind of functionality. I don't have a critical need for this right now, so I didn't explore it more. Let me know if you have any good ideas for it!
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/13/Line-numbers-in-org-mode-code-blocks.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Automatic latex image toggling when cursor is on a fragment]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment" />
    <id>http://jkitchin.github.io/blog/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment</id>
    <updated>2015-10-09T11:54:50Z</updated>
    <published>2015-10-09T11:54:50Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <summary type="html"><![CDATA[Automatic latex image toggling when cursor is on a fragment]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment"><![CDATA[



<p>
There was a recent suggestion on the org-mode mailing list to make it possible to toggle individual equations in org-mode when the cursor is on them, and have them toggle back when the mouse is off. Presumably, this would let you edit the equation and see the result very easily.
</p>

<p>
The strategy to enable this is to use add a function to the post-command function hook. The function will store the last fragment/environment you were on, and compare it to where you are now.  If they are different the function will put the overlay back on the previous point, and do something appropriate at the current point, e.g. nothing if you are not on a fragment, or remove the overlay of the fragment you are on. The function will get run after every command, so we make sure we are in org-mode first!
</p>

<p>
Here are some example equations.
</p>

<p>
Here is a sentence with an equation \(f^{2x}=3\) and another form \(e^x = 20\) in it.
</p>

<p>
Here is a standalone equation environment.
</p>

\begin{equation}
a + b \sqrt{5o}
\end{equation}

<p>
And now, \[15 + 7 = 12\],
</p>

<p>
It is easiest to see this in a video here: <a href="https://www.youtube.com/watch?v=E0s3PDBqsEc">https://www.youtube.com/watch?v=E0s3PDBqsEc</a> 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">org-latex-fragment-last</span> nil
  <span style="color: #036A07;">"Holds last fragment/environment you were on."</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-latex-fragment-toggle</span> ()
  <span style="color: #036A07;">"Toggle a latex fragment image "</span>
  (<span style="color: #0000FF;">and</span> (eq 'org-mode major-mode)
       (<span style="color: #0000FF;">let*</span> ((el (org-element-context))
              (el-type (car el)))
         (<span style="color: #0000FF;">cond</span>
          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">were on a fragment and now on a new fragment</span>
          ((<span style="color: #0000FF;">and</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fragment we were on</span>
            org-latex-fragment-last
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">and are on a fragment now</span>
            (<span style="color: #0000FF;">or</span>
             (eq 'latex-fragment el-type)
             (eq 'latex-environment el-type))
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">but not on the last one this is a little tricky. as you edit the</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">fragment, it is not equal to the last one. We use the begin</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">property which is less likely to change for the comparison.</span>
            (not (= (org-element-property <span style="color: #006FE0;">:begin</span> el)
                    (org-element-property <span style="color: #006FE0;">:begin</span> org-latex-fragment-last))))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">go back to last one and put image back</span>
           (<span style="color: #0000FF;">save-excursion</span>
             (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> org-latex-fragment-last))
             (org-preview-latex-fragment))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">now remove current image</span>
           (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> el))
           (<span style="color: #0000FF;">let</span> ((ov (<span style="color: #0000FF;">loop</span> for ov in org-latex-fragment-image-overlays
                           if
                           (<span style="color: #0000FF;">and</span>
                            (&lt;= (overlay-start ov) (point))
                            (&gt;= (overlay-end ov) (point)))
                           return ov)))
             (<span style="color: #0000FF;">when</span> ov
               (delete-overlay ov)))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">and save new fragment</span>
           (<span style="color: #0000FF;">setq</span> org-latex-fragment-last el))

          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">were on a fragment and now are not on a fragment</span>
          ((<span style="color: #0000FF;">and</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">not on a fragment now</span>
            (not (<span style="color: #0000FF;">or</span>
                  (eq 'latex-fragment el-type)
                  (eq 'latex-environment el-type)))
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">but we were on one</span>
            org-latex-fragment-last)
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">put image back on</span>
           (<span style="color: #0000FF;">save-excursion</span>
             (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> org-latex-fragment-last))
             (org-preview-latex-fragment))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">unset last fragment</span>
           (<span style="color: #0000FF;">setq</span> org-latex-fragment-last nil))

          <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">were not on a fragment, and now are</span>
          ((<span style="color: #0000FF;">and</span>
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">we were not one one</span>
            (not org-latex-fragment-last)
            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">but now we are</span>
            (<span style="color: #0000FF;">or</span>
             (eq 'latex-fragment el-type)
             (eq 'latex-environment el-type)))
           (goto-char (org-element-property <span style="color: #006FE0;">:begin</span> el))
           <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">remove image</span>
           (<span style="color: #0000FF;">let</span> ((ov (<span style="color: #0000FF;">loop</span> for ov in org-latex-fragment-image-overlays
                           if
                           (<span style="color: #0000FF;">and</span>
                            (&lt;= (overlay-start ov) (point))
                            (&gt;= (overlay-end ov) (point)))
                           return ov)))
             (<span style="color: #0000FF;">when</span> ov
               (delete-overlay ov)))
           (<span style="color: #0000FF;">setq</span> org-latex-fragment-last el))))))


(add-hook 'post-command-hook 'org-latex-fragment-toggle)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">org-latex-fragment-toggle</td>
<td class="left">matlab-start-block-highlight-timer</td>
<td class="left">eldoc-schedule-timer</td>
</tr>
</tbody>
</table>


<p>
I think there could be another way to do this with text properties, e.g. point-left and point-entered, but that would require those properties to be set on the fragments. I might try that approach another day.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/09/Automatic-latex-image-toggling-when-cursor-is-on-a-fragment.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[A checkbox list in org-mode with one value]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/10/05/A-checkbox-list-in-org-mode-with-one-value" />
    <id>http://jkitchin.github.io/blog/2015/10/05/A-checkbox-list-in-org-mode-with-one-value</id>
    <updated>2015-10-05T19:15:25Z</updated>
    <published>2015-10-05T19:15:25Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[A checkbox list in org-mode with one value]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/10/05/A-checkbox-list-in-org-mode-with-one-value"><![CDATA[



<p>
A while ago I had a need for a checklist in org-mode where only one value would be checked at a time. Like a radio button in a browser form. That isn't as far as I know a feature yet, but it was not hard to achieve thanks to the org-element api.  My simple idea is to make a function that will be added to the org-checkbox-statistics-hook. The function will uncheck all the boxes, and recheck the one you just clicked with a hybrid of manipulating the cursor and inserting characters with org-element code. We will use an attribute on the checklist to indicate it is a "radio" list. This seems like a feature that might already exist, but I couldn't find it.
</p>

<p>
Here is the code we run. First, we make sure we are on a plain list that has an attr_org property of ":radio", that way this won't apply to all lists, just the radio lists. Then, we loop through each element in the structure, and if it is checked, we replace [X] with [ ]. Then, we reinsert the X and delete a space, which puts [X] where we originally clicked, or used C-c C-c. Finally, we add it to the hook, so it only gets run when a checkbox is changed via clicking with org-mouse, or C-c C-c. Of course, this doesn't work if you type X in the box.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">dash</span>)
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">check-hook-fn</span> ()
  (<span style="color: #0000FF;">when</span> (-contains? (org-element-property
                     <span style="color: #006FE0;">:attr_org</span>
                     (org-element-property <span style="color: #006FE0;">:parent</span> (org-element-context)))
                    <span style="color: #008000;">":radio"</span>)
    (<span style="color: #0000FF;">save-excursion</span>
      (<span style="color: #0000FF;">loop</span> for el in (org-element-property <span style="color: #006FE0;">:structure</span> (org-element-context))
            do
            (goto-char (car el))
            (<span style="color: #0000FF;">when</span> (re-search-forward <span style="color: #008000;">"\\[X\\]"</span> (line-end-position) t)
              (replace-match <span style="color: #008000;">"[ ]"</span>))))
    (forward-char)
    (insert <span style="color: #008000;">"X"</span>)
    (delete-char 1)))

(add-hook 'org-checkbox-statistics-hook 'check-hook-fn)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">check-hook-fn</td>
</tr>
</tbody>
</table>

<p>
Here is a regular checklist. You can check as many as you want.
</p>
<ul class="org-ul">
<li><code>[X]</code> one
</li>
<li><code>[X]</code> two
</li>
<li><code>[&#xa0;]</code> three
</li>
</ul>

<p>
Now, here is a radio checklist. Only one item at a time can be checked. Nice!
</p>

<ul class="org-ul">
<li><code>[&#xa0;]</code> a
</li>
<li><code>[&#xa0;]</code> b
</li>
<li><code>[X]</code> c
</li>
</ul>

<p>
It is worth noting here that if we put a name on the list, it becomes an addressable data source. First we need this convenient function to get the data associated with a named list.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-get-plain-list</span> (name)
  <span style="color: #036A07;">"Get the org-element representation of a plain-list with NAME."</span>
  (<span style="color: #0000FF;">catch</span> '<span style="color: #D0372D;">found</span>
    (org-element-map
        (org-element-parse-buffer)
        'plain-list
      (<span style="color: #0000FF;">lambda</span> (plain-list)
        (<span style="color: #0000FF;">when</span>
            (string= name (org-element-property <span style="color: #006FE0;">:name</span> plain-list))
          (<span style="color: #0000FF;">throw</span> '<span style="color: #D0372D;">found</span> plain-list))))))
</pre>
</div>

<pre class="example">
org-get-plain-list
</pre>

<p>
Now, let's use that to get the value of the checked item in the "test" list. We define the item as everything after the [X] and get it from a regular expression match.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">get-radio-list-value</span> (list-name)
  <span style="color: #036A07;">"Return the value of the checked item in a radio list."</span>
  (<span style="color: #0000FF;">save-excursion</span>
    (<span style="color: #0000FF;">loop</span> for el in (org-element-property
                     <span style="color: #006FE0;">:structure</span>
                     (org-jump-to-plain-list list-name))
          if (string= (nth 4 el) <span style="color: #008000;">"[X]"</span>)
          return (<span style="color: #0000FF;">progn</span>
                   (<span style="color: #0000FF;">let</span> ((item (buffer-substring (car el) (car (last el)))))
                     (string-match <span style="color: #008000;">"\\[X\\]</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">.*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">$"</span> item)
                     (match-string 1 item))))))

(get-radio-list-value <span style="color: #008000;">"test"</span>)
</pre>
</div>

<pre class="example">
c
</pre>

<p>
Perfect. This has lots of potential applications. Data collection and quizzes come to mind, with associated ability to autograde and aggregate the data!
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/10/05/A-checkbox-list-in-org-mode-with-one-value.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Running scientific instruments in Emacs and recording the results]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/07/25/Running-scientific-instruments-in-Emacs-and-recording-the-results" />
    <id>http://jkitchin.github.io/blog/2015/07/25/Running-scientific-instruments-in-Emacs-and-recording-the-results</id>
    <updated>2015-07-25T10:04:01Z</updated>
    <published>2015-07-25T10:04:01Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="notebook" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[Running scientific instruments in Emacs and recording the results]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/07/25/Running-scientific-instruments-in-Emacs-and-recording-the-results"><![CDATA[



<p>
Today we look at running a scientific instrument via http requests from Emacs and org-mode. We will use a Gamry Ref600 potentiostat because Gamry has very nicely provide a COM interface we can access via Python. This will be only a proof of concept to see what it is like. We will not consider any issues of security, etc&#x2026;, only what is it like to do it.
</p>

<p>
The setup will look like this: we will run a flask web app that uses python to control the instrument via http requests. Why? Because I want to run the instrument from my Mac ;) and so far there are only Windows drivers for the instrument. So, we run the flask app on the Windows machine, and I run it from here on my Mac by sending requests. Flask takes care of converting requests to action using Python. You can see the <a href="#sec-2">Flask app here</a>.
</p>

<p>
Let's see what is online:
</p>
<div class="org-src-container">

<pre class="src src-sh">curl jkitchin-win.cheme.cmu.edu:5000/pstats
</pre>
</div>

<pre class="example">
(u'REF600-13089',)
</pre>

<p>
We have one potentiostat online with serial number 13089. I have a dummy cell connected to it which has a little resistor on it. So we can run a cyclic voltammogram and it should be a straight line. We have to know a bit about what is returned. We will get a json file back, and it will have the data in it. The data will be a list of lists. The data we want is in columns 1 and 3 (python indexing). Obviously you need some prior knowledge of what data comes back to use this. That would come from reading some documentation.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">import</span> requests
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt

<span style="color: #BA36A5;">resp</span> = requests.get(<span style="color: #008000;">'http://jkitchin-win.cheme.cmu.edu:5000/cv?endv=0.25&amp;startv=-0.25'</span>)

<span style="color: #BA36A5;">dj</span> = resp.json()
<span style="color: #BA36A5;">data</span> = np.array(dj[<span style="color: #008000;">'data'</span>])

plt.plot(data[:, 1], data[:, 3])
plt.xlabel(<span style="color: #008000;">'Voltage (V)'</span>)
plt.ylabel(<span style="color: #008000;">'Current (A)'</span>)
plt.tight_layout()
plt.savefig(<span style="color: #008000;">'cv-1.png'</span>)
</pre>
</div>

<p>
<img src="/media/2015-07-25-Running-scientific-instruments-in-Emacs-and-recording-the-results/cv-1.png"> 
Well, there you have it. Possibly the first Gamry Ref600 to ever have been driven from a Mac ;) Let me be more explicit about that; I could <i>also</i> run this from Linux, an iPad, etc&#x2026; You could do this in a browser, or in an IPython notebook, or in Matlab, among many other possibilities. You could write a script in perl, shell, ruby, emacs-lisp, or any other language that supports http requests.
</p>

<p>
I am not sure why the graph is not perfectly linear, maybe there is some capacitive charging that starts out. The resistance based on the current at 0.2V is about 2000 ohms, which is in good agreement with what is listed on the board the dummy cell is on.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Summary thoughts</h2>
<div class="outline-text-2" id="text-1">
<p>
There are a host of interesting issues one eventually has to consider here including security, but also error management and debugging. I hacked something like an http api here by running flask on the windows machine running the instrument. That is a layer of abstraction on an abstraction to start with. I think later instruments are likely to run these webservers themselves on small dedicated computers, e.g. via a Raspberry pi or Arduino chipset. It is not obvious how sophisticated you can make this with respect to triggering different instruments, etc&#x2026;
</p>

<p>
In running this, my "notebook" was blocked while the experiment ran. It is possible to run things asynchronously, and sometimes that would make sense. In the example here, we have provided a very limited set of functions to "run" the potentiostat. It was only a proof of concept to get a sense for what it is like. In practice a fuller set of functions would be implemented. Another point to consider is how the data comes back from the potentiostat. We used json here because it is convenient, but we could just as well send files, and other sorts of data too.
</p>

<p>
This lays out the possibility to walk up to an instrument with an electronic notebook, setup and run the experiment, capture the results in the notebook and take it back to the office for analysis. Pretty cool.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><a id="ID-5EB72A19-B9D3-4ABA-975F-61ACE16E0D87" name="ID-5EB72A19-B9D3-4ABA-975F-61ACE16E0D87"></a><span class="section-number-2">2</span> Flask app</h2>
<div class="outline-text-2" id="text-2">

<p>
So, here is my flask app. We setup a few routes using get requests to do things like get a list of the potentiostats online, and to run a cyclic voltamogram. As a side note, after this post is over, I am turning off the app, so you won't be able to repeat the codes ;) This is not a beautiful, secure or error tolerant code. It works enough for a proof of concept of simple experiments.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">from</span> flask <span style="color: #0000FF;">import</span> Flask, request, jsonify
<span style="color: #0000FF;">import</span> time

<span style="color: #BA36A5;">app</span> = Flask(<span style="color: #006FE0;">__name__</span>)

<span style="color: #6434A3;">@app.route</span>(<span style="color: #008000;">'/'</span>)
<span style="color: #0000FF;">def</span> <span style="color: #006699;">hello_world</span>():
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> <span style="color: #008000;">'Hello World!'</span>

<span style="color: #6434A3;">@app.route</span>(<span style="color: #008000;">'/pstats'</span>)
<span style="color: #0000FF;">def</span> <span style="color: #006699;">get_pstats</span>():
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">import</span> win32com.client <span style="color: #0000FF;">as</span> client
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">devices</span> = client.Dispatch(<span style="color: #008000;">'GamryCOM.GamryDeviceList'</span>)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">result</span> = <span style="color: #006FE0;">str</span>(devices.EnumSections())
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> result

<span style="color: #6434A3;">@app.route</span>(<span style="color: #008000;">'/close_pstat'</span>)
<span style="color: #0000FF;">def</span> <span style="color: #006699;">close</span>():
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">import</span> win32com.client <span style="color: #0000FF;">as</span> client
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">devicelist</span> = client.Dispatch(<span style="color: #008000;">'GamryCOM.GamryDeviceList'</span>)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">x</span> = devicelist.EnumSections()[0]
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">pstat</span> = client.Dispatch(<span style="color: #008000;">'GamryCOM.GamryPstat'</span>)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   pstat.Init(x)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   pstat.Close()


<span style="color: #0000FF;">def</span> <span style="color: #006699;">run_ramp</span>(Sinit,  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">start value</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>    Sfinal, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">end value</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>    ScanRate=1,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>    SampleRate=0.01,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>    CtrlMode=1,  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">GamryCOM.PstatMode</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>    fname=<span style="color: #D0372D;">None</span>):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #036A07;">'''We assume the first device is the one you want.</span>
<span style="color: #036A07;">    '''</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">import</span> win32com.client <span style="color: #0000FF;">as</span> client
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">devicelist</span> = client.Dispatch(<span style="color: #008000;">'GamryCOM.GamryDeviceList'</span>)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">x</span> = devicelist.EnumSections()[0]

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">pstat</span> = client.Dispatch(<span style="color: #008000;">'GamryCOM.GamryPstat'</span>)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   pstat.Init(x)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   pstat.Open()

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">dtaqcpiv</span>=client.Dispatch(<span style="color: #008000;">'GamryCOM.GamryDtaqCpiv'</span>)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   dtaqcpiv.Init(pstat)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">sigramp</span>=client.Dispatch(<span style="color: #008000;">'GamryCOM.GamrySignalRamp'</span>)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   sigramp.Init(pstat, Sinit, Sfinal, ScanRate, SampleRate, CtrlMode)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   pstat.SetSignal(sigramp)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   pstat.SetCell(1) <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">1 == GamryCOM.CellOn</span>

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">try</span>:
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   dtaqcpiv.Run(<span style="color: #D0372D;">True</span>)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">except</span> <span style="color: #6434A3;">Exception</span> <span style="color: #0000FF;">as</span> e:
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   pstat.Close()
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">raise</span>

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">NOTE:  The comtypes example in this same directory illustrates the use of com</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">notification events.  The comtypes package is recommended as an alternative</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">to win32com.</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   time.sleep(2) <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">just wait sufficiently long for the acquisition to complete.</span>

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">acquired_points</span> = []
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">count</span> = 1
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">while</span> count &gt; 0:
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">count</span>, <span style="color: #BA36A5;">points</span> = dtaqcpiv.Cook(10)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The columns exposed by GamryDtaq.Cook vary by dtaq and are</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">documented in the Toolkit Reference Manual.</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   acquired_points.extend(<span style="color: #006FE0;">zip</span>(*points))

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">acquired_points</span> = np.array(acquired_points)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">if</span> fname <span style="color: #0000FF;">is</span> <span style="color: #0000FF;">not</span> <span style="color: #D0372D;">None</span>:
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   np.savetxt(fname, acquired_points)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   pstat.Close()
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> jsonify({<span style="color: #008000;">'data'</span>: acquired_points.tolist()})

<span style="color: #6434A3;">@app.route</span>(<span style="color: #008000;">'/cv'</span>)
<span style="color: #0000FF;">def</span> <span style="color: #006699;">run_cv</span>():
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">result</span> = <span style="color: #006FE0;">str</span>(request.values)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">startv</span> = <span style="color: #006FE0;">float</span>(request.values.get(<span style="color: #008000;">'startv'</span>, -0.1))
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">endv</span> = <span style="color: #006FE0;">float</span>(request.values.get(<span style="color: #008000;">'endv'</span>, 0.1))
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">scanrate</span> = <span style="color: #006FE0;">float</span>(request.values.get(<span style="color: #008000;">'scanrate'</span>, 1.0))
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">samplerate</span> = <span style="color: #006FE0;">float</span>(request.values.get(<span style="color: #008000;">'samplerate'</span>, 0.01))

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">data</span> = run_ramp(startv, endv, scanrate, samplerate)
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> data


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">'__main__'</span>:
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   app.run(host=<span style="color: #008000;">'jkitchin-win.cheme.cmu.edu'</span>, port=5000, debug=<span style="color: #D0372D;">True</span>)
</pre>
</div>
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/07/25/Running-scientific-instruments-in-Emacs-and-recording-the-results.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[A sudo org-link and sh block]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/07/17/A-sudo-org-link-and-sh-block" />
    <id>http://jkitchin.github.io/blog/2015/07/17/A-sudo-org-link-and-sh-block</id>
    <updated>2015-07-17T12:42:34Z</updated>
    <published>2015-07-17T12:42:34Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="babel" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[A sudo org-link and sh block]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/07/17/A-sudo-org-link-and-sh-block"><![CDATA[


<p>
Shell blocks in org-mode are pretty useful, but they are a little limited in that it is not obvious how to run a sudo command in them.
</p>

<p>
So for example, this gives me a permission denied error.
</p>
<div class="org-src-container">

<pre class="src src-sh">ls /var/audit
</pre>
</div>

<p>
One way to get around this is to create an org-mode link like this one:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #8D8D84;">;</span><span style="color: #8D8D84; font-style: italic;">http://stackoverflow.com/questions/2472273/how-do-i-run-a-sudo-command-in-emacs</span>
(org-add-link-type
 <span style="color: #008000;">"sudo"</span>
 (<span style="color: #0000FF;">lambda</span> (cmd)
   <span style="color: #036A07;">"Run CMD with sudo."</span>
   (shell-command
    (concat <span style="color: #008000;">"echo "</span> (shell-quote-argument (read-passwd <span style="color: #008000;">"Password? "</span>))
            <span style="color: #008000;">" | sudo -S "</span> cmd))))
</pre>
</div>

<p>
Now you can create a link like <a href="ls /var/audit">ls /var/audit</a>, and when you click on it you will be prompted for a password, and then you will see a buffer containing the output. To get an actual sudo code block, you need a new org babel library. Here is an example of what it might look like. Tangle this file to generate the library. Note: This is a lightly modified version of ob-emacs-lisp.el, and I have not tested it very thoroughly.
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #8D8D84;">;;; </span><span style="color: #8D8D84; font-style: italic;">ob-sudo.el --- An org-mode source block to run shell commands as sudo</span>

<span style="color: #8D8D84;">;;; </span><span style="color: #8D8D84; font-style: italic;">Commentary:</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Runs the block of code as a shell command with sudo.</span>

<span style="color: #8D8D84;">;;; </span><span style="color: #8D8D84; font-style: italic;">Code:</span>

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-babel-execute:sudo</span> (body params)
  <span style="color: #036A07;">"Run BODY as a shell command using sudo."</span>
  (<span style="color: #0000FF;">let*</span> ((passwd (shell-quote-argument (read-passwd <span style="color: #008000;">"Password? "</span>)))
         (result (shell-command-to-string
                  (concat <span style="color: #008000;">"echo "</span> passwd
                          <span style="color: #008000;">" | sudo -S "</span> body))))
    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this is verbatim from ob-emacs-lisp</span>
    (<span style="color: #0000FF;">org-babel-result-cond</span> (cdr (assoc <span style="color: #006FE0;">:result-params</span> params))
      (<span style="color: #0000FF;">let</span> ((print-level nil)
            (print-length nil))
        (<span style="color: #0000FF;">if</span> (<span style="color: #0000FF;">or</span> (member <span style="color: #008000;">"scalar"</span> (cdr (assoc <span style="color: #006FE0;">:result-params</span> params)))
                (member <span style="color: #008000;">"verbatim"</span> (cdr (assoc <span style="color: #006FE0;">:result-params</span> params))))
            (format <span style="color: #008000;">"%S"</span> result)
          (format <span style="color: #008000;">"%s"</span> result)))
      (org-babel-reassemble-table
       result
       (org-babel-pick-name (cdr (assoc <span style="color: #006FE0;">:colname-names</span> params))
                            (cdr (assoc <span style="color: #006FE0;">:colnames</span> params)))
       (org-babel-pick-name (cdr (assoc <span style="color: #006FE0;">:rowname-names</span> params))
                            (cdr (assoc <span style="color: #006FE0;">:rownames</span> params)))))))

(<span style="color: #0000FF;">provide</span> '<span style="color: #D0372D;">ob-sudo</span>)
<span style="color: #8D8D84;">;;; </span><span style="color: #8D8D84; font-style: italic;">ob-sudo.el ends here</span>
</pre>
</div>

<p>
Let us add the current dir to our path so we can load it. If you use this a lot, you should put the library on your permanent path.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(add-to-list 'load-path (expand-file-name <span style="color: #008000;">"."</span>))
</pre>
</div>

<p>
Now, add the sudo "language" to org-babel-load-languages.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-babel-do-load-languages
 'org-babel-load-languages
 '((emacs-lisp . t)
   (python . t)
   (sh . t)
   (matlab . t)
   (sqlite . t)
   (ruby . t)
   (perl . t)
   (org . t)
   (dot . t)
   (plantuml . t)
   (R . t)
   (sudo . t)))
</pre>
</div>

<p>
And, here it is in action. Hopefully I am not giving away some important information here!
</p>

<div class="org-src-container">

<pre class="src src-sudo">ls /var/audit
</pre>
</div>

<pre class="example">
20141106003522.20141110021519
20141110021548.crash_recovery
20141112154126.crash_recovery
20141119201541.20141122145259
20141122145317.20141124214930
20141124215000.crash_recovery
20141126062011.20141202192451
20141202192507.crash_recovery
20141210133306.crash_recovery
20141225181819.20150106015256
20150106015325.20150111010018
20150111010121.crash_recovery
20150115195518.20150115200101
20150115200110.crash_recovery
20150123061227.20150215123411
20150215123454.crash_recovery
20150225004740.20150310201600
20150310201633.20150314214730
20150314214807.crash_recovery
20150323145600.20150329170647
20150329170721.crash_recovery
20150407215846.20150413000423
20150413000438.20150421122044
20150421122104.20150518122545
20150518122616.20150518124432
20150518124432.20150518124513
20150518124513.20150518125437
20150518125437.20150518125935
20150518125935.20150518132111
20150518132111.20150531202621
20150531202719.20150601123612
20150601123612.20150601124932
20150601124932.20150601125151
20150601125151.20150601125555
20150601125555.20150601131947
20150601131947.20150601132421
20150601132421.20150601133735
20150601133735.20150601140740
20150601140740.20150601154012
20150601154012.20150601155125
20150601155125.20150601155215
20150601155215.20150601160937
20150601160937.crash_recovery
20150613061543.20150614054541
20150614054541.20150625165357
20150625165432.20150625200623
20150625200623.20150628042242
20150628042242.20150628103628
20150628103628.20150630052100
20150630052100.20150701232519
20150702005345.20150710203212
20150710203226.not_terminated
current
</pre>

<p>
Summary thoughts: I will reiterate again I have not tested this a lot, I was mostly interested in trying to make a new sh block with sudo support. Let me know if it has issues for you, and make sure you have backups of things it could mess up!</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/07/17/A-sudo-org-link-and-sh-block.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
  <entry>
    <author>
      <name></name>
      <uri>http://jkitchin.github.io/blog</uri>
    </author>
    <title type="html"><![CDATA[Indexing headlines in org files with swish-e with laser-sharp results]]></title>
    <link rel="alternate" type="text/html" href="http://jkitchin.github.io/blog/2015/07/06/Indexing-headlines-in-org-files-with-swish-e-with-laser-sharp-results" />
    <id>http://jkitchin.github.io/blog/2015/07/06/Indexing-headlines-in-org-files-with-swish-e-with-laser-sharp-results</id>
    <updated>2015-07-06T11:04:43Z</updated>
    <published>2015-07-06T11:04:43Z</published>
    <category scheme="http://jkitchin.github.io/blog" term="orgmode" />
    <category scheme="http://jkitchin.github.io/blog" term="swishe" />
    <category scheme="http://jkitchin.github.io/blog" term="emacs" />
    <summary type="html"><![CDATA[Indexing headlines in org files with swish-e with laser-sharp results]]></summary>
    <content type="html" xml:base="http://jkitchin.github.io/blog/2015/07/06/Indexing-headlines-in-org-files-with-swish-e-with-laser-sharp-results"><![CDATA[



<p>
So far, it looks like swish-e is able to do some pretty focused searches on specific content types. However, the return results are not actually that sharp; in the way we have been using swish-e, it can only tell us the document path that matches, not where in the document the match is. To fix that, we need a new approach to what a "document" is, and a new approach to indexing. We will finally use the "-s prog" option in swish-e which runs an external program that prints stuff to stdout for swish-e to index. We will treat each headline in an org file as a "document" but rather than have the path to the file, we will put an org-mode link there that will take us right to the point of interest.
</p>

<p>
You can see this in action here: <a href="https://www.youtube.com/watch?v=bTwXtEb5Ng8">https://www.youtube.com/watch?v=bTwXtEb5Ng8</a> 
</p>

<p>
Basically, we need a program to output chunks like this for each headline in an org-file:
</p>
<pre class="example">
Path-Name: [[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/ase-db.org") (goto-char 1))]]
Content-Length: 247
Document-Type: XML*

&lt;headline&gt;&lt;title&gt;Using the ase database module&lt;/title&gt;&lt;properties&gt;&lt;FILE&gt;/Users/jkitchin/blogofile-jkitchin.github.com/_blog/ase-db.org&lt;/FILE&gt;&lt;BLOCKED&gt;&lt;/BLOCKED&gt;&lt;categories&gt;python, ase&lt;/categories&gt;&lt;CATEGORY&gt;ase-db&lt;/CATEGORY&gt;&lt;/properties&gt;&lt;/headline&gt;
</pre>

<p>
Then we need to tell swish-e to run the program and index its output. Here is the program to do that.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">:<span style="color: #8D8D84;">;</span><span style="color: #8D8D84; font-style: italic;">exec emacs -batch -l $0 "$@"</span>
(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">org</span>)
(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">xml</span>)
(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">cl</span>)

(add-to-list 'load-path <span style="color: #008000;">"~/Dropbox/kitchingroup/jmax/elpa/f-20140828.716"</span>)
(add-to-list 'load-path <span style="color: #008000;">"~/Dropbox/kitchingroup/jmax/elpa/s-20140910.334"</span>)
(add-to-list 'load-path <span style="color: #008000;">"~/Dropbox/kitchingroup/jmax/elpa/dash-20141201.2206"</span>)
(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">f</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">print-tag</span> (name attrs <span style="color: #6434A3;">&amp;optional</span> closingp)
  <span style="color: #036A07;">"Print an xml tag with symbol NAME and ATTRS (a cons list of (attribute . value)).</span>
<span style="color: #036A07;">if CLOSINGP print the closing tag instead."</span>
  (format
   <span style="color: #008000;">"&lt;%s%s%s&gt;"</span>
   (<span style="color: #0000FF;">if</span> closingp <span style="color: #008000;">"/"</span> <span style="color: #008000;">""</span>)
   name
   (<span style="color: #0000FF;">if</span> (<span style="color: #0000FF;">and</span> attrs (not closingp))
       (concat
        <span style="color: #008000;">" "</span>
        (mapconcat
         (<span style="color: #0000FF;">lambda</span> (x)
           (format <span style="color: #008000;">"%s=\"%s\""</span>
                   (car x)
                   (xml-escape-string (cdr x))))
         attrs
         <span style="color: #008000;">" "</span>))
     <span style="color: #008000;">""</span>)))

(<span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">tag</span> (name attributes <span style="color: #6434A3;">&amp;rest</span> body)
  <span style="color: #036A07;">"macro to create an xml tag with NAME, ATTRIBUTES. BODY is executed in the tag."</span>
  `(format <span style="color: #008000;">"%s%s%s"</span>
           (print-tag ,name ,attributes nil)
           (concat
            ,@body)
           (print-tag ,name nil t)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">headline-xml</span> (headline)
  <span style="color: #036A07;">"Return xml representation of an element HEADLINE."</span>
  (<span style="color: #0000FF;">let</span> ((title (org-element-property <span style="color: #006FE0;">:title</span> headline))
        (properties (<span style="color: #0000FF;">save-excursion</span>
                      (goto-char
                       (org-element-property <span style="color: #006FE0;">:begin</span> headline))
                      (org-entry-properties))))
    (tag 'headline ()
         (tag 'title () (xml-escape-string (mapconcat 'identity title <span style="color: #008000;">" "</span>)))
         (<span style="color: #0000FF;">when</span> properties
           (tag 'properties ()
                (mapconcat
                 'identity
                 (<span style="color: #0000FF;">loop</span> for (p . v) in properties
                       collect (tag p () (xml-escape-string v)))
                 <span style="color: #008000;">""</span>))))))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">headline-document</span> (headline)
  <span style="color: #036A07;">"Return the headline \"document\" for swish-e to index."</span>
  (<span style="color: #0000FF;">let</span> ((xml (replace-regexp-in-string
              <span style="color: #008000;">"[</span><span style="color: #008000;">^</span><span style="color: #008000;">[:ascii:]]"</span> <span style="color: #008000;">""</span>
              (headline-xml headline))))
    (format <span style="color: #008000;">"Path-Name: [[elisp:(progn (find-file \"%s\") (goto-char %s) (show-children))][link]]</span>
<span style="color: #008000;">Content-Length: %s</span>
<span style="color: #008000;">Document-Type: XML*</span>

<span style="color: #008000;">%s"</span> (buffer-file-name)
(org-element-property <span style="color: #006FE0;">:begin</span> headline)
(length xml)
xml)))

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">process-file</span> (fname)
  <span style="color: #036A07;">"Print the `</span><span style="color: #D0372D;">headline-document</span><span style="color: #036A07;">' for each headline in FNAME."</span>
  (<span style="color: #0000FF;">with-current-buffer</span> (find-file-noselect fname)
    (mapconcat 'identity
               (org-element-map (org-element-parse-buffer)
                   'headline
                 (<span style="color: #0000FF;">lambda</span> (headline)
                   (princ (headline-document headline))))
               <span style="color: #008000;">""</span>)))

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Here is the main work in the script.</span>
(<span style="color: #0000FF;">loop</span> for dir in '(<span style="color: #008000;">"/Users/jkitchin/blogofile-jkitchin.github.com/_blog"</span>)
      do
      (<span style="color: #0000FF;">loop</span> for fname in (f-entries
                          dir
                          (<span style="color: #0000FF;">lambda</span> (x)
                            (string=  <span style="color: #008000;">"org"</span>  (file-name-extension x)))
                          t)
            do (<span style="color: #0000FF;">ignore-errors</span>
                 (princ (process-file fname)))))
</pre>
</div>

<p>
Now we need a configuration file:
</p>

<div class="org-src-container">

<pre class="src src-text"># Example configuration file

# where to save the index
IndexFile /Users/jkitchin/blogofile-jkitchin.github.com/_blog/index-org-headlines.swish-e

# index all tags for searching
UndefinedMetaTags auto
UndefinedXMLAttributes auto
</pre>
</div>


<p>
And we run the indexer, I did this in an actual shell. For some reason, it was not possible to run here. The output is pretty useful though, as it tells you what MetaNames are searchable.
</p>

<div class="org-src-container">

<pre class="src src-sh">swish-e -c swish-org-headlines.conf -S prog -i ./swish-org-headlines.el
</pre>
</div>

<pre class="example">
10:17 $ swish-e -c swish-org-headlines.conf -S prog -i ./swish-org-headlines.el
Indexing Data Source: "External-Program"
Indexing "./swish-org-headlines.el"
External Program found: ./swish-org-headlines.el
**Adding automatic MetaName 'headline' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 18) (show-children))][link]]'
**Adding automatic MetaName 'title' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 18) (show-children))][link]]'
**Adding automatic MetaName 'properties' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 18) (show-children))][link]]'
**Adding automatic MetaName 'file' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 18) (show-children))][link]]'
**Adding automatic MetaName 'blocked' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 18) (show-children))][link]]'
**Adding automatic MetaName 'categories' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 18) (show-children))][link]]'
**Adding automatic MetaName 'date' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 18) (show-children))][link]]'
**Adding automatic MetaName 'updated' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 18) (show-children))][link]]'
**Adding automatic MetaName 'category' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 18) (show-children))][link]]'
**Adding automatic MetaName 'points' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/writing-exams-in-orgmode.org") (goto-char 1391) (show-children))][link]]'
**Adding automatic MetaName 'tags' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/why-org-mode.org") (goto-char 25) (show-children))][link]]'
**Adding automatic MetaName 'alltags' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/why-org-mode.org") (goto-char 25) (show-children))][link]]'
**Adding automatic MetaName 'todo' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/why-org-mode.org") (goto-char 1733) (show-children))][link]]'
**Adding automatic MetaName 'closed' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/why-org-mode.org") (goto-char 1733) (show-children))][link]]'
**Adding automatic MetaName 'timestamp_ia' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/pdfsync.org") (goto-char 28) (show-children))][link]]'
**Adding automatic MetaName 'id' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-to-docx-pandoc.org") (goto-char 5056) (show-children))][link]]'
**Adding automatic MetaName 'custom_id' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-db.org") (goto-char 1311) (show-children))][link]]'
**Adding automatic MetaName 'calculation' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-db.org") (goto-char 1311) (show-children))][link]]'
**Adding automatic MetaName 'volume' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-db.org") (goto-char 1311) (show-children))][link]]'
**Adding automatic MetaName 'total_energy' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-db.org") (goto-char 1311) (show-children))][link]]'
**Adding automatic MetaName 'stress' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-db.org") (goto-char 1311) (show-children))][link]]'
**Adding automatic MetaName 'priority' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 15327) (show-children))][link]]'
**Adding automatic MetaName 'export_title' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 506769) (show-children))][link]]'
**Adding automatic MetaName 'export_author' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 506769) (show-children))][link]]'
**Adding automatic MetaName 'export_file_name' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 506769) (show-children))][link]]'
**Adding automatic MetaName 'export_date' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 506769) (show-children))][link]]'
**Adding automatic MetaName 'scheduled' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 516502) (show-children))][link]]'
**Adding automatic MetaName 'deadline' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 516502) (show-children))][link]]'
**Adding automatic MetaName 'votes' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 532031) (show-children))][link]]'
**Adding automatic MetaName 'timestamp' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 571125) (show-children))][link]]'
**Adding automatic MetaName 'clock' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 21059) (show-children))][link]]'
**Adding automatic MetaName 'level' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 46582) (show-children))][link]]'
**Adding automatic MetaName 'correct' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 46582) (show-children))][link]]'
**Adding automatic MetaName 'permalink' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 61814) (show-children))][link]]'
**Adding automatic MetaName 'hint' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 340534) (show-children))][link]]'
**Adding automatic MetaName 'answer' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 355206) (show-children))][link]]'
**Adding automatic MetaName 'correct-answer' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 377210) (show-children))][link]]'
**Adding automatic MetaName 'post_filename' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 415454) (show-children))][link]]'
**Adding automatic MetaName 'ordered' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 423900) (show-children))][link]]'
**Adding automatic MetaName 'grade' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/add-subheadings-to-headings.org") (goto-char 2822) (show-children))][link]]'
**Adding automatic MetaName ':export_file_name:' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/add-properties-to-headings.org") (goto-char 2) (show-children))][link]]'
**Adding automatic MetaName 'firstname' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-contacts/referee-contacts.org") (goto-char 155) (show-children))][link]]'
**Adding automatic MetaName 'lastname' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-contacts/referee-contacts.org") (goto-char 155) (show-children))][link]]'
**Adding automatic MetaName 'email' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-contacts/referee-contacts.org") (goto-char 155) (show-children))][link]]'
**Adding automatic MetaName 'affiliation' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-contacts/referee-contacts.org") (goto-char 155) (show-children))][link]]'
**Adding automatic MetaName 'lettergrade' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-report/Slim-Shady-HW1.org") (goto-char 29) (show-children))][link]]'
**Adding automatic MetaName 'difficulty' found in file '[[elisp:(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/problem-selection/problem-selection.org") (goto-char 1) (show-children))][link]]'
Removing very common words...
no words removed.
Writing main index...
Sorting words ...
Sorting 6,044 words alphabetically
Writing header ...
Writing index entries ...
  Writing word text: Complete
  Writing word hash: Complete
  Writing word data: Complete
6,044 unique words indexed.
4 properties sorted.
5,084 files indexed.  1,760,249 total bytes.  368,569 total words.
Elapsed time: 00:00:37 CPU time: 00:00:01
Indexing done!
</pre>


<p>
Ok, now for the proof in the approach!
</p>

<div class="org-src-container">

<pre class="src src-sh">swish-e -f index-org-headlines.swish-e -w <span style="color: #BA36A5;">headline</span>=generating
</pre>
</div>

<p>
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/separate-bib.org") (goto-char 1) (show-children))">link</a> "separate-bib.org") (goto-char 1) (show-children))][link]]" 393
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 158456) (show-children))">link</a> "blog-2014.org") (goto-char 158456) (show-children))][link]]" 229
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 272383) (show-children))">link</a> "blog-2014.org") (goto-char 272383) (show-children))][link]]" 400
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 158456) (show-children))">link</a> "blog-2014.org") (goto-char 158456) (show-children))][link]]" 229
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 448965) (show-children))">link</a> "blog.org") (goto-char 448965) (show-children))][link]]" 389
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-db.org") (goto-char 575) (show-children))">link</a> "org-db.org") (goto-char 575) (show-children))][link]]" 204
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/org-db.org") (goto-char 575) (show-children))">link</a> "org-db.org") (goto-char 575) (show-children))][link]]" 204
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/separate-bib.org") (goto-char 1) (show-children))">link</a> "separate-bib.org") (goto-char 1) (show-children))][link]]" 393
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 272383) (show-children))">link</a> "blog-2014.org") (goto-char 272383) (show-children))][link]]" 400
.
</p>


<div class="org-src-container">

<pre class="src src-sh">swish-e -f index-org-headlines.swish-e -w <span style="color: #BA36A5;">todo</span>=TODO
</pre>
</div>

<p>
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 16933) (show-children))">link</a> "blog.org") (goto-char 16933) (show-children))][link]]" 342
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 61231) (show-children))">link</a> "blog-2014.org") (goto-char 61231) (show-children))][link]]" 207
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 60802) (show-children))">link</a> "blog-2014.org") (goto-char 60802) (show-children))][link]]" 274
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 60289) (show-children))">link</a> "blog-2014.org") (goto-char 60289) (show-children))][link]]" 207
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 61568) (show-children))">link</a> "blog-2014.org") (goto-char 61568) (show-children))][link]]" 246
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 61231) (show-children))">link</a> "blog-2014.org") (goto-char 61231) (show-children))][link]]" 207
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 60802) (show-children))">link</a> "blog-2014.org") (goto-char 60802) (show-children))][link]]" 274
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 60289) (show-children))">link</a> "blog-2014.org") (goto-char 60289) (show-children))][link]]" 207
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 632875) (show-children))">link</a> "blog.org") (goto-char 632875) (show-children))][link]]" 266
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 529123) (show-children))">link</a> "blog.org") (goto-char 529123) (show-children))][link]]" 202
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 529087) (show-children))">link</a> "blog.org") (goto-char 529087) (show-children))][link]]" 206
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 518108) (show-children))">link</a> "blog.org") (goto-char 518108) (show-children))][link]]" 280
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog.org") (goto-char 30559) (show-children))">link</a> "blog.org") (goto-char 30559) (show-children))][link]]" 337
1000 <a href="(progn (find-file "/Users/jkitchin/blogofile-jkitchin.github.com/_blog/blog-2014.org") (goto-char 61568) (show-children))">link</a> "blog-2014.org") (goto-char 61568) (show-children))][link]]" 246
.
</p>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Summary thoughts</h2>
<div class="outline-text-2" id="text-1">
<p>
This could be super useful for a lot of different elements: headlines, src-blocks, links, tables, paragraphs are the main ones that come to mind. You could have pretty focused searches that go straight to the matches!</p>
</div>
</div>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/07/06/Indexing-headlines-in-org-files-with-swish-e-with-laser-sharp-results.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>]]></content>
  </entry>
</feed>
