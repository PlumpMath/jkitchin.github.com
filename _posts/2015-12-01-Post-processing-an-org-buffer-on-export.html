---
title: Post-processing an org-buffer on export
date: 2015/12/01 13:58:46
updated: 2015/12/01 13:58:46
categories: emacs,orgmode
tags: 
---



<p>
In a previous <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/11/22/Adding-emacs-command-key-bindings-and-help-functionality-to-org-mode/">post</a> we examined getting tooltips on emacs keybindings and command syntax in an org-buffer. Someone asked in a comment if we could get that to export to html, or LaTeX. The short answer is not directly, org-mode doesn't recognize our functionalized syntax as an element, and there is no direct way to modify their appearance on export.
</p>

<p>
There is, however, a hook function that runs before parsing, and we can use that to transform these patterns to what we want. Here, I illustrate how to make the key-bindings and commands bold with a tooltip on them for an html export. Basically, we do an export, and then post-process the html output to put what we want in. I found this easier than pre-processing because the documentation for the command tooltip was too big to fit into an html snippet, and an html block causes carriage returns in the html. I didn't find a more elegant solution to that problem.
</p>

<p>
Here we replace the key-binding syntax with the actual keybinding in bold, and a tooltip of the command, and the command syntax we replace with bold command and a tooltip for the documentation. It works pretty well. The documentation for helm is pretty extensive, and gets cutoff in the tooltip. Otherwise, this seems pretty satisfactory.
</p>

<p>
This won't show in the blog post, so you will have to checkout the exported html here: <a href="/media/2015-12-01-Post-processing-an-org-buffer-on-export/blog.html">blog.html</a> .
</p>

<p>
Try \\[helm-find-files] to open a file. You might enjoy using `helm' too. Or this variable `org-agenda-files'.
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">rx</span>)

(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">elisp-symbol-keybinding-re</span>
  (<span style="color: #0000FF;">rx</span>
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">opening \\[</span>
   (eval <span style="color: #008000;">"\\["</span>)
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">one or more characters that are not ]</span>
   (group (one-or-more (not (any <span style="color: #008000;">"]"</span>))))
   <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">The closing ]</span>
   <span style="color: #008000;">"]"</span>)
<span style="color: #036A07;">"Regexp for an elisp command keybinding syntax. \\[</span><span style="color: #D0372D;">some-command</span><span style="color: #036A07;">]</span>
<span style="color: #036A07;">Regexp group 1 matches src_emacs-lisp[:results html]{(command-html "</span>some-command<span style="color: #008000;">")}."</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-process-key-bindings</span> (backend)
  (goto-char (point-min))
  (<span style="color: #0000FF;">while</span> (re-search-forward elisp-symbol-keybinding-re nil t)
    (replace-match
     (<span style="color: #0000FF;">cond</span>
      ((eq backend 'html)
       (format <span style="color: #008000;">"&lt;b title=\"The command is %s.\"&gt;%s&lt;/b&gt;"</span>
               (match-string 1)
               (substitute-command-keys (match-string 0))))))))


(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">org-process-emacs-commands</span> (backend)
  (goto-char (point-min))
  (<span style="color: #0000FF;">while</span> (re-search-forward <span style="color: #008000;">"`</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;">']+</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">'"</span> nil t)
    (replace-match
     (<span style="color: #0000FF;">cond</span>
      ((eq backend 'html)
       (format <span style="color: #008000;">"&lt;b title=\"%s\"&gt;%s&lt;/b&gt;"</span>
          (<span style="color: #0000FF;">if</span> (<span style="color: #0000FF;">or</span> (fboundp (intern (match-string 1)))
                  (boundp (intern (match-string 1))))
              (documentation (intern (match-string 1)))
            <span style="color: #008000;">"No command found."</span>)
          (match-string 1)))))))

(<span style="color: #0000FF;">with-current-buffer</span> (org-html-export-as-html)
  (org-process-key-bindings 'html)
  (org-process-emacs-commands 'html)
  (write-file <span style="color: #008000;">"blog.html"</span>)
  (browse-url <span style="color: #008000;">"blog.html"</span>))
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">org-process-emacs-commands</td>
</tr>
</tbody>
</table>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/12/01/Post-processing-an-org-buffer-on-export.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>