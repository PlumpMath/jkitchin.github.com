---
title: Error tolerance in numerical solutions to ODEs
date: 2013/02/27 14:31:18
updated: 2013/02/27 14:31:18
categories: ODE
---


<p>
<a href="http://matlab.cheme.cmu.edu/2011/09/18/error-tolerance-in-numerical-solutions-to-odes/" >Matlab post</a>

Usually, the numerical ODE solvers in python work well with the standard settings. Sometimes they do not, and it is not always obvious they have not worked! Part of using a tool like python is checking how well your solution really worked. We use an example of integrating an ODE that defines the van der Waal equation of an ideal gas here.
</p>

<p>
we plot the analytical solution to the van der waal equation in reduced form here.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt

Tr = 0.9
Vr = np.linspace(0.34,4,1000)

<span style="color: #ff0000; font-weight: bold;">#</span><span style="color: #ff0000; font-weight: bold;">analytical equation for Pr</span>
Prfh = <span style="color: #8b0000;">lambda</span> Vr: 8.0 / 3.0 * Tr / (Vr - 1.0 / 3.0) - 3.0 / (Vr**2)
Pr = Prfh(Vr) <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">evaluated on our reduced volume vector.</span>

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">Plot the EOS</span>
plt.plot(Vr,Pr)
plt.ylim([0, 2])
plt.xlabel(<span style="color: #228b22;">'$V_R$'</span>)
plt.ylabel(<span style="color: #228b22;">'$P_R$'</span>)
plt.savefig(<span style="color: #228b22;">'images/ode-vw-1.png'</span>)
plt.show()
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; ... &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; ... [&lt;matplotlib.lines.Line2D object at 0x1c5a3550&gt;]
(0, 2)
&lt;matplotlib.text.Text object at 0x1c22f750&gt;
&lt;matplotlib.text.Text object at 0x1d4e0750&gt;
</pre>

<p><img src="/img/./images/ode-vw-1.png"><p>

<p>
we want an equation for dPdV, which we will integrate we use symbolic math to do the derivative for us.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> sympy <span style="color: #8b0000;">import</span> diff, Symbol
Vrs = Symbol(<span style="color: #228b22;">'Vrs'</span>)

Prs = 8.0 / 3.0 * Tr / (Vrs - 1.0/3.0) - 3.0/(Vrs**2) 
<span style="color: #8b0000;">print</span> diff(Prs,Vrs)
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; -2.4/(Vrs - 0.333333333333333)**2 + 6.0/Vrs**3
</pre>

<p>
Now, we solve the ODE. We will specify a large relative tolerance criteria (Note the default is much smaller than what we show here).
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> scipy.integrate <span style="color: #8b0000;">import</span> odeint

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">myode</span>(Pr, Vr):
    dPrdVr = -2.4/(Vr - 0.333333333333333)**2 + 6.0/Vr**3
    <span style="color: #8b0000;">return</span> dPrdVr

Vspan = np.linspace(0.334, 4)
Po = Prfh(Vspan[0])
P = odeint(myode, Po, Vspan, rtol=1e-4)

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">Plot the EOS</span>
plt.plot(Vr,Pr) <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">analytical solution</span>
plt.plot(Vspan, P[:,0], <span style="color: #228b22;">'r.'</span>)
plt.ylim([0, 2])
plt.xlabel(<span style="color: #228b22;">'$V_R$'</span>)
plt.ylabel(<span style="color: #228b22;">'$P_R$'</span>)
plt.savefig(<span style="color: #228b22;">'images/ode-vw-2.png'</span>)
plt.show()
</pre>
</div>

<pre class="example">
... &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; ... [&lt;matplotlib.lines.Line2D object at 0x1d4f3b90&gt;]
[&lt;matplotlib.lines.Line2D object at 0x2ac47518e710&gt;]
(0, 2)
&lt;matplotlib.text.Text object at 0x1c238fd0&gt;
&lt;matplotlib.text.Text object at 0x1c22af10&gt;
</pre>

<p><img src="/img/./images/ode-vw-2.png"><p>

<p>
You can see there is disagreement between the analytical solution and numerical solution. The origin of this problem is accuracy at the initial condition, where the derivative is extremely large.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">print</span> myode(Po, 0.34)
</pre>
</div>

<pre class="example">
-53847.3437818
</pre>

<p>
We can increase the tolerance criteria to get a better answer. The defaults in odeint are actually set to 1.49012e-8.
</p>

<div class="org-src-container">

<pre class="src src-python">Vspan = np.linspace(0.334, 4)
Po = Prfh(Vspan[0])
P = odeint(myode, Po, Vspan)

<span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">Plot the EOS</span>
plt.plot(Vr,Pr) <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">analytical solution</span>
plt.plot(Vspan, P[:,0], <span style="color: #228b22;">'r.'</span>)
plt.ylim([0, 2])
plt.xlabel(<span style="color: #228b22;">'$V_R$'</span>)
plt.ylabel(<span style="color: #228b22;">'$P_R$'</span>)
plt.savefig(<span style="color: #228b22;">'images/ode-vw-3.png'</span>)
plt.show()
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; ... [&lt;matplotlib.lines.Line2D object at 0x1d4dbf10&gt;]
[&lt;matplotlib.lines.Line2D object at 0x1c6e5550&gt;]
(0, 2)
&lt;matplotlib.text.Text object at 0x1d4e31d0&gt;
&lt;matplotlib.text.Text object at 0x1d9d3710&gt;
</pre>

<p><img src="/img/./images/ode-vw-3.png"><p>

<p>
The problem here was the derivative value varied by four orders of magnitude over the integration range, so the default tolerances were insufficient to accurately estimate the numerical derivatives over that range. Tightening the tolerances helped resolve that problem. Another approach might be to split the integration up into different regions. For instance, if instead of starting at Vr = 0.34, which is very close to a sigularity in the van der waal equation at Vr = 1/3, if you start at Vr = 0.5, the solution integrates just fine with the standard tolerances.
</p>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/02/27/Error-tolerance-in-numerical-solutions-to-ODEs.org">org-mode source</a><p>