---
title: Popup tips on bibtex links in org-mode
date: 2014/04/12 14:15:45
updated: 2014/04/12 14:15:45
categories: 
tags: 
---



<p>
I want to explore using popup tips to display richer information about org-mode links. The idea is to have something like a tooltip that displays the bibtex entry when you hover over it, or click on it. 
</p>

<p>
<a href="https://github.com/auto-complete/popup-el/blob/master/popup.el">https://github.com/auto-complete/popup-el/blob/master/popup.el</a> 
</p>

<p>
Here is a canonical example of a popup.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(popup-tip <span style="color: #228b22;">"Hello, World!"</span>)
</pre>
</div>

<pre class="example">
t
</pre>


<div class="figure">
<p><img src="/media/2014-04-12-Popup-tips-on-bibtex-links-in-org-mode/hello-world-popup.png"> 
</p>
</div>

<p>
All I need to do is figure out a simple way to get the bibtex entry as a string, and pop it up when a link is clicked on.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-add-link-type
 <span style="color: #228b22;">"test"</span>
 <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">this function is run when you click</span>
 (<span style="color: #8b0000;">lambda</span> (link-string) 
   (popup-tip link-string))
 <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">formatting</span>
(<span style="color: #8b0000;">lambda</span> (keyword desc format)
   (<span style="color: #8b0000;">cond</span>
    ((eq format 'html) (format <span style="color: #228b22;">"&lt;pre&gt;%s:%s&lt;/pre&gt;"</span> keyword desc)))))
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">lambda</td>
<td class="left">(link-string)</td>
<td class="left">(popup-tip link-string)</td>
</tr>

<tr>
<td class="left">lambda</td>
<td class="left">(keyword desc format)</td>
<td class="left">(cond ((eq format (quote html)) (format &lt;pre&gt;%s:%s&lt;/pre&gt; keyword desc)))</td>
</tr>
</tbody>
</table>

<p>
Now we give it a try.   <pre>test:show-me-the-popup</pre> 
</p>


<div class="figure">
<p><img src="/media/2014-04-12-Popup-tips-on-bibtex-links-in-org-mode/test-link-popup.png"> 
</p>
</div>

<p>
That looks good.
</p>

<p>
Ok, the penultimate step will be to lookup a bibtex entry, and show the entry in a popup. We will hardcode the path to the bibtex file. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(org-add-link-type
 <span style="color: #228b22;">"test"</span>
 <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">this function is run when you click</span>
 (<span style="color: #8b0000;">lambda</span> (bibtex-key)
   (<span style="color: #8b0000;">let</span> ((entry (<span style="color: #8b0000;">with-temp-buffer</span>
                  (insert-file-contents <span style="color: #228b22;">"~/Dropbox/bibliography/references.bib"</span>)
                  (goto-char (point-min))
                  (re-search-forward bibtex-key)
                  (bibtex-narrow-to-entry)
                  (buffer-string))))
     (popup-tip entry))))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">lambda</td>
<td class="left">(bibtex-key)</td>
<td class="left">(let ((cb (current-buffer)) (entry (with-temp-buffer (insert-file-contents ~/Dropbox/bibliography/references.bib) (goto-char (point-min)) (re-search-forward bibtex-key) (bibtex-narrow-to-entry) (buffer-string)))) (popup-tip entry))</td>
</tr>
</tbody>
</table>


<p>
<pre>test:mehta-2014-ident-poten</pre> 
</p>

<p>
And here is what appears for me:
<img src="/media/2014-04-12-Popup-tips-on-bibtex-links-in-org-mode/bibtex-popup-entry.png"> 
</p>

<p>
The final step is to connect this to an <a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Idle-Timers.html">idle timer</a> . We want a popup to occur when our mouse is idle. I am setting this up to run one time, after 5 seconds of idleness.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(run-with-idle-timer 5 nil (<span style="color: #8b0000;">lambda</span> () (popup-tip <span style="color: #228b22;">"You are being idle"</span>)))
</pre>
</div>
<pre class="example">
[nil 0 5 0 nil (lambda nil (popup-tip "You are being idle")) nil idle 0]
</pre>


<div class="figure">
<p><img src="/media/2014-04-12-Popup-tips-on-bibtex-links-in-org-mode/idle-timer-popup.png"> 
</p>
</div>

<p>
So, we need to setup an idle timer that runs on some interval. When the cursor is on the right kind of link, we want to get a popup. I adapted the following code from <a href="http://www.emacswiki.org/emacs/IdleTimers">http://www.emacswiki.org/emacs/IdleTimers</a> .
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">variable for the timer object</span>
(<span style="color: #8b0000;">defvar</span> <span style="color: #8b008b;">idle-timer-bibtex-timer</span> nil)

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">callback function </span>
(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">idle-timer-bibtex-callback</span> ()
  <span style="color: #228b22;">"displays a popup of the bibtex entry in a test link"</span>
  (interactive)
  (<span style="color: #8b0000;">let</span> ((object (org-element-context)))    
    (<span style="color: #8b0000;">when</span> (and (equal (org-element-type object) 'link) 
               (equal (org-element-property <span style="color: #cd0000;">:type</span> object) <span style="color: #228b22;">"test"</span>))
      (<span style="color: #8b0000;">let*</span> ((bibtex-key (org-element-property <span style="color: #cd0000;">:path</span> object))
             (entry (<span style="color: #8b0000;">with-temp-buffer</span>
                      (insert-file-contents <span style="color: #228b22;">"~/Dropbox/bibliography/references.bib"</span>)
                      (goto-char (point-min))
                      (re-search-forward bibtex-key)
                      (bibtex-narrow-to-entry)
                      (buffer-string))))
        (popup-tip entry)))))

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">start functions</span>
(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">idle-timer-bibtex-start</span> ()
  (interactive)
  (<span style="color: #8b0000;">when</span> (timerp idle-timer-bibtex-timer)
    (cancel-timer idle-timer-bibtex-timer))
  (setq idle-timer-bibtex-timer
          (run-with-timer 1 1 #'idle-timer-bibtex-callback)))

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">stop function</span>
(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">idle-timer-bibtex-stop</span> ()
  (interactive)
  (<span style="color: #8b0000;">when</span> (timerp idle-timer-bibtex-timer)
    (cancel-timer idle-timer-bibtex-timer))
  (setq idle-timer-bibtex-timer nil))

(idle-timer-bibtex-start)
</pre>
</div>
<pre class="example">
idle-timer-bibtex-stop
</pre>


<p>
<pre>test:kitchin-2008-alloy</pre> 
</p>

<p>
Now, whenever the cursor is on the link, and there is an idle of about a sec, I get a popup window of the bibtex entry. It looks like this:
</p>


<div class="figure">
<p><img src="/media/2014-04-12-Popup-tips-on-bibtex-links-in-org-mode/bibtex-popup2.png"> 
</p>
</div>

<p>
There are still some limitations to this code. It does not handle multiple citations in a link (like the cite links I normally use do). That will take a little work to fixup. I cannot figure out how to get mouse-over tooltips; this only works when the cursor is on the link.  I do not know what the optimal timer setting is. This one runs every second. I do not see any issues in performance with that. Another issue might be making the timer a file local variable. It would be nice if the timer quit running when the file was closed. I do not know how easy that would be to implement, or if there should be one timer running for org-mode. Finally, this code is hard-coded to use my reference file. For a real module, we would probably provide some customization to choose other bibtex files. Overall though, this might be a handy way to quickly peruse the citations in an org-file.
</p>
<p>Copyright (C) 2014 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/04/12/Popup-tips-on-bibtex-links-in-org-mode.org">org-mode source</a><p><p>Org-mode version = 8.2.5h</p>