---
title: Drag images and files onto org-mode and insert a link to them
date: 2015/07/10 16:11:43
updated: 2015/07/10 16:11:43
categories: emacs,video
tags: 
---


<p>
I want to drag and drop an image onto an org mode file and get a link to that file. This would be used for finding images in Finder, and then dragging them to the Emacs buffer. There is <a href="http://orgmode.org/cgit.cgi/org-mode.git/plain/contrib/lisp/org-download.el">org-download.el</a> which looks like it should do something like this too, but it did not work out of the box for me, and I want to add a few wrinkles to it. For a simple drag-n-drop, I just want the link to appear. With ctrl-drag-n-drop I want to add an attr_org line to set the image size, add a caption line, insert the image at the beginning of the line where the mouse cursor is, put the cursor on the caption line and then refresh the inline images in org-mode so the image is immediately visible.
</p>

<p>
While we are at let us also make it possible to drag file links onto org-files, instead of having the files open. Again, for a simple drag-n-drop, I want a link inserted. For ctrl-drag-n-drop we open the file, and for Meta (alt) drag-n-drop, we insert an attachfile link. You can also define s-drag-n-drop (Super/command) and C-s and M-s drag-n-drop if you can think of things to do with that.
</p>

<p>
Here is the code to make those things happen. Or watch the video: <a href="https://www.youtube.com/watch?v=ahqKXbBVjpQ">https://www.youtube.com/watch?v=ahqKXbBVjpQ</a> 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">my-dnd-func</span> (event)
  (<span style="color: #0000FF;">interactive</span> <span style="color: #008000;">"e"</span>)
  (goto-char (nth 1 (event-start event)))
  (x-focus-frame nil)
  (<span style="color: #0000FF;">let*</span> ((payload (car (last event)))
         (type (car payload))
         (fname (cadr payload))
         (img-regexp <span style="color: #008000;">"</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">png</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">jp[e]?g</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">\\&gt;"</span>))
    (<span style="color: #0000FF;">cond</span>
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">insert image link</span>
     ((<span style="color: #0000FF;">and</span>  (eq 'drag-n-drop (car event))
            (eq 'file type)
            (string-match img-regexp fname))
      (insert (format <span style="color: #008000;">"[[%s]]"</span> fname))
      (org-display-inline-images t t))
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">insert image link with caption</span>
     ((<span style="color: #0000FF;">and</span>  (eq 'C-drag-n-drop (car event))
            (eq 'file type)
            (string-match img-regexp fname))
      (insert <span style="color: #008000;">"#+ATTR_ORG: :width 300\n"</span>)
      (insert (concat  <span style="color: #008000;">"#+CAPTION: "</span> (read-input <span style="color: #008000;">"Caption: "</span>) <span style="color: #008000;">"\n"</span>))
      (insert (format <span style="color: #008000;">"[[%s]]"</span> fname))
      (org-display-inline-images t t))
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">C-drag-n-drop to open a file</span>
     ((<span style="color: #0000FF;">and</span>  (eq 'C-drag-n-drop (car event))
            (eq 'file type))
      (find-file fname))
     ((<span style="color: #0000FF;">and</span> (eq 'M-drag-n-drop (car event))
           (eq 'file type))
      (insert (format <span style="color: #008000;">"[[attachfile:%s]]"</span> fname)))
     <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">regular drag and drop on file</span>
     ((eq 'file type)
      (insert (format <span style="color: #008000;">"[[%s]]\n"</span> fname)))
     (t
      (<span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"I am not equipped for dnd on %s"</span> payload)))))


(define-key org-mode-map (kbd <span style="color: #008000;">"&lt;drag-n-drop&gt;"</span>) 'my-dnd-func)
(define-key org-mode-map (kbd <span style="color: #008000;">"&lt;C-drag-n-drop&gt;"</span>) 'my-dnd-func)
(define-key org-mode-map (kbd <span style="color: #008000;">"&lt;M-drag-n-drop&gt;"</span>) 'my-dnd-func)
</pre>
</div>

<pre class="example">
my-dnd-func
</pre>
<p>

</p>

<p>
<a href="/media/2015-07-10-Drag-images-and-files-onto-org-mode-and-insert-a-link-to-them/jkitchin.json">jkitchin.json</a> 

</p>

<p>
<img src="/media/2015-07-10-Drag-images-and-files-onto-org-mode-and-insert-a-link-to-them/Au-icosahedron-3.png"> </p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/07/10/Drag-images-and-files-onto-org-mode-and-insert-a-link-to-them.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>