---
title: An org-mode filter for blogofile
date: 2016/02/15 10:32:13
updated: 2016/02/15 10:32:13
categories: python,blog,orgmode
tags: 
---


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. An equation</a></li>
<li><a href="#sec-2">2. An image</a></li>
</ul>
</div>
</div>
<p>
For fun today I thought I would create a <a href="http://blogofile.readthedocs.org/en/latest/filters.html">filter</a> for <a href="http://blogofile.readthedocs.org/">blogofile</a> that would let me write posts directly in org-mode. I already more or less do that, and use <a href="https://github.com/jkitchin/jmax/blob/master/user/blogofile.el">this elisp module</a> I wrote to export the org to html. I do that in another "hidden" directory I call _blog, which blogofile ignores. The export puts the rendered html into the _posts directory, and then when I build the blog, it is rerendered by blogofile to _site, and then copied to _deploy and pushed to the github site. My blogofile.el library does a lot more if there are images, files, etc&#x2026; they get copied to the right place.
</p>

<p>
When I started this blog, I did not have as good an understanding of how to convert org-mode to other formats as I have now. It turns out to be easy to write a filter that turns org-content to html here. Here is the simple filter. We just write the content to a file, use emacs to export it to html, delete the file, and return the html. I reuse the machinery of blogofile.el for the export, since it already handles links and files. I use emacsclient to do the conversion so that there is basically no startup cost for emacs (since I have the emacs daemon running already).
</p>

<p>
Why would I want to do this? Lots of reasons ;) I might want a special org-link syntax to link to other posts that this would address, or an easier way to use the interactive plotting tools like bokeh that require injection of javascript into the html header, or because I had some important thing to do this morning and I did this instead ;)
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> tempfile

<span style="color: #BA36A5;">config</span> = {<span style="color: #008000;">"name"</span>: <span style="color: #008000;">"org-mode"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #008000;">"author"</span>: <span style="color: #008000;">"John Kitchin"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #008000;">"description"</span>: <span style="color: #008000;">"Renders org-mode formatted text to HTML"</span>}

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Directory where posts are stored</span>
<span style="color: #BA36A5;">_posts</span> = <span style="color: #008000;">"/Users/jkitchin/blogofile-jkitchin.github.com/_posts"</span>

<span style="color: #0000FF;">def</span> <span style="color: #006699;">run</span>(content):
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">we need to write the content to a file</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">fid</span>, <span style="color: #BA36A5;">tmp</span> = tempfile.mkstemp(<span style="color: #008000;">".org"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #006FE0;">dir</span>=_posts)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">html_file</span> = tmp.replace(<span style="color: #008000;">'.org'</span>, <span style="color: #008000;">'.html'</span>)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">with</span> <span style="color: #006FE0;">open</span>(tmp, <span style="color: #008000;">'w'</span>) <span style="color: #0000FF;">as</span> f:
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   f.write(content)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">run emacs to export it.</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">cmd</span> = (<span style="color: #008000;">"""emacsclient --eval """</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>  <span style="color: #008000;">"""'(progn (with-current-buffer (find-file-noselect "{0}")"""</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>  <span style="color: #008000;">"""   (re-search-forward "^*")"""</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>  <span style="color: #008000;">"""   (let ((html (save-window-excursion (bf-get-post-html))))"""</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>  <span style="color: #008000;">"""     (bf-copy-org-to-blog)"""</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>  <span style="color: #008000;">"""     (save-buffer) (kill-buffer)"""</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>  <span style="color: #008000;">"""     (with-temp-file "{1}" """</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>  <span style="color: #008000;">"""        (insert html)))))'"""</span>.<span style="color: #006FE0;">format</span>(tmp, html_file))

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   os.system(cmd)

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">read the results in and return them</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">with</span> <span style="color: #006FE0;">open</span>(html_file, <span style="color: #008000;">'r'</span>) <span style="color: #0000FF;">as</span> f:
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #BA36A5;">html</span> = f.read()

<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">os.unlink(tmp)</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">os.unlink(html_file)</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #0000FF;">return</span> html
</pre>
</div>

<p>
One mildly annoying feature is you have to have a top headline for the export, or you get an error from org about being before the first headline. That is probably a bug. Here are few tests to see how well it works. I am not sure how often I will use this, as I currently have to manually generate the yaml header in the post to make it work, and give it a filename. That is only an emacs-lisp function away from not annoying me though.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> An equation</h2>
<div class="outline-text-2" id="text-1">
<p>
My favorite: \(e^{i\pi} + 1 = 0\).
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> An image</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np

<span style="color: #BA36A5;">x</span> = np.linspace(0, 20 * np.pi, 200)

<span style="color: #BA36A5;">f</span> = 1e-3
<span style="color: #BA36A5;">y1</span> = np.sin(x) * f / x
<span style="color: #BA36A5;">y2</span> = np.cos(x) * f / x
plt.plot(y1, y2)
plt.savefig(<span style="color: #008000;">'../img/spiral.png'</span>)
</pre>
</div>


<div class="figure">
<p><img src="/media/2016-02-15-An-org-mode-filter-for-blogofile/spiral.png"> 
</p>
</div>
</div>
</div>
<p>Copyright (C) 2016 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2016/02/15/An-org-mode-filter-for-blogofile.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>