---
title: Peak finding in Raman spectroscopy
date: 2013/02/27 10:55:57
updated: 2013/02/27 14:45:37
categories: data analysis
---


<p>
Raman spectroscopy is a vibrational spectroscopy. The data typically comes as intensity vs. wavenumber, and it is discrete. Sometimes it is necessary to identify the precise location of a peak. In this post, we will use spline smoothing to construct an interpolating function of the data, and then use fminbnd to identify peak positions.
</p>

<p>
This example was originally worked out in Matlab at <a href="http://matlab.cheme.cmu.edu/2012/08/27/peak-finding-in-raman-spectroscopy/" >http://matlab.cheme.cmu.edu/2012/08/27/peak-finding-in-raman-spectroscopy/</a>
</p>

<p>
numpy:loadtxt
</p>

<p>
Let us take a look at the raw data.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> os
<span style="color: #8b0000;">print</span> os.getcwd()
<span style="color: #8b0000;">print</span> os.environ[<span style="color: #228b22;">'HOME'</span>]
</pre>
</div>

<pre class="example">
/home/jkitchin/Dropbox/intro-python
/home/jkitchin
</pre>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> numpy <span style="color: #8b0000;">as</span> np
<span style="color: #8b0000;">import</span> matplotlib.pyplot <span style="color: #8b0000;">as</span> plt

w, i = np.loadtxt(<span style="color: #228b22;">'data/raman.txt'</span>, usecols=(0, 1), unpack=<span style="color: #8b0000;">True</span>)

plt.plot(w, i)
plt.xlabel(<span style="color: #228b22;">'Raman shift (cm$^{-1}$)'</span>)
plt.ylabel(<span style="color: #228b22;">'Intensity (counts)'</span>)
plt.savefig(<span style="color: #228b22;">'images/raman-1.png'</span>)
plt.show()
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; [&lt;matplotlib.lines.Line2D object at 0x1d372810&gt;]
&lt;matplotlib.text.Text object at 0x1d48df90&gt;
&lt;matplotlib.text.Text object at 0x1d356a10&gt;
</pre>

<p><img src="/img/./images/raman-1.png"><p>

<p>
The next thing to do is narrow our focus to the region we are interested in between 1340 cm^{-1} and 1360 cm^{-1}.
</p>

<div class="org-src-container">

<pre class="src src-python">ind = (w &gt; 1340) &amp; (w &lt; 1360)
w1 = w[ind]
i1 = i[ind]

plt.plot(w1, i1, <span style="color: #228b22;">'b. '</span>)
plt.xlabel(<span style="color: #228b22;">'Raman shift (cm$^{-1}$)'</span>)
plt.ylabel(<span style="color: #228b22;">'Intensity (counts)'</span>)
plt.savefig(<span style="color: #228b22;">'images/raman-2.png'</span>)
plt.show()
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; [&lt;matplotlib.lines.Line2D object at 0x1d5005d0&gt;]
&lt;matplotlib.text.Text object at 0x1d37a650&gt;
&lt;matplotlib.text.Text object at 0x1d3809d0&gt;
</pre>

<p><img src="/img/./images/raman-2.png"><p>

<p>
Next we consider a scipy:UnivariateSpline. This function &ldquo;smooths&rdquo; the data.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> scipy.interpolate <span style="color: #8b0000;">import</span> UnivariateSpline

<span style="color: #ff0000; font-weight: bold;"># s is a "smoothing" factor</span>
sp = UnivariateSpline(w1, i1, s=3000)

plt.plot(w1, i1, <span style="color: #228b22;">'b. '</span>)
plt.plot(w1, sp(w1), <span style="color: #228b22;">'r-'</span>)
plt.xlabel(<span style="color: #228b22;">'Raman shift (cm$^{-1}$)'</span>)
plt.ylabel(<span style="color: #228b22;">'Intensity (counts)'</span>)
plt.savefig(<span style="color: #228b22;">'images/raman-3.png'</span>)
plt.show()
</pre>
</div>

<pre class="example">
... [&lt;matplotlib.lines.Line2D object at 0x1dd35e90&gt;]
[&lt;matplotlib.lines.Line2D object at 0x2ab334a3d510&gt;]
&lt;matplotlib.text.Text object at 0x1d49bad0&gt;
&lt;matplotlib.text.Text object at 0x1dd3b950&gt;
</pre>

<p><img src="/img/./images/raman-3.png"><p>

<p>
Note that the UnivariateSpline function returns a &ldquo;callable&rdquo; function! Our next goal is to find the places where there are peaks. This is defined by the first derivative of the data being equal to zero. It is easy to get the first derivative of a UnivariateSpline with a second argument as shown below.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ff0000; font-weight: bold;"># get the first derivative evaluated at all the points</span>
d1 =  sp(w1, 1)
plt.plot(w1, d1, label=<span style="color: #228b22;">'first derivative'</span>)
plt.xlabel(<span style="color: #228b22;">'Raman shift (cm$^{-1}$)'</span>)
plt.ylabel(<span style="color: #228b22;">'First derivative'</span>)

<span style="color: #ff0000; font-weight: bold;"># find the places where the first derivative crosses zero</span>
s = np.zeros(d1.shape)
s[d1 &gt;= 0] = 1
s[d1 &lt; 0] = 0

initial_guesses = w1[np.diff(s) == -1]
plt.plot(initial_guesses, 0*initial_guesses, <span style="color: #228b22;">'ro '</span>, label=<span style="color: #228b22;">'Guesses of zeros'</span>)
plt.legend(loc=<span style="color: #228b22;">'best'</span>)
plt.savefig(<span style="color: #228b22;">'images/raman-4.png'</span>
plt.show()
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; [&lt;matplotlib.lines.Line2D object at 0x1d9eaad0&gt;]
&lt;matplotlib.text.Text object at 0x1d4f2210&gt;
&lt;matplotlib.text.Text object at 0x1d9e6910&gt;
&gt;&gt;&gt; ... &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; [&lt;matplotlib.lines.Line2D object at 0x1d4f3250&gt;]
&lt;matplotlib.legend.Legend object at 0x1d839510&gt;
</pre>

<p><img src="/img/./images/raman-4.png"><p>

<p>
Now, we can use these initial guesses to solve for the actual values.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">from</span> scipy.optimize <span style="color: #8b0000;">import</span> fminbound

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">func</span>(w):
    <span style="color: #228b22;">'function to minimize'</span>
    <span style="color: #8b0000;">return</span> -sp(w)

<span style="color: #8b0000;">for</span> value <span style="color: #8b0000;">in</span> initial_guesses:
    sol = fminbound(func, value - 1, value + 1)
    plt.plot(sol, sp(sol), <span style="color: #228b22;">'ro '</span>, ms=8)
    <span style="color: #8b0000;">print</span> <span style="color: #228b22;">'Peak found at {0} cm^{{-1}}'</span>.format(sol)

plt.plot(w1, i1, <span style="color: #228b22;">'b. '</span>)
plt.plot(w1, sp(w1), <span style="color: #228b22;">'r-'</span>)
plt.xlabel(<span style="color: #228b22;">'Raman shift (cm$^{-1}$)'</span>)
plt.ylabel(<span style="color: #228b22;">'Intensity (counts)'</span>)
plt.savefig(<span style="color: #228b22;">'images/raman-5.png'</span>)
plt.show()
</pre>
</div>

<pre class="example">
... ... ... &gt;&gt;&gt; ... [&lt;matplotlib.lines.Line2D object at 0x1da00510&gt;]
Peak found at 1346.50980295 cm^{-1}
[&lt;matplotlib.lines.Line2D object at 0x1d4c0110&gt;]
Peak found at 1348.11261373 cm^{-1}
[&lt;matplotlib.lines.Line2D object at 0x1da02b90&gt;]
[&lt;matplotlib.lines.Line2D object at 0x1da02750&gt;]
&lt;matplotlib.text.Text object at 0x1da01850&gt;
&lt;matplotlib.text.Text object at 0x1d9d4110&gt;
</pre>

<p>
In the end, we have illustrated how to construct a spline smoothing interpolation function and to find maxima in the function, including generating some initial guesses. There is more art to this than you might like, since you have to judge how much smoothing is enough or too much. With too much, you may smooth peaks out. With too little, noise may be mistaken for peaks.
</p>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Summary notes</h2>
<div class="outline-text-2" id="text-1">
<p>
Using org-mode with :session allows a large script to be broken up into mini sections. However, it only seems to work with the default python mode in Emacs, and it does not work with emacs-for-python or the latest python-mode. I also do not really like the output style, e.g. the output from the plotting commands.
</p>
</div>
</div>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/02/27/Peak-finding-in-Raman-spectroscopy.org">org-mode source</a><p>