---
title: Summarizing org-files in a report
date: 2013/04/30 08:30:01
updated: 2013/04/30 09:49:38
categories: emacs-lisp, org-mode
tags: 
---


<p>
This is an example of using emacs-lisp to extract pieces of information about a bunch of org-files into a single report, as well as aggregating data from those files. The scenario where this would likely be useful is if you have a set of org-files that contain information, e.g. from a bunch of different calculations, or from documents turned in by different students, and you want to aggregate the results into a report.
</p>

<p>
In this example, I have a set of org-files in this directory that contain simulated homework assignments turned in. The files in this example all look something like this. Each heading corresponds to a problem, and there is a properties drawer for each heading that contains the grade. 
</p>

<p>
We will create a navigation document that facilitates reviewing each of the files, as well as collecting the grades from the files. Here is what a typical file looks like:
</p>

<pre class="example">
#+PROPERTY: NAME Ellen Donnte
* 1a
  :PROPERTIES:
  :lettergrade: A
  :END:
* 1b
  :PROPERTIES:
  :lettergrade: R
  :END:
* 2
  :PROPERTIES:
  :lettergrade: A
  :END:
#+BEGIN_SRC emacs-lisp
(prin1 42)
#+END_SRC

#+RESULTS:
: 42

* 3
  :PROPERTIES:
  :lettergrade: C
  :END:
</pre>


<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Creating a navigation document</h2>
<div class="outline-text-2" id="text-1">
<p>
In this section we write some code that creates text with a link to each file we need to review. This is something I imagine we would do after all the files have been turned in and collected. This buffer would facilitate navigating all the files, and checking them off. First we create checkboxes. All this does is create an easy to use navigation document that facilitates opening the files, grading them, and marking them as done.<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">require</span> '<span style="color: #cd0000;">find-lisp</span>)

(<span style="color: #8b0000;">dolist</span> (fname (find-lisp-find-files <span style="color: #228b22;">"."</span> <span style="color: #228b22;">"\\HW1.org$"</span>) nil)
  (princ (format <span style="color: #228b22;">"- [ ] [[file:%s][%s]]\n"</span> fname (file-name-nondirectory fname))))
</pre>
</div>

<ul>
<li><code>[X]</code> <a href="file://c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/Slim-Shady-HW1.html" >Slim-Shady-HW1.org</a>
</li>
<li><code>[&nbsp;]</code> <a href="file://c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/John-Doe-HW1.html" >John-Doe-HW1.org</a>
</li>
<li><code>[&nbsp;]</code> <a href="file://c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/Jim-Vicious-HW1.html" >Jim-Vicious-HW1.org</a>
</li>
<li><code>[&nbsp;]</code> <a href="file://c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/Ellen-Donnte-HW1.html" >Ellen-Donnte-HW1.org</a>
</li>
</ul>


<p>
In the results above I have marked one entry as completed.
</p>

<p>
It might be preferrable to have links to places in the file, e.g. to problem 2.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">require</span> '<span style="color: #cd0000;">find-lisp</span>)

(<span style="color: #8b0000;">dolist</span> (fname (find-lisp-find-files <span style="color: #228b22;">"."</span> <span style="color: #228b22;">"\\HW1.org$"</span>) nil)
  (princ (format <span style="color: #228b22;">"- [ ] [[file:%s::*2][%s - problem 2]]\n"</span> fname (file-name-nondirectory fname))))
</pre>
</div>

<ul>
<li><code>[&nbsp;]</code> <a href="file://c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/Slim-Shady-HW1.html" >Slim-Shady-HW1.org - problem 2</a>
</li>
<li><code>[&nbsp;]</code> <a href="file://c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/John-Doe-HW1.html" >John-Doe-HW1.org - problem 2</a>
</li>
<li><code>[X]</code> <a href="file://c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/Jim-Vicious-HW1.html" >Jim-Vicious-HW1.org - problem 2</a>
</li>
<li><code>[&nbsp;]</code> <a href="file://c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/Ellen-Donnte-HW1.html" >Ellen-Donnte-HW1.org - problem 2</a>
</li>
</ul>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Aggregating properties</h2>
<div class="outline-text-2" id="text-2">
<p>
Our goal here is to use emacs-lisp to aggregate the letter grades from all the assignments into a table. This would be done after all the files have been reviewed. First, we write a function that gets the data we want. The function should take a filename, and return the letter grade for a problem, e.g. (get-letter-grade filename problem) -&gt; lettergrade. Then, we will map that function onto a list of files.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">require</span> '<span style="color: #cd0000;">find-lisp</span>)

(<span style="color: #8b0000;">defun</span> <span style="color: #8b2323;">get-letter-grade</span> (filename problem-name)
  <span style="color: #228b22;">"Open filename, get the grade associated with the heading of problem-name."</span>
  (<span style="color: #8b0000;">with-temp-buffer</span>
    (insert-file-contents filename)
    (<span style="color: #8b0000;">let</span> ((studentname nil)
           (lettergrade nil))
      (org-ctrl-c-ctrl-c) <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">this is needed to read the NAME property!</span>
      (setq studentname (org-entry-get (point) <span style="color: #228b22;">"NAME"</span> t))
      (goto-char (point-min))
      (search-forward problem-name)
      (setq lettergrade (org-entry-get (point) <span style="color: #228b22;">"lettergrade"</span>))
      
      (princ (format <span style="color: #228b22;">"|%s|%s|%s|\n"</span> studentname problem-name lettergrade)))))

(princ <span style="color: #228b22;">"#+ATTR_HTML: :border 2 :rules all :frame border\n"</span>)
(princ <span style="color: #228b22;">"#+tblname: GRADES\n"</span>)
(princ <span style="color: #228b22;">"| Name | Problem | Grade |\n|-\n"</span>)

(<span style="color: #8b0000;">dolist</span> (problem-name '(<span style="color: #228b22;">"1a"</span> <span style="color: #228b22;">"1b"</span> <span style="color: #228b22;">"2"</span> <span style="color: #228b22;">"3"</span>) nil)
  (mapcar (<span style="color: #8b0000;">lambda</span> (fname) (get-letter-grade fname problem-name)) 
      (find-lisp-find-files <span style="color: #228b22;">"."</span> <span style="color: #228b22;">"\\HW1.org$"</span>)))
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" id="GRADES">
<caption></caption>

<colgroup>
<col class="left"/>

<col class="left"/>

<col class="left"/>
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Name</th>
<th scope="col" class="left">Problem</th>
<th scope="col" class="left">Grade</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">Slim Shady</td>
<td class="left">1a</td>
<td class="left">A</td>
</tr>

<tr>
<td class="left">John Doe</td>
<td class="left">1a</td>
<td class="left">B</td>
</tr>

<tr>
<td class="left">Jim Vicious</td>
<td class="left">1a</td>
<td class="left">B</td>
</tr>

<tr>
<td class="left">Ellen Donnte</td>
<td class="left">1a</td>
<td class="left">A</td>
</tr>

<tr>
<td class="left">Slim Shady</td>
<td class="left">1b</td>
<td class="left">B</td>
</tr>

<tr>
<td class="left">John Doe</td>
<td class="left">1b</td>
<td class="left">A</td>
</tr>

<tr>
<td class="left">Jim Vicious</td>
<td class="left">1b</td>
<td class="left">C</td>
</tr>

<tr>
<td class="left">Ellen Donnte</td>
<td class="left">1b</td>
<td class="left">R</td>
</tr>

<tr>
<td class="left">Slim Shady</td>
<td class="left">2</td>
<td class="left">R</td>
</tr>

<tr>
<td class="left">John Doe</td>
<td class="left">2</td>
<td class="left">B</td>
</tr>

<tr>
<td class="left">Jim Vicious</td>
<td class="left">2</td>
<td class="left">R</td>
</tr>

<tr>
<td class="left">Ellen Donnte</td>
<td class="left">2</td>
<td class="left">A</td>
</tr>

<tr>
<td class="left">Slim Shady</td>
<td class="left">3</td>
<td class="left">R</td>
</tr>

<tr>
<td class="left">John Doe</td>
<td class="left">3</td>
<td class="left">B</td>
</tr>

<tr>
<td class="left">Jim Vicious</td>
<td class="left">3</td>
<td class="left">D</td>
</tr>

<tr>
<td class="left">Ellen Donnte</td>
<td class="left">3</td>
<td class="left">C</td>
</tr>
</tbody>
</table>


<p>
You could imagine some other kind of aggregating or analysis here too. Now that we have that table, we can use it in other analysis. Let us count the number of A's. 
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">save-excursion</span>
  (goto-char (point-min))
  (search-forward-regexp <span style="color: #228b22;">"^#\\+tblname: GRADES"</span>)
  (next-line)
  (<span style="color: #8b0000;">let</span> ((A-COUNT 0)
        (letter-grade nil)
        <span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">cddr is used to remove the first two rows of the table</span>
        (data (cddr (org-table-to-lisp))))
    (<span style="color: #8b0000;">dolist</span> (entry data nil)
      (setq letter-grade (nth 2 entry))
      (<span style="color: #8b0000;">if</span> (equal  letter-grade <span style="color: #228b22;">"A"</span>)
          (incf A-COUNT)))
    (princ (format <span style="color: #228b22;">"%s A's counted"</span> A-COUNT))))
</pre>
</div>

<pre class="example">
4 A's counted
</pre>

<p>
Since we are in org-mode, we can use the table directly! Let us do that and count the number of R's.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">let</span> ((COUNT 0)
      (letter-grade nil))
    (<span style="color: #8b0000;">dolist</span> (entry (cddr data) nil)
      (setq letter-grade (nth 2 entry))
      (<span style="color: #8b0000;">if</span> (equal  letter-grade <span style="color: #228b22;">"R"</span>)
          (incf COUNT)))
    (princ (format <span style="color: #228b22;">"%s R's counted"</span> COUNT))))
</pre>
</div>

<pre class="example">
4 R's counted
</pre>
</div>
</div>
<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Aggregating sections of org-files into one file</h2>
<div class="outline-text-2" id="text-3">
<p>
Another scenario that may be interesting is to collect all of the responses in a single document. This might be useful to show examples in class, or to review all the problems to see if there are common errors. Here we collect Problem 2.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #8b0000;">require</span> '<span style="color: #cd0000;">find-lisp</span>)

(generate-new-buffer <span style="color: #228b22;">"Problem 2"</span>)
(set-buffer <span style="color: #228b22;">"Problem 2"</span>)
(insert <span style="color: #228b22;">"#+TITLE: Summary of problem 2\n"</span>)

(<span style="color: #8b0000;">dolist</span> (fname (find-lisp-find-files <span style="color: #228b22;">"."</span> <span style="color: #228b22;">"\\HW1.org$"</span>) nil)
  (<span style="color: #8b0000;">save-excursion</span>
    (goto-char (point-max))
    (org-mode)
    (<span style="color: #8b0000;">with-temp-buffer</span> 
      (insert-file-contents fname)
      (org-mode)
      (goto-char (point-min))
      (setq studentname (org-entry-get nil <span style="color: #228b22;">"NAME"</span> t))
      (search-forward <span style="color: #228b22;">"* 2"</span>)
      (org-narrow-to-subtree)
      (forward-line) <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">skip heading</span>
      (setq text (buffer-substring (point) (point-max))))
    (insert (format <span style="color: #228b22;">"* 2 - %s\n"</span> studentname))
    (insert text <span style="color: #228b22;">"\n"</span>)
          
    (search-backward <span style="color: #228b22;">"* 2"</span>)
    (org-entry-put nil <span style="color: #228b22;">"NAME"</span> studentname)
    (org-entry-put nil <span style="color: #228b22;">"source"</span> (format <span style="color: #228b22;">"[[%s][link]]"</span> fname))
))

(switch-to-buffer <span style="color: #228b22;">"Problem 2"</span>)
(org-mode) <span style="color: #ff0000; font-weight: bold;">; </span><span style="color: #ff0000; font-weight: bold;">switch to org-mode in that buffer</span>

<span style="color: #ff0000; font-weight: bold;">;; </span><span style="color: #ff0000; font-weight: bold;">print the lines to see what we got</span>
(<span style="color: #8b0000;">dolist</span> (line (split-string (buffer-string) <span style="color: #228b22;">"\n"</span>) nil) (princ (format <span style="color: #228b22;">": %s\n"</span> line)))
</pre>
</div>

<pre class="example">
: #+TITLE: Summary of problem 2
: * 2 - Slim Shady
:   :PROPERTIES:
:   :lettergrade: R
:   :NAME:     Slim Shady
:   :source:   [[c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/Slim-Shady-HW1.org][link]]
:   :END:
: #+BEGIN_SRC python
: print 3
: 
: #+END_SRC
: 
: #+RESULTS:
: : 3
: 
: * 2 - John Doe
:   :PROPERTIES:
:   :lettergrade: B
:   :NAME:     John Doe
:   :source:   [[c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/John-Doe-HW1.org][link]]
:   :END:
: Here is my solution
: #+BEGIN_SRC python
: print 4
: #+END_SRC
: 
: #+RESULTS:
: : 4
: 
: * 2 - Jim Vicious
:   :PROPERTIES:
:   :lettergrade: R
:   :NAME:     Jim Vicious
:   :source:   [[c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/Jim-Vicious-HW1.org][link]]
:   :END:
: I could not figure this out
: * 2 - Ellen Donnte
:   :PROPERTIES:
:   :lettergrade: A
:   :NAME:     Ellen Donnte
:   :source:   [[c:/Users/jkitchin/Dropbox/blogofile-jkitchin.github.com/_blog/org-report/Ellen-Donnte-HW1.org][link]]
:   :END:
: #+BEGIN_SRC emacs-lisp
: (prin1 42)
: #+END_SRC
: 
: #+RESULTS:
: : 42
</pre>






<p>
I am not super thrilled with this approach. It feels too much like hand-crafting a result, but it does show some possibilities!
</p>
</div>
</div>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/04/30/Summarizing-org-files-in-a-report.org">org-mode source</a><p>