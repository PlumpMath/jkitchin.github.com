---
title: An alternative approach to including org-source in blog posts
date: 2015/05/09 13:50:18
updated: 2015/05/09 14:58:24
categories: orgmode
tags: 
---


<p>
When you publish a Matlab m-file to HTML, Matlab includes the m-file source as an html comment in the output. They also provide a nice function called grabcode that will take a url, and open the source code in the editor. Today, we try a similar approach for org-mode.
</p>

<p>
This post is not totally self-contained. I have my own emacs-lisp module that converts org-mode to blogofile posts, and so far I have not made it broadly available. This is also a super exploratory idea, so I am just going to show the changes I need to make to my setup to get to the evaluation of the idea.
</p>

<p>
The idea is pretty simple, we just insert the current buffer string into an HTML comment. I just modify the bf-get-post-html function lightly to do that. This is a somewhat pathological example since there are html comments in the post! So, we will encode all the dashes to get around that.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">browse-url</span>)
(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">bf-get-post-html</span> ()
  <span style="color: #036A07;">"Return a string containing the YAML header, the post html, my</span>
<span style="color: #036A07;">copyright line, and a link to the org-source code."</span>
  (<span style="color: #0000FF;">interactive</span>)
  (<span style="color: #0000FF;">let</span> ((org-source (buffer-string))
        (url-to-org (bf-get-url-to-org-source))
        (yaml (bf-get-YAML-heading))
        (body (bf-get-HTML)))

    (<span style="color: #0000FF;">with-temp-buffer</span>
      (insert yaml)
      (insert body)
      (insert
       (format <span style="color: #008000;">"&lt;p&gt;Copyright (C) %s by John Kitchin. See the &lt;a href=\"/copying.html\"&gt;License&lt;/a&gt; for information about copying.&lt;p&gt;"</span>
               (format-time-string <span style="color: #008000;">"%Y"</span>)))
      (insert (format <span style="color: #008000;">"&lt;p&gt;&lt;a href=\"%s\"&gt;org-mode source&lt;/a&gt;&lt;p&gt;"</span>
                      url-to-org))
      (insert (format <span style="color: #008000;">"&lt;p&gt;Org-mode version = %s&lt;/p&gt;"</span> (org-version)))
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this is the only new code we need to add.</span>
      (insert (format <span style="color: #008000;">"</span>
<span style="color: #008000;">&lt;!--</span>
<span style="color: #008000;">  ##### SOURCE BEGIN #####</span>
<span style="color: #008000;">%s</span>
<span style="color: #008000;">##### SOURCE END #####</span>
<span style="color: #008000;">--&gt;"</span> (browse-url-url-encode-chars org-source <span style="color: #008000;">"[-]"</span>)))
      <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">return value</span>
      (buffer-string))))
</pre>
</div>

<p>
By itself, that has limited value to me. So, let's also create a grab-org-source function to get the embedded source and open it in a buffer. This might be a naive approach, we just use a regexp to find the source boundaries and open it in a new buffer. We have to unescape the dashes, which appear as %2D in the comments. Here is our function.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">grab-org-source</span> (url)
  <span style="color: #036A07;">"Extract org-source from URL to a buffer named *grab-org-source*."</span>
  (<span style="color: #0000FF;">interactive</span> <span style="color: #008000;">"sURL: "</span>)
  (switch-to-buffer (get-buffer-create <span style="color: #008000;">"*grab-org-source*"</span>))
  (erase-buffer)
  (org-mode)
  (insert
   (<span style="color: #0000FF;">with-current-buffer</span>
       (url-retrieve-synchronously url)
     (<span style="color: #0000FF;">let</span> (start)
       (re-search-forward
        <span style="color: #008000;">"</span>
<span style="color: #008000;">&lt;!--</span>
<span style="color: #008000;">  ##### SOURCE BEGIN #####</span>
<span style="color: #008000;">"</span> nil t)
       (<span style="color: #0000FF;">setq</span> start (point))
       (re-search-forward <span style="color: #008000;">"##### SOURCE END #####</span>
<span style="color: #008000;">--&gt;"</span> nil t)
       (buffer-substring start (match-beginning 0)))))
  (goto-char (point-min))
  (<span style="color: #0000FF;">while</span> (search-forward <span style="color: #008000;">"%2D"</span> nil t)
    (replace-match <span style="color: #008000;">"-"</span>))
  (goto-char (point-min)))
</pre>
</div>

<p>
This concludes my basic proof of concept. I think there is a general escaping challenge in this approach, because it isn't clear if you can put really arbitrary stuff in an html comment, e.g. you cannot put &#x2013;&gt;! I am going to try incorporating this into my posts and see what other issues come up in the future.
</p>
<p>Copyright (C) 2015 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/05/09/An-alternative-approach-to-including-org-source-in-blog-posts.org">org-mode source</a><p><p>Org-mode version = 8.2.10</p>
<!--
  ##### SOURCE BEGIN #####
* DONE An alternative approach to including org%2Dsource in blog posts
  CLOSED: [2015%2D05%2D09 Sat 13:57]
  :PROPERTIES:
  :categories: orgmode
  :date:     2015/05/09 13:50:18
  :updated:  2015/05/09 14:58:24
  :END:
When you publish a Matlab m%2Dfile to HTML, Matlab includes the m%2Dfile source as an html comment in the output. They also provide a nice function called grabcode that will take a url, and open the source code in the editor. Today, we try a similar approach for org%2Dmode.

This post is not totally self%2Dcontained. I have my own emacs%2Dlisp module that converts org%2Dmode to blogofile posts, and so far I have not made it broadly available. This is also a super exploratory idea, so I am just going to show the changes I need to make to my setup to get to the evaluation of the idea.

The idea is pretty simple, we just insert the current buffer string into an HTML comment. I just modify the bf%2Dget%2Dpost%2Dhtml function lightly to do that. This is a somewhat pathological example since there are html comments in the post! So, we will encode all the dashes to get around that.

#+BEGIN_SRC emacs%2Dlisp
(require 'browse%2Durl)
(defun bf%2Dget%2Dpost%2Dhtml ()
  "Return a string containing the YAML header, the post html, my
copyright line, and a link to the org%2Dsource code."
  (interactive)
  (let ((org%2Dsource (buffer%2Dstring))
	(url%2Dto%2Dorg (bf%2Dget%2Durl%2Dto%2Dorg%2Dsource))
	(yaml (bf%2Dget%2DYAML%2Dheading))
	(body (bf%2Dget%2DHTML)))

    (with%2Dtemp%2Dbuffer
      (insert yaml)
      (insert body)
      (insert
       (format "<p>Copyright (C) %s by John Kitchin. See the <a href=\"/copying.html\">License</a> for information about copying.<p>"
	       (format%2Dtime%2Dstring "%Y")))
      (insert (format "<p><a href=\"%s\">org%2Dmode source</a><p>"
		      url%2Dto%2Dorg))
      (insert (format "<p>Org%2Dmode version = %s</p>" (org%2Dversion)))
      ;; this is the only new code we need to add.
      (insert (format "
<!%2D%2D
  ##### SOURCE BEGIN #####
%s
##### SOURCE END #####
%2D%2D>" (browse%2Durl%2Durl%2Dencode%2Dchars org%2Dsource "[%2D]")))
      ;; return value
      (buffer%2Dstring))))
#+END_SRC

By itself, that has limited value to me. So, let's also create a grab%2Dorg%2Dsource function to get the embedded source and open it in a buffer. This might be a naive approach, we just use a regexp to find the source boundaries and open it in a new buffer. We have to unescape the dashes, which appear as %2D in the comments. Here is our function.

#+BEGIN_SRC emacs%2Dlisp
(defun grab%2Dorg%2Dsource (url)
  "Extract org%2Dsource from URL to a buffer named *grab%2Dorg%2Dsource*."
  (interactive "sURL: ")
  (switch%2Dto%2Dbuffer (get%2Dbuffer%2Dcreate "*grab%2Dorg%2Dsource*"))
  (erase%2Dbuffer)
  (org%2Dmode)
  (insert
   (with%2Dcurrent%2Dbuffer
       (url%2Dretrieve%2Dsynchronously url)
     (let (start)
       (re%2Dsearch%2Dforward
	"
<!%2D%2D
  ##### SOURCE BEGIN #####
" nil t)
       (setq start (point))
       (re%2Dsearch%2Dforward "##### SOURCE END #####
%2D%2D>" nil t)
       (buffer%2Dsubstring start (match%2Dbeginning 0)))))
  (goto%2Dchar (point%2Dmin))
  (while (search%2Dforward "%2D" nil t)
    (replace%2Dmatch "%2D"))
  (goto%2Dchar (point%2Dmin)))
#+END_SRC

This concludes my basic proof of concept. I think there is a general escaping challenge in this approach, because it isn't clear if you can put really arbitrary stuff in an html comment, e.g. you cannot put %2D%2D>! I am going to try incorporating this into my posts and see what other issues come up in the future.

##### SOURCE END #####
-->