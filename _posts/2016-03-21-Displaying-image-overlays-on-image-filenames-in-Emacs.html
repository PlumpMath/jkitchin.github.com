---
title: Displaying image overlays on image filenames in Emacs
date: 2016/03/21 11:21:19
updated: 2016/03/21 11:21:19
categories: emacs,orgmode
tags: 
---


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Tooltip approach</a></li>
<li><a href="#sec-2">2. The overlay approach</a></li>
</ul>
</div>
</div>
<p>
It has always bothered me a little that I have to add a file image after code blocks in org-mode to see the results. That extra work&#x2026; I also don't like having to explicitly print the figure in the code, since that is the extra work, just in a different place. Today I look into two approaches to this. First, we consider something like tooltips, and second just putting overlays of image files right on the file name. The plus side of this is no extra work. The downside is they won't export; that will still take the extra work, but you needed that for the caption anyway for now.
</p>

<p>
Here is a video illustrating the code in this post: <a href="https://www.youtube.com/watch?v=VuAnwCERM0U">https://www.youtube.com/watch?v=VuAnwCERM0U</a> 
</p>

<p>
Here is a test.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt
plt.plot([0, 1, 2, 4, 16])
plt.savefig(<span style="color: #008000;">"test-fig.png"</span>)
</pre>
</div>


<div class="figure">
<p><img src="/media/2016-03-21-Displaying-image-overlays-on-image-filenames-in-Emacs/test-fig.png"> 
</p>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Tooltip approach</h2>
<div class="outline-text-2" id="text-1">
<p>
Building on our <a href="http://kitchingroup.cheme.cmu.edu/blog/2016/03/16/Getting-graphical-feedback-as-tooltips-in-Emacs/">previous approach</a> of graphical tooltips, we try that here to show the images. I have solved the issue of why the images didn't show in the tooltips before; it was related to how Emacs was built. I used to build it with "cocoa" support so it integrates well in OSX. Here, I have build it with gtk3, and the tooltips work with images.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">image-tooltip-re</span> (concat  <span style="color: #008000;">"</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?3:</span><span style="color: #008000;">'</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">\"</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?1:</span><span style="color: #008000;">.*\\."</span>
                                  (regexp-opt '(<span style="color: #008000;">"png"</span> <span style="color: #008000;">"PNG"</span> <span style="color: #008000;">"JPG"</span> <span style="color: #008000;">"jpeg"</span>
                                                <span style="color: #008000;">"jpg"</span> <span style="color: #008000;">"JPEG"</span> <span style="color: #008000;">"eps"</span> <span style="color: #008000;">"EPS"</span>))
                                  <span style="color: #008000;">"</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(?:</span><span style="color: #008000;">\\3</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>)
  <span style="color: #036A07;">"Regexp to match image filenames in quotes"</span>)

(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">image-tooltip</span> (window object position)
  (<span style="color: #0000FF;">save-excursion</span>
    (goto-char position)
    (<span style="color: #0000FF;">let</span> (beg end imgfile img s)
      (<span style="color: #0000FF;">while</span> (not (looking-at image-tooltip-re))
        (forward-char -1))
      (<span style="color: #0000FF;">setq</span> imgfile (match-string-no-properties 1))
      (<span style="color: #0000FF;">when</span> (file-exists-p imgfile)
        (<span style="color: #0000FF;">setq</span> img (create-image (expand-file-name imgfile)
                                'imagemagick nil <span style="color: #006FE0;">:width</span> 200))
        (propertize <span style="color: #008000;">"Look in the minibuffer"</span>
                    'display img)))))

(font-lock-add-keywords
 nil
 `((,image-tooltip-re
    0 '(face font-lock-keyword-face
             help-echo image-tooltip))))

(font-lock-fontify-buffer)
</pre>
</div>

<p>
Now these both have tooltips on them: "test-fig.png"  and  'test-fig.png'.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> The overlay approach</h2>
<div class="outline-text-2" id="text-2">
<p>
We might alternatively prefer to put overlays in the buffer. Here we make that happen.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">next-image-overlay</span> (<span style="color: #6434A3;">&amp;optional</span> limit)
  (<span style="color: #0000FF;">when</span> (re-search-forward image-tooltip-re limit t)
    (<span style="color: #0000FF;">setq</span> beg (match-beginning 0)
          end (match-end 0)
          imgfile (match-string 1))
    (<span style="color: #0000FF;">when</span> (file-exists-p imgfile)
      (<span style="color: #0000FF;">setq</span> img (create-image (expand-file-name imgfile)
                              'imagemagick nil <span style="color: #006FE0;">:width</span> 300))
      (<span style="color: #0000FF;">setq</span> ov (make-overlay beg end))
      (overlay-put ov 'display img)
      (overlay-put ov 'face 'default)
      (overlay-put ov 'org-image-overlay t)
      (overlay-put ov 'modification-hooks
                   (list 'org-display-inline-remove-overlay)))))

(font-lock-add-keywords
 nil
 '((next-image-overlay (0  'font-lock-keyword-face t)))
 t)
</pre>
</div>


<p>
Here is the example we looked at before.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt
plt.plot([-0, 1, 2, 4, 16])
plt.savefig(<span style="color: #008000;">"test-fig.png"</span>)
</pre>
</div>

<p>
You may want to remove those overlays. Here is one way. Note they come back if you don't disable the font-lock keywords though.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(ov-clear 'org-image-overlay)
</pre>
</div>
<p>
I know you want to do that so here is:
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(font-lock-remove-keywords
 nil
 '((next-image-overlay (0  'font-lock-keyword-face t))))

(ov-clear 'org-image-overlay)
</pre>
</div>


<p>
Note you still have to clear the overlays. Font lock doesn't seem to do that for you I think.
</p>
</div>
</div>
<p>Copyright (C) 2016 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2016/03/21/Displaying-image-overlays-on-image-filenames-in-Emacs.org">org-mode source</a></p>
<p>Org-mode version = 8.2.10</p>