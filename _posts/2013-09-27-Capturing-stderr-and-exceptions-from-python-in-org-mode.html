---
title: Capturing stderr and exceptions from python in org-mode
date: 2013/09/27 19:37:05
updated: 2013/09/27 19:47:53
categories: org-mode
tags: 
---


<p>
I have used org-mode extensively to create examples of using python using the code blocks. For example to illustrate the difference between integer and float division you can do this:
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">print</span> 1 / 3
<span style="color: #8b0000;">print</span> 1.0 / 3.0
</pre>
</div>

<pre class="example">
0
0.333333333333
</pre>

<p>
There are some limitations to showing output though. For example, the code blocks do not capture anything from stderr.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> sys

<span style="color: #8b0000;">print</span> &gt;&gt;sys.stderr, <span style="color: #228b22;">'message to stderr'</span>
</pre>
</div>

<p>
And exceptions result in no output whatsoever. That is not helpful if you are trying to teach about exceptions! 
</p>

<p>
I discovered a way around this. The key is using a python sandbox that redirects stdout, stderr and that captures anything sent to those channels. You can also capture any exceptions, and redirect them to a variable. Finally, you can construct the output anyway you see fit. 
</p>

<p>
Below is the code that runs python code in a sandbox, with redirected outputs. I defined a function that temporarily redirects the output to stdout and stderr, so they can be captured. I execute the code wrapped in a try/except block to capture any exceptions that occur. Finally, I construct a string formatted in a way that lets you know what was on stdout, stderr, and what was an exception.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ff0000; font-weight: bold;">#</span><span style="color: #ff0000; font-weight: bold;">!/usr/bin/env python</span>
<span style="color: #8b0000;">from</span> cStringIO <span style="color: #8b0000;">import</span> StringIO
<span style="color: #8b0000;">import</span> os, sys

<span style="color: #8b0000;">def</span> <span style="color: #8b2323;">Sandbox</span>(code):
    <span style="color: #228b22;">'''Given code as a string, execute it in a sandboxed python environment</span>

<span style="color: #228b22;">    return the output, stderr, and any exception code</span>
<span style="color: #228b22;">    '''</span>
    <span style="color: #8b008b;">old_stdout</span> = sys.stdout
    <span style="color: #8b008b;">old_stderr</span> = sys.stderr
    <span style="color: #8b008b;">redirected_output</span> = <span style="color: #8b008b;">sys.stdout</span> = StringIO()
    <span style="color: #8b008b;">redirected_error</span> = <span style="color: #8b008b;">sys.stderr</span> = StringIO()

    <span style="color: #8b008b;">ns_globals</span> = {}
    <span style="color: #8b008b;">ns_locals</span> = {}
    <span style="color: #8b008b;">out</span>, <span style="color: #8b008b;">err</span>, <span style="color: #8b008b;">exc</span> = <span style="color: #cd0000;">None</span>, <span style="color: #cd0000;">None</span>, <span style="color: #cd0000;">None</span>

    <span style="color: #8b0000;">try</span>:
        <span style="color: #8b0000;">exec</span>(code, ns_globals, ns_locals)
    <span style="color: #8b0000;">except</span>:
        <span style="color: #8b0000;">import</span> traceback
        <span style="color: #8b008b;">exc</span> = traceback.format_exc()

    <span style="color: #8b008b;">out</span> = redirected_output.getvalue()
    <span style="color: #8b008b;">err</span> = redirected_error.getvalue()

    <span style="color: #ff0000; font-weight: bold;"># </span><span style="color: #ff0000; font-weight: bold;">reset outputs to the original values</span>
    <span style="color: #8b008b;">sys.stdout</span> = old_stdout
    <span style="color: #8b008b;">sys.stderr</span> = old_stderr

    <span style="color: #8b0000;">return</span> out, err, exc


<span style="color: #8b0000;">if</span> <span style="color: #cd0000;">__name__</span> == <span style="color: #228b22;">'__main__'</span>:
    content = sys.stdin.read()
    <span style="color: #8b008b;">out</span>, <span style="color: #8b008b;">err</span>, exc =  Sandbox(content)

    s = <span style="color: #228b22;">'''---stdout-----------------------------------------------------------</span>
<span style="color: #228b22;">{0}</span>
<span style="color: #228b22;">'''</span>.<span style="color: #cd0000;">format</span>(out)

    <span style="color: #8b0000;">if</span> err:
        s += <span style="color: #228b22;">'''---stderr-----------------------------------------------------------</span>
<span style="color: #228b22;">{0}</span>
<span style="color: #228b22;">'''</span>.<span style="color: #cd0000;">format</span>(err)

    <span style="color: #8b0000;">if</span> exc:
        s += <span style="color: #228b22;">'''---Exception--------------------------------------------------------</span>
<span style="color: #228b22;">{0}</span>
<span style="color: #228b22;">'''</span>.<span style="color: #cd0000;">format</span>(exc)

    <span style="color: #8b0000;">print</span> s
</pre>
</div>

<p>
To use this, we have to put this file (sandbox.py) in our PYTHONPATH. Then, we tell org-babel to run python using our new sandbox.py module. org-babel pipes the code in a src block to stdin of the python command, which will be intercepted by our sandbox module. If you put this in your init.el, or other customization location, then subsequent uses of python in org-mode will use your sandbox module. I usually only run this for a session as needed.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(setq org-babel-python-command <span style="color: #228b22;">"python -m sandbox"</span>)
</pre>
</div>

<p>
Now, when we use python, we can capture output to stderr!
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">import</span> sys

<span style="color: #8b0000;">print</span> &gt;&gt;sys.stderr, <span style="color: #228b22;">'message to stderr'</span>
</pre>
</div>

<pre class="example">
---stdout-----------------------------------------------------------

---stderr-----------------------------------------------------------
message to stderr
</pre>
<p>
And, we can capture exceptions!
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #8b0000;">print</span> 1 / 0
</pre>
</div>

<pre class="example">
---stdout-----------------------------------------------------------

---Exception--------------------------------------------------------
Traceback (most recent call last):
  File "c:\Users\jkitchin\Dropbox\blogofile-jkitchin.github.com\_blog\sandbox.py", line 20, in Sandbox
    exec(code, ns_globals, ns_locals)
  File "&lt;string&gt;", line 1, in &lt;module&gt;
ZeroDivisionError: integer division or modulo by zero
</pre>

<p>
There is a little obfuscation in the exception, since it technically occurs in the Sandbox, but this is better than getting no output whatsoever! I have not tested the sandbox.py code extensively, so I don't know if there will be things that do not work as expected. If you find any, please let me know!
</p>
<p>Copyright (C) 2013 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2013/09/27/Capturing-stderr-and-exceptions-from-python-in-org-mode.org">org-mode source</a><p>
